<!DOCTYPE html>
<!--
================================================================================
    TRACACHOC - Syst√®me de Tra√ßabilit√© pour Chocolateries Artisanales
    Version 2.5.0
    
    Copyright ¬© 2024-2026 Emmanuel Laurent / Emotions Chocolats
    Tous droits r√©serv√©s / All rights reserved
    
    ‚ö†Ô∏è  AVIS JURIDIQUE / LEGAL NOTICE
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Ce logiciel et son code source sont la propri√©t√© exclusive de l'auteur.
    This software and its source code are the exclusive property of the author.
    
    Toute reproduction, modification, distribution, ou utilisation commerciale
    de ce logiciel, en tout ou en partie, sans l'autorisation √©crite pr√©alable
    de l'auteur est strictement interdite et constitue une violation du droit
    d'auteur conform√©ment √† la loi belge du 30 juin 1994 relative au droit 
    d'auteur et aux droits voisins, ainsi qu'aux directives europ√©ennes 
    2001/29/CE et 2019/790.
    
    Any reproduction, modification, distribution, or commercial use of this
    software, in whole or in part, without prior written permission from the
    author is strictly prohibited and constitutes a copyright infringement.
    
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    
    üë§ Auteur : Emmanuel Laurent
    üè≠ Entreprise : Emotions Chocolats
    üìç Localisation : Couthuin, Belgique
    üìß Contact licence : man497@hotmail.be
    
    D√©p√¥t i-DEPOT BOIP : 156533
    
================================================================================
-->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Emmanuel Laurent - Emotions Chocolats">
    <meta name="copyright" content="¬© 2024-2026 Emmanuel Laurent / Emotions Chocolats - Tous droits r√©serv√©s">
    <meta name="description" content="TRACACHOC - Syst√®me professionnel de tra√ßabilit√© HACCP pour chocolateries artisanales. Gestion des lots, mati√®res premi√®res, recettes et conformit√© alimentaire.">
    <meta name="robots" content="noindex, nofollow">
    <title>TRACACHOC - Syst√®me de Tra√ßabilit√© Chocolaterie</title>
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,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">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,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">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,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">
    <style>
        /* ============================================
           TRACACHOC - Syst√®me de Tra√ßabilit√©
           Version 2.5.0
           Copyright ¬© 2024-2026 Emmanuel Laurent
           Emotions Chocolats - Couthuin, Belgique
           Tous droits r√©serv√©s
           ============================================ */
        
        /* ============================================
           DESIGN ARTISAN PREMIUM - Chocolaterie
           Version 2.5.0 - Th√®me Clair √âl√©gant
           ============================================ */
        
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600&display=swap');
        
        :root {
            /* Couleurs principales */
            --chocolate-dark: #3d2314;
            --chocolate: #5c3a21;
            --chocolate-light: #8b5a2b;
            --caramel: #c4853d;
            --gold: #d4a853;
            --cream: #faf6f1;
            
            /* Fond et surfaces */
            --bg-body: linear-gradient(145deg, #f5f0e8 0%, #ebe4d8 100%);
            --bg-card: #ffffff;
            --bg-elevated: #fdfcfa;
            --bg-input: #f8f6f3;
            --border-light: #e8e2d9;
            --border-medium: #d4ccc0;
            
            /* Texte */
            --text-dark: #2c1810;
            --text-medium: #5c4a3d;
            --text-light: #8a7b6c;
            --text-muted: #a99f93;
            
            /* √âtats */
            --success: #2d8a4e;
            --success-light: #e8f5ed;
            --warning: #c17f24;
            --warning-light: #fef4e6;
            --danger: #c43d3d;
            --danger-light: #fdeaea;
            --info: #2a6fa8;
            --info-light: #e8f2fa;
            
            /* Ombres */
            --shadow-sm: 0 2px 8px rgba(60, 35, 20, 0.06);
            --shadow-md: 0 4px 20px rgba(60, 35, 20, 0.1);
            --shadow-lg: 0 8px 40px rgba(60, 35, 20, 0.15);
            --shadow-card: 0 2px 12px rgba(60, 35, 20, 0.08);
            
            /* Rayons */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-body);
            min-height: 100vh;
            padding: 24px;
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* ===== PAGE DE CONNEXION ===== */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 24px;
            background: linear-gradient(135deg, #f5f0e8 0%, #e8dfd2 50%, #f0e9de 100%);
        }

        .auth-box {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 48px;
            max-width: 440px;
            width: 100%;
            animation: slideUp 0.5s ease-out;
            border: 1px solid var(--border-light);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 36px;
        }

        .auth-header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--chocolate-dark);
            margin-bottom: 8px;
        }

        .auth-header p {
            color: var(--text-light);
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 28px;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.25s ease;
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
        }

        .auth-tab.active {
            color: white;
            background: var(--chocolate);
            box-shadow: var(--shadow-sm);
        }

        .auth-tab:hover:not(.active) {
            color: var(--chocolate);
            background: rgba(92, 58, 33, 0.08);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .auth-form .form-group {
            margin-bottom: 20px;
        }

        .auth-form .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-medium);
            font-size: 13px;
        }

        .auth-form .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 15px;
            transition: all 0.25s ease;
            background: var(--bg-input);
            color: var(--text-dark);
            font-family: 'Inter', sans-serif;
        }

        .auth-form .form-group input:focus {
            outline: none;
            border-color: var(--caramel);
            background: white;
            box-shadow: 0 0 0 4px rgba(196, 133, 61, 0.12);
        }

        .auth-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--chocolate) 0%, var(--chocolate-light) 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.25s ease;
            margin-top: 8px;
            font-family: 'Poppins', sans-serif;
            box-shadow: 0 4px 12px rgba(92, 58, 33, 0.25);
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(92, 58, 33, 0.35);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-light);
        }

        .auth-link a {
            color: var(--chocolate);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-link a:hover {
            text-decoration: underline;
        }

        /* ===== MENU UTILISATEUR ===== */
        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-button {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: var(--chocolate-dark);
            font-weight: 600;
            font-size: 14px;
            box-shadow: var(--shadow-sm);
        }

        .user-button:hover {
            background: white;
            box-shadow: var(--shadow-md);
        }

        .user-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .user-dropdown.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .user-dropdown-item {
            padding: 14px 18px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-dark);
            font-size: 14px;
            border-bottom: 1px solid var(--border-light);
        }

        .user-dropdown-item:hover {
            background: var(--bg-input);
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
            color: var(--danger);
        }

        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        /* ===== CONTAINER PRINCIPAL ===== */
        .container {
            max-width: 1440px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--chocolate-dark) 0%, var(--chocolate) 50%, var(--chocolate-light) 100%);
            color: white;
            padding: 28px 36px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(212, 168, 83, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .header-content {
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 4px;
            color: white;
        }

        .stats-bar {
            display: flex;
            justify-content: flex-start;
            gap: 48px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-family: 'Poppins', sans-serif;
            font-size: 2em;
            font-weight: 700;
            color: var(--gold);
            line-height: 1.1;
        }

        .stat-label {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 2px;
        }

        /* ===== ONGLETS ===== */
        .tabs {
            display: flex;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-light);
            flex-wrap: wrap;
            padding: 0 8px;
        }

        .tab {
            flex: 1;
            min-width: 140px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 13px;
            transition: all 0.25s ease;
            font-weight: 600;
            color: var(--text-light);
            position: relative;
            font-family: 'Inter', sans-serif;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--caramel);
            border-radius: 3px 3px 0 0;
            transition: all 0.25s ease;
        }

        .tab.active {
            color: var(--chocolate);
            background: white;
        }

        .tab.active::after {
            width: calc(100% - 24px);
        }

        .tab:hover:not(.active) {
            color: var(--chocolate);
            background: rgba(92, 58, 33, 0.04);
        }

        .tab-content {
            display: none;
            padding: 32px;
            animation: fadeIn 0.3s ease;
            background: white;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== FORMULAIRES ===== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-medium);
            font-size: 13px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.25s ease;
            background: var(--bg-input);
            color: var(--text-dark);
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--caramel);
            background: white;
            box-shadow: 0 0 0 4px rgba(196, 133, 61, 0.1);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        /* ===== BOUTONS ===== */
        .btn {
            background: linear-gradient(135deg, var(--chocolate) 0%, var(--chocolate-light) 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.25s ease;
            box-shadow: 0 4px 12px rgba(92, 58, 33, 0.2);
            margin: 4px;
            font-family: 'Poppins', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(92, 58, 33, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.25);
        }

        .btn-small {
            padding: 8px 18px;
            font-size: 12px;
        }

        /* ===== CARTES DE LOT ===== */
        .lot-card {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 22px;
            margin-bottom: 14px;
            transition: all 0.25s ease;
            box-shadow: var(--shadow-card);
        }

        .lot-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-medium);
        }

        .lot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .lot-number {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2em;
            font-weight: 700;
            color: var(--chocolate);
        }
        
        .lot-number[onclick] {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .lot-number[onclick]:hover {
            color: var(--caramel);
            text-decoration: underline;
        }

        .lot-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .lot-status {
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-production { background: var(--warning-light); color: var(--warning); }
        .status-fini { background: var(--success-light); color: var(--success); }
        .status-vendu { background: var(--info-light); color: var(--info); }
        .status-conforme { background: var(--success-light); color: var(--success); }
        .status-non-conforme { background: var(--danger-light); color: var(--danger); }

        .lot-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .detail-label {
            font-weight: 500;
            color: var(--text-light);
        }

        /* ===== RECHERCHE ET FILTRES ===== */
        .search-filters {
            background: var(--bg-elevated);
            padding: 22px;
            border-radius: var(--radius-lg);
            margin-bottom: 22px;
            border: 1px solid var(--border-light);
        }

        .search-bar {
            width: 100%;
            padding: 14px 22px;
            border: 2px solid var(--border-light);
            border-radius: 50px;
            font-size: 15px;
            margin-bottom: 14px;
            background: white;
            color: var(--text-dark);
            transition: all 0.25s ease;
            font-family: 'Inter', sans-serif;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--caramel);
            box-shadow: 0 0 0 4px rgba(196, 133, 61, 0.1);
        }

        .search-bar::placeholder {
            color: var(--text-muted);
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
        }

        /* ===== ALERTES ===== */
        .alert {
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 18px;
            font-weight: 500;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideUp 0.3s ease;
        }

        .alert-success {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid rgba(45, 138, 78, 0.2);
        }

        .alert-warning {
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid rgba(193, 127, 36, 0.2);
        }

        .alert-danger {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid rgba(196, 61, 61, 0.2);
        }

        /* ===== MODALES ===== */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(44, 24, 16, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 4% auto;
            padding: 28px;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 620px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        .close {
            color: var(--text-light);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 16px;
            transition: all 0.2s ease;
        }

        .close:hover {
            color: var(--text-dark);
        }

        .export-section {
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            padding: 22px;
            margin: 22px 0;
            border: 1px solid var(--border-light);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ===== CARTES DE R√âSUM√â ===== */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
            margin-bottom: 28px;
        }

        .summary-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-light);
            transition: all 0.25s ease;
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .summary-number {
            font-family: 'Poppins', sans-serif;
            font-size: 2.6em;
            font-weight: 700;
            color: var(--chocolate);
            margin-bottom: 6px;
            line-height: 1;
        }

        .summary-label {
            font-size: 0.95em;
            color: var(--text-light);
            font-weight: 500;
        }

        /* ===== TABLEAUX ===== */
        .table-responsive {
            overflow-x: auto;
            margin: 22px 0;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .data-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            background: white;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .data-table th {
            background: var(--chocolate);
            color: white;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table th[onclick] {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .data-table th[onclick]:hover {
            background: var(--chocolate-light);
        }

        .sort-indicator {
            margin-left: 6px;
            font-size: 12px;
            opacity: 0.6;
        }

        .sort-indicator.active {
            opacity: 1;
            color: var(--gold);
        }

        .data-table tr:nth-child(even) {
            background: var(--bg-input);
        }

        .data-table tr:hover {
            background: rgba(196, 133, 61, 0.06);
        }

        .data-table .actions-column {
            min-width: 200px;
            white-space: nowrap;
        }

        .data-table .actions-column .btn {
            margin: 2px;
            padding: 6px 12px;
            font-size: 11px;
        }

        /* ===== VALIDATION ===== */
        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: var(--danger);
            box-shadow: 0 0 0 4px rgba(196, 61, 61, 0.1);
        }

        .validation-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: 6px;
        }

        /* ===== PHOTOS ===== */
        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 14px;
        }

        .photo-item {
            position: relative;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        .photo-item img {
            width: 100%;
            height: 85px;
            object-fit: cover;
        }

        .photo-remove-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0.9;
        }

        .photo-remove-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .camera-section {
            margin-bottom: 14px;
            text-align: center;
        }

        .camera-video {
            width: 100%;
            max-width: 400px;
            border-radius: var(--radius-lg);
            background: #000;
        }

        .smart-camera-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }

        .smart-camera-video {
            width: 100%;
            max-width: 500px;
            border-radius: var(--radius-lg);
            background: #000;
        }

        .camera-grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .camera-grid-overlay::before,
        .camera-grid-overlay::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
        }

        .camera-grid-overlay::before {
            left: 33.33%;
            right: 33.33%;
            top: 0;
            bottom: 0;
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.4);
        }

        .camera-grid-overlay::after {
            top: 33.33%;
            bottom: 33.33%;
            left: 0;
            right: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
        }

        .camera-indicators {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .camera-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-input);
            transition: all 0.25s ease;
        }

        .camera-indicator.good {
            background: var(--success-light);
            color: var(--success);
        }

        .camera-indicator.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .camera-indicator.bad {
            background: var(--danger-light);
            color: var(--danger);
        }

        .indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* ===== LIGHTBOX ===== */
        .photo-lightbox {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 24, 16, 0.95);
        }

        .photo-lightbox.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .photo-lightbox-close {
            position: absolute;
            top: 20px;
            right: 28px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 40px;
            cursor: pointer;
            z-index: 10001;
            transition: all 0.2s ease;
        }

        .photo-lightbox-close:hover {
            color: var(--gold);
            transform: scale(1.1);
        }

        .photo-lightbox-content {
            max-width: 90%;
            max-height: 80vh;
            text-align: center;
        }

        .photo-lightbox-content img {
            max-width: 100%;
            max-height: 75vh;
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            cursor: zoom-in;
            transition: all 0.3s ease;
        }

        .photo-lightbox-content img.zoomed {
            max-width: none;
            max-height: none;
            cursor: grab;
            transform-origin: 0 0;
        }

        .photo-lightbox-content img.zoomed:active {
            cursor: grabbing;
        }

        .photo-lightbox-content {
            max-width: 90%;
            max-height: 80vh;
            text-align: center;
            overflow: hidden;
            position: relative;
        }

        .photo-lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 50px;
            cursor: pointer;
            padding: 20px;
            transition: all 0.2s ease;
            user-select: none;
            z-index: 10001;
        }

        .photo-lightbox-nav:hover {
            color: var(--gold);
            transform: translateY(-50%) scale(1.15);
        }

        .photo-lightbox-prev {
            left: 20px;
        }

        .photo-lightbox-next {
            right: 20px;
        }

        .photo-lightbox-info {
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            margin-top: 18px;
            font-size: 15px;
        }

        .photo-lightbox-info strong {
            color: var(--gold);
        }

        .photo-lightbox-counter {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 22px;
            border-radius: 50px;
            margin-top: 10px;
            display: inline-block;
        }

        .photo-lightbox-zoom-hint {
            color: rgba(255, 255, 255, 0.5);
            font-size: 13px;
            margin-top: 10px;
        }

        .photo-lightbox-toolbar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .photo-lightbox-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .photo-lightbox-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
        }

        .photo-lightbox-btn.active {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .photo-lightbox-content img {
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .photo-lightbox-content img.sharpened {
            filter: contrast(1.1) saturate(1.1);
            image-rendering: -webkit-optimize-contrast;
        }

        /* ===== INGR√âDIENTS ===== */
        .ingredients-section {
            margin-top: 24px;
            padding: 22px;
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--border-medium);
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: white;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            border-left: 4px solid var(--caramel);
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .ingredient-item:hover {
            transform: translateX(6px);
            box-shadow: var(--shadow-card);
        }

        .ingredient-badge {
            display: inline-block;
            margin: 2px 5px 2px 0;
            padding: 4px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 50px;
            font-size: 12px;
            color: var(--text-medium);
        }

        .ingredients-total {
            margin-top: 14px;
            padding: 12px 16px;
            background: white;
            border-radius: var(--radius-md);
            font-weight: 700;
            color: var(--chocolate);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
        }

        .ingredients-empty {
            text-align: center;
            color: var(--text-light);
            padding: 26px;
            font-style: italic;
            background: white;
            border-radius: var(--radius-md);
            border: 1px dashed var(--border-medium);
        }

        .lot-ingredients-display {
            margin-top: 14px;
            padding: 14px;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }

        .lot-ingredients-title {
            color: var(--chocolate);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .auto-calculated {
            background-color: var(--success-light) !important;
            border-color: rgba(45, 138, 78, 0.3) !important;
        }

        .auto-calculated:focus {
            box-shadow: 0 0 0 4px rgba(45, 138, 78, 0.15) !important;
        }

        .dlc-info {
            font-size: 12px;
            margin-top: 6px;
            padding: 4px 10px;
            border-radius: 50px;
            background: var(--bg-input);
            border: 1px solid var(--border-light);
        }

        .dlc-calculated {
            background: var(--success-light) !important;
            border-color: rgba(45, 138, 78, 0.3) !important;
            color: var(--success) !important;
        }

        .dlc-manual {
            background: var(--warning-light) !important;
            border-color: rgba(193, 127, 36, 0.3) !important;
            color: var(--warning) !important;
        }

        .reception-card {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 22px;
            margin-bottom: 14px;
            transition: all 0.25s ease;
            box-shadow: var(--shadow-card);
        }

        .reception-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .stats-bar {
                gap: 24px;
            }
            
            .stat-number {
                font-size: 1.6em;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                min-width: 115px;
                padding: 14px 10px;
                font-size: 11px;
            }
            
            .tab-content {
                padding: 18px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .lot-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .lot-details {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .summary-number {
                font-size: 1.8em;
            }
            
            .modal-content {
                margin: 2% auto;
                width: 95%;
                padding: 18px;
                max-height: 90vh;
            }
            
            .photo-preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            }
            
            .photo-item img {
                height: 65px;
            }
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--chocolate-light);
        }

        /* ===== SELECTION ===== */
        ::selection {
            background: var(--caramel);
            color: white;
        }

        /* ===== √âTIQUETTES BROTHER TD-4550 ===== */
        .label-printable {
            background: white;
            border: 3px solid #000;
            padding: 15px;
            margin: 0 auto;
        }
        
        .label-size-a5 { width: 148mm; max-width: 148mm; }
        .label-size-a6 { width: 105mm; max-width: 105mm; }
        .label-size-a4 { width: 210mm; max-width: 210mm; }
        .label-size-brother-50x23 { 
            width: 50mm; 
            max-width: 50mm; 
            height: 23mm; 
            max-height: 23mm; 
            padding: 1mm 1mm 1mm 3mm !important; 
            border: none; 
            overflow: hidden;
            box-sizing: border-box;
        }
        .label-size-brother-62x29 { width: 62mm; max-width: 62mm; min-height: 29mm; padding: 6px; }
        .label-size-brother-62x51 { width: 62mm; max-width: 62mm; min-height: 51mm; padding: 8px; }
        .label-size-brother-102x51 { width: 102mm; max-width: 102mm; min-height: 51mm; padding: 12px; }
        
        /* Format 50x23mm - Sans QR code, optimis√© impression thermique */
        .label-size-brother-50x23 .label-simple-layout { 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start;
            height: 100%;
            gap: 0;
        }
        .label-size-brother-50x23 .label-simple-header { 
            border: none; 
            padding: 0; 
            display: flex; 
            flex-direction: column;
            gap: 0;
            width: 100%;
        }
        .label-size-brother-50x23 .label-simple-info { 
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .label-size-brother-50x23 .label-simple-qr { 
            display: none !important;
        }
        .label-size-brother-50x23 .label-simple-product { 
            font-size: 14px; 
            line-height: 1.2; 
            font-weight: 900; 
            margin: 0;
            padding: 0.5mm 0 1.5mm 0;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #000;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .label-size-brother-50x23 .label-simple-lot { 
            font-size: 14px; 
            font-weight: 900; 
            margin: 0; 
            padding: 0.5mm 2mm; 
            background: white; 
            color: #000; 
            display: block;
            text-align: center;
            border: 2px solid #000;
        }
        .label-size-brother-50x23 .label-simple-dlc { 
            padding: 0.5mm 2mm; 
            border: 2px solid #000; 
            display: block;
            text-align: center;
            background: white;
            color: black;
            margin: 0;
            margin-top: 0.5mm;
        }
        .label-size-brother-50x23 .dlc-simple-label { 
            font-size: 11px; 
            font-weight: 900; 
        }
        .label-size-brother-50x23 .dlc-simple-date { 
            font-size: 14px; 
            font-weight: 900; 
        }
        .label-size-brother-50x23 .qr-code-img { 
            display: none !important;
        }
        .label-size-brother-50x23 .label-simple-title { display: none; }
        .label-size-brother-50x23 .label-ingredients-simple { display: none; }
        
        @media print {
            .label-size-brother-50x23 {
                width: 50mm !important;
                height: 23mm !important;
                max-height: 23mm !important;
                padding: 1mm !important;
                margin: 0 !important;
                border: none !important;
                page-break-inside: avoid;
            }
            @page {
                size: 50mm 23mm;
                margin: 0;
            }
        }

        /* Sections repliables */
        .config-section-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 8px 0;
        }
        .config-section-header:hover { opacity: 0.8; }
        .config-section-header .toggle-arrow {
            display: inline-block;
            width: 20px;
            font-size: 14px;
            transition: transform 0.2s ease;
            color: #8B4513;
            margin-right: 8px;
        }
        .config-section-header.collapsed .toggle-arrow {
            transform: rotate(-90deg);
        }
        .config-section-body {
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        .config-section-body.collapsed {
            max-height: 0 !important;
            overflow: hidden;
            opacity: 0;
            padding: 0 !important;
            margin: 0 !important;
        }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="auth-container" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1>üç´ Syst√®me de Tra√ßabilit√©</h1>
                <p>Gestion compl√®te des lots de production chocolati√®re</p>
            </div>

            <!-- Formulaire de connexion -->
            <div id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="votre@email.com" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Mot de passe</label>
                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="button" class="auth-btn" id="login-btn" onclick="handleLogin()">
                    üîê Se connecter
                </button>
                <div class="auth-link">
                    <a href="#" onclick="handleForgotPassword(); return false;">Mot de passe oubli√© ?</a>
                </div>
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                    <p style="font-size: 14px; color: #666;">Pas encore de compte ?</p>
                    <a href="#" onclick="toggleAuthForm('signup'); return false;" style="font-size: 16px; font-weight: 700; color: #8B4513; text-decoration: none;">Cr√©er un compte gratuitement ‚Üí</a>
                </div>
            </div>

            <!-- Formulaire d'inscription -->
            <div id="signup-form" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="votre@email.com" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Mot de passe</label>
                    <input type="password" id="signup-password" placeholder="Minimum 6 caract√®res" required>
                </div>
                <div class="form-group">
                    <label for="signup-password-confirm">Confirmer le mot de passe</label>
                    <input type="password" id="signup-password-confirm" placeholder="Confirmez votre mot de passe" required>
                </div>
                <button type="button" class="auth-btn" id="signup-btn" onclick="handleSignup()" style="background: linear-gradient(135deg, #d4a843, #ffd700); color: #1a0e05;">
                    ‚ú® Cr√©er mon compte
                </button>
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                    <p style="font-size: 14px; color: #666;">D√©j√† un compte ?</p>
                    <a href="#" onclick="toggleAuthForm('login'); return false;" style="font-size: 16px; font-weight: 700; color: #8B4513; text-decoration: none;">‚Üê Se connecter</a>
                </div>
            </div>
            
            <!-- Copyright -->
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                <p style="font-size: 12px; color: #888; margin: 0;">
                    ¬© 2026 <strong style="color: #8B4513;">Emotions Chocolats</strong> ¬Æ
                </p>
                <p style="font-size: 11px; color: #aaa; margin-top: 5px;">
                    Chocolaterie artisanale belge
                </p>
            </div>
        </div>
    </div>

    <!-- Application principale -->
    <!-- PAYWALL -->
    <div id="paywall-container" style="display: none; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1a0e05 0%, #3b1f0b 50%, #5d3a1a 100%); padding: 20px;">
        <div style="background: white; border-radius: 24px; padding: 50px 40px; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="font-size: 60px; margin-bottom: 16px;">üç´</div>
            <h1 style="font-family: Georgia, serif; font-size: 32px; color: #1a0e05; margin-bottom: 8px;">TRACACHOC <span style="color: #d4a843;">Pro</span></h1>
            <p style="color: #8b4513; font-size: 16px; margin-bottom: 32px; line-height: 1.6;">
                Acc√©dez √† toutes les fonctionnalit√©s de tra√ßabilit√© pour votre chocolaterie artisanale.
            </p>
            
            <div style="background: linear-gradient(135deg, #fdf6e3 0%, #f5e6c8 100%); border-radius: 16px; padding: 24px; margin-bottom: 28px; border: 2px solid #d4a843;">
                <div style="font-family: Georgia, serif; font-size: 48px; font-weight: 900; color: #1a0e05;">39‚Ç¨ <span style="font-size: 18px; color: #8b4513; font-weight: 400;">/mois</span></div>
                <div style="color: #8b4513; font-size: 14px; margin-top: 8px;">Essai gratuit 30 jours ‚Ä¢ Annulation √† tout moment</div>
            </div>
            
            <ul style="text-align: left; list-style: none; padding: 0; margin-bottom: 32px;">
                <li style="padding: 8px 0; font-size: 15px; color: #2c1810;">‚úì Lots illimit√©s</li>
                <li style="padding: 8px 0; font-size: 15px; color: #2c1810;">‚úì Recettes illimit√©es</li>
                <li style="padding: 8px 0; font-size: 15px; color: #2c1810;">‚úì √âtiquetage & impression</li>
                <li style="padding: 8px 0; font-size: 15px; color: #2c1810;">‚úì Bo√Ætes mixtes & FIFO</li>
                <li style="padding: 8px 0; font-size: 15px; color: #2c1810;">‚úì Statistiques & rapports PDF</li>
                <li style="padding: 8px 0; font-size: 15px; color: #2c1810;">‚úì Support prioritaire</li>
            </ul>
            
            <button id="subscribe-btn" onclick="startSubscription()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #d4a843, #ffd700); color: #1a0e05; border: none; border-radius: 50px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,168,67,0.4);">
                üí≥ S'abonner - 39‚Ç¨/mois
            </button>
            
            <p style="margin-top: 16px; font-size: 12px; color: #999;">
                Paiement s√©curis√© via Mollie ‚Ä¢ Bancontact, Visa, Mastercard
            </p>
            
            <button onclick="handleLogout()" style="margin-top: 20px; background: none; border: none; color: #8b4513; cursor: pointer; font-size: 14px; text-decoration: underline;">
                Se d√©connecter
            </button>
        </div>
    </div>

    <div id="app-container" class="app-container">
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1;">
                        <h1>üç´ Syst√®me de Tra√ßabilit√©</h1>
                        <p>Gestion compl√®te des lots de production chocolati√®re</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div id="connection-status" style="font-size: 14px; font-weight: 600;">
                            üü¢ Connect√© Supabase
                        </div>
                        <button class="btn btn-small" onclick="syncAllData()" style="font-size: 13px; padding: 8px 16px;">
                            üîÑ Synchroniser
                        </button>
                        <div class="user-menu">
                            <button class="user-button" onclick="toggleUserMenu()">
                                <span>üë§</span>
                                <span id="user-email">Utilisateur</span>
                                <span>‚ñº</span>
                            </button>
                            <div class="user-dropdown" id="user-dropdown">
                                <div class="user-dropdown-item" style="border-bottom: 1px solid #e9ecef; font-weight: 600;">
                                    <div style="font-size: 12px; color: #666;">Connect√© en tant que</div>
                                    <div id="user-email-dropdown" style="margin-top: 4px;">-</div>
                                </div>
                                <div class="user-dropdown-item" onclick="handleLogout()">
                                    üö™ D√©connexion
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-number" id="stat-lots-total">0</div>
                        <div class="stat-label">Lots Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-lots-production">0</div>
                        <div class="stat-label">En Production</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-lots-finis">0</div>
                        <div class="stat-label">Termin√©s</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-production-mois">0</div>
                        <div class="stat-label">kg ce mois</div>
                    </div>
                </div>
                
                <!-- Copyright -->
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); text-align: center;">
                    <span style="font-size: 11px; color: rgba(255,255,255,0.7);">
                        ¬© 2026 <strong style="color: #FFD700;">Emotions Chocolats</strong> ¬Æ ‚Äî Chocolaterie artisanale belge
                    </span>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">Tableau de Bord</button>
            <button class="tab" onclick="showTab('nouveau-lot')">Nouveau Lot</button>
            <button class="tab" onclick="showTab('consulter-lots')">Consulter Lots</button>
            <button class="tab" onclick="showTab('inventaire')">Inventaire</button>
            <button class="tab" onclick="showTab('reception-marchandises')">R√©ception Marchandises</button>
            <button class="tab" onclick="showTab('matieres-premieres')">Mati√®res Premi√®res</button>
            <button class="tab" onclick="showTab('recettes')">üß™ Recettes</button>
            <button class="tab" onclick="showTab('configuration')">Configuration</button>
            <button class="tab" onclick="showTab('rapports')">Rapports</button>
            <button class="tab" id="admin-tab-btn" onclick="showTab('admin')" style="display:none; background: linear-gradient(135deg, #d4a843, #ffd700); color: #1a0e05;">üëë Admin</button>
            <button class="tab" onclick="showTab('archives')">üì¶ Archives</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <h2>Tableau de Bord</h2>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-number" id="dashboard-lots-semaine">0</div>
                    <div class="summary-label">Lots cette semaine</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="dashboard-kg-semaine">0</div>
                    <div class="summary-label">kg produits cette semaine</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="dashboard-produits-populaires">-</div>
                    <div class="summary-label">Produit le plus produit</div>
                </div>
            </div>

            <div class="export-section">
                <h3>üíæ Sauvegarde et Gestion des Donn√©es</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    La sauvegarde compl√®te inclut <strong>TOUS les modules</strong> de l'application :
                    lots de production, mati√®res premi√®res, r√©ceptions, contr√¥les qualit√©, configuration des produits et param√®tres.
                </p>
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="saveCompleteBackup()">üíæ Sauvegarde Compl√®te</button>
                    <button class="btn btn-secondary" onclick="loadBackupFile()">üìÇ Charger Sauvegarde</button>
                    <button class="btn" onclick="exportData('csv')">üìä Export CSV (Lots uniquement)</button>
                    <button class="btn btn-secondary" onclick="clearAllData()">üóëÔ∏è Effacer Tout</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 13px; border-left: 4px solid #2196F3;">
                    <strong style="color: #1976d2;">üìã Contenu de la sauvegarde compl√®te :</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li><strong>Lots de production</strong> avec tous leurs d√©tails et ingr√©dients</li>
                        <li><strong>Mati√®res premi√®res</strong> avec stocks et informations fournisseurs</li>
                        <li><strong>R√©ceptions de marchandises</strong> incluant les photos</li>
                        <li><strong>Contr√¥les qualit√©</strong> et historique complet</li>
                        <li><strong>Configuration des produits</strong> personnalis√©s</li>
                        <li><strong>Configuration des cat√©gories</strong> de mati√®res premi√®res</li>
                        <li><strong>Param√®tres g√©n√©raux</strong> de l'application</li>
                    </ul>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 12px; border-left: 4px solid #ffc107;">
                    <strong>üí° Conseil :</strong> Effectuez une sauvegarde r√©guli√®re (hebdomadaire recommand√©) pour prot√©ger vos donn√©es !
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; font-size: 12px; border-left: 4px solid #2196F3;">
                    <strong>‚ÑπÔ∏è Note :</strong> Les photos des r√©ceptions sont sauvegard√©es uniquement dans Supabase (cloud) pour √©conomiser l'espace de stockage local.
                </div>
            </div>

            <h3>Derniers Lots Cr√©√©s</h3>
            <div id="recent-lots-container">
                <!-- Les lots r√©cents seront affich√©s ici -->
            </div>

            <h3>Alertes et Notifications</h3>
            <div id="alerts-container">
                <!-- Les alertes seront affich√©es ici -->
            </div>
        </div>

        <!-- Nouveau Lot -->
        <div id="nouveau-lot" class="tab-content">
            <h2>Cr√©ation d'un Nouveau Lot</h2>
            
            <div id="nouveau-lot-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="numero-lot">Num√©ro de Lot *</label>
                        <input type="text" id="numero-lot" required placeholder="Ex: 2025-001" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; font-weight: 600;">
                    </div>
                    
                    <div class="form-group">
                        <label for="produit">Produit *</label>
                        <select id="produit" required onchange="calculateDLC(); updateQuantityMode();" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800; font-weight: 500; color: #e65100;">
                            <option value="">S√©lectionner un produit</option>
                        </select>
                        <input type="text" id="produit-mixte" placeholder="Ex: Coffret D√©couverte 12 pcs" style="display: none; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800; font-weight: 500; color: #e65100;">
                    </div>

                    <div class="form-group">
                        <label for="date-production">Date de Production *</label>
                        <input type="date" id="date-production" required onchange="calculateDLC()" style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); border: 2px solid #e91e63;">
                    </div>

                    <!-- Mode de saisie quantit√© -->
                    <div class="form-group">
                        <label>Mode de Saisie de la Quantit√© *</label>
                        <div style="display: flex; gap: 15px; margin-top: 8px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; background: #e8f5e9; border-radius: 8px; border: 2px solid #4caf50; flex: 1; min-width: 140px;">
                                <input type="radio" name="mode-quantite" value="recette" checked onchange="toggleQuantityMode()">
                                <span style="font-weight: 600; color: #2e7d32;">üß™ Par Recette</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; background: #f5f5f5; border-radius: 8px; border: 2px solid #9e9e9e; flex: 1; min-width: 140px;">
                                <input type="radio" name="mode-quantite" value="manuel" onchange="toggleQuantityMode()">
                                <span style="font-weight: 500; color: #616161;">‚úèÔ∏è Manuel</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; background: #f5f5f5; border-radius: 8px; border: 2px solid #9e9e9e; flex: 1; min-width: 140px;">
                                <input type="radio" name="mode-quantite" value="mixte" onchange="toggleQuantityMode()">
                                <span style="font-weight: 500; color: #616161;">üì¶ Bo√Æte Mixte</span>
                            </label>
                        </div>
                    </div>

                    <!-- Mode Recette -->
                    <div id="mode-recette-container" class="form-group">
                        <label for="nombre-recettes">Nombre de Recettes *</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="nombre-recettes" step="0.1" min="0.1" placeholder="Ex: 1.5" style="flex: 1; font-size: 18px; font-weight: bold; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;" oninput="calculateFromRecipe()">
                            <span style="font-size: 24px; color: #666;">√ó</span>
                            <div id="recette-base-info" style="flex: 2; padding: 12px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: 8px; border: 2px solid #9c27b0; text-align: center;">
                                <span style="color: #7b1fa2; font-weight: 600;">S√©lectionnez un produit</span>
                            </div>
                        </div>
                        <div id="recette-calcul-result" style="margin-top: 10px; padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; border: 2px solid #4caf50; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <span style="font-size: 13px; color: #2e7d32;">Quantit√© totale :</span>
                                    <span id="recette-quantite-totale" style="font-size: 20px; font-weight: bold; color: #1b5e20; margin-left: 8px;">-</span>
                                </div>
                            </div>
                        </div>
                        <div id="recette-no-recipe-warning" style="display: none; margin-top: 10px; padding: 12px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800; color: #e65100; font-size: 13px;">
                            ‚ö†Ô∏è Aucune recette configur√©e pour ce produit. <a href="#" onclick="showTab('recettes'); return false;" style="color: #e65100; font-weight: bold;">Cr√©er une recette</a> ou utilisez le mode manuel.
                        </div>
                    </div>

                    <!-- Mode Manuel -->
                    <div id="mode-manuel-container" class="form-group" style="display: none;">
                        <label for="quantite">Quantit√© Produite *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="quantite" step="1" placeholder="Ex: 500" min="1" style="flex: 2; background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #00bcd4; font-weight: 600;" oninput="updateIngredientsDisplay()">
                            <select id="unite" style="flex: 1; background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #00bcd4;" onchange="updateIngredientsDisplay()">
                                <option value="g">grammes</option>
                                <option value="kg">kg</option>
                                <option value="pieces">pi√®ces</option>
                            </select>
                        </div>
                    </div>

                    <!-- Mode Bo√Æte Mixte -->
                    <div id="mode-mixte-container" class="form-group" style="display: none;">
                        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 10px; border: 2px solid #ff9800; margin-bottom: 15px;">
                            <p style="color: #e65100; font-weight: 600; margin: 0 0 8px 0;">üì¶ Mode Bo√Æte Mixte</p>
                            <p style="color: #666; font-size: 12px; margin: 0;">Assemblez plusieurs lots existants (pralines, tablettes...) dans une bo√Æte. Les stocks seront automatiquement d√©duits des lots sources.</p>
                        </div>
                        
                        <!-- S√©lection des produits pour la bo√Æte mixte -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #5d4037; margin-bottom: 10px; display: block;">S√©lectionner les produits √† inclure</label>
                            <div id="mixte-products-list" style="max-height: 400px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 10px; background: #fafafa;">
                                <!-- Rempli dynamiquement -->
                                <div style="text-align: center; color: #999; padding: 20px;">Chargement...</div>
                            </div>
                        </div>
                        
                        <!-- R√©sum√© bo√Æte mixte -->
                        <div id="mixte-summary" style="display: none; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; border: 2px solid #4caf50;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div>
                                    <span style="font-size: 13px; color: #2e7d32;">üì¶ Lots sources :</span>
                                    <span id="mixte-total-lots" style="font-size: 18px; font-weight: bold; color: #1b5e20; margin-left: 8px;">0</span>
                                </div>
                                <div>
                                    <span style="font-size: 13px; color: #2e7d32;">üç´ Pi√®ces totales :</span>
                                    <span id="mixte-total-pieces" style="font-size: 18px; font-weight: bold; color: #1b5e20; margin-left: 8px;">0</span>
                                </div>
                                <div>
                                    <span style="font-size: 13px; color: #2e7d32;">‚öñÔ∏è Poids total :</span>
                                    <span id="mixte-total-poids" style="font-size: 18px; font-weight: bold; color: #1b5e20; margin-left: 8px;">0 g</span>
                                </div>
                                <div>
                                    <span style="font-size: 13px; color: #2e7d32;">üí∞ Co√ªt estim√© :</span>
                                    <span id="mixte-total-cout" style="font-size: 18px; font-weight: bold; color: #1b5e20; margin-left: 8px;">0.00 ‚Ç¨</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nombre de bo√Ætes et prix -->
                        <div style="margin-top: 15px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 150px;">
                                <label for="mixte-nb-boites" style="font-weight: 600;">üì¶ Nombre de bo√Ætes</label>
                                <input type="number" id="mixte-nb-boites" step="1" min="1" value="1" placeholder="Ex: 10" oninput="updateMixteSummary()" style="width: 100%; margin-top: 5px; padding: 10px; border: 2px solid #ff9800; border-radius: 8px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); font-weight: 600; font-size: 16px; text-align: center;">
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <label for="mixte-prix-vente" style="font-weight: 600;">üí∂ Prix de vente unitaire (‚Ç¨/bo√Æte)</label>
                                <input type="number" id="mixte-prix-vente" step="0.01" min="0" placeholder="Ex: 25.00" style="width: 100%; margin-top: 5px; padding: 10px; border: 2px solid #4caf50; border-radius: 8px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); font-weight: 600;">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <input type="text" id="operateur" placeholder="Nom de l'artisan" required style="background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); border: 2px solid #673ab7;">
                    </div>

                    <div class="form-group">
                        <label for="dlc">Date Limite de Consommation</label>
                        <input type="date" id="dlc" style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border: 2px solid #f44336;">
                        <div style="font-size: 12px; margin-top: 5px; padding: 3px 8px; border-radius: 4px; background: #f8f9fa; border: 1px solid #e9ecef;">
                            <span id="dlc-info">Calcul√©e automatiquement selon le produit</span>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            üí° <strong>Tip:</strong> La DLC est calcul√©e automatiquement. Vous pouvez la modifier manuellement si n√©cessaire.
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="cout-production">Co√ªt de Production (‚Ç¨)</label>
                        <input type="number" id="cout-production" step="0.01" placeholder="Calcul√© auto ou saisie manuelle" min="0" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                            üí° En mode recette, le co√ªt est calcul√© automatiquement. Vous pouvez le modifier.
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="observations">Observations</label>
                    <textarea id="observations" rows="3" placeholder="Notes particuli√®res sur la production..." style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107;"></textarea>
                </div>

                <!-- Section Ingr√©dients -->
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); border-radius: 12px; border: 2px solid #8d6e63;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #5d4037;">üßÑ Ingr√©dients Utilis√©s</h4>
                        <div id="btn-charger-recette-container">
                            <button type="button" class="btn" onclick="loadRecipeForProduct()" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); font-size: 14px; padding: 10px 20px;">
                                üß™ Charger Recette Automatique
                            </button>
                        </div>
                    </div>
                    <p style="color: #666; margin-bottom: 15px;">S√©lectionnez les mati√®res premi√®res utilis√©es pour ce lot</p>
                    
                    <div class="form-grid" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="ingredient-select">Mati√®re Premi√®re</label>
                            <select id="ingredient-select">
                                <option value="">Choisir une mati√®re premi√®re</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="ingredient-quantity">Quantit√© Utilis√©e</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="ingredient-quantity" step="0.001" min="0.001" placeholder="Ex: 500" style="flex: 2;">
                                <select id="ingredient-quantity-unite" style="flex: 1;">
                                    <option value="g">grammes</option>
                                    <option value="kg">kg</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="display: flex; align-items: end; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="addIngredient()">‚ûï Ajouter</button>
                            <button type="button" class="btn btn-danger btn-small" onclick="clearIngredients()">üóëÔ∏è Effacer Tout</button>
                        </div>
                    </div>
                    
                    <!-- Liste des ingr√©dients ajout√©s -->
                    <div id="ingredients-list" style="margin-top: 15px;">
                        <div id="ingredients-empty" style="text-align: center; color: #666; padding: 20px; font-style: italic;">
                            Aucun ingr√©dient ajout√©
                        </div>
                    </div>
                    
                    <div id="ingredients-total" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; display: none; border: 2px solid #dee2e6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div style="font-weight: bold; color: #8B4513;">
                                üì¶ Total ingr√©dients : <span id="total-ingredients-weight" style="font-size: 18px;">0</span>
                            </div>
                            <div style="font-weight: bold; color: #2e7d32; background: #e8f5e9; padding: 8px 15px; border-radius: 8px; border: 2px solid #4caf50;">
                                üí∞ Co√ªt production : <span id="total-ingredients-cout" style="font-size: 18px;">0.00 ‚Ç¨</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="button" class="btn" onclick="createNewLot()">‚úÖ Cr√©er le Lot</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
                </div>
            </div>
        </div>

        <!-- Consulter Lots -->
        <div id="consulter-lots" class="tab-content">
            <h2>Consultation des Lots</h2>
            
            <div class="search-filters" style="background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%); padding: 20px; border-radius: 12px; border: 2px solid #e0e0e0;">
                <input type="text" class="search-bar" id="search-lots" placeholder="üîç Rechercher par n¬∞ lot, produit, op√©rateur, fournisseur, lot fournisseur..." style="background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%); border: 2px solid #9e9e9e;">
                
                <div class="filters-row">
                    <div class="form-group">
                        <label for="filter-produit">Filtrer par Produit</label>
                        <select id="filter-produit" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800;">
                            <option value="">Tous les produits</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-statut">Filtrer par Statut</label>
                        <select id="filter-statut" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
                            <option value="">Tous les statuts</option>
                            <option value="fini">Termin√©</option>
                            <option value="production">En Production</option>
                            <option value="vendu">Vendu</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-date-debut">Date de D√©but</label>
                        <input type="date" id="filter-date-debut" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3;">
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-date-fin">Date de Fin</label>
                        <input type="date" id="filter-date-fin" style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); border: 2px solid #e91e63;">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Effacer Filtres</button>
                    <button class="btn" onclick="applyLotsFilters()">üîç Appliquer Filtres</button>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <span id="lots-count">0 lot(s) trouv√©(s)</span>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-small" onclick="openTraceabilityModule()" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); font-weight: bold;">
                        üîç Tra√ßabilit√© Inverse (Rappel)
                    </button>
                    <select id="sort-by" style="background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); border: 2px solid #673ab7;">
                        <option value="date-desc">Date (plus r√©cent)</option>
                        <option value="date-asc">Date (plus ancien)</option>
                        <option value="numero-asc">Num√©ro (A-Z)</option>
                        <option value="numero-desc">Num√©ro (Z-A)</option>
                        <option value="quantite-desc">Quantit√© (plus important)</option>
                        <option value="quantite-asc">Quantit√© (plus petit)</option>
                    </select>
                    <button class="btn btn-small" onclick="applySorting()">Trier</button>
                    <button class="btn btn-small btn-success" onclick="printLotsHistory()">üñ®Ô∏è Imprimer PDF</button>
                </div>
            </div>
            
            <div id="lots-container">
                <!-- Les lots seront affich√©s ici dynamiquement -->
            </div>
        </div>

        <!-- Inventaire -->
        <div id="inventaire" class="tab-content">
            <h2>üì¶ Inventaire des Mati√®res Premi√®res</h2>
            
            <div id="inventaire-alerts-container">
                <!-- Les alertes de stock seront affich√©es ici -->
            </div>
            
            <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-number" id="inventaire-total-mp">0</div>
                            <div class="summary-label">Mati√®res Premi√®res</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-number" id="inventaire-stock-total">0</div>
                            <div class="summary-label">Stock Total (kg)</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-number" id="inventaire-valeur-totale">0</div>
                            <div class="summary-label">Valeur Totale (‚Ç¨)</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-number" id="inventaire-alertes">0</div>
                            <div class="summary-label">Alertes Stock</div>
                        </div>
            </div>
            
            <div class="search-filters" style="margin-bottom: 20px;">
                <input type="text" class="search-bar" id="search-inventaire" placeholder="üîç Rechercher par nom, lot, fournisseur...">
                
                <div class="filters-row">
                    <div class="form-group">
                        <label for="filter-inventaire-categorie">Filtrer par Cat√©gorie</label>
                        <select id="filter-inventaire-categorie" onchange="applyInventaireFilters()">
                            <option value="">Toutes les cat√©gories</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-inventaire-stock">Filtrer par Niveau de Stock</label>
                        <select id="filter-inventaire-stock" onchange="applyInventaireFilters()">
                            <option value="">Tous</option>
                            <option value="critique">üî¥ Critique (‚â§ Stock mini)</option>
                            <option value="faible">üü† Faible (‚â§ 1.5x Stock mini)</option>
                            <option value="ok">üü¢ OK</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sort-inventaire">Trier par</label>
                        <select id="sort-inventaire" onchange="applyInventaireFilters()">
                            <option value="nom-asc">Nom (A-Z)</option>
                            <option value="nom-desc">Nom (Z-A)</option>
                            <option value="stock-desc">Stock (Plus √©lev√©)</option>
                            <option value="stock-asc">Stock (Plus faible)</option>
                            <option value="valeur-desc">Valeur (Plus √©lev√©)</option>
                            <option value="dlc-asc">DLC (Plus proche)</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="clearInventaireFilters()">üóëÔ∏è Effacer Filtres</button>
                    <button class="btn" onclick="exportInventairePDF()">üì• Exporter Inventaire (PDF)</button>
                    <button class="btn btn-success" onclick="printInventaire()">üñ®Ô∏è Imprimer Inventaire</button>
                    <button class="btn btn-danger" onclick="showLossesHistory()">‚ö†Ô∏è Historique des Pertes</button>
                    <button class="btn btn-secondary" onclick="reloadLossesFromSupabase()" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">üîÑ Recharger Pertes</button>
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <div id="header-inv-table" class="config-section-header" onclick="toggleConfigSection('inv-table')">
                    <span class="toggle-arrow">‚ñº</span>
                    <h3 style="margin:0; font-size: 16px;">üìã D√©tail du stock</h3>
                </div>
                <div id="body-inv-table" class="config-section-body">
            <div class="table-responsive">
                <table class="data-table" id="inventaire-table">
                    <thead>
                        <tr>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('categorie')" title="Cliquer pour trier">
                                Cat√©gorie <span class="sort-indicator" id="sort-inv-categorie">‚áÖ</span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('nom')" title="Cliquer pour trier">
                                Mati√®re Premi√®re <span class="sort-indicator" id="sort-inv-nom">‚áÖ</span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('lot')" title="Cliquer pour trier">
                                Lot Fournisseur <span class="sort-indicator" id="sort-inv-lot">‚áÖ</span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('fournisseur')" title="Cliquer pour trier">
                                Fournisseur <span class="sort-indicator" id="sort-inv-fournisseur">‚áÖ</span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('stock')" title="Cliquer pour trier">
                                Stock Actuel <span class="sort-indicator" id="sort-inv-stock">‚áÖ</span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('stockMini')" title="Cliquer pour trier">
                                Stock Mini <span class="sort-indicator" id="sort-inv-stockMini">‚áÖ</span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('cout')" title="Cliquer pour trier">
                                Co√ªt (‚Ç¨/kg) <span class="sort-indicator" id="sort-inv-cout">‚áÖ</span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('valeur')" title="Cliquer pour trier">
                                Valeur (‚Ç¨) <span class="sort-indicator" id="sort-inv-valeur">‚áÖ</span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('dlc')" title="Cliquer pour trier">
                                DLC <span class="sort-indicator" id="sort-inv-dlc">‚áÖ</span>
                            </th>
                            <th style="cursor: pointer; user-select: none;" onclick="sortInventaireTable('statut')" title="Cliquer pour trier">
                                Statut <span class="sort-indicator" id="sort-inv-statut">‚áÖ</span>
                            </th>
                            <th class="actions-column" style="min-width: 280px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- L'inventaire sera affich√© ici -->
                    </tbody>
                    <tfoot>
                        <tr style="background: #f8f9fa; font-weight: bold;">
                            <td colspan="4" style="text-align: right;">TOTAL :</td>
                            <td id="inventaire-total-stock-footer">0 kg</td>
                            <td></td>
                            <td></td>
                            <td id="inventaire-total-valeur-footer">0 ‚Ç¨</td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
                </div>
            </div>
        </div>

        <!-- Modal de modification du prix -->
        <div id="price-modal" class="modal">
            <div class="modal-content" onclick="event.stopPropagation();">
                <span class="close" onclick="closePriceModal()">&times;</span>
                <h2>Modifier le Prix</h2>
                <div id="price-form">
                    <input type="hidden" id="price-mp-id">
                    
                    <div class="form-group">
                        <label id="price-mp-name">Mati√®re Premi√®re</label>
                        <p><strong id="price-mp-lot">Lot: </strong></p>
                    </div>
                    
                    <div class="form-group">
                        <label>Prix actuel</label>
                        <p id="price-current">0 ‚Ç¨/kg</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="price-new">Nouveau Prix (‚Ç¨/kg) *</label>
                        <input type="number" id="price-new" step="0.01" min="0" placeholder="Ex: 12.50" required>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn" onclick="savePriceUpdate()">üíæ Enregistrer</button>
                        <button type="button" class="btn btn-secondary" onclick="closePriceModal()">‚ùå Annuler</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- R√©ception Marchandises -->
        <div id="reception-marchandises" class="tab-content">
            <h2>üì¶ R√©ception de Marchandises</h2>
            
            <div id="reception-form" style="background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #e0e0e0;">
                <h3 style="color: #5d4037;">üöõ Nouvelle R√©ception</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="reception-date">Date de R√©ception *</label>
                        <input type="date" id="reception-date" required style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reception-heure">Heure de R√©ception *</label>
                        <input type="time" id="reception-heure" required style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reception-bon-livraison">N¬∞ Bon de Livraison *</label>
                        <input type="text" id="reception-bon-livraison" placeholder="Ex: BL-2024-001" required style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800; font-weight: 600;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reception-fournisseur">Fournisseur *</label>
                        <input type="text" id="reception-fournisseur" placeholder="Nom du fournisseur" required style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #9c27b0;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reception-temperature">Temp√©rature Camion (¬∞C)</label>
                        <input type="number" id="reception-temperature" step="0.1" placeholder="Ex: 18.5" style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #00bcd4;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reception-commentaires">Commentaires</label>
                    <textarea id="reception-commentaires" rows="3" placeholder="√âtat de la marchandise, conditions de transport, observations..." style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107;"></textarea>
                </div>
                
                <!-- Section Produits √† R√©ceptionner -->
<div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; border: 2px solid #4caf50;">
                    <h4 style="color: #2e7d32; margin-bottom: 15px;">üì¶ Produits √† R√©ceptionner</h4>
                    
                    <div class="form-grid" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="reception-mp-nom">Nom de la Mati√®re Premi√®re *</label>
                            <select id="reception-mp-nom-select" onchange="onReceptionMPRefSelect(this)" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800;">
                                <option value="">-- S√©lectionner une MP --</option>
                                <option value="__custom__">‚úèÔ∏è Saisie libre...</option>
                            </select>
                            <input type="text" id="reception-mp-nom" placeholder="Tapez le nom de la MP" style="display: none; margin-top: 8px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800;">
                        </div>
                        
                        <div class="form-group">
                            <label for="reception-mp-categorie">Cat√©gorie *</label>
                            <select id="reception-mp-categorie" style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107;">
                                <option value="">S√©lectionner une cat√©gorie</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="reception-mp-lot">Num√©ro de Lot Fournisseur *</label>
                            <input type="text" id="reception-mp-lot" placeholder="Ex: VEN-2024-03" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3;">
                        </div>
                        
                        <div class="form-group">
                            <label for="reception-mp-fournisseur">Fournisseur *</label>
                            <input type="text" id="reception-mp-fournisseur" placeholder="Nom du fournisseur" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #9c27b0;">
                        </div>
                    </div>
                    
                    <div class="form-grid" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="reception-mp-date-reception">Date de R√©ception *</label>
                            <input type="date" id="reception-mp-date-reception" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
                        </div>
                        
                        <div class="form-group">
                            <label for="reception-mp-dlc">Date Limite de Consommation</label>
                            <input type="date" id="reception-mp-dlc" style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border: 2px solid #f44336;">
                        </div>
                        
                        <div class="form-group">
                            <label for="reception-mp-quantite">Quantit√© Re√ßue (g) *</label>
                            <input type="number" id="reception-mp-quantite" step="1" min="0" placeholder="Ex: 10500" style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #00bcd4;">
                        </div>
                        
                        <div class="form-group">
                            <label for="reception-mp-prix">Co√ªt Unitaire (‚Ç¨/kg)</label>
                            <input type="number" id="reception-mp-prix" step="0.01" min="0" placeholder="Ex: 5.50" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
                        </div>
                    </div>
                    
                    <div class="form-grid" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="reception-mp-stock-mini">Stock Minimum (g)</label>
                            <input type="number" id="reception-mp-stock-mini" step="1" min="0" placeholder="Seuil d'alerte" style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107;">
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="addReceptionItem()" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); padding: 12px 30px; font-size: 16px; font-weight: bold;">
                            ‚ûï Ajouter cette Mati√®re Premi√®re
                        </button>
                    </div>
                    
                    <!-- Liste des produits ajout√©s -->
                    <div id="reception-items-list" style="margin-top: 20px;">
                        <p id="reception-items-empty" style="color: #666; text-align: center; padding: 20px;">Aucun produit ajout√©. Remplissez le formulaire ci-dessus pour ajouter des mati√®res premi√®res.</p>
                    </div>
                    
                    <!-- Total -->
                    <div id="reception-items-total" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #4caf50;">
                        <div style="display: flex; justify-content: space-between; font-size: 16px;">
                            <span><strong>üì¶ Total produits :</strong> <span id="reception-total-count">0</span></span>
                            <span><strong>‚öñÔ∏è Quantit√© totale :</strong> <span id="reception-total-qty">0</span> kg</span>
                            <span><strong>üí∞ Co√ªt total :</strong> <span id="reception-total-cost">0.00</span> ‚Ç¨</span>
                        </div>
                    </div>
                </div>
                
                <!-- Section Photos -->
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); border-radius: 12px; border: 2px solid #8d6e63;">
                    <h4 style="color: #5d4037;">üì∏ Documentation Photographique</h4>
                    <p style="color: #666; margin-bottom: 15px;">Prenez des photos de la marchandise, du camion, des conditions de livraison...</p>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button type="button" class="btn" onclick="startCamera()">üì∑ Prendre Photo</button>
                        <button type="button" class="btn btn-secondary" onclick="selectFromGallery()">üñºÔ∏è Galerie</button>
                        <button type="button" class="btn btn-secondary" onclick="clearPhotos()">üóëÔ∏è Effacer Photos</button>
                    </div>
                    
                    <!-- Cam√©ra intelligente -->
                    <div id="camera-section" style="display: none; margin-bottom: 15px;">
                        <div class="smart-camera-container">
                            <video id="camera-video" class="smart-camera-video" playsinline></video>
                            <div class="camera-grid-overlay" id="camera-grid"></div>
                            <div class="capture-countdown" id="capture-countdown" style="display: none;"></div>
                        </div>
                        
                        <!-- Indicateurs de luminosit√© et stabilit√© -->
                        <div class="camera-indicators">
                            <div class="camera-indicator" id="light-indicator">
                                <span class="indicator-dot"></span>
                                <span id="light-status">Analyse lumi√®re...</span>
                            </div>
                            <div class="camera-indicator" id="stability-indicator">
                                <span class="indicator-dot"></span>
                                <span id="stability-status">Stabilisation...</span>
                            </div>
                        </div>
                        
                        <!-- Boutons de capture -->
                        <div class="smart-capture-buttons">
                            <button type="button" class="btn-capture" onclick="smartCapture()" id="btn-smart-capture">
                                üì∏ Capture Intelligente (3s)
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="capturePhoto()">
                                ‚ö° Capture Rapide
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="stopCamera()">
                                ‚ùå Annuler
                            </button>
                        </div>
                        
                        <!-- Toggle grille -->
                        <div style="margin-top: 10px;">
                            <label style="font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="toggle-grid" checked onchange="toggleCameraGrid()">
                                Afficher la grille de cadrage
                            </label>
                        </div>
                        
                        <canvas id="photo-canvas" style="display: none;"></canvas>
                        <canvas id="enhancement-canvas" style="display: none;"></canvas>
                    </div>
                    
                    <!-- Preview d'am√©lioration -->
                    <div id="enhancement-preview" class="enhancement-preview">
                        <h3 style="text-align: center; margin-bottom: 15px;">‚ú® Am√©lioration de la Photo</h3>
                        
                        <div class="preview-comparison">
                            <div class="preview-item">
                                <h4>üì∑ Original</h4>
                                <img id="preview-original" src="" alt="Original">
                            </div>
                            <div class="preview-item">
                                <h4>‚ú® Am√©lior√©e</h4>
                                <img id="preview-enhanced" src="" alt="Am√©lior√©e">
                            </div>
                        </div>
                        
                        <div class="enhancement-stats">
                            <div class="enhancement-stat">
                                <div class="value" id="stat-brightness">+0%</div>
                                <div class="label">Luminosit√©</div>
                            </div>
                            <div class="enhancement-stat">
                                <div class="value" id="stat-contrast">+0%</div>
                                <div class="label">Contraste</div>
                            </div>
                            <div class="enhancement-stat">
                                <div class="value" id="stat-sharpness">+0%</div>
                                <div class="label">Nettet√©</div>
                            </div>
                            <div class="enhancement-stat">
                                <div class="value" id="stat-size">0 KB</div>
                                <div class="label">Taille finale</div>
                            </div>
                        </div>
                        
                        <div class="preview-actions">
                            <button type="button" class="btn" onclick="acceptEnhancedPhoto()">‚úÖ Accepter</button>
                            <button type="button" class="btn btn-secondary" onclick="useOriginalPhoto()">üì∑ Garder Original</button>
                            <button type="button" class="btn btn-secondary" onclick="retakePhoto()">üîÑ Reprendre</button>
                        </div>
                    </div>
                    
                    <!-- Input fichier cach√© -->
                    <input type="file" id="gallery-input" accept="image/*" multiple style="display: none;" onchange="handleGallerySelect(event)">
                    
                    <!-- Aper√ßu des photos -->
                    <div id="photos-preview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px;">
                        <!-- Les photos seront affich√©es ici -->
                    </div>
                    
                    <div id="photos-count" style="margin-top: 10px; font-size: 14px; color: #666;">
                        0 photo(s) s√©lectionn√©e(s)
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button type="button" class="btn" onclick="saveReception()">‚úÖ Enregistrer R√©ception</button>
                    <button type="button" class="btn btn-secondary" onclick="resetReceptionForm()">üîÑ R√©initialiser</button>
                </div>
            </div>
            
            <!-- Historique des r√©ceptions -->
            <h3>üìã Historique des R√©ceptions</h3>
            <div class="search-filters">
                <input type="text" class="search-bar" id="search-receptions" placeholder="üîç Rechercher par fournisseur, bon de livraison...">
                
                <div class="filters-row">
                    <div class="form-group">
                        <label for="filter-reception-fournisseur">Filtrer par Fournisseur</label>
                        <select id="filter-reception-fournisseur">
                            <option value="">Tous les fournisseurs</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-reception-date-debut">Date de D√©but</label>
                        <input type="date" id="filter-reception-date-debut">
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-reception-date-fin">Date de Fin</label>
                        <input type="date" id="filter-reception-date-fin">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="clearReceptionFilters()">üóëÔ∏è Effacer Filtres</button>
                    <button class="btn" onclick="applyReceptionFilters()">üîç Appliquer Filtres</button>
                    <button class="btn btn-success" onclick="printReceptionsHistory()">üñ®Ô∏è Imprimer Historique PDF</button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="data-table" id="receptions-table">
                    <thead>
                        <tr>
                            <th>Date/Heure</th>
                            <th>Bon Livraison</th>
                            <th>Fournisseur</th>
                            <th>Temp√©rature</th>
                            <th>Photos</th>
                            <th>Statut</th>
                            <th class="actions-column">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Les r√©ceptions seront affich√©es ici -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mati√®res Premi√®res -->
        <div id="matieres-premieres" class="tab-content">
            <h2>‚úèÔ∏è Ajout Manuel de Mati√®re Premi√®re</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                ‚ö†Ô∏è Cette section est pour ajouter manuellement une MP (correction de stock, inventaire, production interne). 
                Pour les r√©ceptions fournisseurs, utilisez l'onglet <strong>"R√©ception Marchandises"</strong>.
            </p>
            
            <div id="mp-alerts-container">
                <!-- Les alertes de stock seront affich√©es ici -->
            </div>
            
            <div id="matiere-premiere-form" style="background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #e0e0e0;">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="mp-nom">Nom de la Mati√®re Premi√®re *</label>
                        <select id="mp-nom-select" onchange="onMPRefSelect(this)" required style="background: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%); border: 2px solid #8d6e63; font-weight: 600;">
                            <option value="">-- S√©lectionner une MP --</option>
                            <!-- MP r√©f√©renc√©es charg√©es dynamiquement -->
                            <option value="__custom__">‚úèÔ∏è Saisie libre...</option>
                        </select>
                        <input type="text" id="mp-nom" placeholder="Tapez le nom de la MP" style="display: none; margin-top: 8px; background: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%); border: 2px solid #8d6e63; font-weight: 600;">
                    </div>
                    
                    <div class="form-group">
                        <label for="mp-categorie">Cat√©gorie *</label>
                        <select id="mp-categorie" required style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800;">
                            <option value="">S√©lectionner une cat√©gorie</option>
                            <option value="cacao">üç´ Cacao / Chocolat</option>
                            <option value="sucre">üç¨ Sucres</option>
                            <option value="laitier">ü•õ Produits Laitiers</option>
                            <option value="fruits-secs">üå∞ Fruits Secs & Ol√©agineux</option>
                            <option value="epices">üåø √âpices & Ar√¥mes</option>
                            <option value="matieres-grasses">üßà Mati√®res Grasses</option>
                            <option value="additifs">‚öóÔ∏è Additifs & Auxiliaires</option>
                            <option value="fruits">üçä Fruits & Pur√©es</option>
                            <option value="alcool">ü•É Alcools & Liqueurs</option>
                            <option value="oeufs">ü•ö Oeufs & Ovoproduits</option>
                            <option value="biscuit">üç™ Biscuits & Croustillants</option>
                            <option value="autre">üì¶ Autre</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="mp-lot">Num√©ro de Lot Fournisseur *</label>
                        <input type="text" id="mp-lot" placeholder="Ex: VEN-2024-03" required style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; font-weight: 600;">
                    </div>

                    <div class="form-group">
                        <label for="mp-fournisseur">Fournisseur *</label>
                        <input type="text" id="mp-fournisseur" placeholder="Nom du fournisseur" required style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #9c27b0;">
                    </div>

                    <div class="form-group">
                        <label for="mp-date-reception">Date de R√©ception *</label>
                        <input type="date" id="mp-date-reception" required style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
                    </div>

                    <div class="form-group">
                        <label for="mp-dlc">Date Limite de Consommation</label>
                        <input type="date" id="mp-dlc" style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border: 2px solid #f44336;">
                    </div>

                    <div class="form-group">
                        <label for="mp-quantite">Quantit√© Re√ßue (g) *</label>
                        <input type="number" id="mp-quantite" step="1" required min="1" style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #00bcd4; font-weight: 600;">
                    </div>

                    <div class="form-group">
                        <label for="mp-cout">Co√ªt Unitaire (‚Ç¨/kg)</label>
                        <input type="number" id="mp-cout" step="0.01" min="0" style="background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%); border: 2px solid #4caf50;">
                    </div>

                    <div class="form-group">
                        <label for="mp-stock-mini">Stock Minimum (g)</label>
                        <input type="number" id="mp-stock-mini" step="1" min="0" placeholder="Seuil d'alerte" style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107;">
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn" onclick="addMatierePremiere()">‚úÖ Enregistrer Mati√®re Premi√®re</button>
                    <button type="button" class="btn" onclick="clearMPForm()" style="background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);">üóëÔ∏è Effacer</button>
                    <button type="button" class="btn" onclick="showImportMPModal()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">üì• Importer Liste Excel/CSV</button>
                </div>
            </div>

            <h3>Stock Actuel</h3>
            
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px; color: #666;">
                    <strong id="mp-count">0</strong> mati√®re(s) premi√®re(s) active(s)
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-small" onclick="exportMPCSV()" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                        üì§ Exporter MP (CSV)
                    </button>
                    <button class="btn btn-small" onclick="showImportMPModal()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                        üì• Importer MP
                    </button>
                    <button class="btn btn-small" onclick="detectDuplicateMP()" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">
                        üîç D√©tecter Doublons
                    </button>
                </div>
            </div>
            
            <div class="search-filters" style="margin-bottom: 20px;">
                <div class="filters-row">
                    <div class="form-group">
                        <label for="filter-mp-categorie">Filtrer par Cat√©gorie</label>
                        <select id="filter-mp-categorie" onchange="applyMPFilters()">
                            <option value="">Toutes les cat√©gories</option>
                            <option value="cacao">üç´ Cacao / Chocolat</option>
                            <option value="sucre">üç¨ Sucres</option>
                            <option value="laitier">ü•õ Produits Laitiers</option>
                            <option value="fruits-secs">üå∞ Fruits Secs & Ol√©agineux</option>
                            <option value="epices">üåø √âpices & Ar√¥mes</option>
                            <option value="matieres-grasses">üßà Mati√®res Grasses</option>
                            <option value="additifs">‚öóÔ∏è Additifs & Auxiliaires</option>
                            <option value="fruits">üçä Fruits & Pur√©es</option>
                            <option value="alcool">ü•É Alcools & Liqueurs</option>
                            <option value="oeufs">ü•ö Oeufs & Ovoproduits</option>
                            <option value="biscuit">üç™ Biscuits & Croustillants</option>
                            <option value="autre">üì¶ Autre</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-mp-fournisseur">Filtrer par Fournisseur</label>
                        <select id="filter-mp-fournisseur" onchange="applyMPFilters()">
                            <option value="">Tous les fournisseurs</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-mp-stock">Filtrer par Stock</label>
                        <select id="filter-mp-stock" onchange="applyMPFilters()">
                            <option value="">Tous</option>
                            <option value="alerte">‚ö†Ô∏è Stock faible</option>
                            <option value="ok">‚úÖ Stock OK</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="clearMPFilters()">üóëÔ∏è Effacer Filtres</button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="data-table" id="mp-table">
                    <thead>
                        <tr>
                            <th style="width: 120px; cursor: pointer; user-select: none;" onclick="sortMPTable('categorie')" title="Cliquer pour trier">
                                Cat√©gorie <span class="sort-indicator" id="sort-mp-categorie">‚áÖ</span>
                            </th>
                            <th style="width: 180px; cursor: pointer; user-select: none;" onclick="sortMPTable('nom')" title="Cliquer pour trier">
                                Mati√®re Premi√®re <span class="sort-indicator" id="sort-mp-nom">‚áÖ</span>
                            </th>
                            <th style="width: 120px; cursor: pointer; user-select: none;" onclick="sortMPTable('lot')" title="Cliquer pour trier">
                                Lot Fournisseur <span class="sort-indicator" id="sort-mp-lot">‚áÖ</span>
                            </th>
                            <th style="width: 140px; cursor: pointer; user-select: none;" onclick="sortMPTable('fournisseur')" title="Cliquer pour trier">
                                Fournisseur <span class="sort-indicator" id="sort-mp-fournisseur">‚áÖ</span>
                            </th>
                            <th style="width: 100px; cursor: pointer; user-select: none;" onclick="sortMPTable('stock')" title="Cliquer pour trier">
                                Stock Actuel <span class="sort-indicator" id="sort-mp-stock">‚áÖ</span>
                            </th>
                            <th style="width: 100px; cursor: pointer; user-select: none;" onclick="sortMPTable('dlc')" title="Cliquer pour trier">
                                DLC <span class="sort-indicator" id="sort-mp-dlc">‚áÖ</span>
                            </th>
                            <th style="width: 80px; cursor: pointer; user-select: none;" onclick="sortMPTable('statut')" title="Cliquer pour trier">
                                Statut <span class="sort-indicator" id="sort-mp-statut">‚áÖ</span>
                            </th>
                            <th class="actions-column" style="min-width: 350px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Les mati√®res premi√®res seront affich√©es ici -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Configuration -->
        <div id="configuration" class="tab-content">
            <h2>‚öôÔ∏è Configuration du Syst√®me</h2>
            
            <div style="margin-bottom: 30px;">
                <h3>üè¢ Param√®tres G√©n√©raux</h3>
                
                <div id="settings-form" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #2196f3;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="config-entreprise">Nom de l'Entreprise *</label>
                            <input type="text" id="config-entreprise" placeholder="Ex: Emotions Chocolats" style="background: linear-gradient(135deg, #fff 0%, #e3f2fd 100%); border: 2px solid #1976d2; font-weight: 600;">
                        </div>
                        
                        <div class="form-group">
                            <label for="config-stock-alerte">Seuil d'Alerte Stock (kg)</label>
                            <input type="number" id="config-stock-alerte" placeholder="Ex: 20" min="0" step="0.1" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: #fff; border-radius: 8px; font-size: 13px; border-left: 4px solid #2196F3;">
                        <strong>üì¶ Format des num√©ros de lot :</strong> ANN√âE-XXX (Ex: 2026-001, 2026-002...)
                        <div style="margin-top: 5px; color: #666; font-size: 12px;">üí° Le compteur repart √† 001 chaque nouvelle ann√©e</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn" onclick="saveGeneralSettings()">üíæ Enregistrer Param√®tres</button>
                        <button type="button" class="btn btn-secondary" onclick="loadGeneralSettings()">üîÑ Recharger</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <div id="header-categories" class="config-section-header collapsed" onclick="toggleConfigSection('categories')">
                    <span class="toggle-arrow">‚ñº</span>
                    <h3 style="margin:0;">üì¶ Gestion des Cat√©gories de Mati√®res Premi√®res</h3>
                </div>
                <div id="body-categories" class="config-section-body collapsed">
                
                <div id="categorie-form" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #ff9800;">
                    <h4 style="color: #e65100;">Ajouter/Modifier une Cat√©gorie</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="config-categorie-nom">Nom de la Cat√©gorie *</label>
                            <input type="text" id="config-categorie-nom" placeholder="Ex: Bio & √âquitable" required style="background: linear-gradient(135deg, #fff 0%, #fff3e0 100%); border: 2px solid #f57c00;">
                        </div>
                        
                        <div class="form-group">
                            <label for="config-categorie-emoji">Emoji *</label>
                            <input type="text" id="config-categorie-emoji" placeholder="Ex: üå±" maxlength="2" required style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107; font-size: 24px; text-align: center;">
                        </div>
                        
                        <div class="form-group">
                            <label for="config-categorie-actif">Statut</label>
                            <select id="config-categorie-actif" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" id="config-categorie-id">
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn" onclick="saveCategorie()">üíæ Enregistrer Cat√©gorie</button>
                        <button type="button" class="btn btn-secondary" onclick="resetCategorieForm()">üîÑ R√©initialiser</button>
                        <button type="button" class="btn btn-secondary" onclick="loadDefaultCategories()">üì¶ Charger Cat√©gories par D√©faut</button>
                    </div>
                </div>
                
                <h4>Liste des Cat√©gories Configur√©es</h4>
                <div class="table-responsive">
                    <table class="data-table" id="categories-table">
                        <thead>
                            <tr>
                                <th>Emoji</th>
                                <th>Nom</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Les cat√©gories seront affich√©es ici -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            </div>
            <div style="margin-bottom: 30px;">
                <div id="header-products" class="config-section-header collapsed" onclick="toggleConfigSection('products')">
                    <span class="toggle-arrow">‚ñº</span>
                    <h3 style="margin:0;">üç´ Gestion des Produits</h3>
                </div>
                <div id="body-products" class="config-section-body collapsed">
                
                <div id="produit-form" style="background: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #8d6e63;">
                    <h4 style="color: #5d4037;">Ajouter/Modifier un Produit</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="config-produit-id">Code Produit *</label>
                            <input type="text" id="config-produit-id" placeholder="Ex: tablette-noir-70" required style="background: linear-gradient(135deg, #fff 0%, #efebe9 100%); border: 2px solid #6d4c41; font-weight: 600;">
                        </div>
                        
                        <div class="form-group">
                            <label for="config-produit-nom">Nom du Produit *</label>
                            <input type="text" id="config-produit-nom" placeholder="Ex: Tablette Noir 70%" required style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #9c27b0;">
                        </div>
                        
                        <div class="form-group">
                            <label for="config-produit-dlc">Dur√©e Conservation (jours) *</label>
                            <input type="number" id="config-produit-dlc" min="1" placeholder="Ex: 730" required style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border: 2px solid #f44336;">
                        </div>
                        
                        <div class="form-group">
                            <label for="config-produit-categorie">Cat√©gorie</label>
                            <select id="config-produit-categorie" style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #00bcd4;">
                                <option value="autre">Autre</option>
                                <option value="barre">Barre</option>
                                <option value="boisson">Boisson</option>
                                <option value="bonbon">Bonbon</option>
                                <option value="coffret">Coffret</option>
                                <option value="confiserie">Confiserie</option>
                                <option value="glace">Glace</option>
                                <option value="mendiants">Mendiants</option>
                                <option value="orangettes">Orangettes</option>
                                <option value="patisserie">P√¢tisserie</option>
                                <option value="praline">Praline</option>
                                <option value="rocher">Rocher</option>
                                <option value="sorbet">Sorbet</option>
                                <option value="tablette">Tablette</option>
                                <option value="truffe">Truffe</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="config-produit-prix">Prix de Vente (‚Ç¨/kg)</label>
                            <input type="number" id="config-produit-prix" step="0.01" min="0" placeholder="Ex: 45.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="config-produit-actif">Statut</label>
                            <select id="config-produit-actif">
                                <option value="true">Actif</option>
                                <option value="false">Inactif</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="config-produit-description">Description</label>
                        <textarea id="config-produit-description" rows="2" placeholder="Description d√©taill√©e du produit..."></textarea>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid #ffc107;">
                        <h4 style="margin: 0 0 15px 0; color: #f57c00;">üè∑Ô∏è Informations √âtiquette Produit</h4>
                        
                        <div class="form-group">
                            <label for="config-produit-poids">Poids Net</label>
                            <input type="text" id="config-produit-poids" placeholder="Ex: 100g, 250g, 500g..." style="background: white; border: 2px solid #ff9800;">
                        </div>
                        
                        <div class="form-group">
                            <label for="config-produit-ingredients">Ingr√©dients (liste compl√®te)</label>
                            <textarea id="config-produit-ingredients" rows="3" placeholder="Ex: P√¢te de cacao, sucre, beurre de cacao, l√©cithine de soja, vanille..." style="background: white; border: 2px solid #ff9800;"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="config-produit-allergenes">Allerg√®nes (en majuscules)</label>
                            <input type="text" id="config-produit-allergenes" placeholder="Ex: SOJA, LAIT, FRUITS √Ä COQUE..." style="background: white; border: 2px solid #ff9800;">
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn" onclick="saveProduct()">üíæ Enregistrer Produit</button>
                        <button type="button" class="btn btn-secondary" onclick="resetProductForm()">üîÑ R√©initialiser</button>
                        <button type="button" class="btn btn-secondary" onclick="loadDefaultProducts()">üì¶ Charger Produits par D√©faut</button>
                        <button type="button" class="btn" onclick="showImportProductsModal()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">üì• Importer Liste Excel/CSV</button>
                    </div>
                </div>
                
                <h4>Liste des Produits Configur√©s</h4>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-between; align-items: center;">
                    <div style="font-size: 14px; color: #666;">
                        <strong id="products-count">0</strong> produit(s) configur√©(s)
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <label style="font-size: 13px; font-weight: 600;">Trier par :</label>
                        <select id="products-sort" onchange="displayProductsConfig()" style="padding: 8px 12px; border: 2px solid #D2691E; border-radius: 6px; font-size: 13px;">
                            <option value="nom-asc">Nom (A-Z)</option>
                            <option value="nom-desc">Nom (Z-A)</option>
                            <option value="categorie-asc">Cat√©gorie (A-Z)</option>
                            <option value="categorie-desc">Cat√©gorie (Z-A)</option>
                            <option value="dlc-asc">DLC (croissant)</option>
                            <option value="dlc-desc">DLC (d√©croissant)</option>
                            <option value="prix-asc">Prix (croissant)</option>
                            <option value="prix-desc">Prix (d√©croissant)</option>
                            <option value="actif">Actifs en premier</option>
                            <option value="inactif">Inactifs en premier</option>
                        </select>
                        <button class="btn btn-small" onclick="exportProductsCSV()" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                            üì§ Exporter Produits (CSV)
                        </button>
                        <button class="btn btn-small" onclick="showImportProductsModal()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                            üì• Importer Produits
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="data-table" id="products-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Nom</th>
                                <th>Cat√©gorie</th>
                                <th>DLC (jours)</th>
                                <th>Prix (‚Ç¨/kg)</th>
                                <th style="min-width: 200px;">Recette</th>
                                <th>Statut</th>
                                <th class="actions-column" style="min-width: 280px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Les produits seront affich√©s ici -->
                        </tbody>
                    </table>
                </div>
            </div>

            </div>
            <div style="margin-bottom: 30px;">
                <div id="header-mpref" class="config-section-header collapsed" onclick="toggleConfigSection('mpref')">
                    <span class="toggle-arrow">‚ñº</span>
                    <h3 style="margin:0;">üßÑ Gestion des Mati√®res Premi√®res R√©f√©renc√©es</h3>
                </div>
                <div id="body-mpref" class="config-section-body collapsed">
                
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #4caf50;">
                    <strong style="color: #2e7d32;">üí° Cr√©ez ici votre liste de mati√®res premi√®res.</strong>
                    <div style="margin-top: 5px; color: #388e3c; font-size: 14px;">
                        Elles appara√Ætront dans un menu d√©roulant lors de l'ajout d'une nouvelle MP, pour √©viter les erreurs de saisie.
                    </div>
                </div>

                <div id="mp-ref-form" style="background: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #8d6e63;">
                    <h4 style="color: #5d4037;">Ajouter/Modifier une Mati√®re Premi√®re</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="config-mp-nom">Nom *</label>
                            <input type="text" id="config-mp-nom" placeholder="Ex: Cacao Venezuela 72%" required style="background: linear-gradient(135deg, #fff 0%, #efebe9 100%); border: 2px solid #6d4c41; font-weight: 600;">
                        </div>
                        
                        <div class="form-group">
                            <label for="config-mp-categorie">Cat√©gorie</label>
                            <select id="config-mp-categorie" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800;">
                                <option value="">S√©lectionner</option>
                                <option value="cacao">üç´ Cacao / Chocolat</option>
                                <option value="sucre">üç¨ Sucres</option>
                                <option value="laitier">ü•õ Produits Laitiers</option>
                                <option value="fruits-secs">üå∞ Fruits Secs & Ol√©agineux</option>
                                <option value="epices">üåø √âpices & Ar√¥mes</option>
                                <option value="matieres-grasses">üßà Mati√®res Grasses</option>
                                <option value="additifs">‚öóÔ∏è Additifs & Auxiliaires</option>
                                <option value="fruits">üçä Fruits & Pur√©es</option>
                                <option value="alcool">ü•É Alcools & Liqueurs</option>
                                <option value="oeufs">ü•ö Oeufs & Ovoproduits</option>
                                <option value="biscuit">üç™ Biscuits & Croustillants</option>
                                <option value="autre">üì¶ Autre</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="config-mp-fournisseur">Fournisseur par d√©faut</label>
                            <input type="text" id="config-mp-fournisseur" placeholder="Ex: Mayata" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #9c27b0;">
                        </div>

                        <div class="form-group">
                            <label for="config-mp-unite">Unit√©</label>
                            <select id="config-mp-unite" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3;">
                                <option value="kg">kg</option>
                                <option value="g">g</option>
                                <option value="L">L</option>
                                <option value="unit√©">unit√©</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="config-mp-prix">Prix unitaire (‚Ç¨)</label>
                            <input type="number" id="config-mp-prix" step="0.01" min="0" placeholder="Ex: 25.00" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
                        </div>

                        <div class="form-group">
                            <label for="config-mp-stock-mini">Stock minimum</label>
                            <input type="number" id="config-mp-stock-mini" step="0.1" min="0" placeholder="Ex: 5" style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border: 2px solid #f44336;">
                        </div>
                    </div>
                    
                    <input type="hidden" id="config-mp-edit-index" value="-1">
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn" onclick="saveMPRef()">üíæ Enregistrer MP</button>
                        <button type="button" class="btn btn-secondary" onclick="resetMPRefForm()">üîÑ R√©initialiser</button>

                    </div>
                </div>
                
                <h4>Liste des Mati√®res Premi√®res R√©f√©renc√©es (<span id="mp-ref-count">0</span>)</h4>
                <div class="table-responsive">
                    <table class="data-table" id="mp-ref-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Cat√©gorie</th>
                                <th>Fournisseur</th>
                                <th>Unit√©</th>
                                <th>Prix</th>
                                <th>Stock mini</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Les MP r√©f√©renc√©es seront affich√©es ici -->
                        </tbody>
                    </table>
                </div>
            </div>

            </div>
            <!-- Configuration des √âtiquettes -->
            <div style="margin-bottom: 30px;">
                <div id="header-labels" class="config-section-header collapsed" onclick="toggleConfigSection('labels')">
                    <span class="toggle-arrow">‚ñº</span>
                    <h3 style="margin:0;">üè∑Ô∏è Configuration des √âtiquettes</h3>
                </div>
                <div id="body-labels" class="config-section-body collapsed">
                
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #ff9800;">
                    <strong style="color: #e65100;">üí° Configurez vos formats d'√©tiquettes personnalis√©s.</strong>
                    <div style="margin-top: 5px; color: #bf360c; font-size: 14px;">
                        Ajoutez les dimensions correspondant √† votre imprimante. Seuls les formats activ√©s appara√Ætront dans le s√©lecteur d'√©tiquettes.
                    </div>
                </div>

                <!-- Format par d√©faut -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #ff9800;">
                    <h4 style="margin-top:0; color: #e65100;">üìè Format par d√©faut</h4>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <select id="config-label-default" style="padding: 10px; border: 2px solid #ff9800; border-radius: 8px; font-size: 14px; min-width: 300px;">
                            <!-- Rempli dynamiquement -->
                        </select>
                        <button type="button" class="btn" onclick="saveDefaultLabelSize()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">üíæ D√©finir par d√©faut</button>
                    </div>
                </div>

                <!-- Ajouter un format personnalis√© -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #ff9800;">
                    <h4 style="margin-top:0; color: #e65100;">‚ûï Ajouter un format personnalis√©</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Nom du format *</label>
                            <input type="text" id="config-label-name" placeholder="Ex: Mon imprimante 80x50" style="border: 2px solid #ff9800;">
                        </div>
                        <div class="form-group">
                            <label>Largeur (mm) *</label>
                            <input type="number" id="config-label-width" placeholder="Ex: 80" min="20" max="300" style="border: 2px solid #ff9800;">
                        </div>
                        <div class="form-group">
                            <label>Hauteur min (mm) *</label>
                            <input type="number" id="config-label-height" placeholder="Ex: 50" min="10" max="300" style="border: 2px solid #ff9800;">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button type="button" class="btn" onclick="addCustomLabelSize()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">‚ûï Ajouter ce format</button>
                    </div>
                </div>

                <!-- Liste des formats personnalis√©s -->
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #ff9800;">
                    <h4 style="margin-top:0; color: #e65100;">üìã Formats personnalis√©s (<span id="custom-label-count">0</span>)</h4>
                    <table class="table-styled" id="custom-label-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Largeur</th>
                                <th>Hauteur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Recettes -->
        <div id="recettes" class="tab-content">
            <h2>üß™ Gestion des Recettes</h2>
            
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #2196F3;">
                <strong style="font-size: 18px; color: #1976d2;">üí° √Ä quoi servent les recettes ?</strong>
                <div style="margin-top: 10px; color: #1565c0; line-height: 1.6;">
                    ‚Ä¢ <strong>Calcul automatique :</strong> Les ingr√©dients sont calcul√©s selon la quantit√© produite<br>
                    ‚Ä¢ <strong>Gain de temps :</strong> Plus besoin de saisir les ingr√©dients √† chaque lot<br>
                    ‚Ä¢ <strong>Coh√©rence :</strong> Les proportions restent toujours exactes<br>
                    ‚Ä¢ <strong>V√©rification stock :</strong> Alerte automatique si stock insuffisant
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <strong style="color: #e65100;">üîß Maintenance des recettes :</strong>
                    <div style="margin-top: 8px;">
                        <button class="btn btn-secondary" onclick="syncRecipesWithMP()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none; color: white;">
                            üîÑ Synchroniser les recettes avec les MP
                        </button>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            Corrige automatiquement les liaisons entre les recettes et les mati√®res premi√®res (√† faire une fois)
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="recette-form" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #9c27b0;">
                <h4 style="color: #7b1fa2;">Cr√©er/Modifier une Recette</h4>
                
                <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <strong style="color: #856404;">üí° Astuce :</strong>
                    <div style="margin-top: 8px; color: #856404; font-size: 13px; line-height: 1.6;">
                        Les produits list√©s ci-dessous proviennent de votre configuration. Si vous ne voyez pas un produit, ajoutez-le d'abord dans l'onglet "Configuration" ‚Üí "Gestion des Produits".
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="config-recette-produit">Produit *</label>
                        <select id="config-recette-produit" required onchange="checkRecipeExists()" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800;">
                            <option value="">S√©lectionner un produit</option>
                        </select>
                        <div id="recipe-exists-warning" style="display: none; margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107; font-size: 12px; color: #856404;">
                            ‚ö†Ô∏è Une recette existe d√©j√† pour ce produit. La sauvegarder √©crasera l'ancienne.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="config-recette-quantite-base">Quantit√© de Base *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="config-recette-quantite-base" step="1" min="1" placeholder="Ex: 1459" required style="flex: 2; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; font-weight: 600;" oninput="updateRecipeIngredientsDisplay()">
                            <select id="config-recette-unite-base" style="flex: 1; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;" onchange="updateRecipeIngredientsDisplay()">
                                <option value="g" selected>g</option>
                                <option value="kg">kg</option>
                                <option value="nombre">nombre</option>
                            </select>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                            üí° Quantit√© pour laquelle la recette est d√©finie
                        </div>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px; border: 2px solid #9C27B0;">
                    <h5 style="color: #9C27B0; margin-bottom: 12px;">üßÑ Ingr√©dients de la Recette</h5>
                    
                    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #9C27B0;">
                        <strong style="color: #7B1FA2;">üí° Comment √ßa marche :</strong>
                        <div style="margin-top: 8px; color: #6A1B9A; font-size: 13px;">
                            S√©lectionnez les <strong>mati√®res premi√®res</strong> de votre stock et indiquez les quantit√©s pour cette recette.<br>
                            La recette sera enregistr√©e et pourra √™tre charg√©e automatiquement lors de la cr√©ation d'un lot.
                        </div>
                    </div>
                    
                    <div class="form-grid" style="margin-bottom: 12px;">
                        <div class="form-group">
                            <label for="recette-ingredient-select">Mati√®re Premi√®re</label>
                            <select id="recette-ingredient-select" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3;">
                                <option value="">Choisir une mati√®re premi√®re</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="recette-ingredient-quantite">Quantit√©</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="recette-ingredient-quantite" step="0.001" min="0.001" placeholder="Ex: 500" style="flex: 2; background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #00bcd4;">
                                <select id="recette-ingredient-unite" style="flex: 1; background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #00bcd4;">
                                    <option value="g">grammes</option>
                                    <option value="kg">kg</option>
                                    <option value="nombre">nombre</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button type="button" class="btn btn-secondary" onclick="addRecipeIngredient()">‚ûï Ajouter</button>
                        </div>
                    </div>
                    
                    <div id="recette-ingredients-list" style="margin-top: 15px;">
                        <div id="recette-ingredients-empty" style="text-align: center; color: #666; padding: 20px; font-style: italic; background: #f8f9fa; border-radius: 8px; border: 1px dashed #dee2e6;">
                            Aucun ingr√©dient ajout√© √† la recette
                        </div>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%); border-radius: 8px; border: 2px solid #8B4513;">
                    <h5 style="color: #5d4037; margin-bottom: 12px;">üç´ Chocolat d'Enrobage (optionnel)</h5>
                    
                    <div style="background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #8B4513;">
                        <strong style="color: #5c3a21;">üí° Info :</strong>
                        <div style="margin-top: 8px; color: #5c3a21; font-size: 13px;">
                            Si votre recette n√©cessite un enrobage chocolat, s√©lectionnez le type de chocolat, indiquez le grammage par pi√®ce et le nombre de pi√®ces produites.
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="recette-enrobage-chocolat">Type de Chocolat</label>
                            <select id="recette-enrobage-chocolat" onchange="toggleEnrobageFields(); updateEnrobageDisplay(); updateRecipeIngredientsDisplay();" style="background: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%); border: 2px solid #6d4c41;">
                                <option value="">Pas d'enrobage</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="enrobage-grammage-group" style="display: none;">
                            <label for="recette-enrobage-grammage">Grammage par pi√®ce</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="recette-enrobage-grammage" step="0.1" min="0" placeholder="Ex: 5" style="flex: 2; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107;" oninput="updateEnrobageDisplay(); updateRecipeIngredientsDisplay();">
                                <span style="flex: 1; display: flex; align-items: center; padding: 0 10px; background: #f5f0e8; border-radius: 8px; color: #5c3a21; font-weight: 500;">grammes</span>
                            </div>
                        </div>
                        
                        <div class="form-group" id="enrobage-pieces-group" style="display: none;">
                            <label for="recette-enrobage-pieces">
                                Nombre de pi√®ces produites
                                <span style="font-size: 11px; color: #666; font-weight: normal;">
                                    (pour cette quantit√© de base)
                                </span>
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="recette-enrobage-pieces" step="1" min="1" placeholder="Ex: 50" style="flex: 2; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3;" oninput="updateEnrobageDisplay(); updateRecipeIngredientsDisplay();">
                                <span style="flex: 1; display: flex; align-items: center; padding: 0 10px; background: #f5f0e8; border-radius: 8px; color: #5c3a21; font-weight: 500;">pi√®ces</span>
                            </div>
                        </div>
                        
                        <div class="form-group" id="enrobage-total-group" style="display: none;">
                            <label for="recette-enrobage-total">Total pour la recette</label>
                            <div id="recette-enrobage-total" style="padding: 12px 15px; background: #f5f0e8; border-radius: 8px; color: #5c3a21; font-weight: 600;">
                                -
                            </div>
                        </div>
                    </div>
                </div>
                    
                <div id="recette-total" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; display: none; border: 2px solid #9C27B0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="font-weight: bold; color: #9C27B0;">
                            üì¶ Total recette : <span id="total-recette-weight" style="font-size: 18px;">0</span>
                        </div>
                        <div style="font-weight: bold; color: #2e7d32; background: #e8f5e9; padding: 8px 15px; border-radius: 8px; border: 2px solid #4caf50;">
                            üí∞ Prix de revient : <span id="total-recette-cout" style="font-size: 18px;">0.00</span> ‚Ç¨
                        </div>
                        <div id="recette-cout-unitaire" style="display: none; font-weight: bold; color: #1976D2; background: #e3f2fd; padding: 8px 15px; border-radius: 8px; border: 2px solid #2196F3;">
                            üìä Co√ªt unitaire : <span id="cout-par-unite">0.00</span> ‚Ç¨/<span id="unite-base-label">kg</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn" onclick="saveRecipe()">üíæ Enregistrer Recette</button>
                    <button type="button" class="btn btn-secondary" onclick="resetRecipeForm()">üîÑ R√©initialiser</button>
                </div>
            </div>
            
            <h4>Liste des Recettes Configur√©es</h4>
            <div class="table-responsive">
                <table class="data-table" id="recipes-table">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Quantit√© Base</th>
                            <th>Ingr√©dients</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Rapports -->
        <div id="rapports" class="tab-content">
            <h2>Rapports et Analyses</h2>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-number" id="rapport-lots-mois">0</div>
                    <div class="summary-label">Lots ce mois</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="rapport-production-mois">0</div>
                    <div class="summary-label">kg produits ce mois</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="rapport-cout-moyen">0</div>
                    <div class="summary-label">Co√ªt moyen par lot (‚Ç¨)</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="rapport-note-qualite">0</div>
                    <div class="summary-label">Note qualit√© moyenne</div>
                </div>
            </div>

            <div class="export-section">
                <h3>üìä G√©n√©ration de Rapports et Sauvegarde</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Exportez vos donn√©es ou cr√©ez une sauvegarde compl√®te de l'application.
                </p>
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="saveCompleteBackup()">üíæ Sauvegarde Compl√®te (Tous Modules)</button>
                    <button class="btn btn-secondary" onclick="loadBackupFile()">üìÇ Restaurer Sauvegarde</button>
                    <button class="btn" onclick="generateSimpleReport()">üìä Rapport JSON Simple</button>
                    <button class="btn" onclick="exportData('csv')">üìÑ Export CSV (Lots)</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f1f8e9; border-radius: 8px; font-size: 13px; border-left: 4px solid #8BC34A;">
                    <strong style="color: #558B2F;">‚úÖ La sauvegarde compl√®te inclut :</strong>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div>‚úì ${lots.length} lot(s) de production</div>
                        <div>‚úì ${matieresPremi√®res.length} mati√®re(s) premi√®re(s)</div>
                        <div>‚úì ${receptions.length} r√©ception(s)</div>
                        <div>‚úì ${controlesQualite.length} contr√¥le(s) qualit√©</div>
                        <div>‚úì ${productsConfig.length} produit(s) configur√©(s)</div>
                        <div>‚úì ${categoriesMP.length} cat√©gorie(s)</div>
                        <div>‚úì Tous les param√®tres</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Archives -->
        <div id="archives" class="tab-content">
            <h2>üì¶ Archives des Mati√®res Premi√®res</h2>
            
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #ffc107;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 32px;">üì¶</span>
                    <div>
                        <strong style="font-size: 18px; color: #856404;">Qu'est-ce que les Archives ?</strong>
                        <div style="font-size: 14px; color: #856404; margin-top: 5px; line-height: 1.6;">
                            Les mati√®res premi√®res archiv√©es ne sont plus disponibles pour cr√©er de nouveaux lots,<br>
                            mais restent visibles dans l'historique pour la tra√ßabilit√© compl√®te.
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="archives-alerts-container">
                <!-- Les alertes d'archivage automatique seront affich√©es ici -->
            </div>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-number" id="archives-total">0</div>
                    <div class="summary-label">MP Archiv√©es</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="archives-epuisees">0</div>
                    <div class="summary-label">Stock √âpuis√© (0 kg)</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="archives-perimees">0</div>
                    <div class="summary-label">DLC D√©pass√©e</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="archives-valeur-perdue">0 ‚Ç¨</div>
                    <div class="summary-label">Valeur Archiv√©e</div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px; text-align: center;">
                <button class="btn" onclick="checkAutoArchive()">üîç V√©rifier Archivage Automatique</button>
                <button class="btn btn-secondary" onclick="exportArchives()">üìä Exporter Archives (CSV)</button>
                <button class="btn btn-secondary" onclick="syncArchivesWithSupabase()" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">üîÑ Re-synchroniser avec Supabase</button>
            </div>
            
            <div class="search-filters" style="background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%); padding: 20px; border-radius: 12px; border: 2px solid #e0e0e0; margin-bottom: 20px;">
                <input type="text" class="search-bar" id="search-archives" placeholder="üîç Rechercher dans les archives..." oninput="applyArchivesFilters()" style="background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%); border: 2px solid #9e9e9e;">
                
                <div class="filters-row">
                    <div class="form-group">
                        <label for="filter-archives-categorie">Filtrer par Cat√©gorie</label>
                        <select id="filter-archives-categorie" onchange="applyArchivesFilters()" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800;">
                            <option value="">Toutes les cat√©gories</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filter-archives-raison">Raison d'archivage</label>
                        <select id="filter-archives-raison" onchange="applyArchivesFilters()" style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border: 2px solid #f44336;">
                            <option value="">Toutes les raisons</option>
                            <option value="manuel">üì¶ Manuel</option>
                            <option value="perime">üìÖ P√©rim√© (DLC)</option>
                            <option value="stock-zero">üìâ Stock √† 0</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sort-archives">Trier par</label>
                        <select id="sort-archives" onchange="applyArchivesFilters()" style="background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); border: 2px solid #673ab7;">
                            <option value="date-desc">Date archivage (r√©cent)</option>
                            <option value="date-asc">Date archivage (ancien)</option>
                            <option value="nom-asc">Nom (A-Z)</option>
                            <option value="nom-desc">Nom (Z-A)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="data-table" id="archives-table">
                    <thead>
                        <tr>
                            <th>Cat√©gorie</th>
                            <th>Mati√®re Premi√®re</th>
                            <th>Lot Fournisseur</th>
                            <th>Fournisseur</th>
                            <th>Stock Final</th>
                            <th>DLC</th>
                            <th>Date Archivage</th>
                            <th>Raison</th>
                            <th class="actions-column">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Les MP archiv√©es seront affich√©es ici -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div id="admin" class="tab-content">
            <h2>üëë Dashboard Administrateur</h2>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-number" id="admin-total-users">-</div>
                    <div class="summary-label">Utilisateurs</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #d4edda, #c3e6cb);">
                    <div class="summary-number" id="admin-active-subs">-</div>
                    <div class="summary-label">Abonnements actifs</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #fff3cd, #ffeaa7);">
                    <div class="summary-number" id="admin-revenue">-</div>
                    <div class="summary-label">Revenus mensuels</div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üìã Liste des utilisateurs</h3>
                    <button class="btn btn-primary" onclick="loadAdminData()" style="font-size: 14px; padding: 8px 16px;">üîÑ Rafra√Æchir</button>
                </div>
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Plan</th>
                            <th>Statut</th>
                            <th>D√©but</th>
                            <th>Expiration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-subs-table">
                        <tr><td colspan="6" style="text-align: center; color: #999;">Cliquez sur Rafra√Æchir pour charger les donn√©es</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- D√©tail client -->
            <div id="admin-client-detail" style="display: none; margin-top: 30px; background: #f8f9fa; border-radius: 16px; padding: 30px; border: 2px solid #e0e0e0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="admin-client-title">üìä Donn√©es du client</h3>
                    <button class="btn" onclick="document.getElementById('admin-client-detail').style.display='none'" style="font-size: 14px; padding: 8px 16px; background: #dc3545; color: white;">‚úï Fermer</button>
                </div>
                
                <div class="summary-cards" id="admin-client-stats">
                </div>

                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">üì¶ Derniers lots</h4>
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Num√©ro</th>
                                <th>Produit</th>
                                <th>Date</th>
                                <th>Quantit√©</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody id="admin-client-lots"></tbody>
                    </table>
                </div>

                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">üßÑ Mati√®res premi√®res</h4>
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Fournisseur</th>
                                <th>Stock</th>
                                <th>Unit√©</th>
                                <th>DLC</th>
                            </tr>
                        </thead>
                        <tbody id="admin-client-mp"></tbody>
                    </table>
                </div>

                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">üìâ Pertes r√©centes</h4>
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Mati√®re</th>
                                <th>Quantit√©</th>
                                <th>Raison</th>
                                <th>Date</th>
                                <th>Valeur</th>
                            </tr>
                        </thead>
                        <tbody id="admin-client-losses"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal pour l'√©dition de lots -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Modifier le Lot</h2>
            <div id="edit-lot-form">
                <input type="hidden" id="edit-lot-id">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="edit-numero">Num√©ro de Lot *</label>
                        <input type="text" id="edit-numero" required style="font-weight: 600; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3;">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-statut">Statut</label>
                        <select id="edit-statut">
                            <option value="fini">Termin√©</option>
                            <option value="production">En Production</option>
                            <option value="vendu">Vendu</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-quantite">Quantit√©</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="edit-quantite" step="0.1" min="0.1" style="flex: 2;">
                            <select id="edit-unite" style="flex: 1;">
                                <option value="kg">kg</option>
                                <option value="pieces">pi√®ces</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-dlc">Date Limite Consommation</label>
                        <input type="date" id="edit-dlc">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-cout">Co√ªt Production (‚Ç¨)</label>
                        <input type="number" id="edit-cout" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-observations">Observations</label>
                    <textarea id="edit-observations" rows="3"></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn" onclick="saveEditedLot()">üíæ Sauvegarder</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 id="confirm-title">Confirmation</h2>
            <div id="confirm-message" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #D2691E; max-height: 300px; overflow-y: auto;">√ätes-vous s√ªr ?</div>
            <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                <button type="button" class="btn" id="confirm-yes" style="min-width: 120px;">‚úÖ Confirmer</button>
                <button type="button" class="btn btn-secondary" id="confirm-no" style="min-width: 120px; margin-left: 10px;">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal d'ajustement de stock -->
    <div id="stock-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeStockModal()">&times;</span>
            <h2>Ajuster le Stock</h2>
            <div id="stock-form">
                <input type="hidden" id="stock-mp-id">
                
                <div class="form-group">
                    <label id="stock-mp-name">Mati√®re Premi√®re</label>
                    <p id="stock-current">Stock actuel: <strong id="stock-current-value">0 kg</strong></p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="stock-operation">Type d'op√©ration</label>
                        <select id="stock-operation">
                            <option value="add">‚ûï Ajouter au stock (livraison)</option>
                            <option value="remove">‚ûñ Retirer du stock (utilisation)</option>
                            <option value="set">üîÑ D√©finir stock exact (inventaire)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="stock-quantity">Quantit√© (g)</label>
                        <input type="number" id="stock-quantity" step="1" min="1" placeholder="Ex: 5000" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="stock-reason">Motif (optionnel)</label>
                    <input type="text" id="stock-reason" placeholder="Ex: Livraison fournisseur, Production lot CHO-001...">
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn" onclick="saveStockAdjustment()">üíæ Appliquer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeStockModal()">‚ùå Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de d√©claration de perte -->
    <div id="loss-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLossModal()">&times;</span>
            <h2>‚ö†Ô∏è D√©claration de Perte</h2>
            <div id="loss-form">
                <input type="hidden" id="loss-mp-id">
                
                <div class="form-group">
                    <label id="loss-mp-name">Mati√®re Premi√®re</label>
                    <p id="loss-current">Stock actuel: <strong id="loss-current-value">0 kg</strong></p>
                </div>
                
                <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; margin-bottom: 20px;">
                    <strong style="color: #856404;">üí° Types de pertes :</strong>
                    <ul style="margin-top: 8px; margin-left: 20px; color: #856404; font-size: 13px;">
                        <li>Casse ou d√©t√©rioration</li>
                        <li>Date limite d√©pass√©e (DLC/DLUO)</li>
                        <li>Contamination</li>
                        <li>Erreur de manipulation</li>
                    </ul>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="loss-quantity">Quantit√© perdue (g) *</label>
                        <input type="number" id="loss-quantity" step="1" min="1" placeholder="Ex: 2500" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="loss-type">Type de perte *</label>
                        <select id="loss-type" required>
                            <option value="">S√©lectionner</option>
                            <option value="autre">Autre</option>
                            <option value="casse">Casse / D√©t√©rioration</option>
                            <option value="contamination">Contamination</option>
                            <option value="dlc">DLC / DLUO d√©pass√©e</option>
                            <option value="erreur">Erreur de manipulation</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="loss-reason">Description de la perte *</label>
                    <textarea id="loss-reason" rows="3" placeholder="D√©crivez les circonstances de la perte..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="loss-date">Date de la perte *</label>
                    <input type="date" id="loss-date" required>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" onclick="saveLossDeclaration()">‚ö†Ô∏è D√©clarer la Perte</button>
                    <button type="button" class="btn btn-secondary" onclick="closeLossModal()">‚ùå Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de d√©claration de perte sur LOT (produit fini) -->
    <div id="lot-loss-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLotLossModal()">&times;</span>
            <h2>‚ö†Ô∏è D√©claration de Perte - Produit Fini</h2>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong style="color: #856404;">üì¶ Lot concern√© :</strong>
                <div style="margin-top: 10px;">
                    <span style="font-size: 18px; font-weight: bold;" id="lot-loss-numero"></span>
                    <br>
                    <span id="lot-loss-produit" style="color: #666;"></span>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; display: flex; gap: 20px; flex-wrap: wrap;">
                    <div><strong>Stock actuel :</strong> <span id="lot-loss-current-qty"></span></div>
                    <div id="lot-loss-cout-info" style="display: none;"><strong>üí∞ Co√ªt production :</strong> <span id="lot-loss-cout-total"></span> ‚Ç¨ <span id="lot-loss-cout-unitaire" style="font-size: 12px; color: #666;"></span></div>
                </div>
            </div>
            <div id="lot-loss-valeur-estimee" style="display: none; background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f44336;">
                <strong style="color: #c62828;">üí∏ Valeur estim√©e de la perte :</strong>
                <div style="font-size: 24px; font-weight: bold; color: #c62828; margin-top: 5px;">
                    <span id="lot-loss-valeur-montant">0.00</span> ‚Ç¨
                </div>
            </div>
            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                <strong style="color: #1565c0;">üí° Types de pertes produit fini :</strong>
                <ul style="margin: 10px 0 0 20px; color: #1565c0;">
                    <li><strong>Casse</strong> - Produit cass√© ou endommag√©</li>
                    <li><strong>D√©faut qualit√©</strong> - Non conforme aux standards</li>
                    <li><strong>P√©remption</strong> - DLC d√©pass√©e</li>
                    <li><strong>Retour client</strong> - Produit retourn√©</li>
                    <li><strong>√âchantillon</strong> - Donn√© en d√©gustation</li>
                    <li><strong>Autre</strong> - Autre raison</li>
                </ul>
            </div>
            <input type="hidden" id="lot-loss-id">
            <input type="hidden" id="lot-loss-cout-unitaire-value">
            <div class="form-group">
                <label for="lot-loss-quantity">Quantit√© perdue (g) *</label>
                <input type="number" id="lot-loss-quantity" step="1" min="1" placeholder="Ex: 500" required oninput="updateLotLossValue()">
            </div>
            <div class="form-group">
                <label for="lot-loss-type">Type de perte *</label>
                <select id="lot-loss-type" required>
                    <option value="">-- S√©lectionner --</option>
                    <option value="autre">‚ùì Autre</option>
                    <option value="casse">üî® Casse / Dommage</option>
                    <option value="defaut_qualite">‚ùå D√©faut qualit√©</option>
                    <option value="echantillon">üç´ √âchantillon / D√©gustation</option>
                    <option value="peremption">üìÖ P√©remption (DLC d√©pass√©e)</option>
                    <option value="retour_client">‚Ü©Ô∏è Retour client</option>
                </select>
            </div>
            <div class="form-group">
                <label for="lot-loss-reason">Description de la perte *</label>
                <textarea id="lot-loss-reason" rows="3" placeholder="D√©crivez les circonstances de la perte..." required></textarea>
            </div>
            <div class="form-group">
                <label for="lot-loss-date">Date de la perte *</label>
                <input type="date" id="lot-loss-date" required>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-danger" onclick="saveLotLossDeclaration()">‚ö†Ô∏è D√©clarer la Perte</button>
                <button type="button" class="btn btn-secondary" onclick="closeLotLossModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal de visualisation des photos de r√©ception -->
    <div id="photo-viewer-modal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <span class="close" onclick="closePhotoViewer()">&times;</span>
            <h2 id="photo-viewer-title">Photos de la R√©ception</h2>
            <div id="photo-viewer-gallery" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <!-- Les photos seront affich√©es ici -->
            </div>
        </div>
    </div>

    <!-- LIGHTBOX pour agrandir les photos -->
    <div id="photo-lightbox" class="photo-lightbox" onclick="closeLightboxOnBackground(event)">
        <span class="photo-lightbox-close" onclick="closeLightbox()">&times;</span>
        <span class="photo-lightbox-nav photo-lightbox-prev" onclick="navigateLightbox(-1)">‚ùÆ</span>
        <span class="photo-lightbox-nav photo-lightbox-next" onclick="navigateLightbox(1)">‚ùØ</span>
        <div class="photo-lightbox-content">
            <img id="lightbox-image" src="" alt="Photo agrandie" onclick="toggleZoom()">
        </div>
        <div class="photo-lightbox-info">
            <div id="lightbox-caption"></div>
            <div class="photo-lightbox-counter">
                <span id="lightbox-counter">1 / 1</span>
            </div>
            <div class="photo-lightbox-toolbar">
                <button class="photo-lightbox-btn" onclick="rotateLightboxImage(-90)" title="Rotation gauche">
                    ‚Ü∫ Gauche
                </button>
                <button class="photo-lightbox-btn" onclick="rotateLightboxImage(90)" title="Rotation droite">
                    ‚Üª Droite
                </button>
                <button class="photo-lightbox-btn" id="btn-sharpen" onclick="toggleSharpen()" title="Am√©liorer la nettet√©">
                    ‚ú® Nettet√©
                </button>
                <button class="photo-lightbox-btn" onclick="toggleZoom()" title="Zoom">
                    üîç Zoom
                </button>
                <button class="photo-lightbox-btn" onclick="zoomImage(0.5)" title="Zoom +">
                    ‚ûï
                </button>
                <button class="photo-lightbox-btn" onclick="zoomImage(-0.5)" title="Zoom -">
                    ‚ûñ
                </button>
                <button class="photo-lightbox-btn" onclick="downloadLightboxImage()" title="T√©l√©charger">
                    üíæ T√©l√©charger
                </button>
            </div>
            <div class="photo-lightbox-zoom-hint">üí° Molette = zoom ‚Ä¢ Glisser = d√©placer ‚Ä¢ Clic image = zoom x3 ‚Ä¢ ‚Üê ‚Üí naviguer ‚Ä¢ √âchap fermer</div>
        </div>
    </div>

    <!-- Modal de d√©tail de r√©ception -->
    <div id="reception-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReceptionDetail()">&times;</span>
            <h2>D√©tail de la R√©ception</h2>
            <div id="reception-detail-content">
                <!-- Le contenu d√©taill√© sera affich√© ici -->
            </div>
        </div>
    </div>

    <!-- Modal de d√©tail de lot -->
    <div id="lot-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="closeLotDetail()">&times;</span>
            <h2 id="lot-detail-title">D√©tail du Lot</h2>
            <div id="lot-detail-content">
                <!-- Le contenu d√©taill√© sera affich√© ici -->
            </div>
        </div>
    </div>

    <!-- Modal d'impression d'√©tiquette -->
    <div id="label-modal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 95vh;">
            <span class="close" onclick="closeLabelModal()">&times;</span>
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="font-size: 28px; margin-bottom: 15px;">üìã Aper√ßu de l'√âtiquette</h2>
                
                <!-- S√©lecteur de taille -->
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; margin: 20px 0; display: inline-block; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <label style="font-weight: 700; font-size: 16px; margin-right: 15px; color: #333;">üìè Format d'√©tiquette :</label>
                    <select id="label-size-select" onchange="changeLabelSize()" style="padding: 12px 20px; border: 2px solid #D2691E; border-radius: 8px; font-size: 15px; cursor: pointer; min-width: 300px; font-weight: 600;">
                        <!-- Rempli dynamiquement par updateLabelSizeSelects() -->
                    </select>
                    <div style="margin-top: 12px; font-size: 13px; color: #666; background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                        üí° <strong>Astuce :</strong> Ajoutez vos propres formats dans <strong>Configuration ‚Üí üè∑Ô∏è √âtiquettes</strong>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn" id="print-label-direct-btn" style="font-size: 16px; padding: 14px 32px; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);">üñ®Ô∏è Imprimer</button>
                    <button class="btn btn-secondary" id="download-label-btn" style="font-size: 14px; padding: 12px 24px;">üíæ T√©l√©charger</button>
                    <button class="btn btn-secondary" id="close-label-btn" style="font-size: 14px; padding: 12px 24px;">‚ùå Fermer</button>
                </div>
                
                <div style="background: #e8f5e9; padding: 12px; margin-top: 15px; border-radius: 8px; font-size: 13px; border-left: 4px solid #4CAF50; text-align: center;">
                    üí° Cliquez sur <strong>"üñ®Ô∏è Imprimer"</strong> puis s√©lectionnez votre imprimante Brother TD-4550
                </div>
            </div>
            
            <div style="background: #e9ecef; padding: 30px; border-radius: 12px; overflow: auto; box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);">
                <div id="label-content" class="label-printable label-size-brother-50x23" style="margin: 0 auto;">
                    <!-- Le contenu de l'√©tiquette sera g√©n√©r√© ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal √âtiquette Produit -->
    <div id="product-label-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-btn" onclick="closeProductLabelModal()">&times;</span>
            <h3 style="color: #8B4513; margin-bottom: 20px;">üè∑Ô∏è √âtiquette Produit - Format 29√ó90mm</h3>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <div>
                        <label><strong>‚úèÔ∏è Poids √† afficher :</strong></label>
                        <input type="text" id="product-label-poids" placeholder="Ex: 100g" style="padding: 8px; border: 2px solid #FF9800; border-radius: 5px; width: 100px;">
                    </div>
                    <button class="btn" onclick="refreshProductLabelPreview()" style="background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);">üîÑ Actualiser</button>
                </div>
            </div>
            
            <div style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn" id="print-product-label-btn" style="font-size: 16px; padding: 14px 32px; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);">üñ®Ô∏è Imprimer</button>
                <button class="btn btn-secondary" onclick="closeProductLabelModal()" style="font-size: 14px; padding: 12px 24px;">‚ùå Fermer</button>
            </div>
            
            <div style="background: #e8f5e9; padding: 12px; margin-bottom: 15px; border-radius: 8px; font-size: 13px; border-left: 4px solid #4CAF50; text-align: center;">
                üí° Cliquez sur <strong>"üñ®Ô∏è Imprimer"</strong> puis s√©lectionnez votre imprimante Brother
            </div>
            
            <div style="background: #e9ecef; padding: 20px; border-radius: 12px; overflow: auto;">
                <div id="product-label-content" style="margin: 0 auto; background: white; width: 90mm; min-height: 29mm; padding: 3mm; border: 1px solid #ccc; font-family: Arial, sans-serif;">
                    <!-- Le contenu sera g√©n√©r√© ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Input cach√© pour l'import de fichiers -->
    <input type="file" id="file-import" accept=".json" style="display: none;" onchange="handleFileImport(event)">
    <input type="file" id="products-import" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleProductsImport(event)">
    <input type="file" id="mp-import" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleMPImport(event)">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ============================================
        // CONFIGURATION SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://qaxwzxkdmtvyyckxexaw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFheHd6eGtkbXR2eXlja3hleGF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTM2ODMsImV4cCI6MjA4NzA2OTY4M30.CFd2Dmy2N3G0i-LY6Omk6rDCOsmXzQ00G9M-QYSfR8c';
        
        // Initialiser le client Supabase
        let supabaseClient = null;
        
        try {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('‚úÖ Client Supabase initialis√© avec succ√®s');
            console.log('üîó URL:', SUPABASE_URL);
        } catch (error) {
            console.error('‚ùå Erreur initialisation Supabase:', error);
        }
        
        window.supabaseClient = supabaseClient;
        
        // ============================================
        // FONCTIONS D'AUTHENTIFICATION
        // ============================================
        
        function toggleAuthForm(form) {
            if (form === 'signup') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('signup-form').style.display = 'block';
            } else {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
            }
        }
        
        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;
            const btn = document.getElementById('signup-btn');
            
            if (!email || !password) {
                showAlert('‚ùå Veuillez remplir tous les champs', 'danger');
                return;
            }
            
            if (password.length < 6) {
                showAlert('‚ùå Le mot de passe doit contenir au moins 6 caract√®res', 'danger');
                return;
            }
            
            if (password !== passwordConfirm) {
                showAlert('‚ùå Les mots de passe ne correspondent pas', 'danger');
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Cr√©ation en cours...';
                
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                if (data.user && data.session) {
                    // Inscription + connexion directe
                    currentUser = data.user;
                    currentSession = data.session;
                    showAlert('‚úÖ Compte cr√©√© avec succ√®s ! Bienvenue !', 'success');
                    showAppWithSubscriptionCheck();
                } else {
                    // Email de confirmation requis
                    showAlert('‚úÖ Compte cr√©√© ! V√©rifiez votre email pour confirmer votre inscription.', 'success');
                    toggleAuthForm('login');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur inscription:', error);
                let msg = error.message;
                if (msg.includes('already registered')) msg = 'Cet email est d√©j√† utilis√©';
                showAlert('‚ùå ' + msg, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ú® Cr√©er mon compte';
            }
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            
            if (!email || !password) {
                showAlert('‚ö†Ô∏è Veuillez remplir tous les champs', 'warning');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Connexion en cours...';
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                console.log('‚úÖ Connexion r√©ussie:', data);
                currentUser = data.user;
                currentSession = data.session;
                
                showAppWithSubscriptionCheck();
                showAlert(`‚úÖ Bienvenue ${email} !`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erreur de connexion:', error);
                showAlert(`‚ùå Erreur: ${error.message}`, 'danger');
                btn.disabled = false;
                btn.textContent = 'üîê Se connecter';
            }
        }
        
        async function handleLogout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                currentSession = null;
                
                showAuth();
                showAlert('‚úÖ D√©connexion r√©ussie', 'success');
                
            } catch (error) {
                console.error('‚ùå Erreur de d√©connexion:', error);
                showAlert(`‚ùå Erreur: ${error.message}`, 'danger');
            }
        }
        
        async function handleForgotPassword(event) {
            if (event) event.preventDefault();
            
            const email = prompt('Entrez votre adresse email pour r√©initialiser votre mot de passe:');
            
            if (!email) return;
            
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin
                });
                
                if (error) throw error;
                
                showAlert(`‚úÖ Email de r√©initialisation envoy√© √† ${email}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                showAlert(`‚ùå Erreur: ${error.message}`, 'danger');
            }
        }
        
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('active');
        }
        
        // Fermer le menu si on clique ailleurs
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu && !userMenu.contains(event.target)) {
                document.getElementById('user-dropdown').classList.remove('active');
            }
        });
        
        function showAuth() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('app-container').classList.remove('active');
            document.body.style.padding = '0';
        }
        
        let currentSubscription = null;
        
        async function checkSubscription() {
            if (!currentUser) return { active: false, plan: 'free' };
            
            try {
                const response = await fetch('/.netlify/functions/check-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });
                const data = await response.json();
                currentSubscription = data;
                return data;
            } catch (error) {
                console.error('Erreur v√©rification abonnement:', error);
                // En cas d'erreur r√©seau, permettre l'acc√®s (graceful degradation)
                return { active: true, plan: 'pro' };
            }
        }
        
        async function startSubscription() {
            if (!currentUser) return;
            
            try {
                const btn = document.getElementById('subscribe-btn');
                if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Redirection vers Mollie...'; }
                
                const response = await fetch('/.netlify/functions/create-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        userEmail: currentUser.email,
                        plan: 'pro'
                    })
                });
                
                const data = await response.json();
                
                if (data.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                } else {
                    showAlert('‚ùå Erreur: ' + (data.error || 'Impossible de cr√©er le paiement'), 'danger');
                    if (btn) { btn.disabled = false; btn.textContent = 'üí≥ S\'abonner - 39‚Ç¨/mois'; }
                }
            } catch (error) {
                console.error('Erreur paiement:', error);
                showAlert('‚ùå Erreur de connexion au service de paiement', 'danger');
            }
        }
        
        function showPaywall() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').classList.remove('active');
            document.getElementById('paywall-container').style.display = 'flex';
        }
        
        async function loadAdminData() {
            if (!isAdmin || !currentUser) return;
            
            try {
                document.getElementById('admin-subs-table').innerHTML = '<tr><td colspan="5" style="text-align:center;">‚è≥ Chargement...</td></tr>';
                
                const response = await fetch('/.netlify/functions/admin-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminEmail: currentUser.email })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showAlert('‚ùå ' + data.error, 'danger');
                    return;
                }
                
                // Mettre √† jour les compteurs
                document.getElementById('admin-total-users').textContent = data.totalUsers || 0;
                document.getElementById('admin-active-subs').textContent = data.activeSubscriptions || 0;
                document.getElementById('admin-revenue').textContent = (data.monthlyRevenue || 0) + '‚Ç¨';
                
                // Remplir le tableau
                const tbody = document.getElementById('admin-subs-table');
                if (!data.users || data.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">Aucun utilisateur</td></tr>';
                    return;
                }
                
                // Stocker les donn√©es pour le d√©tail
                window._adminUsers = data.users;
                
                tbody.innerHTML = data.users.map((u, i) => `
                    <tr>
                        <td>${u.email}</td>
                        <td><span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${u.plan === 'pro' ? '#d4edda' : '#f0f0f0'}; color: ${u.plan === 'pro' ? '#155724' : '#666'};">${u.plan === 'pro' ? '‚≠ê Pro' : 'Gratuit'}</span></td>
                        <td><span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${u.status === 'active' ? '#d4edda' : '#f8d7da'}; color: ${u.status === 'active' ? '#155724' : '#721c24'};">${u.status === 'active' ? '‚úÖ Actif' : '‚ùå Inactif'}</span></td>
                        <td>${u.started_at ? new Date(u.started_at).toLocaleDateString('fr-BE') : '-'}</td>
                        <td>${u.expires_at ? new Date(u.expires_at).toLocaleDateString('fr-BE') : '-'}</td>
                        <td><button onclick="viewClientData('${u.user_id}', '${u.email}')" style="padding: 6px 14px; background: linear-gradient(135deg, #8B4513, #a0522d); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">üëÅ Voir</button></td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Erreur chargement admin:', error);
                showAlert('‚ùå Erreur chargement donn√©es admin', 'danger');
            }
        }
        
        async function viewClientData(userId, email) {
            if (!isAdmin || !userId) return;
            
            document.getElementById('admin-client-title').textContent = 'üìä Donn√©es de ' + email;
            document.getElementById('admin-client-detail').style.display = 'block';
            document.getElementById('admin-client-lots').innerHTML = '<tr><td colspan="5" style="text-align:center;">‚è≥ Chargement...</td></tr>';
            document.getElementById('admin-client-mp').innerHTML = '<tr><td colspan="5" style="text-align:center;">‚è≥ Chargement...</td></tr>';
            document.getElementById('admin-client-losses').innerHTML = '<tr><td colspan="5" style="text-align:center;">‚è≥ Chargement...</td></tr>';
            
            // Scroll vers le d√©tail
            document.getElementById('admin-client-detail').scrollIntoView({ behavior: 'smooth' });
            
            try {
                const response = await fetch('/.netlify/functions/admin-client-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminEmail: currentUser.email, userId: userId })
                });
                
                const data = await response.json();
                if (data.error) { showAlert('‚ùå ' + data.error, 'danger'); return; }
                
                // Stats
                document.getElementById('admin-client-stats').innerHTML = `
                    <div class="summary-card">
                        <div class="summary-number">${data.totalLots}</div>
                        <div class="summary-label">Lots</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${data.totalMP}</div>
                        <div class="summary-label">Mati√®res premi√®res</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${data.totalLosses}</div>
                        <div class="summary-label">Pertes</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${data.totalReceptions}</div>
                        <div class="summary-label">R√©ceptions</div>
                    </div>
                `;
                
                // Lots
                const lotsBody = document.getElementById('admin-client-lots');
                if (data.lots && data.lots.length > 0) {
                    lotsBody.innerHTML = data.lots.map(l => `
                        <tr>
                            <td><strong>${l.numero || '-'}</strong></td>
                            <td>${l.produit || '-'}</td>
                            <td>${l.date ? new Date(l.date).toLocaleDateString('fr-BE') : '-'}</td>
                            <td>${l.quantite || 0} ${l.unite || 'kg'}</td>
                            <td>${l.statut || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    lotsBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">Aucun lot</td></tr>';
                }
                
                // MP
                const mpBody = document.getElementById('admin-client-mp');
                if (data.mp && data.mp.length > 0) {
                    mpBody.innerHTML = data.mp.map(m => `
                        <tr>
                            <td><strong>${m.nom || '-'}</strong></td>
                            <td>${m.fournisseur || '-'}</td>
                            <td>${m.quantite_actuelle || 0}</td>
                            <td>${m.unite || 'kg'}</td>
                            <td>${m.dlc ? new Date(m.dlc).toLocaleDateString('fr-BE') : '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    mpBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">Aucune MP</td></tr>';
                }
                
                // Pertes
                const lossesBody = document.getElementById('admin-client-losses');
                if (data.losses && data.losses.length > 0) {
                    lossesBody.innerHTML = data.losses.map(l => `
                        <tr>
                            <td>${l.matierepremiere || '-'}</td>
                            <td>${l.quantity || 0}</td>
                            <td>${l.reason || '-'}</td>
                            <td>${l.date ? new Date(l.date).toLocaleDateString('fr-BE') : '-'}</td>
                            <td>${(l.valeurperte || 0).toFixed(2)}‚Ç¨</td>
                        </tr>
                    `).join('');
                } else {
                    lossesBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">Aucune perte</td></tr>';
                }
                
            } catch (error) {
                console.error('Erreur chargement client:', error);
                showAlert('‚ùå Erreur chargement donn√©es client', 'danger');
            }
        }
        
        function showApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('paywall-container').style.display = 'none';
            document.getElementById('app-container').classList.add('active');
            document.body.style.padding = '20px';
            
            if (currentUser) {
                document.getElementById('user-email').textContent = currentUser.email.split('@')[0];
                document.getElementById('user-email-dropdown').textContent = currentUser.email;
            }
            
            // Afficher l'onglet Admin si administrateur
            if (isAdmin) {
                document.getElementById('admin-tab-btn').style.display = '';
            }
            
            // Charger les donn√©es de l'utilisateur
            loadFromSupabase();
        }
        
        // Liste des emails administrateurs
        const ADMIN_EMAILS = ['info@emotionschocolats.be'];
        let isAdmin = false;
        
        async function showAppWithSubscriptionCheck() {
            if (!currentUser) { showAuth(); return; }
            
            // Bypass pour les admins
            isAdmin = ADMIN_EMAILS.includes(currentUser.email);
            if (isAdmin) {
                console.log('üëë Acc√®s admin d√©tect√©');
                showApp();
                return;
            }
            
            // V√©rifier le param√®tre payment=success dans l'URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('payment') === 'success') {
                // Attendre un peu que le webhook Mollie traite le paiement
                showAlert('‚è≥ V√©rification du paiement en cours...', 'info');
                await new Promise(r => setTimeout(r, 3000));
                // Nettoyer l'URL
                window.history.replaceState({}, '', window.location.pathname);
            }
            
            const sub = await checkSubscription();
            
            if (sub.active) {
                showApp();
            } else {
                showPaywall();
            }
        }
        
        // V√©rifier la session au chargement
        async function checkSession() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session) {
                    console.log('‚úÖ Session active trouv√©e');
                    currentUser = session.user;
                    currentSession = session;
                    showAppWithSubscriptionCheck();
                } else {
                    console.log('‚ÑπÔ∏è Aucune session active');
                    showAuth();
                }
            } catch (error) {
                console.error('‚ùå Erreur de v√©rification de session:', error);
                showAuth();
            }
        }
        
        // √âcouter les changements d'authentification
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('üîÑ Auth state changed:', event);
            
            if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                currentUser = session.user;
                currentSession = session;
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                currentSession = null;
                showAuth();
            }
        });
        
        let isOnline = navigator.onLine;
        let syncInProgress = false;
        
        // Variables globales
        let lots = [];
        let matieresPremi√®res = [];
        let filteredMatieresPremi√®res = [];
        let controlesQualite = [];
        let receptions = [];
        let losses = []; // Nouveau : historique des pertes
        let filteredLots = [];
        let filteredReceptions = [];
        let productsConfig = [];
        let mpRefConfig = [];
        let labelConfig = { defaultSize: 'a5', customFormats: [] };
        let recipesConfig = []; // Nouveau : recettes de production
        let generalSettings = {};
        let currentPhotos = [];
        let cameraStream = null;
        let currentIngredients = [];
        let showArchivedMP = false; // Afficher ou masquer les MP archiv√©es
        let currentRecipeIngredients = []; // Pour la configuration des recettes
        
        // Fonction utilitaire pour obtenir les MP actives (non archiv√©es)
        function getActiveMatieresPremi√®res() {
            return matieresPremi√®res.filter(mp => !mp.archived);
        }
        
        // Fonction pour rafra√Æchir toutes les listes filtr√©es (MP et Inventaire)
        function refreshAllMPLists() {
            const activeMP = getActiveMatieresPremi√®res();
            
            // V√©rifier si des filtres sont actifs
            const categorieFilter = document.getElementById('filter-mp-categorie')?.value || '';
            const fournisseurFilter = document.getElementById('filter-mp-fournisseur')?.value || '';
            const stockFilter = document.getElementById('filter-mp-stock')?.value || '';
            
            // Si des filtres sont actifs, les r√©appliquer
            if (categorieFilter || fournisseurFilter || stockFilter) {
                filteredMatieresPremi√®res = activeMP.filter(mp => {
                    const matchesCategorie = !categorieFilter || mp.categorie === categorieFilter;
                    const matchesFournisseur = !fournisseurFilter || mp.fournisseur === fournisseurFilter;
                    
                    // Compatibilit√© snake_case et camelCase
                    const quantiteActuelle = mp.quantite_actuelle ?? mp.quantiteActuelle ?? 0;
                    const stockMini = mp.stock_mini ?? mp.stockMini ?? 0;
                    
                    let matchesStock = true;
                    if (stockFilter === 'alerte') {
                        matchesStock = quantiteActuelle <= stockMini;
                    } else if (stockFilter === 'ok') {
                        matchesStock = quantiteActuelle > stockMini;
                    }
                    
                    return matchesCategorie && matchesFournisseur && matchesStock;
                });
            } else {
                filteredMatieresPremi√®res = [...activeMP];
            }
            
            filteredInventaire = [...activeMP];
        }
        let categoriesMP = [
            { id: 'cacao', nom: 'Cacao / Chocolat', emoji: 'üç´', actif: true },
            { id: 'sucre', nom: 'Sucres', emoji: 'üç¨', actif: true },
            { id: 'laitier', nom: 'Produits Laitiers', emoji: 'ü•õ', actif: true },
            { id: 'fruits-secs', nom: 'Fruits Secs & Ol√©agineux', emoji: 'üå∞', actif: true },
            { id: 'fruits', nom: 'Fruits & Pur√©es', emoji: 'üçä', actif: true },
            { id: 'epices', nom: '√âpices & Ar√¥mes', emoji: 'üåø', actif: true },
            { id: 'matieres-grasses', nom: 'Mati√®res Grasses', emoji: 'üßà', actif: true },
            { id: 'alcool', nom: 'Alcools & Liqueurs', emoji: 'ü•É', actif: true },
            { id: 'oeufs', nom: 'Oeufs & Ovoproduits', emoji: 'ü•ö', actif: true },
            { id: 'biscuit', nom: 'Biscuits & Croustillants', emoji: 'üç™', actif: true },
            { id: 'additifs', nom: 'Additifs & Auxiliaires', emoji: '‚öóÔ∏è', actif: true },
            { id: 'autre', nom: 'Autre', emoji: 'üì¶', actif: true }
        ];
        
        // ============================================
        // FONCTIONS UTILITAIRES OPTIMIS√âES
        // ============================================
        
        // Obtenir la quantit√© actuelle d'une MP (compatibilit√© snake_case/camelCase)
        function getQuantiteActuelle(mp) {
            return mp.quantite_actuelle ?? mp.quantiteActuelle ?? 0;
        }
        
        // Obtenir la quantit√© initiale d'une MP
        function getQuantiteInitiale(mp) {
            return mp.quantite_initiale ?? mp.quantiteInitiale ?? getQuantiteActuelle(mp);
        }
        
        // Obtenir le stock minimum d'une MP
        function getStockMini(mp) {
            return mp.stock_mini ?? mp.stockMini ?? 0;
        }
        
        // Mettre √† jour la quantit√© d'une MP (met √† jour les deux formats)
        function setQuantiteActuelle(mp, value) {
            mp.quantite_actuelle = value;
            mp.quantiteActuelle = value;
        }
        
        // Obtenir une cat√©gorie par ID
        function getCategorieById(id) {
            return categoriesMP.find(c => c.id === id) || { nom: 'Autre', emoji: 'üì¶' };
        }
        
        // Formater un nombre en euros
        function formatEuros(value) {
            return (value || 0).toFixed(2) + ' ‚Ç¨';
        }
        
        // Formater une quantit√© en kg/g intelligemment
        function formatQuantiteIntelligent(valueKg) {
            const v = valueKg || 0;
            const grams = v * 1000;
            if (v >= 1) {
                return grams.toFixed(0) + ' g (' + v.toFixed(3) + ' kg)';
            } else {
                return grams.toFixed(0) + ' g';
            }
        }
        
        // √âchapper les apostrophes pour les attributs onclick
        function escJS(str) {
            return (str || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }
        
        // Obtenir la quantit√© d'un lot en kg
        function getLotQuantiteKg(lot) {
            if (lot.unite === 'pieces' || lot.unite === 'nombre') return 0;
            const q = lot.quantite || 0;
            if (lot.unite === 'g') return q / 1000;
            // D√©tection anciens lots stock√©s en grammes avec unite 'kg'
            // Un lot artisanal chocolat d√©passe rarement 50 kg
            if (q > 50) return q / 1000;
            return q;
        }
        
        // V√©rifier si une MP est p√©rim√©e
        function isMPPerimee(mp) {
            if (!mp.dlc) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dlcDate = new Date(mp.dlc);
            return dlcDate < today;
        }
        
        // V√©rifier si une MP expire bient√¥t (dans les X jours)
        function isMPExpireSoon(mp, days = 30) {
            if (!mp.dlc) return false;
            const today = new Date();
            const dlcDate = new Date(mp.dlc);
            const diffTime = dlcDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 && diffDays <= days;
        }
        
        // Obtenir les MP actives (non archiv√©es, avec stock > 0)
        function getActiveMPs() {
            return matieresPremi√®res.filter(mp => !mp.archived && getQuantiteActuelle(mp) > 0);
        }
        
        // Obtenir les MP par cat√©gorie
        function getMPsByCategorie(categorieId) {
            return getActiveMPs().filter(mp => mp.categorie === categorieId);
        }
        
        // Fonctions de gestion des modals - D√âCLARATION GLOBALE
        window.closePriceModal = function() {
            const modal = document.getElementById('price-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            console.log('üî¥ Modal prix ferm√©');
        }
        
        window.editPriceFromInventaire = function(id) {
            const mp = matieresPremi√®res.find(m => m.id === id);
            if (!mp) return;
            
            console.log('üîµ Ouverture modal prix pour:', mp.nom);
            
            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            const cout = mp.cout || 0;
            
            document.getElementById('price-mp-id').value = mp.id;
            document.getElementById('price-mp-name').textContent = mp.nom;
            document.getElementById('price-mp-lot').textContent = 'Lot: ' + mp.lot;
            document.getElementById('price-current').textContent = cout.toFixed(2) + ' ‚Ç¨/kg';
            document.getElementById('price-new').value = '';
            
            const modal = document.getElementById('price-modal');
            if (modal) {
                modal.style.display = 'block';
                console.log('‚úÖ Modal prix affich√©');
            } else {
                console.error('‚ùå Modal prix introuvable');
            }
        }
        
        window.adjustStockFromInventaire = function(id) {
            adjustStock(id);
        }
        
        window.savePriceUpdate = async function() {
            const mpId = parseInt(document.getElementById('price-mp-id').value);
            const newPrice = parseFloat(document.getElementById('price-new').value);
            
            if (!newPrice || newPrice < 0) {
                showAlert('Veuillez saisir un prix valide', 'warning');
                return;
            }
            
            const mp = matieresPremi√®res.find(m => m.id === mpId);
            if (!mp) return;
            
            const oldPrice = mp.cout || 0;
            mp.cout = newPrice;
            
            // Sauvegarder dans Supabase
            await saveToSupabase('matieres_premieres', mp, true);
            
            showAlert(`Prix mis √† jour pour "${mp.nom}": ${oldPrice.toFixed(2)} ‚Ç¨ ‚Üí ${newPrice.toFixed(2)} ‚Ç¨/kg`, 'success');
            
            window.closePriceModal();
            
            // Rafra√Æchir les filtres et l'affichage
            refreshAllMPLists();
            displayMatieresPremi√®res();
            displayInventaire();
            updateInventaireStats();
        }

        // ============================================
        // FONCTIONS SUPABASE - SYNCHRONISATION
        // ============================================
        
        // V√©rifier la connexion
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
            showAlert('‚úÖ Connexion internet r√©tablie - Synchronisation automatique...', 'success');
            syncAllData();
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
            showAlert('‚ö†Ô∏è Mode hors-ligne - Les donn√©es seront synchronis√©es √† la reconnexion', 'warning');
        });
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                if (isOnline) {
                    statusElement.innerHTML = 'üü¢ Connect√© Supabase';
                    statusElement.style.color = '#28a745';
                } else {
                    statusElement.innerHTML = 'üî¥ Hors ligne';
                    statusElement.style.color = '#dc3545';
                }
            }
        }
        
        // Charger les donn√©es depuis Supabase
        async function loadFromSupabase() {
            if (!isOnline) {
                console.log('Mode hors-ligne - Chargement depuis localStorage');
                loadFromLocalStorage();
                return;
            }
            
            if (!supabaseClient) {
                console.error('‚ùå Client Supabase non initialis√©');
                showAlert('‚ö†Ô∏è Client Supabase non pr√™t - Chargement local', 'warning');
                loadFromLocalStorage();
                return;
            }
            
            try {
                console.log('üîÑ Connexion √† Supabase...');
                const startTime = performance.now();
                
                // Afficher un indicateur de chargement
                showAlert('üì• Chargement des donn√©es...', 'success');
                
                // ============================================
                // CHARGEMENT PARALL√àLE - BEAUCOUP PLUS RAPIDE !
                // ============================================
                
                const [
                    lotsResult,
                    mpResult,
                    lossesResult,
                    receptionsResult,
                    cqResult,
                    configResult
                ] = await Promise.all([
                    // Lots
                    supabaseClient
                        .from('lots')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false }),
                    
                    // Mati√®res premi√®res
                    supabaseClient
                        .from('matieres_premieres')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false }),
                    
                    // Pertes
                    supabaseClient
                        .from('losses')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false }),
                    
                    // R√©ceptions (sans les photos pour √©viter timeout)
                    supabaseClient
                        .from('receptions')
                        .select('id, date, heure, bon_livraison, fournisseur, temperature, commentaires, statut, created_at')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false })
                        .limit(50),
                    
                    // Contr√¥les qualit√©
                    supabaseClient
                        .from('controles_qualite')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false }),
                    
                    // Configuration
                    supabaseClient
                        .from('configuration')
                        .select('*')
                        .eq('user_id', currentUser.id)
                ]);
                
                const loadTime = Math.round(performance.now() - startTime);
                console.log(`‚ö° Requ√™tes parall√®les termin√©es en ${loadTime}ms`);
                
                // Traiter les r√©sultats
                if (lotsResult.error) throw new Error(`Lots: ${lotsResult.error.message}`);
                lots = lotsResult.data || [];
                console.log('‚úÖ Lots charg√©s:', lots.length);
                
                // Correction auto: lots stock√©s en grammes avec unite 'kg'
                const lotsToFix = lots.filter(l => (!l.unite || l.unite === 'kg') && l.quantite > 50);
                if (lotsToFix.length > 0) {
                    console.log(`üîß Correction auto: ${lotsToFix.length} lot(s) avec quantit√© en grammes`);
                    for (const lot of lotsToFix) {
                        const oldQ = lot.quantite;
                        lot.quantite = lot.quantite / 1000;
                        console.log(`   üîß ${lot.numero}: ${oldQ} ‚Üí ${lot.quantite.toFixed(3)} kg`);
                        // Sauvegarder le lot complet dans Supabase
                        await saveToSupabase('lots', lot, true);
                    }
                    console.log(`‚úÖ ${lotsToFix.length} lot(s) corrig√©(s) dans Supabase`);
                }
                
                if (mpResult.error) throw new Error(`Mati√®res premi√®res: ${mpResult.error.message}`);
                // Normaliser les donn√©es MP
                matieresPremi√®res = (mpResult.data || []).map(mp => ({
                    ...mp,
                    quantiteActuelle: mp.quantite_actuelle ?? 0,
                    quantiteInitiale: mp.quantite_initiale ?? mp.quantite_actuelle ?? 0,
                    stockMini: mp.stock_mini ?? 0,
                    dateReception: mp.date_reception,
                    cout: mp.cout || mp.prix_unitaire || mp.prix || 0,
                    archived: mp.archived ?? false,
                    archived_at: mp.archived_at || null,
                    archived_reason: mp.archived_reason || null
                }));
                console.log('‚úÖ Mati√®res premi√®res charg√©es:', matieresPremi√®res.length);
                
                // Pertes (peut √©chouer si table n'existe pas)
                if (lossesResult.error) {
                    console.warn('‚ö†Ô∏è Table losses:', lossesResult.error.message);
                    losses = [];
                } else {
                    losses = (lossesResult.data || []).map(loss => ({
                        id: loss.id,
                        matierePremiere: loss.matierepremiere,
                        categorie: loss.categorie,
                        lot: loss.lot,
                        fournisseur: loss.fournisseur,
                        quantity: loss.quantity,
                        type: loss.type,
                        reason: loss.reason,
                        date: loss.date,
                        cout: loss.cout,
                        valeurPerte: loss.valeurperte,
                        declaredAt: loss.declaredat || loss.created_at,
                        created_at: loss.created_at
                    }));
                    console.log('‚úÖ Pertes charg√©es:', losses.length);
                }
                
                if (receptionsResult.error) {
                    console.warn('‚ö†Ô∏è R√©ceptions (requ√™te parall√®le √©chou√©e):', receptionsResult.error.message);
                    // Essayer une requ√™te s√©par√©e
                    try {
                        console.log('üîÑ Tentative de chargement s√©par√© des r√©ceptions...');
                        const { data: receptionsData, error: receptionsError } = await supabaseClient
                            .from('receptions')
                            .select('id, date, heure, bon_livraison, fournisseur, temperature, commentaires, statut, created_at')
                            .eq('user_id', currentUser.id)
                            .order('created_at', { ascending: false })
                            .limit(20);
                        
                        if (receptionsError) {
                            console.warn('‚ö†Ô∏è R√©ceptions (2√®me tentative √©chou√©e):', receptionsError.message);
                            // Fallback localStorage
                            const localData = localStorage.getItem('tracabilite_data');
                            if (localData) {
                                const parsed = JSON.parse(localData);
                                receptions = parsed.receptions || [];
                                console.log('üì¶ R√©ceptions charg√©es depuis cache local:', receptions.length);
                            } else {
                                receptions = [];
                            }
                        } else {
                            receptions = receptionsData || [];
                            console.log('‚úÖ R√©ceptions charg√©es (2√®me tentative):', receptions.length);
                        }
                    } catch (e) {
                        console.error('‚ùå Erreur chargement r√©ceptions:', e);
                        receptions = [];
                    }
                } else {
                    receptions = receptionsResult.data || [];
                    console.log('‚úÖ R√©ceptions charg√©es:', receptions.length);
                }
                console.log('‚úÖ R√©ceptions charg√©es:', receptions.length);
                
                if (cqResult.error) throw new Error(`Contr√¥les qualit√©: ${cqResult.error.message}`);
                controlesQualite = cqResult.data || [];
                console.log('‚úÖ Contr√¥les qualit√© charg√©s:', controlesQualite.length);
                
                // Configuration
                if (!configResult.error && configResult.data) {
                    configResult.data.forEach(config => {
                        if (config.type === 'products') productsConfig = config.data || [];
                        else if (config.type === 'settings') generalSettings = config.data || {};
                        else if (config.type === 'categories') categoriesMP = config.data || categoriesMP;
                        else if (config.type === 'recipes') recipesConfig = config.data || [];
                        else if (config.type === 'mp_references') mpRefConfig = config.data || [];
                        else if (config.type === 'label_config') labelConfig = config.data || { defaultSize: 'a5', customFormats: [] };
                    });
                    console.log('‚úÖ Configuration charg√©e');
                } else {
                    productsConfig = [...defaultProductsConfig];
                    recipesConfig = [];
                    mpRefConfig = [];
                    generalSettings = { entreprise: 'Emotions Chocolats - Couthuin, Belgium', stockAlerte: 20 };
                }
                
                // Sauvegarder localement comme backup
                saveToLocalStorage();
                
                const totalTime = Math.round(performance.now() - startTime);
                showAlert(`‚úÖ Donn√©es charg√©es en ${totalTime}ms !`, 'success');
                console.log(`‚úÖ Chargement total termin√© en ${totalTime}ms`);
                
                // Mettre √† jour les s√©lecteurs
                updateCategorieSelects();
                updateProductSelects();
                updateRecipeProductSelects();
                updateRecipeIngredientSelect();
                renderMPRefTable();
                updateMPRefSelects();
                renderCustomLabelTable();
                updateLabelSizeSelects();
                
                // Initialiser les listes filtr√©es AVANT l'affichage
                filteredLots = [...lots];
                filteredReceptions = [...receptions];
                refreshAllMPLists();
                
                // Mettre √† jour toutes les interfaces
                updateStats();
                updateDashboard();
                displayLots();
                displayMatieresPremi√®res();
                displayInventaire();
                displayReceptions();
                checkStockAlerts();
                checkInventaireAlerts();
                updateReceptionFilters();
                updateIngredientsSelect();
                console.log('‚úÖ Toutes les interfaces mises √† jour');
                
            } catch (error) {
                console.error('‚ùå Erreur d√©taill√©e Supabase:', error);
                showAlert(`‚ö†Ô∏è Erreur cloud: ${error.message}\n\nChargement depuis le cache local.`, 'warning');
                
                loadFromLocalStorage();
            }
        }
        
        // Charger les photos des r√©ceptions en arri√®re-plan
        async function loadReceptionPhotosInBackground() {
            if (!supabaseClient || receptions.length === 0) return;
            
            console.log('üì∑ Chargement des photos en arri√®re-plan...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('receptions')
                    .select('id, photos')
                    .eq('user_id', currentUser.id)
                    .not('photos', 'is', null);
                
                if (!error && data) {
                    data.forEach(r => {
                        const reception = receptions.find(rec => rec.id === r.id);
                        if (reception && r.photos) {
                            try {
                                reception.photos = typeof r.photos === 'string' ? JSON.parse(r.photos) : r.photos;
                            } catch (e) {
                                reception.photos = [];
                            }
                        }
                    });
                    console.log('üì∑ Photos charg√©es pour', data.length, 'r√©ceptions');
                    // Rafra√Æchir l'affichage des r√©ceptions si n√©cessaire
                    displayReceptions();
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Erreur chargement photos:', e);
            }
        }
        
        // Sauvegarder dans Supabase
        async function saveToSupabase(table, data, isUpdate = false) {
            console.log(`üíæ saveToSupabase appel√© - Table: ${table}, isUpdate: ${isUpdate}`);
            console.log('üì¶ Donn√©es √† sauvegarder:', data);
            
            if (!isOnline) {
                console.log('‚ö†Ô∏è Mode hors-ligne - Sauvegarde locale uniquement');
                saveToLocalStorage();
                return { success: false, offline: true };
            }
            
            if (!supabaseClient) {
                console.error('‚ùå Client Supabase non initialis√©');
                saveToLocalStorage();
                return { success: false, offline: true };
            }
            
            // Injecter le user_id automatiquement
            if (currentUser && currentUser.id) {
                data.user_id = currentUser.id;
            }
            
            try {
                console.log(`üíæ Tentative de sauvegarde dans ${table}:`, data);
                
                // Convertir les donn√©es en snake_case pour Supabase
                let supabaseData = { ...data };
                
                // Conversion sp√©cifique pour matieres_premieres
                if (table === 'matieres_premieres') {
                    // Garantir que les champs obligatoires ont des valeurs par d√©faut
                    const quantiteActuelle = data.quantite_actuelle ?? data.quantiteActuelle ?? 0;
                    const quantiteInitiale = data.quantite_initiale ?? data.quantiteInitiale ?? quantiteActuelle;
                    const stockMini = data.stock_mini ?? data.stockMini ?? 0;
                    
                    supabaseData = {
                        ...data,
                        quantite_actuelle: quantiteActuelle,
                        quantite_initiale: quantiteInitiale,
                        stock_mini: stockMini,
                        date_reception: data.date_reception || data.dateReception,
                        archived: data.archived ?? false,
                        archived_at: data.archived_at || null,
                        archived_reason: data.archived_reason || null
                    };
                    
                    // Supprimer les versions camelCase
                    delete supabaseData.quantiteActuelle;
                    delete supabaseData.quantiteInitiale;
                    delete supabaseData.stockMini;
                    delete supabaseData.dateReception;
                    
                    console.log('üîç Donn√©es MP converties pour Supabase:', {
                        nom: supabaseData.nom,
                        quantite_actuelle: supabaseData.quantite_actuelle,
                        quantite_initiale: supabaseData.quantite_initiale,
                        stock_mini: supabaseData.stock_mini,
                        archived: supabaseData.archived,
                        archived_at: supabaseData.archived_at,
                        archived_reason: supabaseData.archived_reason
                    });
                }
                
                // Conversion pour autres tables si n√©cessaire
                if (table === 'lots') {
                    // Stocker les donn√©es mixte dans le champ ingredients si c'est une bo√Æte mixte
                    let ingredientsData = data.ingredients;
                    if (data.isMixte && data.mixteLots && data.mixteLots.length > 0) {
                        ingredientsData = {
                            _isMixte: true,
                            _prixVente: data.prixVente || 0,
                            _mixteLots: data.mixteLots
                        };
                    }
                    
                    supabaseData = {
                        id: data.id,
                        user_id: data.user_id,
                        numero: data.numero,
                        produit: data.produit,
                        date: data.date,
                        quantite: data.quantite,
                        unite: data.unite || 'kg',
                        operateur: data.operateur,
                        statut: data.statut || 'production',
                        dlc: data.dlc,
                        cout: data.cout || 0,
                        observations: data.observations || '',
                        ingredients: ingredientsData ? JSON.stringify(ingredientsData) : null,
                        created_at: data.created_at
                    };
                    
                    // Supprimer les champs undefined
                    Object.keys(supabaseData).forEach(key => {
                        if (supabaseData[key] === undefined) {
                            delete supabaseData[key];
                        }
                    });
                    
                    console.log('üîç Donn√©es LOTS converties pour Supabase:', supabaseData);
                }
                
                if (table === 'receptions') {
                    supabaseData = {
                        id: data.id,
                        user_id: data.user_id,
                        date: data.date,
                        heure: data.heure,
                        fournisseur: data.fournisseur,
                        produits: data.produits,
                        temperature: data.temperature,
                        conformite: data.conformite,
                        statut: data.statut || 'recu',
                        notes: data.notes,
                        commentaires: data.commentaires,
                        bon_livraison: data.bon_livraison || data.bonLivraison,
                        numero_lot: data.numero_lot || data.numeroLot,
                        quantite: data.quantite,
                        unite: data.unite,
                        photos: data.photos ? JSON.stringify(data.photos) : null,
                        created_at: data.created_at
                    };
                    
                    // Supprimer les champs undefined pour √©viter les erreurs
                    Object.keys(supabaseData).forEach(key => {
                        if (supabaseData[key] === undefined) {
                            delete supabaseData[key];
                        }
                    });
                    
                    console.log('üîç Donn√©es RECEPTIONS converties pour Supabase:', supabaseData);
                }
                
                if (table === 'controles_qualite') {
                    supabaseData = {
                        ...data,
                        lot_id: data.lot_id || data.lotId,
                        lot_numero: data.lot_numero || data.lotNumero
                    };
                    delete supabaseData.lotId;
                    delete supabaseData.lotNumero;
                }
                
                // Conversion pour la table losses (pertes)
                if (table === 'losses') {
                    supabaseData = {
                        id: data.id,
                        user_id: data.user_id,
                        matierepremiereid: data.matiere_premiere_id || data.matierepremiereid || 0,
                        matierepremiere: data.matiere_premiere || data.matierepremiere || data.nom,
                        categorie: data.categorie,
                        lot: data.lot,
                        fournisseur: data.fournisseur,
                        quantity: data.quantity,
                        type: data.type,
                        reason: data.reason,
                        date: data.date,
                        cout: data.cout || 0,
                        valeurperte: data.valeur_perte || data.valeurperte || (data.quantity * (data.cout || 0)),
                        declaredat: data.declared_at || data.declaredat || new Date().toISOString()
                    };
                    
                    // Supprimer les champs undefined
                    Object.keys(supabaseData).forEach(key => {
                        if (supabaseData[key] === undefined) {
                            delete supabaseData[key];
                        }
                    });
                    
                    console.log('üîç Donn√©es LOSSES converties pour Supabase:', supabaseData);
                }
                
                console.log('üì§ Donn√©es converties pour Supabase:', supabaseData);
                
                let result;
                
                if (isUpdate) {
                    console.log(`üîÑ UPDATE dans ${table} avec id:`, supabaseData.id);
                    const { data: returnedData, error } = await supabaseClient
                        .from(table)
                        .upsert(supabaseData)
                        .select();
                    
                    if (error) {
                        console.error(`‚ùå Erreur UPDATE ${table}:`, error);
                        console.error('D√©tails erreur:', JSON.stringify(error, null, 2));
                        throw error;
                    }
                    result = { data: returnedData, error: null };
                    console.log(`‚úÖ UPDATE r√©ussi dans ${table}:`, returnedData);
                } else {
                    console.log(`‚ûï INSERT dans ${table}`);
                    const { data: returnedData, error } = await supabaseClient
                        .from(table)
                        .insert(supabaseData)
                        .select();
                    
                    if (error) {
                        console.error(`‚ùå Erreur INSERT ${table}:`, error);
                        console.error('D√©tails erreur:', JSON.stringify(error, null, 2));
                        throw error;
                    }
                    result = { data: returnedData, error: null };
                    console.log(`‚úÖ INSERT r√©ussi dans ${table}:`, returnedData);
                }
                
                console.log(`‚úÖ ${table} sauvegard√© dans Supabase avec succ√®s`);
                console.log('Donn√©es retourn√©es:', result.data);
                
                // Sauvegarder aussi localement
                saveToLocalStorage();
                
                return { success: true, data: result.data, offline: false };
                
            } catch (error) {
                console.error('‚ùå ERREUR D√âTAILL√âE de sauvegarde Supabase:');
                console.error('Table:', table);
                console.error('Type:', isUpdate ? 'UPDATE' : 'INSERT');
                console.error('Erreur compl√®te:', error);
                console.error('Message:', error.message || 'Pas de message');
                console.error('Code:', error.code || 'Pas de code');
                console.error('Details:', error.details || 'Pas de d√©tails');
                console.error('Hint:', error.hint || 'Pas de hint');
                
                const errorMessage = error.message || error.hint || 'Erreur inconnue';
                showAlert(`‚ö†Ô∏è Erreur Supabase (${table}): ${errorMessage}\n\nDonn√©es sauvegard√©es localement.\n\nOuvrez la console (F12) pour plus de d√©tails.`, 'warning');
                saveToLocalStorage();
                return { success: false, error, offline: false };
            }
        }
        
        // Supprimer de Supabase
        async function deleteFromSupabase(table, id) {
            if (!isOnline) {
                console.log('Mode hors-ligne - Suppression locale uniquement');
                saveToLocalStorage();
                return { success: true, offline: true };
            }
            
            if (!supabaseClient) {
                console.error('‚ùå Client Supabase non initialis√©');
                saveToLocalStorage();
                return { success: true, offline: true };
            }
            
            try {
                const { error } = await supabaseClient
                    .from(table)
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                saveToLocalStorage();
                return { success: true };
                
            } catch (error) {
                console.error('Erreur de suppression Supabase:', error);
                saveToLocalStorage();
                return { success: false, error };
            }
        }
        
        // Synchronisation manuelle compl√®te
        async function syncAllData() {
            if (!isOnline) {
                showAlert('‚ùå Impossible de synchroniser - Pas de connexion internet', 'danger');
                return;
            }
            
            if (syncInProgress) {
                showAlert('‚è≥ Synchronisation d√©j√† en cours...', 'warning');
                return;
            }
            
            syncInProgress = true;
            showAlert('üîÑ Synchronisation en cours...', 'success');
            
            try {
                // Recharger depuis Supabase
                await loadFromSupabase();
                
                // Mettre √† jour l'interface
                updateStats();
                updateDashboard();
                displayLots();
                displayMatieresPremi√®res();
                displayReceptions();
                
                showAlert('‚úÖ Synchronisation termin√©e avec succ√®s !', 'success');
                
            } catch (error) {
                console.error('Erreur de synchronisation:', error);
                showAlert('‚ùå Erreur lors de la synchronisation', 'danger');
            } finally {
                syncInProgress = false;
            }
        }
        
        // Sauvegarder dans localStorage (backup)
        function saveToLocalStorage() {
            try {
                // Pour les r√©ceptions, ne pas sauvegarder les photos en localStorage (trop lourd)
                // Les photos sont d√©j√† dans Supabase
                const receptionsForStorage = receptions.map(r => ({
                    ...r,
                    photos: [] // Ne pas sauvegarder les photos en localStorage
                }));
                
                localStorage.setItem('chocolaterie_lots', JSON.stringify(lots));
                localStorage.setItem('chocolaterie_mp', JSON.stringify(matieresPremi√®res));
                localStorage.setItem('chocolaterie_receptions', JSON.stringify(receptionsForStorage));
                localStorage.setItem('chocolaterie_cq', JSON.stringify(controlesQualite));
                localStorage.setItem('chocolaterie_losses', JSON.stringify(losses));
                localStorage.setItem('chocolaterie_config', JSON.stringify(productsConfig));
                localStorage.setItem('chocolaterie_settings', JSON.stringify(generalSettings));
                localStorage.setItem('chocolaterie_categories', JSON.stringify(categoriesMP));
                localStorage.setItem('chocolaterie_recipes', JSON.stringify(recipesConfig));
                
                console.log('üíæ Sauvegarde localStorage OK (photos exclues)');
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.warn('‚ö†Ô∏è Quota localStorage d√©pass√© - Les photos sont dans Supabase uniquement');
                    // Essayer de sauvegarder au moins les donn√©es essentielles sans les r√©ceptions
                    try {
                        localStorage.setItem('chocolaterie_lots', JSON.stringify(lots));
                        localStorage.setItem('chocolaterie_mp', JSON.stringify(matieresPremi√®res));
                        localStorage.setItem('chocolaterie_cq', JSON.stringify(controlesQualite));
                        localStorage.setItem('chocolaterie_losses', JSON.stringify(losses));
                        console.log('üíæ Sauvegarde localStorage partielle OK (sans r√©ceptions)');
                    } catch (e) {
                        console.error('‚ùå Impossible de sauvegarder m√™me les donn√©es essentielles:', e);
                    }
                } else {
                    console.error('‚ùå Erreur localStorage:', error);
                }
            }
        }
        
        // Charger depuis localStorage (fallback)
        function loadFromLocalStorage() {
            try {
                console.log('üìÇ Chargement depuis localStorage...');
                lots = JSON.parse(localStorage.getItem('chocolaterie_lots') || '[]');
                matieresPremi√®res = JSON.parse(localStorage.getItem('chocolaterie_mp') || '[]');
                receptions = JSON.parse(localStorage.getItem('chocolaterie_receptions') || '[]');
                controlesQualite = JSON.parse(localStorage.getItem('chocolaterie_cq') || '[]');
                losses = JSON.parse(localStorage.getItem('chocolaterie_losses') || '[]');
                
                const savedConfig = localStorage.getItem('chocolaterie_config');
                const savedSettings = localStorage.getItem('chocolaterie_settings');
                const savedCategories = localStorage.getItem('chocolaterie_categories');
                const savedRecipes = localStorage.getItem('chocolaterie_recipes');
                
                if (savedConfig) {
                    productsConfig = JSON.parse(savedConfig);
                } else {
                    productsConfig = [...defaultProductsConfig];
                }
                
                if (savedSettings) {
                    generalSettings = JSON.parse(savedSettings);
                } else {
                    generalSettings = { 
                        entreprise: 'Emotions Chocolats - Couthuin, Belgium', 
                        stockAlerte: 20 
                    };
                }
                
                if (savedCategories) {
                    categoriesMP = JSON.parse(savedCategories);
                }
                
                if (savedRecipes) {
                    recipesConfig = JSON.parse(savedRecipes);
                } else {
                    recipesConfig = [];
                }
                
                console.log('‚úÖ Chargement localStorage termin√©');
                console.log(`üìä ${lots.length} lots, ${matieresPremi√®res.length} MP, ${receptions.length} r√©ceptions, ${losses.length} pertes`);
                
                // IMPORTANT : Mettre √† jour tous les s√©lecteurs apr√®s le chargement
                setTimeout(() => {
                    console.log('üîÑ Mise √† jour des s√©lecteurs...');
                    updateCategorieSelects();
                    updateProductSelects();
                    updateRecipeProductSelects();
                    updateRecipeIngredientSelect();
                    updateIngredientsSelect();
                    updateReceptionFilters();
                    
                    // IMPORTANT : Initialiser les listes filtr√©es AVANT l'affichage
                    filteredLots = [...lots];
                    filteredReceptions = [...receptions];
                    refreshAllMPLists();
                    
                    // Mettre √† jour les interfaces
                    updateStats();
                    updateDashboard();
                    displayLots();
                    displayMatieresPremi√®res();
                    displayInventaire();
                    displayReceptions();
                    checkStockAlerts();
                    checkInventaireAlerts();
                    
                    console.log('‚úÖ S√©lecteurs mis √† jour');
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Erreur localStorage:', error);
                // Charger la config par d√©faut en cas d'erreur
                productsConfig = [...defaultProductsConfig];
                generalSettings = { 
                    entreprise: 'Emotions Chocolats - Couthuin, Belgium', 
                    stockAlerte: 20 
                };
            }
        }

        // Configuration par d√©faut des produits
        const defaultProductsConfig = [
            { id: 'tablette-noir-70', nom: 'Tablette Noir 70%', dlc: 730, categorie: 'tablette', prix: 42.00, actif: true, description: 'Tablette de chocolat noir 70% de cacao' },
            { id: 'tablette-noir-85', nom: 'Tablette Noir 85%', dlc: 730, categorie: 'tablette', prix: 48.00, actif: true, description: 'Tablette de chocolat noir 85% de cacao' },
            { id: 'tablette-lait-40', nom: 'Tablette Lait 40%', dlc: 548, categorie: 'tablette', prix: 38.00, actif: true, description: 'Tablette de chocolat au lait 40% de cacao' },
            { id: 'truffes-nature', nom: 'Truffes Nature', dlc: 28, categorie: 'truffe', prix: 85.00, actif: true, description: 'Truffes au chocolat nature' },
            { id: 'bonbons-assortis', nom: 'Bonbons Assortis', dlc: 56, categorie: 'bonbon', prix: 65.00, actif: true, description: 'Assortiment de bonbons chocolat' }
        ];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // V√©rifier la session avant d'initialiser l'app
            checkSession().then(() => {
                // L'initialisation se fera dans showApp() si l'utilisateur est connect√©
            });
            
            // Fermer les modales en cliquant en dehors
            window.addEventListener('click', function(event) {
                const editModal = document.getElementById('edit-modal');
                const confirmModal = document.getElementById('confirm-modal');
                const stockModal = document.getElementById('stock-modal');
                const priceModal = document.getElementById('price-modal');
                const photoViewerModal = document.getElementById('photo-viewer-modal');
                const receptionDetailModal = document.getElementById('reception-detail-modal');
                const labelModal = document.getElementById('label-modal');
                const lotDetailModal = document.getElementById('lot-detail-modal');
                const lossModal = document.getElementById('loss-modal');
                
                if (event.target === editModal) {
                    editModal.style.display = 'none';
                }
                if (event.target === confirmModal) {
                    confirmModal.style.display = 'none';
                }
                if (event.target === stockModal) {
                    stockModal.style.display = 'none';
                }
                if (event.target === priceModal) {
                    priceModal.style.display = 'none';
                }
                if (event.target === photoViewerModal) {
                    photoViewerModal.style.display = 'none';
                }
                if (event.target === receptionDetailModal) {
                    receptionDetailModal.style.display = 'none';
                }
                if (event.target === labelModal) {
                    labelModal.style.display = 'none';
                }
                if (event.target === lotDetailModal) {
                    lotDetailModal.style.display = 'none';
                }
                if (event.target === lossModal) {
                    lossModal.style.display = 'none';
                }
            });
        });

        function initializeApp() {
            console.log('üöÄ Initialisation de l\'application...');
            
            // Charger la configuration
            loadConfiguration();
            
            // Charger les donn√©es depuis Supabase
            loadFromSupabase().then(() => {
                // Initialiser les dates
                const today = new Date().toISOString().split('T')[0];
                document.querySelectorAll('input[type="date"]').forEach(input => {
                    if (input.id.includes('production') || input.id.includes('cq-date') || input.id.includes('mp-date-reception')) {
                        input.value = today;
                    }
                });
                
                // G√©n√©rer le num√©ro de lot (avec d√©lai pour s'assurer que le DOM est pr√™t)
                setTimeout(() => {
                    generateLotNumber();
                }, 100);
                
                // Initialiser les √©v√©nements
                setupEventListeners();
                
                // Mettre √† jour l'interface
                updateStats();
                updateDashboard();
                
                // Initialiser les listes
                updateProductSelects();
                updateCategorieSelects();
                updateIngredientsSelect();
                updateEnrobageChocolatSelect(); // Charger les chocolats d'enrobage
                
                // Calculer la DLC initiale si n√©cessaire
                setTimeout(() => {
                    calculateDLC();
                }, 200);
                
                // Initialiser la liste filtr√©e
                filteredLots = [...lots];
                
                // Mettre √† jour le statut de connexion
                updateConnectionStatus();
            });
        }

        function loadConfiguration() {
            if (productsConfig.length === 0) {
                productsConfig = [...defaultProductsConfig];
            }
            if (Object.keys(generalSettings).length === 0) {
                generalSettings = { 
                    entreprise: 'Emotions Chocolats - Couthuin, Belgium', 
                    stockAlerte: 20 
                };
            }
        }

        function setupEventListeners() {
            const searchLots = document.getElementById('search-lots');
            if (searchLots) {
                searchLots.addEventListener('input', debounce(applyLotsFilters, 300));
            }
            
            const searchReceptions = document.getElementById('search-receptions');
            if (searchReceptions) {
                searchReceptions.addEventListener('input', debounce(applyReceptionFilters, 300));
            }
            
            ['filter-produit', 'filter-statut', 'filter-date-debut', 'filter-date-fin'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyLotsFilters);
                }
            });
            
            ['filter-reception-fournisseur', 'filter-reception-date-debut', 'filter-reception-date-fin'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyReceptionFilters);
                }
            });
        }

        // Toggle sections repliables
        function toggleConfigSection(sectionId) {
            const header = document.getElementById('header-' + sectionId);
            const body = document.getElementById('body-' + sectionId);
            if (!header || !body) return;
            header.classList.toggle('collapsed');
            body.classList.toggle('collapsed');
        }

        // Gestion des onglets
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            switch(tabName) {
                case 'nouveau-lot':
                    console.log('üîÑ Ouverture onglet Nouveau Lot');
                    console.log('üì¶ Produits configur√©s:', productsConfig.length);
                    console.log('üì¶ Produits actifs:', productsConfig.filter(p => p.actif).length);
                    updateIngredientsSelect();
                    updateProductSelects(); // S'assurer que les produits sont charg√©s
                    generateLotNumber(); // G√©n√©rer le num√©ro de lot si vide
                    // Calculer la DLC si un produit et une date sont d√©j√† s√©lectionn√©s
                    setTimeout(calculateDLC, 100);
                    break;
                case 'consulter-lots':
                    populateProductFilter();
                    applyLotsFilters();
                    break;
                case 'reception-marchandises':
                    initializeReceptionForm();
                    displayReceptions();
                    updateReceptionFilters();
                    break;
                case 'matieres-premieres':
                    refreshAllMPLists();
                    displayMatieresPremi√®res();
                    checkStockAlerts();
                    updateMPFilters();
                    break;
                case 'inventaire':
                    updateInventaire();
                    break;
                case 'recettes':
                    displayRecipesConfig();
                    updateRecipeProductSelects();
                    updateRecipeIngredientSelect();
                    updateEnrobageChocolatSelect();
                    break;
                case 'configuration':
                    displayProductsConfig();
                    displayCategoriesConfig();
                    loadGeneralSettings();
                    break;
                case 'rapports':
                    updateRapportStats();
                    break;
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'archives':
                    updateArchiveFilters();
                    displayArchives();
                    updateArchivesStats();
                    break;
            }
        }

        function formatQuantite(quantite, unite) {
            if (unite === 'g') {
                return `${(quantite / 1000).toFixed(3)} kg`;
            }
            if (!unite || unite === 'kg') {
                const q = parseFloat(quantite);
                // Correction anciens lots stock√©s en grammes
                if (q > 50) return `${(q / 1000).toFixed(3)} kg`;
                return `${q.toFixed(3)} kg`;
            }
            return `${Math.round(quantite)} pi√®ce${quantite > 1 ? 's' : ''}`;
        }

        // Cr√©ation d'un nouveau lot
        async function createNewLot() {
            const produitSelect = document.getElementById('produit');
            const modeMixte = document.querySelector('input[name="mode-quantite"][value="mixte"]').checked;
            const modeRecette = document.querySelector('input[name="mode-quantite"][value="recette"]').checked;
            
            let produitId, produitText;
            
            if (modeMixte) {
                produitText = document.getElementById('produit-mixte').value.trim();
                produitId = 'mixte-' + Date.now();
                if (!produitText) {
                    showAlert('Veuillez saisir un nom pour la bo√Æte mixte', 'warning');
                    return;
                }
            } else {
                produitId = produitSelect.value;
                produitText = produitSelect.selectedOptions[0] ? produitSelect.selectedOptions[0].text : produitSelect.value;
            }
            
            let quantite, unite, quantiteAffichage, uniteAffichage, nombreRecettes = null;
            
            if (modeRecette) {
                // Mode recette
                nombreRecettes = parseFloat(document.getElementById('nombre-recettes').value);
                
                if (!nombreRecettes || nombreRecettes <= 0) {
                    showAlert('Veuillez saisir un nombre de recettes valide', 'warning');
                    return;
                }
                
                if (!produitId) {
                    showAlert('Veuillez s√©lectionner un produit', 'warning');
                    return;
                }
                
                const recipe = recipesConfig.find(r => r.productId === produitId);
                
                if (!recipe) {
                    showAlert('Aucune recette configur√©e pour ce produit. Utilisez le mode manuel ou cr√©ez une recette.', 'warning');
                    return;
                }
                
                // Calculer la quantit√© √† partir de la recette
                quantite = nombreRecettes * recipe.quantiteBase;
                unite = recipe.uniteBase === 'nombre' ? 'pieces' : recipe.uniteBase;
                quantiteAffichage = quantite;
                uniteAffichage = recipe.uniteBase === 'nombre' ? 'pi√®ce(s)' : recipe.uniteBase;
                
                // Si la recette est en grammes, convertir en kg pour le stockage
                if (recipe.uniteBase === 'g') {
                    quantiteAffichage = quantite;
                    uniteAffichage = 'g';
                    quantite = quantite / 1000;
                    unite = 'kg';
                }
                
            } else if (modeMixte) {
                // Mode bo√Æte mixte - recalculer le r√©sum√©
                updateMixteSummary();
                
                if (currentMixteLots.length === 0) {
                    showAlert('Veuillez s√©lectionner au moins un produit et remplir les quantit√©s', 'warning');
                    return;
                }
                
                // V√©rifier les stocks
                const stockIssues = [];
                const container = document.getElementById('mixte-products-list');
                const products = container._productData || [];
                products.forEach((ps, idx) => {
                    const checkbox = document.getElementById(`mixte-check-${idx}`);
                    if (!checkbox || !checkbox.checked) return;
                    const poidsG = parseFloat(document.getElementById(`mixte-poids-${idx}`).value) || 0;
                    const poidsTotal = poidsG * nbBoites;
                    if (poidsTotal > ps.totalG) {
                        stockIssues.push(`${ps.nom}: demand√© ${poidsTotal}g (${poidsG}g √ó ${nbBoites}), stock ${ps.totalG.toFixed(0)}g`);
                    }
                });
                if (stockIssues.length > 0) {
                    showAlert('Stock insuffisant :\n' + stockIssues.join('\n'), 'danger');
                    return;
                }
                
                const nbBoites = parseInt(document.getElementById('mixte-nb-boites')?.value) || 1;
                const totalPoidsG = currentMixteLots.reduce((s, ml) => s + ml.poidsG, 0);
                const totalPieces = currentMixteLots.reduce((s, ml) => s + ml.pieces, 0);
                
                if (totalPoidsG > 0) {
                    quantite = totalPoidsG / 1000; // Stocker en kg
                    unite = 'kg';
                    quantiteAffichage = totalPoidsG;
                    uniteAffichage = 'g';
                } else {
                    quantite = totalPieces;
                    unite = 'pieces';
                    quantiteAffichage = totalPieces;
                    uniteAffichage = 'pi√®ce(s)';
                }
                
            } else {
                // Mode manuel
                quantite = parseFloat(document.getElementById('quantite').value);
                unite = document.getElementById('unite').value;
                
                if (!quantite || quantite <= 0) {
                    showAlert('Veuillez saisir une quantit√© valide', 'warning');
                    return;
                }
                
                quantiteAffichage = quantite;
                uniteAffichage = unite;
                
                // Si en grammes, convertir en kg pour le stockage
                if (unite === 'g') {
                    quantiteAffichage = quantite;
                    uniteAffichage = 'g';
                    quantite = quantite / 1000;
                    unite = 'kg';
                }
            }
            
            // Validations communes
            if (!modeMixte && !produitId) {
                showAlert('Veuillez s√©lectionner un produit', 'warning');
                return;
            }
            
            const operateur = document.getElementById('operateur').value;
            if (!operateur) {
                showAlert('Veuillez saisir le nom de l\'op√©rateur', 'warning');
                return;
            }
            
            const newLot = {
                numero: document.getElementById('numero-lot').value,
                produit: produitText,
                date: document.getElementById('date-production').value,
                quantite: quantite,
                unite: unite,
                operateur: operateur,
                statut: 'production',
                dlc: document.getElementById('dlc').value,
                cout: document.getElementById('cout-production').value ? parseFloat(document.getElementById('cout-production').value) : 0,
                observations: document.getElementById('observations').value,
                ingredients: modeMixte ? [] : [...currentIngredients],
                nombreRecettes: nombreRecettes,
                isMixte: modeMixte || false,
                mixteLots: modeMixte ? [...currentMixteLots] : [],
                nbBoites: modeMixte ? (parseInt(document.getElementById('mixte-nb-boites')?.value) || 1) : 0,
                prixVente: modeMixte ? (parseFloat(document.getElementById('mixte-prix-vente')?.value) || 0) : 0
            };
            
            // DEBUG
            console.log('üîÑ Cr√©ation du lot:', newLot.numero);
            if (modeMixte) {
                console.log('üì¶ Mode Bo√Æte Mixte:', currentMixteLots.length, 'lots sources');
            } else {
                console.log('üîÑ Quantit√©:', quantiteAffichage, uniteAffichage, modeRecette ? `(${nombreRecettes} recette(s))` : '(mode manuel)');
            }
            
            // Sauvegarder le lot dans Supabase
            const result = await saveToSupabase('lots', newLot, false);
            
            let saveStatus = '';
            if (result.success && result.data) {
                newLot.id = result.data[0].id;
                newLot.created_at = result.data[0].created_at;
                saveStatus = ' ‚úÖ [Synchronis√© Supabase ‚òÅÔ∏è]';
                console.log('‚úÖ Lot sauvegard√© dans Supabase avec ID:', newLot.id);
            } else if (result.offline) {
                newLot.id = Date.now();
                saveStatus = ' ‚ö†Ô∏è [Sauvegard√© localement - Sync √† la reconnexion]';
                console.log('‚ö†Ô∏è Mode hors-ligne - Lot sauvegard√© localement');
            } else {
                newLot.id = Date.now();
                saveStatus = ' ‚ö†Ô∏è [Erreur Supabase - Sauvegard√© localement]';
                console.error('‚ùå Erreur sauvegarde Supabase:', result.error);
            }
            
            lots.unshift(newLot);
            
            // D√©duire les stocks
            if (modeMixte && currentMixteLots.length > 0) {
                // Mode mixte: d√©duire les quantit√©s des lots sources
                console.log('üì¶ D√©duction stocks lots sources:', currentMixteLots.length, 'lot(s)');
                for (const ml of currentMixteLots) {
                    const sourceLot = lots.find(l => l.id === ml.lotId);
                    if (sourceLot) {
                        const oldQty = sourceLot.quantite;
                        sourceLot.quantite = Math.max(0, sourceLot.quantite - ml.poidsKg);
                        console.log(`   üì¶ Lot ${ml.lotNumero}: ${(oldQty*1000).toFixed(0)}g ‚Üí ${(sourceLot.quantite*1000).toFixed(0)}g (-${ml.poidsG}g)`);
                        await saveToSupabase('lots', sourceLot, true);
                    }
                }
            } else if (currentIngredients.length > 0) {
                // Mode recette/manuel: d√©duire les ingr√©dients du stock
                console.log('üì¶ Mise √† jour des stocks pour', currentIngredients.length, 'ingr√©dient(s)');
                await updateStockFromIngredientsAndSave(currentIngredients);
            }
            
            let ingredientsText, quantiteMsg;
            if (modeMixte) {
                const totalPieces = currentMixteLots.reduce((s, ml) => s + ml.pieces, 0);
                const totalPoidsG = currentMixteLots.reduce((s, ml) => s + ml.poidsG, 0);
                const nbBoitesMsg = nbBoites > 1 ? ` (${nbBoites} bo√Ætes)` : '';
                ingredientsText = `\nüì¶ ${currentMixteLots.length} lot(s) source(s)${nbBoitesMsg}`;
                ingredientsText += currentMixteLots.map(ml => `\n   ‚Ä¢ ${ml.produit} (${ml.lotNumero}): ${ml.pieces > 0 ? ml.pieces + ' pcs' : ''} ${ml.poidsG > 0 ? ml.poidsG.toFixed(0) + 'g' : ''}`).join('');
                quantiteMsg = nbBoites > 1 
                    ? `${nbBoites} bo√Ætes √ó ${(totalPoidsG/nbBoites).toFixed(0)}g = ${totalPoidsG.toFixed(0)}g total`
                    : `${totalPieces} pi√®ces, ${totalPoidsG.toFixed(0)}g`;
            } else {
                ingredientsText = currentIngredients.length > 0 ? `\nüì¶ ${currentIngredients.length} ingr√©dient(s) utilis√©(s)` : '';
                if (modeRecette) {
                    quantiteMsg = `${nombreRecettes} recette(s) = ${quantiteAffichage} ${uniteAffichage}`;
                } else {
                    quantiteMsg = uniteAffichage === 'g' ? `${quantiteAffichage}g (${quantite.toFixed(3)} kg)` : `${quantite} ${unite}`;
                }
            }
            
            // Calculer le co√ªt de production au kg (bas√© sur le poids total des ingr√©dients)
            let coutInfo = '';
            const coutTotal = newLot.cout || 0;
            const totalIngredientsKg = currentIngredients.reduce((sum, ing) => sum + (ing.quantiteUtilisee || 0), 0);
            if (coutTotal > 0 && totalIngredientsKg > 0) {
                const coutParKg = coutTotal / totalIngredientsKg;
                coutInfo = `\nüí∞ Co√ªt: ${coutTotal.toFixed(2)} ‚Ç¨ (${coutParKg.toFixed(2)} ‚Ç¨/kg)`;
            }
            showAlert(`‚úÖ Lot ${newLot.numero} cr√©√© avec succ√®s !\nüìä Quantit√©: ${quantiteMsg}${ingredientsText}${coutInfo}${saveStatus}`, 'success');
            
            // Proposer l'impression de l'√©tiquette
            setTimeout(() => {
                showPrintLabelOption(newLot.id);
            }, 500);
            
            resetForm();
            updateStats();
            updateDashboard();
            filteredLots = [...lots];  // Mettre √† jour les lots filtr√©s AVANT l'affichage
            displayLots();  // Rafra√Æchir la liste des lots
            populateProductFilter();  // Mettre √† jour le filtre des produits
            generateLotNumber();
            displayMatieresPremi√®res();
            checkStockAlerts();
            updateIngredientsSelect();
        }

        async function updateStockFromIngredientsAndSave(ingredients) {
            for (const ingredient of ingredients) {
                const mp = matieresPremi√®res.find(m => m.id === ingredient.matierePremiereId);
                if (mp) {
                    // Compatibilit√© snake_case et camelCase
                    const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                    const newQuantite = Math.max(0, quantiteActuelle - ingredient.quantiteUtilisee);
                    
                    // Mettre √† jour les deux formats
                    mp.quantite_actuelle = newQuantite;
                    mp.quantiteActuelle = newQuantite;
                    
                    // Sauvegarder dans Supabase
                    console.log(`üíæ Sauvegarde stock ${mp.nom}: ${quantiteActuelle.toFixed(1)}kg ‚Üí ${newQuantite.toFixed(1)}kg`);
                    await saveToSupabase('matieres_premieres', mp, true);
                }
            }
        }

        function updateIngredientsSelect() {
            const select = document.getElementById('ingredient-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choisir une mati√®re premi√®re</option>';
            
            // Grouper les MP par NOM (pas par lot) pour le FIFO
            const mpByName = {};
            
            matieresPremi√®res.forEach(mp => {
                if (mp.archived) return;
                
                const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                if (quantiteActuelle <= 0) return;
                
                const key = (mp.nom || '').toLowerCase().trim()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                if (!mpByName[key]) {
                    mpByName[key] = {
                        nom: mp.nom,
                        categorie: mp.categorie || 'autre',
                        fournisseur: mp.fournisseur,
                        stockTotal: 0,
                        lots: []
                    };
                }
                
                mpByName[key].stockTotal += quantiteActuelle;
                mpByName[key].lots.push({
                    id: mp.id,
                    lot: mp.lot,
                    quantite: quantiteActuelle,
                    dlc: mp.dlc,
                    dateReception: mp.date_reception || mp.dateReception
                });
            });
            
            // Trier les lots par date de r√©ception (FIFO - plus ancien en premier)
            Object.values(mpByName).forEach(mpGroup => {
                mpGroup.lots.sort((a, b) => {
                    const dateA = new Date(a.dateReception || '2000-01-01');
                    const dateB = new Date(b.dateReception || '2000-01-01');
                    return dateA - dateB;
                });
            });
            
            // Grouper par cat√©gorie pour l'affichage
            const categories = {};
            categoriesMP.filter(cat => cat.actif).forEach(cat => {
                categories[cat.id] = [];
            });
            
            Object.values(mpByName).forEach(mpGroup => {
                const categorie = mpGroup.categorie;
                if (!categories[categorie]) {
                    categories[categorie] = [];
                }
                categories[categorie].push(mpGroup);
            });
            
            // Ajouter les options group√©es par cat√©gorie
            categoriesMP
                .filter(cat => cat.actif)
                .forEach(cat => {
                    if (categories[cat.id] && categories[cat.id].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `${cat.emoji} ${cat.nom}`;
                        
                        // Trier par nom
                        categories[cat.id].sort((a, b) => a.nom.localeCompare(b.nom));
                        
                        categories[cat.id].forEach(mpGroup => {
                            const stockGrams = (mpGroup.stockTotal * 1000).toFixed(0);
                            const nbLots = mpGroup.lots.length;
                            const option = document.createElement('option');
                            option.value = mpGroup.nom; // Utiliser le nom comme valeur (pas l'ID)
                            option.dataset.category = mpGroup.categorie;
                            
                            if (nbLots > 1) {
                                option.textContent = `${mpGroup.nom} (${stockGrams}g total - ${nbLots} lots FIFO)`;
                            } else {
                                option.textContent = `${mpGroup.nom} - Lot: ${mpGroup.lots[0].lot} (${stockGrams}g)`;
                            }
                            optgroup.appendChild(option);
                        });
                        
                        select.appendChild(optgroup);
                    }
                });
        }

        // Fonction FIFO pour obtenir les lots d'une MP tri√©s par anciennet√©
        function getMPLotsFIFO(mpNameOrId) {
            let lots = [];
            let mpName = null;
            
            // Si c'est un ID (nombre), trouver d'abord le nom de cette MP
            if (typeof mpNameOrId === 'number' || (typeof mpNameOrId === 'string' && !isNaN(parseInt(mpNameOrId)) && mpNameOrId.match(/^\d+$/))) {
                const mpId = parseInt(mpNameOrId);
                const mpRef = matieresPremi√®res.find(mp => mp.id === mpId);
                
                if (mpRef) {
                    mpName = mpRef.nom;
                    
                    // Chercher TOUS les lots avec ce nom (pas seulement cet ID)
                    lots = matieresPremi√®res
                        .filter(mp => {
                            if (mp.archived) return false;
                            return mp.nom === mpName;
                        })
                        .filter(mp => (mp.quantite_actuelle || mp.quantiteActuelle || 0) > 0);
                }
            }
            
            // Si pas trouv√© par ID, chercher par nom
            if (lots.length === 0 && typeof mpNameOrId === 'string') {
                // Fonction de normalisation compl√®te
                const normalizeString = (str) => {
                    return str
                        .toLowerCase()
                        .trim()
                        .replace(/\s+/g, ' ')  // Espaces multiples ‚Üí simple
                        .replace(/['']/g, "'")  // Apostrophes courbes ‚Üí droites
                        .replace(/[""]/g, '"')  // Guillemets courbes ‚Üí droits
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // Retirer accents
                };
                
                const mpNameNormalized = normalizeString(mpNameOrId);
                
                // √âtape 1: Chercher correspondance EXACTE (non archiv√©es avec stock > 0)
                lots = matieresPremi√®res
                    .filter(mp => {
                        if (mp.archived) return false;
                        const nomNormalized = normalizeString(mp.nom || '');
                        return nomNormalized === mpNameNormalized;
                    })
                    .filter(mp => (mp.quantite_actuelle || mp.quantiteActuelle || 0) > 0);
                
                // √âtape 2: Si pas trouv√©, chercher correspondance PARTIELLE (le nom de la MP COMMENCE par le nom recherch√©)
                if (lots.length === 0) {
                    lots = matieresPremi√®res
                        .filter(mp => {
                            if (mp.archived) return false;
                            const nomNormalized = normalizeString(mp.nom || '');
                            return nomNormalized.startsWith(mpNameNormalized);
                        })
                        .filter(mp => (mp.quantite_actuelle || mp.quantiteActuelle || 0) > 0);
                }
                
                // √âtape 3: Si toujours pas trouv√©, chercher si le nom recherch√© CONTIENT ou EST CONTENU dans le nom de la MP
                if (lots.length === 0) {
                    lots = matieresPremi√®res
                        .filter(mp => {
                            if (mp.archived) return false;
                            const nomNormalized = normalizeString(mp.nom || '');
                            return nomNormalized.includes(mpNameNormalized) || mpNameNormalized.includes(nomNormalized);
                        })
                        .filter(mp => (mp.quantite_actuelle || mp.quantiteActuelle || 0) > 0);
                }
            }
            
            // Mapper et trier par date FIFO
            return lots
                .map(mp => ({
                    id: mp.id,
                    nom: mp.nom,
                    lot: mp.lot,
                    fournisseur: mp.fournisseur,
                    categorie: mp.categorie,
                    quantite: mp.quantite_actuelle || mp.quantiteActuelle || 0,
                    dlc: mp.dlc,
                    dateReception: mp.date_reception || mp.dateReception,
                    cout: mp.cout || 0
                }))
                .sort((a, b) => {
                    const dateA = new Date(a.dateReception || '2000-01-01');
                    const dateB = new Date(b.dateReception || '2000-01-01');
                    return dateA - dateB;
                });
        }

        function addIngredient() {
            const mpName = document.getElementById('ingredient-select').value;
            const quantityInput = parseFloat(document.getElementById('ingredient-quantity').value);
            const unite = document.getElementById('ingredient-quantity-unite').value;
            
            if (!mpName || !quantityInput || quantityInput <= 0) {
                showAlert('Veuillez s√©lectionner une mati√®re premi√®re et saisir une quantit√© valide', 'warning');
                return;
            }
            
            // Convertir en kg selon l'unit√© choisie
            let quantityNeeded;
            let quantityGrams;
            if (unite === 'kg') {
                quantityNeeded = quantityInput; // D√©j√† en kg
                quantityGrams = quantityInput * 1000;
            } else {
                quantityNeeded = quantityInput / 1000; // Convertir g en kg
                quantityGrams = quantityInput;
            }
            
            // Obtenir tous les lots disponibles pour cette MP (tri√©s FIFO)
            const availableLots = getMPLotsFIFO(mpName);
            
            if (availableLots.length === 0) {
                showAlert(`Mati√®re premi√®re "${mpName}" non trouv√©e ou stock √©puis√©`, 'danger');
                return;
            }
            
            // Calculer le stock total disponible
            const totalStock = availableLots.reduce((sum, lot) => sum + lot.quantite, 0);
            
            if (quantityNeeded > totalStock) {
                showAlert(`Quantit√© insuffisante !\n\nDemand√©: ${quantityGrams.toFixed(0)}g (${quantityNeeded.toFixed(3)}kg)\nStock disponible: ${(totalStock * 1000).toFixed(0)}g (${totalStock.toFixed(3)}kg)`, 'danger');
                return;
            }
            
            // Appliquer le FIFO - prendre sur les lots les plus anciens d'abord
            let remainingQuantity = quantityNeeded;
            const lotsUsed = [];
            
            for (const lot of availableLots) {
                if (remainingQuantity <= 0) break;
                
                const quantityFromThisLot = Math.min(remainingQuantity, lot.quantite);
                
                if (quantityFromThisLot > 0) {
                    // R√©cup√©rer le co√ªt unitaire de la MP (‚Ç¨/kg)
                    const coutUnitaire = lot.cout || 0;
                    const coutIngredient = quantityFromThisLot * coutUnitaire;
                    
                    // V√©rifier si ce lot est d√©j√† dans les ingr√©dients
                    const existingIndex = currentIngredients.findIndex(ing => ing.matierePremiereId === lot.id);
                    
                    if (existingIndex >= 0) {
                        currentIngredients[existingIndex].quantiteUtilisee += quantityFromThisLot;
                        currentIngredients[existingIndex].coutTotal += coutIngredient;
                    } else {
                        currentIngredients.push({
                            matierePremiereId: lot.id,
                            matierePremiereNom: lot.nom,
                            matierePremiereCategorie: lot.categorie || 'autre',
                            matierePremiereLot: lot.lot,
                            matierePremiereFournisseur: lot.fournisseur,
                            quantiteUtilisee: quantityFromThisLot,
                            coutUnitaire: coutUnitaire,
                            coutTotal: coutIngredient
                        });
                    }
                    
                    lotsUsed.push({
                        lot: lot.lot,
                        quantite: quantityFromThisLot,
                        cout: coutIngredient
                    });
                    
                    remainingQuantity -= quantityFromThisLot;
                }
            }
            
            updateIngredientsDisplay();
            
            // R√©initialiser les champs
            document.getElementById('ingredient-select').value = '';
            document.getElementById('ingredient-quantity').value = '';
            
            // Calculer le co√ªt total ajout√©
            const coutAjoute = lotsUsed.reduce((sum, l) => sum + l.cout, 0);
            
            // Message de confirmation avec d√©tail FIFO
            if (lotsUsed.length === 1) {
                showAlert(`‚úÖ ${quantityGrams}g de ${mpName} ajout√© (${coutAjoute.toFixed(2)} ‚Ç¨)\n\nüì¶ Lot: ${lotsUsed[0].lot}`, 'success');
            } else {
                const lotsDetail = lotsUsed.map(l => `‚Ä¢ Lot ${l.lot}: ${(l.quantite * 1000).toFixed(0)}g (${l.cout.toFixed(2)} ‚Ç¨)`).join('\n');
                showAlert(`‚úÖ ${quantityGrams}g de ${mpName} ajout√© (${coutAjoute.toFixed(2)} ‚Ç¨)\n\nüì¶ R√©partition FIFO sur ${lotsUsed.length} lots:\n${lotsDetail}`, 'success');
            }
        }
        
        // Fonction pour charger automatiquement la recette d'un produit avec FIFO
        function loadRecipeForProduct() {
            const produitSelect = document.getElementById('produit');
            const productId = produitSelect.value;
            
            if (!productId) {
                showAlert('Veuillez d\'abord s√©lectionner un produit', 'warning');
                return;
            }
            
            // Chercher la recette pour ce produit
            const recipe = recipesConfig.find(r => r.productId === productId);
            
            if (!recipe) {
                showAlert('‚ùå Aucune recette configur√©e pour ce produit\n\nVeuillez d\'abord cr√©er une recette dans l\'onglet Configuration.', 'warning');
                return;
            }
            
            // V√©rifier qu'une quantit√© est saisie
            const quantite = parseFloat(document.getElementById('quantite').value);
            if (!quantite || quantite <= 0) {
                showAlert('Veuillez saisir la quantit√© √† produire avant de charger la recette', 'warning');
                return;
            }
            
            // Effacer les ingr√©dients actuels
            currentIngredients = [];
            
            // Calculer le ratio entre la quantit√© √† produire et la quantit√© de base de la recette
            // Normaliser : si la recette est en grammes, convertir en kg pour le ratio
            const recipeBaseKg = recipe.uniteBase === 'g' ? recipe.quantiteBase / 1000 : recipe.quantiteBase;
            const ratio = quantite / recipeBaseKg;
            
            let addedCount = 0;
            let missingMPs = [];
            let insufficientMPs = [];
            let fifoDetails = [];
            
            // Pour chaque ingr√©dient de la recette
            for (const recipeIng of recipe.ingredients) {
                // Calculer la quantit√© n√©cessaire selon le ratio
                const quantityNeeded = recipeIng.quantity * ratio;
                
                console.log(`üîç Recherche ingr√©dient: "${recipeIng.mpNom}" (besoin: ${(quantityNeeded * 1000).toFixed(0)}g)`);
                
                // Utiliser le FIFO : obtenir tous les lots disponibles pour ce nom de MP
                const availableLots = getMPLotsFIFO(recipeIng.mpNom);
                
                if (availableLots.length === 0) {
                    console.log(`   ‚ùå AUCUN LOT trouv√© pour "${recipeIng.mpNom}"`);
                    console.log(`   üìã MPs disponibles similaires:`, matieresPremi√®res
                        .filter(mp => !mp.archived && (mp.quantite_actuelle || mp.quantiteActuelle || 0) > 0)
                        .map(mp => mp.nom)
                        .filter(nom => nom.toLowerCase().includes(recipeIng.mpNom.toLowerCase().split(' ')[0]))
                    );
                    missingMPs.push(recipeIng.mpNom);
                    continue;
                }
                
                console.log(`   ‚úÖ ${availableLots.length} lot(s) trouv√©(s):`, availableLots.map(l => `${l.lot} (${(l.quantite * 1000).toFixed(0)}g)`));
                
                // Calculer le stock total disponible
                const totalStock = availableLots.reduce((sum, lot) => sum + lot.quantite, 0);
                
                if (quantityNeeded > totalStock) {
                    insufficientMPs.push({
                        nom: recipeIng.mpNom,
                        needed: quantityNeeded,
                        available: totalStock
                    });
                }
                
                // Appliquer le FIFO - prendre sur les lots les plus anciens d'abord
                let remainingQuantity = Math.min(quantityNeeded, totalStock);
                const lotsUsedForThisMP = [];
                
                for (const lot of availableLots) {
                    if (remainingQuantity <= 0) break;
                    
                    const quantityFromThisLot = Math.min(remainingQuantity, lot.quantite);
                    
                    if (quantityFromThisLot > 0) {
                        // R√©cup√©rer le co√ªt unitaire de la MP (‚Ç¨/kg)
                        const coutUnitaire = lot.cout || 0;
                        const coutIngredient = quantityFromThisLot * coutUnitaire;
                        
                        // V√©rifier si ce lot est d√©j√† dans les ingr√©dients
                        const existingIndex = currentIngredients.findIndex(ing => ing.matierePremiereId === lot.id);
                        
                        if (existingIndex >= 0) {
                            currentIngredients[existingIndex].quantiteUtilisee += quantityFromThisLot;
                            currentIngredients[existingIndex].coutTotal = (currentIngredients[existingIndex].coutTotal || 0) + coutIngredient;
                        } else {
                            currentIngredients.push({
                                matierePremiereId: lot.id,
                                matierePremiereNom: lot.nom,
                                matierePremiereCategorie: lot.categorie || 'autre',
                                matierePremiereLot: lot.lot,
                                matierePremiereFournisseur: lot.fournisseur,
                                quantiteUtilisee: quantityFromThisLot,
                                coutUnitaire: coutUnitaire,
                                coutTotal: coutIngredient
                            });
                        }
                        
                        lotsUsedForThisMP.push({
                            lot: lot.lot,
                            quantite: quantityFromThisLot
                        });
                        
                        remainingQuantity -= quantityFromThisLot;
                    }
                }
                
                if (lotsUsedForThisMP.length > 1) {
                    fifoDetails.push({
                        nom: recipeIng.mpNom,
                        lots: lotsUsedForThisMP
                    });
                }
                
                addedCount++;
            }
            
            // ========== TRAITEMENT DU CHOCOLAT D'ENROBAGE ==========
            let enrobageInfo = '';
            if (recipe.enrobage && recipe.enrobage.chocolat && recipe.enrobage.grammage > 0) {
                // Utiliser le nombre de pi√®ces stock√© dans la recette
                let nombrePiecesBase = recipe.enrobage.nombrePieces;
                
                // FALLBACK : Si nombrePieces n'existe pas dans la recette (anciennes recettes)
                if (!nombrePiecesBase) {
                    if (recipe.uniteBase === 'nombre') {
                        // Si unit√© = nombre, utiliser quantiteBase
                        nombrePiecesBase = recipe.quantiteBase;
                    } else {
                        // Si unit√© = kg, assumer 1 pi√®ce par unit√© (pas id√©al mais mieux que rien)
                        nombrePiecesBase = recipe.quantiteBase;
                        console.warn(`‚ö†Ô∏è Recette "${recipe.productName}" : nombrePieces manquant pour l'enrobage. Utilisation de quantiteBase (${nombrePiecesBase}). Veuillez re-sauvegarder la recette pour corriger.`);
                    }
                }
                
                // Calculer le nombre de pi√®ces r√©el selon le ratio de production
                let nombrePieces = nombrePiecesBase * ratio;
                
                console.log(`üç´ Enrobage: ${recipe.enrobage.grammage}g √ó ${nombrePieces.toFixed(0)} pi√®ces = ${(recipe.enrobage.grammage * nombrePieces).toFixed(0)}g`);
                
                // Calculer la quantit√© d'enrobage n√©cessaire (grammage en g √ó nombre de pi√®ces ‚Üí convertir en kg)
                const quantiteEnrobageKg = (recipe.enrobage.grammage * nombrePieces) / 1000;
                
                // Chercher le chocolat d'enrobage dans le stock
                const enrobageLots = getMPLotsFIFO(recipe.enrobage.chocolat);
                
                if (enrobageLots.length === 0) {
                    missingMPs.push(`${recipe.enrobage.chocolat} (enrobage)`);
                } else {
                    // Calculer le stock total disponible
                    const totalStockEnrobage = enrobageLots.reduce((sum, lot) => sum + lot.quantite, 0);
                    
                    if (quantiteEnrobageKg > totalStockEnrobage) {
                        insufficientMPs.push({
                            nom: `${recipe.enrobage.chocolat} (enrobage)`,
                            needed: quantiteEnrobageKg,
                            available: totalStockEnrobage
                        });
                    }
                    
                    // Appliquer le FIFO pour l'enrobage
                    let remainingEnrobage = Math.min(quantiteEnrobageKg, totalStockEnrobage);
                    const lotsUsedForEnrobage = [];
                    
                    for (const lot of enrobageLots) {
                        if (remainingEnrobage <= 0) break;
                        
                        const quantityFromThisLot = Math.min(remainingEnrobage, lot.quantite);
                        
                        if (quantityFromThisLot > 0) {
                            const coutUnitaire = lot.cout || 0;
                            const coutIngredient = quantityFromThisLot * coutUnitaire;
                            
                            // V√©rifier si ce lot est d√©j√† dans les ingr√©dients
                            const existingIndex = currentIngredients.findIndex(ing => ing.matierePremiereId === lot.id);
                            
                            if (existingIndex >= 0) {
                                currentIngredients[existingIndex].quantiteUtilisee += quantityFromThisLot;
                                currentIngredients[existingIndex].coutTotal = (currentIngredients[existingIndex].coutTotal || 0) + coutIngredient;
                            } else {
                                currentIngredients.push({
                                    matierePremiereId: lot.id,
                                    matierePremiereNom: lot.nom,
                                    matierePremiereCategorie: lot.categorie || 'cacao',
                                    matierePremiereLot: lot.lot,
                                    matierePremiereFournisseur: lot.fournisseur,
                                    quantiteUtilisee: quantityFromThisLot,
                                    coutUnitaire: coutUnitaire,
                                    coutTotal: coutIngredient,
                                    isEnrobage: true // Marqueur pour identifier l'enrobage
                                });
                            }
                            
                            lotsUsedForEnrobage.push({
                                lot: lot.lot,
                                quantite: quantityFromThisLot
                            });
                            
                            remainingEnrobage -= quantityFromThisLot;
                        }
                    }
                    
                    if (lotsUsedForEnrobage.length > 0) {
                        addedCount++;
                        enrobageInfo = `\nüç´ Enrobage: ${recipe.enrobage.chocolat} - ${(quantiteEnrobageKg * 1000).toFixed(0)}g (${recipe.enrobage.grammage}g √ó ${Math.round(nombrePieces)} pi√®ces)`;
                        
                        if (lotsUsedForEnrobage.length > 1) {
                            fifoDetails.push({
                                nom: `${recipe.enrobage.chocolat} (enrobage)`,
                                lots: lotsUsedForEnrobage
                            });
                        }
                    }
                }
            }
            // ========== FIN TRAITEMENT ENROBAGE ==========
            
            updateIngredientsDisplay();
            
            // Construire le message de r√©sultat
            let message = `‚úÖ Recette charg√©e avec FIFO automatique !\n\n`;
            message += `üì¶ Produit : ${recipe.productName}\n`;
            message += `‚öñÔ∏è Quantit√© √† produire : ${quantite} ${recipe.uniteBase === 'nombre' ? 'pi√®ces' : recipe.uniteBase || 'kg'}\n`;
            message += `üßÑ ${addedCount} ingr√©dient(s) ajout√©(s)`;
            message += enrobageInfo;
            message += `\n`;
            
            if (fifoDetails.length > 0) {
                message += `\nüìã R√©partition FIFO :\n`;
                fifoDetails.forEach(detail => {
                    message += `‚Ä¢ ${detail.nom}: ${detail.lots.map(l => `${l.lot} (${(l.quantite * 1000).toFixed(0)}g)`).join(' + ')}\n`;
                });
            }
            
            if (missingMPs.length > 0) {
                message += `\n‚ö†Ô∏è Mati√®res premi√®res manquantes :\n${missingMPs.join(', ')}`;
            }
            
            if (insufficientMPs.length > 0) {
                message += `\n‚ö†Ô∏è Stock insuffisant pour :\n`;
                insufficientMPs.forEach(mp => {
                    message += `‚Ä¢ ${mp.nom}: besoin ${(mp.needed * 1000).toFixed(0)}g, dispo ${(mp.available * 1000).toFixed(0)}g\n`;
                });
            }
            
            if (missingMPs.length > 0 || insufficientMPs.length > 0) {
                message += `\nüí° Vous pouvez ajuster les quantit√©s manuellement.`;
                showAlert(message, 'warning');
            } else {
                message += `\n‚úÖ Tous les ingr√©dients sont disponibles en quantit√© suffisante !`;
                showAlert(message, 'success');
            }
        }

        function updateIngredientsDisplay() {
            const container = document.getElementById('ingredients-list');
            const emptyMessage = document.getElementById('ingredients-empty');
            const totalDiv = document.getElementById('ingredients-total');
            const totalWeight = document.getElementById('total-ingredients-weight');
            const totalCout = document.getElementById('total-ingredients-cout');
            const coutProductionInput = document.getElementById('cout-production');
            
            // IMPORTANT : Supprimer tous les anciens ingr√©dients affich√©s
            const oldIngredients = container.querySelectorAll('.ingredient-item');
            oldIngredients.forEach(item => item.remove());
            
            if (currentIngredients.length === 0) {
                emptyMessage.style.display = 'block';
                totalDiv.style.display = 'none';
                return;
            }
            
            emptyMessage.style.display = 'none';
            totalDiv.style.display = 'block';
            
            const totalKg = currentIngredients.reduce((sum, ing) => sum + ing.quantiteUtilisee, 0);
            const totalGrams = totalKg * 1000;
            const totalCoutValue = currentIngredients.reduce((sum, ing) => sum + (ing.coutTotal || 0), 0);
            
            totalWeight.textContent = totalGrams.toFixed(0) + 'g (' + totalKg.toFixed(3) + ' kg)';
            if (totalCout) {
                if (totalKg > 0) {
                    totalCout.innerHTML = `${totalCoutValue.toFixed(2)} ‚Ç¨ <span style="font-size: 14px; color: #666;">(${(totalCoutValue / totalKg).toFixed(2)} ‚Ç¨/kg)</span>`;
                } else {
                    totalCout.textContent = totalCoutValue.toFixed(2);
                }
            }
            
            // Auto-remplir le champ co√ªt de production avec le co√ªt des ingr√©dients
            if (coutProductionInput && totalCoutValue > 0) {
                coutProductionInput.value = totalCoutValue.toFixed(2);
            }
            
            const ingredientsHTML = currentIngredients.map((ingredient, index) => {
                const gramsUsed = ingredient.quantiteUtilisee * 1000;
                const coutDisplay = (ingredient.coutTotal || 0).toFixed(2);
                const coutUnitaireDisplay = (ingredient.coutUnitaire || 0).toFixed(2);
                
                return `
                <div class="ingredient-item" style="display: flex; flex-direction: column; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #D2691E;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span class="lot-status" style="font-size: 11px; padding: 3px 8px;">${getCategorieLabel(ingredient.matierePremiereCategorie || 'autre')}</span>
                                <strong style="font-size: 15px;">${ingredient.matierePremiereNom}</strong>
                                <span style="font-size: 11px; color: #888;">(${coutUnitaireDisplay} ‚Ç¨/kg)</span>
                            </div>
                            <div style="font-size: 13px; color: #333; margin-top: 4px;">
                                <span style="background: #000; color: #fff; padding: 3px 8px; border-radius: 4px; font-weight: 900; font-family: 'Courier New', monospace; letter-spacing: 0.5px;">Lot: ${ingredient.matierePremiereLot}</span>
                                <span style="margin: 0 8px; color: #666;">‚Ä¢</span>
                                <span style="font-weight: 600; font-size: 16px; color: #D2691E;">${gramsUsed.toFixed(0)}g</span>
                                <span style="font-size: 12px; color: #666;">(${ingredient.quantiteUtilisee.toFixed(3)}kg)</span>
                                <span style="margin: 0 8px; color: #666;">‚Ä¢</span>
                                <span style="font-weight: 700; font-size: 14px; color: #2e7d32;">üí∞ ${coutDisplay} ‚Ç¨</span>
                            </div>
                        </div>
                        <button onclick="removeIngredient(${index})" class="btn btn-small btn-danger" style="padding: 6px 10px;">üóëÔ∏è</button>
                    </div>
                    ${ingredient.matierePremiereFournisseur ? `
                    <div style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: white; border-radius: 4px; border: 1px solid #e9ecef; font-size: 12px;">
                        <span>üè≠</span>
                        <span style="font-weight: 600; color: #666;">Fournisseur:</span>
                        <span style="font-weight: 700; color: #333;">${ingredient.matierePremiereFournisseur}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            }).join('');
            
            // Ajouter les nouveaux ingr√©dients apr√®s le message vide
            emptyMessage.insertAdjacentHTML('afterend', ingredientsHTML);
        }

        function removeIngredient(index) {
            if (index >= 0 && index < currentIngredients.length) {
                const removed = currentIngredients[index];
                currentIngredients.splice(index, 1);
                
                // Supprimer les anciens √©l√©ments d'ingr√©dients
                document.querySelectorAll('.ingredient-item').forEach(item => item.remove());
                
                updateIngredientsDisplay();
                showAlert(`${removed.matierePremiereNom} retir√© des ingr√©dients`, 'success');
            }
        }

        function clearIngredients() {
            currentIngredients = [];
            document.querySelectorAll('.ingredient-item').forEach(item => item.remove());
            updateIngredientsDisplay();
        }

        function validateForm(formId) {
            const formContainer = document.getElementById(formId);
            if (!formContainer) return false;
            
            let isValid = true;
            
            formContainer.querySelectorAll('.form-group').forEach(group => {
                group.classList.remove('error');
                const error = group.querySelector('.validation-error');
                if (error) error.remove();
            });
            
            formContainer.querySelectorAll('[required]').forEach(field => {
                if (!field.value || !field.value.trim()) {
                    showFieldError(field, 'Ce champ est obligatoire');
                    isValid = false;
                }
            });
            
            // Validation sp√©cifique pour le formulaire de nouveau lot
            if (formId === 'nouveau-lot-form') {
                if (!validateDLCCalculation()) {
                    isValid = false;
                }
                
                // V√©rifier qu'au moins un ingr√©dient est ajout√©
                if (currentIngredients.length === 0) {
                    showAlert('Veuillez ajouter au moins un ingr√©dient √† ce lot', 'warning');
                    // Optionnel : on peut permettre des lots sans ingr√©dients
                    // isValid = false;
                }
            }
            
            return isValid;
        }

        function showFieldError(field, message) {
            const group = field.closest('.form-group');
            group.classList.add('error');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error';
            errorDiv.textContent = message;
            group.appendChild(errorDiv);
        }

        function resetForm() {
            const inputs = document.querySelectorAll('#nouveau-lot-form input, #nouveau-lot-form select, #nouveau-lot-form textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    // Ne pas r√©initialiser les radios du mode quantit√©
                    if (input.name !== 'mode-quantite') {
                        input.checked = false;
                    }
                } else {
                    input.value = '';
                }
                // Retirer les classes de calcul automatique
                input.classList.remove('auto-calculated');
            });
            
            const dateProduction = document.getElementById('date-production');
            if (dateProduction) {
                dateProduction.value = new Date().toISOString().split('T')[0];
            }
            
            // Remettre l'unit√© par d√©faut sur grammes
            const uniteSelect = document.getElementById('unite');
            if (uniteSelect) {
                uniteSelect.value = 'g';
            }
            
            // Remettre le mode recette par d√©faut
            const modeRecette = document.querySelector('input[name="mode-quantite"][value="recette"]');
            if (modeRecette) {
                modeRecette.checked = true;
                toggleQuantityMode();
            }
            
            // R√©initialiser l'info DLC
            const dlcInfo = document.getElementById('dlc-info');
            if (dlcInfo) {
                dlcInfo.textContent = 'Calcul√©e automatiquement selon le produit';
                dlcInfo.style.color = '#666';
            }
            
            // R√©initialiser les infos de recette
            const recetteBaseInfo = document.getElementById('recette-base-info');
            if (recetteBaseInfo) {
                recetteBaseInfo.innerHTML = '<span style="color: #7b1fa2; font-weight: 600;">S√©lectionnez un produit</span>';
            }
            
            const recetteResult = document.getElementById('recette-calcul-result');
            if (recetteResult) recetteResult.style.display = 'none';
            
            const noRecipeWarning = document.getElementById('recette-no-recipe-warning');
            if (noRecipeWarning) noRecipeWarning.style.display = 'none';
            
            clearIngredients();
            currentMixteLots = [];
            const produitMixte = document.getElementById('produit-mixte');
            if (produitMixte) produitMixte.value = '';
            const prixVente = document.getElementById('mixte-prix-vente');
            if (prixVente) prixVente.value = '';
            const nbBoites = document.getElementById('mixte-nb-boites');
            if (nbBoites) nbBoites.value = '1';
            // Reset mixte product checkboxes
            document.querySelectorAll('[id^="mixte-check-"]').forEach(cb => {
                cb.checked = false;
                const idx = cb.id.replace('mixte-check-', '');
                const pc = document.getElementById(`mixte-pieces-container-${idx}`);
                const wc = document.getElementById(`mixte-poids-container-${idx}`);
                if (pc) pc.style.display = 'none';
                if (wc) wc.style.display = 'none';
            });
            const summaryDiv = document.getElementById('mixte-summary');
            if (summaryDiv) summaryDiv.style.display = 'none';
            generateLotNumber(true); // Forcer la reg√©n√©ration
        }

        // ============================================
        // GESTION DES MODES DE SAISIE QUANTIT√â
        // ============================================
        
        function toggleQuantityMode() {
            const modeRecette = document.querySelector('input[name="mode-quantite"][value="recette"]').checked;
            const modeMixte = document.querySelector('input[name="mode-quantite"][value="mixte"]').checked;
            const modeRecetteContainer = document.getElementById('mode-recette-container');
            const modeManuelContainer = document.getElementById('mode-manuel-container');
            const modeMixteContainer = document.getElementById('mode-mixte-container');
            const btnChargerRecette = document.getElementById('btn-charger-recette-container');
            const ingredientsSection = document.querySelector('#nouveau-lot-form > div:last-of-type')?.previousElementSibling;
            
            // Labels des boutons radio
            const labelRecette = document.querySelector('input[name="mode-quantite"][value="recette"]').parentElement;
            const labelManuel = document.querySelector('input[name="mode-quantite"][value="manuel"]').parentElement;
            const labelMixte = document.querySelector('input[name="mode-quantite"][value="mixte"]').parentElement;
            
            // Reset all styles
            [labelRecette, labelManuel, labelMixte].forEach(l => {
                l.style.background = '#f5f5f5';
                l.style.borderColor = '#9e9e9e';
            });
            
            // Hide all containers
            modeRecetteContainer.style.display = 'none';
            modeManuelContainer.style.display = 'none';
            modeMixteContainer.style.display = 'none';
            
            // Show/hide ingredients section (not needed for mixte)
            const ingredientsSectionEl = document.querySelector('#nouveau-lot-form [style*="8d6e63"]');
            
            if (modeRecette) {
                modeRecetteContainer.style.display = 'block';
                if (btnChargerRecette) btnChargerRecette.style.display = 'none';
                labelRecette.style.background = '#e8f5e9';
                labelRecette.style.borderColor = '#4caf50';
                if (ingredientsSectionEl) ingredientsSectionEl.style.display = '';
                document.getElementById('produit').style.display = '';
                document.getElementById('produit-mixte').style.display = 'none';
                updateQuantityMode();
            } else if (modeMixte) {
                modeMixteContainer.style.display = 'block';
                labelMixte.style.background = '#fff3e0';
                labelMixte.style.borderColor = '#ff9800';
                if (ingredientsSectionEl) ingredientsSectionEl.style.display = 'none';
                if (btnChargerRecette) btnChargerRecette.style.display = 'none';
                document.getElementById('produit').style.display = 'none';
                document.getElementById('produit-mixte').style.display = '';
                updateMixteLotSelect();
            } else {
                modeManuelContainer.style.display = 'block';
                if (btnChargerRecette) btnChargerRecette.style.display = 'block';
                labelManuel.style.background = '#e3f2fd';
                labelManuel.style.borderColor = '#2196f3';
                if (ingredientsSectionEl) ingredientsSectionEl.style.display = '';
                document.getElementById('produit').style.display = '';
                document.getElementById('produit-mixte').style.display = 'none';
            }
        }
        
        // ============================================
        // MODE BO√éTE MIXTE
        // ============================================
        
        let currentMixteLots = []; // Lots sources s√©lectionn√©s automatiquement (FIFO)
        
        function updateMixteLotSelect() {
            // Regrouper les lots par produit (nom nettoy√©)
            const productStock = {};
            lots.forEach(lot => {
                if (lot.quantite <= 0) return;
                if (lot.statut !== 'production' && lot.statut !== 'fini') return;
                
                const nom = lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim();
                if (!productStock[nom]) {
                    productStock[nom] = { nom, totalG: 0, lots: [] };
                }
                productStock[nom].totalG += lot.quantite * 1000;
                productStock[nom].lots.push(lot);
            });
            
            // Trier les lots de chaque produit par date (FIFO : plus ancien d'abord)
            Object.values(productStock).forEach(ps => {
                ps.lots.sort((a, b) => new Date(a.date) - new Date(b.date));
            });
            
            const container = document.getElementById('mixte-products-list');
            if (!container) return;
            
            const products = Object.values(productStock).sort((a, b) => a.nom.localeCompare(b.nom));
            
            if (products.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Aucun lot avec stock disponible</div>';
                return;
            }
            
            let html = '';
            products.forEach((ps, idx) => {
                const stockG = ps.totalG.toFixed(0);
                const nbLots = ps.lots.length;
                html += `
                    <div id="mixte-product-${idx}" style="display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-bottom: 1px solid #eee; transition: background 0.2s;" 
                         onmouseenter="this.style.background='#fff3e0'" onmouseleave="this.style.background=this.querySelector('input[type=checkbox]').checked ? '#fff3e0' : ''">
                        <input type="checkbox" id="mixte-check-${idx}" data-product="${escJS(ps.nom)}" 
                               onchange="toggleMixteProduct(${idx})" 
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="flex: 3;">
                            <label for="mixte-check-${idx}" style="font-weight: 600; color: #5d4037; cursor: pointer; display: block;">${ps.nom}</label>
                            <span style="font-size: 11px; color: #888;">Stock: ${stockG}g ¬∑ ${nbLots} lot(s)</span>
                        </div>
                        <div style="flex: 1; min-width: 80px; display: none;" id="mixte-pieces-container-${idx}">
                            <label style="font-size: 10px; color: #888; display: block;">Nb pi√®ces dans la bo√Æte</label>
                            <input type="number" id="mixte-pieces-${idx}" step="1" min="1" placeholder="Ex: 4" 
                                   data-idx="${idx}" oninput="updateMixteSummary()"
                                   style="width: 100%; padding: 6px; border: 2px solid #ff9800; border-radius: 6px; font-weight: 600; font-size: 14px;">
                        </div>
                        <div style="flex: 1; min-width: 80px; display: none;" id="mixte-poids-container-${idx}">
                            <label style="font-size: 10px; color: #888; display: block;">Poids total pr√©lev√© (g)</label>
                            <input type="number" id="mixte-poids-${idx}" step="1" min="1" placeholder="Ex: 48" 
                                   data-idx="${idx}" data-max="${stockG}" oninput="updateMixteSummary()"
                                   style="width: 100%; padding: 6px; border: 2px solid #4caf50; border-radius: 6px; font-weight: 600; font-size: 14px;">
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            
            // Stocker les donn√©es pour r√©cup√©rer les lots FIFO
            container._productData = products;
        }
        
        function toggleMixteProduct(idx) {
            const checkbox = document.getElementById(`mixte-check-${idx}`);
            const piecesContainer = document.getElementById(`mixte-pieces-container-${idx}`);
            const poidsContainer = document.getElementById(`mixte-poids-container-${idx}`);
            const row = document.getElementById(`mixte-product-${idx}`);
            
            if (checkbox.checked) {
                piecesContainer.style.display = '';
                poidsContainer.style.display = '';
                row.style.background = '#fff3e0';
            } else {
                piecesContainer.style.display = 'none';
                poidsContainer.style.display = 'none';
                row.style.background = '';
                document.getElementById(`mixte-pieces-${idx}`).value = '';
                document.getElementById(`mixte-poids-${idx}`).value = '';
            }
            updateMixteSummary();
        }
        
        function updateMixteSummary() {
            const container = document.getElementById('mixte-products-list');
            const summaryDiv = document.getElementById('mixte-summary');
            const products = container._productData || [];
            const nbBoites = parseInt(document.getElementById('mixte-nb-boites')?.value) || 1;
            
            currentMixteLots = [];
            let totalPiecesParBoite = 0, totalPoidsGParBoite = 0, totalCout = 0;
            
            products.forEach((ps, idx) => {
                const checkbox = document.getElementById(`mixte-check-${idx}`);
                if (!checkbox || !checkbox.checked) return;
                
                const piecesParBoite = parseInt(document.getElementById(`mixte-pieces-${idx}`).value) || 0;
                const poidsGParBoite = parseFloat(document.getElementById(`mixte-poids-${idx}`).value) || 0;
                
                if (piecesParBoite <= 0 && poidsGParBoite <= 0) return;
                
                const poidsGTotal = poidsGParBoite * nbBoites;
                const poidsKgTotal = poidsGTotal / 1000;
                
                // V√©rifier stock suffisant pour toutes les bo√Ætes
                if (poidsGTotal > ps.totalG) {
                    document.getElementById(`mixte-poids-${idx}`).style.borderColor = '#f44336';
                } else {
                    document.getElementById(`mixte-poids-${idx}`).style.borderColor = '#4caf50';
                }
                
                // FIFO : r√©partir le pr√©l√®vement total sur les lots les plus anciens
                let remainingKg = poidsKgTotal;
                for (const lot of ps.lots) {
                    if (remainingKg <= 0) break;
                    const takeKg = Math.min(remainingKg, lot.quantite);
                    
                    let coutSource = 0;
                    if (lot.cout && lot.quantite > 0) {
                        coutSource = (lot.cout / lot.quantite) * takeKg;
                    }
                    
                    currentMixteLots.push({
                        lotId: lot.id,
                        lotNumero: lot.numero,
                        produit: ps.nom,
                        pieces: piecesParBoite * nbBoites,
                        poidsG: takeKg * 1000,
                        poidsKg: takeKg,
                        cout: coutSource,
                        dlc: lot.dlc
                    });
                    
                    totalCout += coutSource;
                    remainingKg -= takeKg;
                }
                
                totalPiecesParBoite += piecesParBoite;
                totalPoidsGParBoite += poidsGParBoite;
            });
            
            if (currentMixteLots.length > 0) {
                const totalPieces = totalPiecesParBoite * nbBoites;
                const totalPoidsG = totalPoidsGParBoite * nbBoites;
                
                document.getElementById('mixte-total-lots').textContent = currentMixteLots.length;
                document.getElementById('mixte-total-pieces').textContent = nbBoites > 1 
                    ? `${totalPieces} (${totalPiecesParBoite}/bo√Æte √ó ${nbBoites})` 
                    : totalPieces;
                document.getElementById('mixte-total-poids').textContent = nbBoites > 1
                    ? `${totalPoidsG.toFixed(0)}g (${totalPoidsGParBoite.toFixed(0)}g/bo√Æte √ó ${nbBoites})`
                    : `${totalPoidsG.toFixed(0)}g (${(totalPoidsG/1000).toFixed(3)} kg)`;
                document.getElementById('mixte-total-cout').textContent = totalCout.toFixed(2) + ' ‚Ç¨';
                summaryDiv.style.display = 'block';
                
                // Auto-fill cost
                const coutInput = document.getElementById('cout-production');
                if (coutInput) coutInput.value = totalCout.toFixed(2);
            } else {
                summaryDiv.style.display = 'none';
            }
        }
        
        function updateQuantityMode() {
            const produitSelect = document.getElementById('produit');
            const produitId = produitSelect.value;
            const recetteBaseInfo = document.getElementById('recette-base-info');
            const recetteResult = document.getElementById('recette-calcul-result');
            const noRecipeWarning = document.getElementById('recette-no-recipe-warning');
            const nombreRecettes = document.getElementById('nombre-recettes');
            
            if (!produitId) {
                recetteBaseInfo.innerHTML = '<span style="color: #7b1fa2; font-weight: 600;">S√©lectionnez un produit</span>';
                recetteResult.style.display = 'none';
                noRecipeWarning.style.display = 'none';
                return;
            }
            
            // Chercher la recette pour ce produit
            const recipe = recipesConfig.find(r => r.productId === produitId);
            
            if (recipe) {
                const uniteLabel = recipe.uniteBase === 'nombre' ? 'pi√®ce(s)' : recipe.uniteBase;
                recetteBaseInfo.innerHTML = `
                    <div style="font-size: 20px; font-weight: bold; color: #7b1fa2;">${recipe.quantiteBase} ${uniteLabel}</div>
                    <div style="font-size: 11px; color: #9c27b0;">${recipe.ingredients ? recipe.ingredients.length : 0} ingr√©dient(s)</div>
                `;
                noRecipeWarning.style.display = 'none';
                
                // Si nombre de recettes d√©j√† saisi, recalculer
                if (nombreRecettes.value) {
                    calculateFromRecipe();
                }
            } else {
                recetteBaseInfo.innerHTML = '<span style="color: #ff9800; font-weight: 600;">Pas de recette</span>';
                recetteResult.style.display = 'none';
                noRecipeWarning.style.display = 'block';
            }
        }
        
        function calculateFromRecipe() {
            const produitSelect = document.getElementById('produit');
            const produitId = produitSelect.value;
            const nombreRecettes = parseFloat(document.getElementById('nombre-recettes').value) || 0;
            const recetteResult = document.getElementById('recette-calcul-result');
            const quantiteTotaleSpan = document.getElementById('recette-quantite-totale');
            
            if (!produitId || nombreRecettes <= 0) {
                recetteResult.style.display = 'none';
                return;
            }
            
            const recipe = recipesConfig.find(r => r.productId === produitId);
            
            if (!recipe) {
                recetteResult.style.display = 'none';
                return;
            }
            
            // Calculer la quantit√© totale
            const quantiteTotale = nombreRecettes * recipe.quantiteBase;
            const uniteLabel = recipe.uniteBase === 'nombre' ? 'pi√®ce(s)' : recipe.uniteBase;
            
            quantiteTotaleSpan.textContent = `${quantiteTotale} ${uniteLabel}`;
            recetteResult.style.display = 'block';
            
            // Charger automatiquement les ingr√©dients (le co√ªt sera calcul√© √† partir des ingr√©dients r√©els)
            loadRecipeIngredientsForQuantity(recipe, nombreRecettes);
        }
        
        function loadRecipeIngredientsForQuantity(recipe, nombreRecettes) {
            
            // Vider les ingr√©dients actuels
            clearIngredients();
            
            if (!recipe.ingredients || recipe.ingredients.length === 0) {
                return;
            }
            
            let ingredientsManquants = [];
            
            // Calculer les ingr√©dients proportionnellement
            recipe.ingredients.forEach(ing => {
                
                const quantiteProportionnelle = ing.quantity * nombreRecettes;
                
                // Chercher d'abord par ID si disponible, sinon par nom
                const searchKey = ing.mpId || ing.mpNom;
                console.log(`üîç Recherche de "${ing.mpNom}" (ID: ${ing.mpId || 'N/A'}) pour ${quantiteProportionnelle.toFixed(3)} kg...`);
                
                // Chercher les lots disponibles en FIFO (par ID d'abord, puis par nom)
                let lotsDisponibles = [];
                
                // Essayer d'abord par ID
                if (ing.mpId) {
                    lotsDisponibles = getMPLotsFIFO(ing.mpId);
                }
                
                // Si pas trouv√© par ID, essayer par nom
                if (lotsDisponibles.length === 0 && ing.mpNom) {
                    lotsDisponibles = getMPLotsFIFO(ing.mpNom);
                }
                
                console.log(`   ‚Üí ${lotsDisponibles.length} lot(s) trouv√©(s)`);
                
                if (lotsDisponibles.length > 0) {
                    let quantiteRestante = quantiteProportionnelle;
                    
                    for (const lotMP of lotsDisponibles) {
                        
                        if (quantiteRestante <= 0) break;
                        
                        const stockDispo = lotMP.quantite || 0;
                        const quantiteAPrendre = Math.min(quantiteRestante, stockDispo);
                        
                        console.log(`   ‚Üí Lot "${lotMP.lot}": stock=${stockDispo.toFixed(3)} kg, prendre=${quantiteAPrendre.toFixed(3)} kg`);
                        
                        if (quantiteAPrendre > 0) {
                            const coutUnitaire = lotMP.cout || 0;
                            const coutTotal = quantiteAPrendre * coutUnitaire;
                            
                            currentIngredients.push({
                                matierePremiereId: lotMP.id,
                                matierePremiereNom: lotMP.nom,
                                matierePremiereLot: lotMP.lot,
                                matierePremiereCategorie: lotMP.categorie,
                                matierePremiereFournisseur: lotMP.fournisseur,
                                quantiteUtilisee: quantiteAPrendre,
                                unite: ing.unite || 'kg',
                                coutUnitaire: coutUnitaire,
                                coutTotal: coutTotal
                            });
                            
                            quantiteRestante -= quantiteAPrendre;
                        }
                    }
                    
                    if (quantiteRestante > 0) {
                        ingredientsManquants.push(`${ing.mpNom}: stock insuffisant (manque ${quantiteRestante.toFixed(3)} kg)`);
                    }
                } else {
                    console.log(`   ‚ùå Aucun lot trouv√© pour "${ing.mpNom}"`);
                    ingredientsManquants.push(`${ing.mpNom}: non trouv√© en stock`);
                }
            });
            
            // G√©rer l'enrobage si pr√©sent
            if (recipe.enrobage && recipe.enrobage.chocolat) {
                // Utiliser le nombre de pi√®ces stock√© dans la recette
                let nombrePiecesBase = recipe.enrobage.nombrePieces;
                
                // FALLBACK : Si nombrePieces n'existe pas dans la recette (anciennes recettes)
                if (!nombrePiecesBase) {
                    if (recipe.uniteBase === 'nombre') {
                        nombrePiecesBase = recipe.quantiteBase;
                    } else {
                        nombrePiecesBase = recipe.quantiteBase;
                        console.warn(`‚ö†Ô∏è Recette "${recipe.productName}" : nombrePieces manquant pour l'enrobage. Utilisation de quantiteBase (${nombrePiecesBase}). Veuillez re-sauvegarder la recette.`);
                    }
                }
                
                // Calculer le nombre de pi√®ces total
                const nombrePiecesTotal = nombrePiecesBase * nombreRecettes;
                
                // Calculer la quantit√© d'enrobage n√©cessaire
                const quantiteEnrobageKg = (recipe.enrobage.grammage * nombrePiecesTotal) / 1000;
                
                console.log(`üîç Recherche enrobage "${recipe.enrobage.chocolat}" (ID: ${recipe.enrobage.mpId || 'N/A'}) pour ${quantiteEnrobageKg.toFixed(3)} kg...`);
                console.log(`   üìä Calcul: ${recipe.enrobage.grammage}g √ó ${nombrePiecesTotal.toFixed(0)} pi√®ces (${nombrePiecesBase} √ó ${nombreRecettes} recettes)`);
                
                // Chercher d'abord par ID si disponible
                let lotsChocolat = [];
                if (recipe.enrobage.mpId) {
                    lotsChocolat = getMPLotsFIFO(recipe.enrobage.mpId);
                }
                if (lotsChocolat.length === 0 && recipe.enrobage.chocolat) {
                    lotsChocolat = getMPLotsFIFO(recipe.enrobage.chocolat);
                }
                
                console.log(`   ‚Üí ${lotsChocolat.length} lot(s) trouv√©(s)`);
                
                if (lotsChocolat.length > 0) {
                    let quantiteRestante = quantiteEnrobageKg;
                    
                    for (const lotMP of lotsChocolat) {
                        if (quantiteRestante <= 0) break;
                        
                        const stockDispo = lotMP.quantite || 0;
                        const quantiteAPrendre = Math.min(quantiteRestante, stockDispo);
                        
                        if (quantiteAPrendre > 0) {
                            const coutUnitaire = lotMP.cout || 0;
                            const coutTotal = quantiteAPrendre * coutUnitaire;
                            
                            currentIngredients.push({
                                matierePremiereId: lotMP.id,
                                matierePremiereNom: lotMP.nom + ' (Enrobage)',
                                matierePremiereLot: lotMP.lot,
                                matierePremiereCategorie: lotMP.categorie,
                                matierePremiereFournisseur: lotMP.fournisseur,
                                quantiteUtilisee: quantiteAPrendre,
                                unite: 'kg',
                                coutUnitaire: coutUnitaire,
                                coutTotal: coutTotal,
                                isEnrobage: true
                            });
                            
                            quantiteRestante -= quantiteAPrendre;
                        }
                    }
                    
                    if (quantiteRestante > 0) {
                        ingredientsManquants.push(`${recipe.enrobage.chocolat} (enrobage): stock insuffisant (manque ${quantiteRestante.toFixed(3)} kg)`);
                    }
                } else {
                    ingredientsManquants.push(`${recipe.enrobage.chocolat} (enrobage): non trouv√© en stock`);
                }
            }
            
            // Afficher un avertissement si des ingr√©dients manquent
            if (ingredientsManquants.length > 0) {
                console.warn('‚ö†Ô∏è Ingr√©dients manquants:', ingredientsManquants);
                showAlert(`‚ö†Ô∏è Certains ingr√©dients n'ont pas pu √™tre charg√©s :\n\n‚Ä¢ ${ingredientsManquants.join('\n‚Ä¢ ')}\n\nV√©rifiez votre stock de mati√®res premi√®res.`, 'warning');
            }
            
            updateIngredientsDisplay();
        }


        function generateLotNumber(force = false) {
            const numeroLotInput = document.getElementById('numero-lot');
            
            // Ne pas √©craser si un num√©ro existe d√©j√† (sauf si force = true)
            if (!force && numeroLotInput && numeroLotInput.value.trim() !== '') {
                console.log(`üìã Num√©ro de lot conserv√©: ${numeroLotInput.value}`);
                return;
            }
            
            const today = new Date();
            const year = today.getFullYear(); // 2026
            
            console.log(`üìã Recherche num√©ro lot - Lots: ${lots.length}`);
            
            // Trouver tous les lots de l'ann√©e en cours
            const lotsThisYear = lots.filter(lot => {
                if (!lot.numero) return false;
                const lotYear = lot.numero.split('-')[0];
                return parseInt(lotYear) === year;
            });
            
            // Trier par date de cr√©ation (le plus r√©cent en premier)
            const lotsSorted = lotsThisYear.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.date || 0);
                const dateB = new Date(b.createdAt || b.date || 0);
                return dateB - dateA;
            });
            
            // Prendre le num√©ro du lot le plus r√©cent
            let lastNumber = 0;
            if (lotsSorted.length > 0) {
                const lastLot = lotsSorted[0];
                const parts = lastLot.numero.split('-');
                if (parts.length === 2) {
                    const number = parseInt(parts[1]);
                    if (!isNaN(number)) {
                        lastNumber = number;
                    }
                }
                console.log(`üìã Dernier lot trouv√©: ${lastLot.numero} (date: ${lastLot.date})`);
            }
            
            // Incr√©menter
            const nextNumber = lastNumber + 1;
            const lotNumber = `${year}-${String(nextNumber).padStart(3, '0')}`;
            
            if (numeroLotInput) {
                numeroLotInput.value = lotNumber;
                console.log(`üìã Num√©ro de lot g√©n√©r√©: ${lotNumber}`);
            } else {
                console.log(`‚ö†Ô∏è Input numero-lot non trouv√©`);
            }
        }

        // Impression d'√©tiquette - D√âCLARATION GLOBALE
        window.printLabel = function(lotId) {
            const lot = lots.find(l => l.id === lotId);
            if (!lot) {
                showAlert('Lot non trouv√©', 'danger');
                return;
            }
            
            generateLabel(lot);
            
            // R√©initialiser le s√©lecteur de taille √† A5 par d√©faut
            const sizeSelect = document.getElementById('label-size-select');
            if (sizeSelect) {
                sizeSelect.value = 'brother-50x23';
            }
            
            // S'assurer que la classe par d√©faut est appliqu√©e
            const labelContent = document.getElementById('label-content');
            if (labelContent) {
                labelContent.className = 'label-printable label-size-brother-50x23';
            }
            
            document.getElementById('label-modal').style.display = 'block';
            
            // Attacher les √©v√©nements aux boutons apr√®s l'ouverture du modal
            setTimeout(() => {
                const downloadBtn = document.getElementById('download-label-btn');
                const closeBtn = document.getElementById('close-label-btn');
                const printDirectBtn = document.getElementById('print-label-direct-btn');
                
                if (printDirectBtn) {
                    printDirectBtn.onclick = function() {
                        printLabelDirect();
                    };
                }
                
                if (downloadBtn) {
                    downloadBtn.onclick = function() {
                        downloadLabelAsHTML(lot);
                    };
                }
                
                if (closeBtn) {
                    closeBtn.onclick = function() {
                        document.getElementById('label-modal').style.display = 'none';
                    };
                }
            }, 100);
        }
        
        // Fonction d'impression directe
        function printLabelDirect() {
            const labelContent = document.getElementById('label-content');
            const sizeSelect = document.getElementById('label-size-select');
            
            if (!labelContent) {
                showAlert('Erreur : contenu non trouv√©', 'danger');
                return;
            }
            
            const selectedSize = sizeSelect ? sizeSelect.value : 'a5';
            
            // Cr√©er une fen√™tre d'impression avec le contenu de l'√©tiquette
            const printWindow = window.open('', '_blank', 'width=600,height=400');
            
            // CSS pour l'impression
            let printCSS = `
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: Arial, sans-serif; }
                .label-printable {
                    background: white;
                    margin: 0;
                    padding: 1mm 1mm 1mm 3mm;
                }
                .label-simple-layout { 
                    display: flex; 
                    flex-direction: column; 
                    justify-content: flex-start;
                    height: 100%;
                    gap: 0;
                }
                .label-simple-header { 
                    border: none; 
                    padding: 0; 
                    display: flex; 
                    flex-direction: column;
                    gap: 0;
                    width: 100%;
                }
                .label-simple-info { 
                    display: flex;
                    flex-direction: column;
                    gap: 0;
                }
                .label-simple-qr { display: none !important; }
                .qr-code-img { display: none !important; }
                .label-simple-product { 
                    font-size: 14px; 
                    line-height: 1.2; 
                    font-weight: 900; 
                    margin: 0;
                    padding: 0.5mm 0 1.5mm 0;
                    text-align: center;
                    text-transform: uppercase;
                    letter-spacing: 0.3px;
                    color: #000;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                }
                .label-simple-lot { 
                    font-size: 14px; 
                    font-weight: 900; 
                    margin: 0; 
                    padding: 0.5mm 2mm; 
                    background: white; 
                    color: #000; 
                    display: block;
                    text-align: center;
                    border: 2px solid #000;
                }
                .label-simple-dlc { 
                    padding: 0.5mm 2mm; 
                    border: 2px solid #000; 
                    display: block;
                    text-align: center;
                    background: white;
                    color: black;
                    margin: 0;
                    margin-top: 0.5mm;
                }
                .dlc-simple-label { 
                    font-size: 11px; 
                    font-weight: 900; 
                }
                .dlc-simple-date { 
                    font-size: 14px; 
                    font-weight: 900; 
                }
                .label-simple-title { display: none; }
                .label-ingredients-simple { display: none; }
                
                @media print {
                    @page {
                        size: 50mm 23mm;
                        margin: 0;
                    }
                    body { 
                        width: 50mm;
                        height: 23mm;
                    }
                    .label-printable {
                        width: 50mm !important;
                        height: 23mm !important;
                        border: none !important;
                    }
                }
            `;
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>√âtiquette</title>
                    <style>${printCSS}</style>
                </head>
                <body>
                    <div class="label-printable">
                        ${labelContent.innerHTML}
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            // Lancer l'impression apr√®s un court d√©lai
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 300);
        }

        // ============================================
        // √âTIQUETTE PRODUIT 29√ó90mm
        // ============================================
        
        let currentProductLabelLot = null;
        
        window.printProductLabel = function(lotId) {
            const lot = lots.find(l => l.id === lotId);
            if (!lot) {
                showAlert('Lot non trouv√©', 'danger');
                return;
            }
            
            currentProductLabelLot = lot;
            
            // Trouver le produit dans la config pour avoir les infos compl√®tes
            const productName = lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim();
            const product = productsConfig.find(p => p.nom === productName || lot.produit.includes(p.nom));
            
            // Pr√©-remplir le poids si disponible
            const poidsInput = document.getElementById('product-label-poids');
            if (poidsInput && product && product.poids) {
                poidsInput.value = product.poids;
            }
            
            generateProductLabel(lot, product);
            
            document.getElementById('product-label-modal').style.display = 'block';
            
            // Attacher l'√©v√©nement au bouton imprimer
            setTimeout(() => {
                const printBtn = document.getElementById('print-product-label-btn');
                if (printBtn) {
                    printBtn.onclick = function() {
                        printProductLabelDirect();
                    };
                }
            }, 100);
        }
        
        window.closeProductLabelModal = function() {
            document.getElementById('product-label-modal').style.display = 'none';
            currentProductLabelLot = null;
        }
        
        window.refreshProductLabelPreview = function() {
            if (currentProductLabelLot) {
                const productName = currentProductLabelLot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim();
                const product = productsConfig.find(p => p.nom === productName || currentProductLabelLot.produit.includes(p.nom));
                generateProductLabel(currentProductLabelLot, product);
            }
        }
        
        function generateProductLabel(lot, product) {
            const labelContent = document.getElementById('product-label-content');
            if (!labelContent) return;
            
            const productName = lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim();
            const poids = document.getElementById('product-label-poids')?.value || product?.poids || '';
            const ingredients = product?.ingredients || 'Non renseign√©';
            const allergenes = product?.allergenes || '';
            
            labelContent.innerHTML = `
                <div style="font-size: 8px; line-height: 1.3; height: 100%;">
                    <!-- En-t√™te entreprise -->
                    <div style="text-align: center; border-bottom: 1px solid #000; padding-bottom: 2mm; margin-bottom: 2mm;">
                        <div style="font-size: 10px; font-weight: 900;">EMOTIONS CHOCOLATS</div>
                        <div style="font-size: 7px;">Rue Houmvent 4a, 4218 Couthuin</div>
                    </div>
                    
                    <!-- Nom produit -->
                    <div style="text-align: center; font-size: 11px; font-weight: 900; text-transform: uppercase; margin-bottom: 2mm;">
                        ${productName}
                    </div>
                    
                    <!-- Poids -->
                    ${poids ? `<div style="text-align: center; font-size: 9px; font-weight: 700; margin-bottom: 2mm;">Poids net : ${poids}</div>` : ''}
                    
                    <!-- Ingr√©dients -->
                    <div style="margin-bottom: 2mm;">
                        <span style="font-weight: 700;">Ingr√©dients :</span> ${ingredients}
                    </div>
                    
                    <!-- Allerg√®nes -->
                    ${allergenes ? `
                    <div style="margin-bottom: 2mm; background: #f0f0f0; padding: 1.5mm; border-radius: 2px;">
                        <strong>Allerg√®nes : ${allergenes}</strong>
                    </div>
                    ` : ''}
                    
                    <!-- Lot et DLC -->
                    <div style="display: flex; justify-content: space-between; border-top: 2px solid #000; padding-top: 2mm; margin-top: auto; font-size: 10px; font-weight: 900;">
                        <div>Lot : ${lot.numero}</div>
                        <div>DLC : ${formatDate(lot.dlc)}</div>
                    </div>
                </div>
            `;
        }
        
        function printProductLabelDirect() {
            const labelContent = document.getElementById('product-label-content');
            
            if (!labelContent) {
                showAlert('Erreur : contenu non trouv√©', 'danger');
                return;
            }
            
            const printWindow = window.open('', '_blank', 'width=400,height=300');
            
            const printCSS = `
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: Arial, sans-serif; 
                    width: 90mm;
                    height: 29mm;
                }
                .product-label {
                    width: 90mm;
                    height: 29mm;
                    padding: 2mm;
                    font-size: 8px;
                    line-height: 1.3;
                }
                @media print {
                    @page {
                        size: 90mm 29mm;
                        margin: 0;
                    }
                    body {
                        width: 90mm;
                        height: 29mm;
                    }
                }
            `;
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>√âtiquette Produit</title>
                    <style>${printCSS}</style>
                </head>
                <body>
                    <div class="product-label">
                        ${labelContent.innerHTML}
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 300);
        }

        function downloadLabelAsHTML(lot) {
            const labelContent = document.getElementById('label-content');
            const sizeSelect = document.getElementById('label-size-select');
            
            if (!labelContent) {
                showAlert('Erreur : contenu non trouv√©', 'danger');
                return;
            }
            
            // R√©cup√©rer la taille s√©lectionn√©e
            const selectedSize = sizeSelect ? sizeSelect.value : 'a5';
            const sizeClass = 'label-size-' + selectedSize;
            
            // R√©cup√©rer tous les styles CSS n√©cessaires avec TOUTES les tailles
            const styles = `
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
                    .label-printable {
                        background: white;
                        border: 4px solid #000;
                        padding: 22px;
                        margin: 0 auto;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    }
                    
                    /* Tailles de base */
                    .label-size-a5 { width: 148mm; max-width: 148mm; }
                    .label-size-a6 { width: 105mm; max-width: 105mm; }
                    .label-size-a4 { width: 210mm; max-width: 210mm; }
                    .label-size-label-small { width: 70mm; max-width: 70mm; padding: 12px; }
                    .label-size-label-medium { width: 100mm; max-width: 100mm; padding: 16px; }
                    .label-size-label-large { width: 150mm; max-width: 150mm; }
                    
                    /* Formats Brother TD-4550 */
                    .label-size-brother-102x152 { width: 102mm; max-width: 102mm; min-height: 152mm; }
                    .label-size-brother-102x127 { width: 102mm; max-width: 102mm; min-height: 127mm; }
                    .label-size-brother-102x102 { width: 102mm; max-width: 102mm; min-height: 102mm; }
                    .label-size-brother-102x76 { width: 102mm; max-width: 102mm; min-height: 76mm; }
                    .label-size-brother-102x51 { width: 102mm; max-width: 102mm; min-height: 51mm; padding: 15px; }
                    .label-size-brother-102x38 { width: 102mm; max-width: 102mm; min-height: 38mm; padding: 12px; }
                    .label-size-brother-102x25 { width: 102mm; max-width: 102mm; min-height: 25mm; padding: 8px; }
                    .label-size-brother-62x100 { width: 62mm; max-width: 62mm; min-height: 100mm; padding: 12px; }
                    .label-size-brother-62x51 { width: 62mm; max-width: 62mm; min-height: 51mm; padding: 10px; }
                    .label-size-brother-62x29 { width: 62mm; max-width: 62mm; min-height: 29mm; padding: 8px; }
                    .label-size-brother-51x26 { width: 51mm; max-width: 51mm; min-height: 26mm; padding: 4px; border-width: 2px; }
                    
                    /* Adaptations A6 */
                    .label-size-a6 .label-simple-product { font-size: 22px; }
                    .label-size-a6 .label-simple-lot { font-size: 24px; font-weight: 900; }
                    .label-size-a6 .dlc-simple-label { font-size: 16px; font-weight: 900; }
                    .label-size-a6 .dlc-simple-date { font-size: 24px; font-weight: 900; }
                    .label-size-a6 .qr-code-img { width: 90px; height: 90px; }
                    .label-size-a6 .ingredient-simple-name { font-size: 14px; }
                    
                    /* Adaptations A4 */
                    .label-size-a4 .label-simple-product { font-size: 36px; }
                    .label-size-a4 .label-simple-lot { font-size: 36px; font-weight: 900; }
                    .label-size-a4 .dlc-simple-label { font-size: 28px; font-weight: 900; }
                    .label-size-a4 .dlc-simple-date { font-size: 36px; font-weight: 900; }
                    .label-size-a4 .qr-code-img { width: 160px; height: 160px; }
                    .label-size-a4 .ingredient-simple-name { font-size: 20px; }
                    .label-size-a4 .ingredient-simple-qty { font-size: 20px; }
                    .label-size-a4 .label-simple-title { font-size: 22px; }
                    
                    /* Adaptations Petite */
                    .label-size-label-small .label-simple-product { font-size: 16px; font-weight: 900; }
                    .label-size-label-small .label-simple-lot { font-size: 18px; font-weight: 900; }
                    .label-size-label-small .dlc-simple-label { font-size: 12px; font-weight: 900; }
                    .label-size-label-small .dlc-simple-date { font-size: 18px; font-weight: 900; }
                    .label-size-label-small .qr-code-img { width: 60px; height: 60px; }
                    .label-size-label-small .label-simple-title { font-size: 12px; }
                    .label-size-label-small .ingredient-simple-name { font-size: 11px; }
                    .label-size-label-small .ingredient-simple-lot { font-size: 10px; }
                    .label-size-label-small .ingredient-simple-qty { font-size: 11px; }
                    
                    /* Adaptations Moyenne */
                    .label-size-label-medium .label-simple-product { font-size: 24px; }
                    .label-size-label-medium .label-simple-lot { font-size: 24px; font-weight: 900; }
                    .label-size-label-medium .dlc-simple-label { font-size: 16px; font-weight: 900; }
                    .label-size-label-medium .dlc-simple-date { font-size: 24px; font-weight: 900; }
                    .label-size-label-medium .qr-code-img { width: 100px; height: 100px; }
                    .label-size-label-medium .ingredient-simple-name { font-size: 15px; }
                    
                    /* Adaptations Grande */
                    .label-size-label-large .label-simple-product { font-size: 32px; }
                    .label-size-label-large .label-simple-lot { font-size: 32px; font-weight: 900; }
                    .label-size-label-large .dlc-simple-label { font-size: 22px; font-weight: 900; }
                    .label-size-label-large .dlc-simple-date { font-size: 32px; font-weight: 900; }
                    .label-size-label-large .qr-code-img { width: 140px; height: 140px; }
                    .label-size-label-large .ingredient-simple-name { font-size: 18px; }
                    .label-size-label-large .ingredient-simple-qty { font-size: 18px; }
                    
                    /* Adaptations Brother 102√ó152mm - Grande Standard */
                    .label-size-brother-102x152 .label-simple-product { font-size: 30px; line-height: 1.2; font-weight: 900; }
                    .label-size-brother-102x152 .label-simple-lot { font-size: 28px; font-weight: 900; }
                    .label-size-brother-102x152 .dlc-simple-label { font-size: 18px; font-weight: 900; }
                    .label-size-brother-102x152 .dlc-simple-date { font-size: 28px; font-weight: 900; }
                    .label-size-brother-102x152 .qr-code-img { width: 130px; height: 130px; }
                    .label-size-brother-102x152 .ingredient-simple-name { font-size: 17px; }
                    .label-size-brother-102x152 .ingredient-simple-qty { font-size: 17px; }
                    .label-size-brother-102x152 .label-simple-title { font-size: 19px; }
                    
                    /* Adaptations Brother 102√ó127mm - Grande */
                    .label-size-brother-102x127 .label-simple-product { font-size: 28px; line-height: 1.2; font-weight: 900; }
                    .label-size-brother-102x127 .label-simple-lot { font-size: 26px; font-weight: 900; }
                    .label-size-brother-102x127 .dlc-simple-label { font-size: 17px; font-weight: 900; }
                    .label-size-brother-102x127 .dlc-simple-date { font-size: 26px; font-weight: 900; }
                    .label-size-brother-102x127 .qr-code-img { width: 120px; height: 120px; }
                    .label-size-brother-102x127 .ingredient-simple-name { font-size: 16px; }
                    .label-size-brother-102x127 .ingredient-simple-qty { font-size: 16px; }
                    .label-size-brother-102x127 .label-simple-title { font-size: 18px; }
                    
                    /* Adaptations Brother 102√ó102mm - Carr√©e Grande */
                    .label-size-brother-102x102 .label-simple-product { font-size: 26px; line-height: 1.1; font-weight: 900; }
                    .label-size-brother-102x102 .label-simple-lot { font-size: 24px; font-weight: 900; }
                    .label-size-brother-102x102 .dlc-simple-label { font-size: 16px; font-weight: 900; }
                    .label-size-brother-102x102 .dlc-simple-date { font-size: 24px; font-weight: 900; }
                    .label-size-brother-102x102 .qr-code-img { width: 110px; height: 110px; }
                    .label-size-brother-102x102 .ingredient-simple-name { font-size: 15px; }
                    .label-size-brother-102x102 .ingredient-simple-qty { font-size: 15px; }
                    .label-size-brother-102x102 .label-simple-title { font-size: 17px; }
                    .label-size-brother-102x102 .ingredient-simple-row { padding: 6px; }
                    
                    /* Adaptations Brother 102√ó76mm - Moyenne */
                    .label-size-brother-102x76 .label-simple-product { font-size: 24px; line-height: 1.1; font-weight: 900; }
                    .label-size-brother-102x76 .label-simple-lot { font-size: 22px; font-weight: 900; }
                    .label-size-brother-102x76 .dlc-simple-label { font-size: 15px; font-weight: 900; }
                    .label-size-brother-102x76 .dlc-simple-date { font-size: 22px; font-weight: 900; }
                    .label-size-brother-102x76 .qr-code-img { width: 100px; height: 100px; }
                    .label-size-brother-102x76 .ingredient-simple-name { font-size: 14px; }
                    .label-size-brother-102x76 .ingredient-simple-qty { font-size: 14px; }
                    .label-size-brother-102x76 .label-simple-title { font-size: 16px; }
                    .label-size-brother-102x76 .ingredient-simple-row { padding: 5px; }
                    
                    /* Adaptations Brother 102√ó51mm - Compacte */
                    .label-size-brother-102x51 .label-simple-product { font-size: 19px; line-height: 1; font-weight: 900; }
                    .label-size-brother-102x51 .label-simple-lot { font-size: 20px; font-weight: 900; }
                    .label-size-brother-102x51 .dlc-simple-label { font-size: 14px; font-weight: 900; }
                    .label-size-brother-102x51 .dlc-simple-date { font-size: 20px; font-weight: 900; }
                    .label-size-brother-102x51 .qr-code-img { width: 80px; height: 80px; }
                    .label-size-brother-102x51 .label-simple-title { font-size: 14px; }
                    .label-size-brother-102x51 .ingredient-simple-name { font-size: 12px; }
                    .label-size-brother-102x51 .ingredient-simple-lot { font-size: 11px; }
                    .label-size-brother-102x51 .ingredient-simple-qty { font-size: 12px; }
                    .label-size-brother-102x51 .ingredient-simple-row { padding: 4px; }
                    .label-size-brother-102x51 .label-simple-header { gap: 12px; padding-bottom: 12px; }
                    
                    /* Adaptations Brother 102√ó38mm - Petite Large */
                    .label-size-brother-102x38 .label-simple-product { font-size: 17px; line-height: 1; font-weight: 900; }
                    .label-size-brother-102x38 .label-simple-lot { font-size: 18px; font-weight: 900; }
                    .label-size-brother-102x38 .dlc-simple-label { font-size: 13px; font-weight: 900; }
                    .label-size-brother-102x38 .dlc-simple-date { font-size: 18px; font-weight: 900; }
                    .label-size-brother-102x38 .qr-code-img { width: 60px; height: 60px; }
                    .label-size-brother-102x38 .label-simple-title { font-size: 12px; }
                    .label-size-brother-102x38 .ingredient-simple-name { font-size: 11px; }
                    .label-size-brother-102x38 .ingredient-simple-lot { font-size: 10px; }
                    .label-size-brother-102x38 .ingredient-simple-qty { font-size: 11px; }
                    .label-size-brother-102x38 .ingredient-simple-row { padding: 3px; }
                    .label-size-brother-102x38 .label-simple-header { gap: 8px; padding-bottom: 8px; }
                    .label-size-brother-102x38 .label-simple-layout { gap: 10px; }
                    
                    /* Adaptations Brother 102√ó25mm - Bandeau */
                    .label-size-brother-102x25 .label-simple-product { font-size: 15px; line-height: 1; margin-bottom: 4px; font-weight: 900; }
                    .label-size-brother-102x25 .label-simple-lot { font-size: 17px; margin-bottom: 4px; font-weight: 900; }
                    .label-size-brother-102x25 .dlc-simple-label { font-size: 12px; font-weight: 900; }
                    .label-size-brother-102x25 .dlc-simple-date { font-size: 17px; font-weight: 900; }
                    .label-size-brother-102x25 .qr-code-img { width: 50px; height: 50px; }
                    .label-size-brother-102x25 .label-simple-title { font-size: 11px; padding-bottom: 4px; margin-bottom: 4px; }
                    .label-size-brother-102x25 .ingredient-simple-name { font-size: 10px; }
                    .label-size-brother-102x25 .ingredient-simple-lot { font-size: 9px; }
                    .label-size-brother-102x25 .ingredient-simple-qty { font-size: 10px; }
                    .label-size-brother-102x25 .ingredient-simple-row { padding: 2px; }
                    .label-size-brother-102x25 .label-simple-header { gap: 6px; padding-bottom: 6px; border-bottom: 2px solid #000; }
                    .label-size-brother-102x25 .label-simple-layout { gap: 6px; }
                    .label-size-brother-102x25 .label-simple-dlc { padding: 4px 6px; }
                    .label-size-brother-102x25 .label-ingredients-simple { padding: 6px; border: 1px solid #000; }
                    
                    /* Adaptations Brother 62√ó100mm - Standard √âtroite */
                    .label-size-brother-62x100 .label-simple-product { font-size: 19px; line-height: 1.1; font-weight: 900; }
                    .label-size-brother-62x100 .label-simple-lot { font-size: 20px; font-weight: 900; }
                    .label-size-brother-62x100 .dlc-simple-label { font-size: 14px; font-weight: 900; }
                    .label-size-brother-62x100 .dlc-simple-date { font-size: 20px; font-weight: 900; }
                    .label-size-brother-62x100 .qr-code-img { width: 85px; height: 85px; }
                    .label-size-brother-62x100 .label-simple-title { font-size: 14px; }
                    .label-size-brother-62x100 .ingredient-simple-name { font-size: 12px; }
                    .label-size-brother-62x100 .ingredient-simple-lot { font-size: 11px; }
                    .label-size-brother-62x100 .ingredient-simple-qty { font-size: 12px; }
                    .label-size-brother-62x100 .ingredient-simple-row { padding: 4px; }
                    .label-size-brother-62x100 .label-simple-header { gap: 10px; padding-bottom: 10px; }
                    
                    /* Adaptations Brother 62√ó51mm - Carr√©e √âtroite */
                    .label-size-brother-62x51 .label-simple-product { font-size: 17px; line-height: 1; font-weight: 900; }
                    .label-size-brother-62x51 .label-simple-lot { font-size: 18px; font-weight: 900; }
                    .label-size-brother-62x51 .dlc-simple-label { font-size: 13px; font-weight: 900; }
                    .label-size-brother-62x51 .dlc-simple-date { font-size: 18px; font-weight: 900; }
                    .label-size-brother-62x51 .qr-code-img { width: 70px; height: 70px; }
                    .label-size-brother-62x51 .label-simple-title { font-size: 12px; }
                    .label-size-brother-62x51 .ingredient-simple-name { font-size: 11px; }
                    .label-size-brother-62x51 .ingredient-simple-lot { font-size: 10px; }
                    .label-size-brother-62x51 .ingredient-simple-qty { font-size: 11px; }
                    .label-size-brother-62x51 .ingredient-simple-row { padding: 3px; }
                    .label-size-brother-62x51 .label-simple-header { gap: 8px; padding-bottom: 8px; }
                    .label-size-brother-62x51 .label-simple-layout { gap: 8px; }
                    
                    /* Adaptations Brother 62√ó29mm - Mini */
                    .label-size-brother-62x29 .label-simple-product { font-size: 14px; line-height: 1; margin-bottom: 3px; font-weight: 900; }
                    .label-size-brother-62x29 .label-simple-lot { font-size: 16px; margin-bottom: 3px; font-weight: 900; }
                    .label-size-brother-62x29 .dlc-simple-label { font-size: 11px; font-weight: 900; }
                    .label-size-brother-62x29 .dlc-simple-date { font-size: 16px; font-weight: 900; }
                    .label-size-brother-62x29 .qr-code-img { width: 45px; height: 45px; }
                    .label-size-brother-62x29 .label-simple-title { font-size: 10px; padding-bottom: 3px; margin-bottom: 3px; }
                    .label-size-brother-62x29 .ingredient-simple-name { font-size: 9px; }
                    .label-size-brother-62x29 .ingredient-simple-lot { font-size: 8px; }
                    .label-size-brother-62x29 .ingredient-simple-qty { font-size: 9px; }
                    .label-size-brother-62x29 .ingredient-simple-row { padding: 2px; }
                    .label-size-brother-62x29 .label-simple-header { gap: 5px; padding-bottom: 5px; border-bottom: 1px solid #000; }
                    .label-size-brother-62x29 .label-simple-layout { gap: 5px; }
                    .label-size-brother-62x29 .label-simple-dlc { padding: 3px 5px; }
                    .label-size-brother-62x29 .label-ingredients-simple { padding: 5px; border: 1px solid #000; }
                    
                    /* Adaptations Brother 51√ó26mm - Tr√®s Petite */
                    .label-size-brother-51x26 .label-simple-product { font-size: 11px; line-height: 1; margin-bottom: 2px; font-weight: 900; }
                    .label-size-brother-51x26 .label-simple-lot { font-size: 13px; margin-bottom: 2px; font-weight: 900; padding: 1px 3px; }
                    .label-size-brother-51x26 .dlc-simple-label { font-size: 8px; font-weight: 900; }
                    .label-size-brother-51x26 .dlc-simple-date { font-size: 12px; font-weight: 900; }
                    .label-size-brother-51x26 .qr-code-img { width: 32px; height: 32px; }
                    .label-size-brother-51x26 .label-simple-title { display: none; }
                    .label-size-brother-51x26 .ingredient-simple-name { font-size: 7px; }
                    .label-size-brother-51x26 .ingredient-simple-lot { display: none; }
                    .label-size-brother-51x26 .ingredient-simple-qty { font-size: 7px; }
                    .label-size-brother-51x26 .ingredient-simple-row { padding: 1px; }
                    .label-size-brother-51x26 .label-simple-header { gap: 3px; padding-bottom: 3px; border-bottom: 1px solid #000; flex-direction: row; }
                    .label-size-brother-51x26 .label-simple-layout { gap: 2px; }
                    .label-size-brother-51x26 .label-simple-dlc { padding: 1px 3px; border-width: 1px; }
                    .label-size-brother-51x26 .label-ingredients-simple { display: none; }
                    .label-size-brother-51x26 .label-simple-info { flex: 1; }
                    .label-size-brother-51x26 .label-simple-qr { flex-shrink: 0; }
                    
                    /* Adaptations Brother 50√ó23mm - Ultra Compact SANS QR CODE */
                    .label-size-brother-50x23 { 
                        width: 50mm; 
                        max-width: 50mm; 
                        height: 23mm; 
                        max-height: 23mm; 
                        padding: 1mm 1mm 1mm 3mm; 
                        border: none;
                        overflow: hidden;
                        box-sizing: border-box;
                    }
                    .label-size-brother-50x23 .label-simple-layout { 
                        display: flex; 
                        flex-direction: column; 
                        justify-content: flex-start;
                        height: 100%;
                        gap: 0;
                    }
                    .label-size-brother-50x23 .label-simple-header { 
                        border: none; 
                        padding: 0; 
                        display: flex; 
                        flex-direction: column;
                        gap: 0;
                        width: 100%;
                    }
                    .label-size-brother-50x23 .label-simple-info { 
                        display: flex;
                        flex-direction: column;
                        gap: 0;
                    }
                    .label-size-brother-50x23 .label-simple-qr { 
                        display: none !important;
                    }
                    .label-size-brother-50x23 .label-simple-product { 
                        font-size: 14px; 
                        line-height: 1.2; 
                        font-weight: 900; 
                        margin: 0;
                        padding: 0.5mm 0 1.5mm 0;
                        text-align: center;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: #000;
                        word-wrap: break-word;
                        overflow-wrap: break-word;
                    }
                    .label-size-brother-50x23 .label-simple-lot { 
                        font-size: 14px; 
                        font-weight: 900; 
                        margin: 0; 
                        padding: 0.5mm 2mm; 
                        background: white; 
                        color: #000; 
                        display: block;
                        text-align: center;
                        border: 2px solid #000;
                    }
                    .label-size-brother-50x23 .label-simple-dlc { 
                        padding: 0.5mm 2mm; 
                        border: 2px solid #000; 
                        display: block;
                        text-align: center;
                        background: white;
                        color: black;
                        margin: 0;
                        margin-top: 0.5mm;
                    }
                    .label-size-brother-50x23 .dlc-simple-label { 
                        font-size: 11px; 
                        font-weight: 900; 
                    }
                    .label-size-brother-50x23 .dlc-simple-date { 
                        font-size: 14px; 
                        font-weight: 900; 
                    }
                    .label-size-brother-50x23 .qr-code-img { 
                        display: none !important;
                    }
                    .label-size-brother-50x23 .label-simple-title { display: none; }
                    .label-size-brother-50x23 .label-ingredients-simple { display: none; }
                    
                    @media print {
                        .label-size-brother-50x23 {
                            width: 50mm !important;
                            height: 23mm !important;
                            padding: 1mm 1mm 1mm 3mm !important;
                            margin: 0 !important;
                            border: none !important;
                        }
                        @page {
                            size: 50mm 23mm;
                            margin: 0;
                        }
                    }
                    
                    .label-simple-layout { display: flex; flex-direction: column; gap: 20px; }
                    .label-simple-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        gap: 20px;
                        padding-bottom: 20px;
                        border-bottom: 3px solid #000;
                    }
                    .label-simple-info { flex: 1; }
                    .label-simple-product {
                        font-size: 36px;
                        font-weight: 900;
                        color: #000;
                        margin-bottom: 14px;
                        line-height: 1.2;
                    }
                    .label-simple-lot {
                        font-size: 36px;
                        font-weight: 900;
                        color: #000;
                        margin-bottom: 14px;
                        font-family: 'Courier New', monospace;
                        background: #f0f0f0;
                        padding: 10px 16px;
                        border-radius: 6px;
                        border: 4px solid #000;
                        display: inline-block;
                    }
                    .label-simple-dlc {
                        display: flex;
                        align-items: baseline;
                        gap: 12px;
                        background: #000;
                        color: white;
                        padding: 12px 16px;
                        border-radius: 6px;
                        margin-top: 14px;
                    }
                    .dlc-simple-label {
                        font-size: 22px;
                        font-weight: 900;
                        text-transform: uppercase;
                    }
                    .dlc-simple-date {
                        font-size: 36px;
                        font-weight: 900;
                    }
                    .label-simple-qr { flex-shrink: 0; }
                    .qr-code-img {
                        width: 150px;
                        height: 150px;
                        border: 3px solid #000;
                        display: block;
                    }
                    .label-ingredients-simple {
                        border: 3px solid #000;
                        padding: 18px;
                    }
                    .label-simple-title {
                        font-size: 19px;
                        font-weight: 900;
                        text-transform: uppercase;
                        margin-bottom: 14px;
                        color: #000;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                    }
                    .ingredients-simple-list {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }
                    .ingredient-simple-row {
                        display: grid;
                        grid-template-columns: 1fr auto auto;
                        gap: 14px;
                        padding: 10px;
                        border-bottom: 1px solid #ddd;
                        align-items: center;
                        background: #f9f9f9;
                    }
                    .ingredient-simple-row:nth-child(even) { background: white; }
                    .ingredient-simple-row:last-child { border-bottom: none; }
                    .ingredient-simple-name {
                        font-size: 17px;
                        font-weight: 700;
                        color: #000;
                    }
                    .ingredient-simple-lot {
                        font-size: 16px;
                        color: #000;
                        font-family: 'Courier New', monospace;
                        font-weight: 700;
                        background: #e8e8e8;
                        padding: 4px 10px;
                        border-radius: 4px;
                        border: 1px solid #000;
                    }
                    .ingredient-simple-qty {
                        font-size: 17px;
                        font-weight: 700;
                        color: #000;
                        text-align: right;
                    }
                    @media print {
                        body { 
                            padding: 0; 
                            background: white;
                        }
                        .instructions-box {
                            display: none;
                        }
                        @page { 
                            margin: 10mm;
                        }
                    }
                </style>
            `;
            
            // Cloner le contenu et lui appliquer la bonne classe
            const clonedContent = labelContent.cloneNode(true);
            clonedContent.className = 'label-printable ' + sizeClass;
            
            // Noms des formats pour l'affichage
            const sizeNames = {};
            getAllLabelFormats().forEach(f => { sizeNames[f.id] = f.name; });
            
            // Cr√©er le document HTML complet
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>√âtiquette ${sizeNames[selectedSize]} - ${lot.numero}</title>
                    ${styles}
                </head>
                <body>
                    ${clonedContent.outerHTML}
                    <div class="instructions-box" style="text-align: center; margin-top: 40px; padding: 25px; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 12px; border: 3px solid #ffc107; max-width: 700px; margin-left: auto; margin-right: auto; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);">
                        <p style="font-size: 20px; color: #000; margin-bottom: 15px; font-weight: 800;">
                            üìè Format s√©lectionn√© : ${sizeNames[selectedSize]}
                        </p>
                        <p style="font-size: 17px; color: #333; margin-bottom: 15px; font-weight: 700;">
                            <strong>Pour imprimer cette √©tiquette :</strong>
                        </p>
                        <p style="font-size: 16px; color: #555; line-height: 1.8;">
                            ‚Ä¢ Windows : <strong style="font-size: 18px; color: #000;">Ctrl + P</strong><br>
                            ‚Ä¢ Mac : <strong style="font-size: 18px; color: #000;">Cmd + P</strong><br><br>
                            <span style="font-size: 15px; color: #666;">
                                üí° S√©lectionnez votre imprimante Brother TD-4550 dans les options d'impression
                            </span>
                        </p>
                        <p style="font-size: 13px; color: #999; margin-top: 15px; font-style: italic;">
                            Ce bloc dispara√Ætra automatiquement √† l'impression
                        </p>
                    </div>
                </body>
                </html>
            `;
            
            // Cr√©er un blob et t√©l√©charger
            const blob = new Blob(['\uFEFF' + htmlContent], { type: 'text/html; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `etiquette_${selectedSize}_${lot.numero}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert(`‚úÖ √âtiquette ${sizeNames[selectedSize]} t√©l√©charg√©e ! Ouvrez le fichier et utilisez Ctrl+P pour imprimer.`, 'success');
        }

        function copyLabelHTML() {
            const labelContent = document.getElementById('label-content');
            if (!labelContent) {
                showAlert('Erreur : contenu non trouv√©', 'danger');
                return;
            }
            
            const htmlText = labelContent.outerHTML;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(htmlText).then(() => {
                    showAlert('‚úÖ Code HTML copi√© ! Collez-le dans un fichier .html', 'success');
                }).catch(() => {
                    showAlert('‚ùå Impossible de copier automatiquement', 'warning');
                });
            } else {
                showAlert('‚ùå Copie non support√©e par ce navigateur', 'warning');
            }
        }

        window.generateLabel = function(lot) {
            const labelContent = document.getElementById('label-content');
            
            // Nettoyer le nom du produit en enlevant la mention "(DLC: +X jours)"
            const productName = lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim();
            
            // Adapter la taille de police selon la longueur du nom
            let productFontSize = '14px';
            let productStyle = '';
            
            if (productName.length > 25) {
                productFontSize = '10px';
                productStyle = 'line-height: 1.1;';
            } else if (productName.length > 20) {
                productFontSize = '11px';
            } else if (productName.length > 15) {
                productFontSize = '12px';
            }
            
            // G√©n√©rer les donn√©es pour le QR Code (taille augment√©e pour meilleure lisibilit√©)
            const qrData = `LOT:${lot.numero}|PRODUIT:${productName}|DATE:${lot.date}|DLC:${lot.dlc || 'N/A'}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;
            
            labelContent.innerHTML = `
                <div class="label-simple-layout">
                    <!-- En-t√™te avec QR Code -->
                    <div class="label-simple-header">
                        <div class="label-simple-info">
                            <div class="label-simple-product" style="font-size: ${productFontSize}; ${productStyle}">${productName}</div>
                            <div class="label-simple-lot">Lot : ${lot.numero}</div>
                            ${lot.dlc ? `
                            <div class="label-simple-dlc">
                                <span class="dlc-simple-label">DLC :</span>
                                <span class="dlc-simple-date">${formatDate(lot.dlc)}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="label-simple-qr">
                            <img src="${qrCodeUrl}" alt="QR Code" class="qr-code-img">
                        </div>
                    </div>
                </div>
            `;
        }

        window.closeLabelModal = function() {
            document.getElementById('label-modal').style.display = 'none';
        }

        window.changeLabelSize = function() {
            const sizeSelect = document.getElementById('label-size-select');
            const labelContent = document.getElementById('label-content');
            const selectedSize = sizeSelect.value;
            
            // Retirer toutes les classes de taille
            labelContent.className = 'label-printable';
            
            // Ajouter la nouvelle classe de taille
            labelContent.classList.add('label-size-' + selectedSize);
            
            // Animation de changement fluide
            labelContent.style.transform = 'scale(0.95)';
            labelContent.style.opacity = '0.7';
            
            setTimeout(() => {
                labelContent.style.transform = 'scale(1)';
                labelContent.style.opacity = '1';
            }, 150);
            
            // Message visuel discret
            const sizeNames = {};
            getAllLabelFormats().forEach(f => { sizeNames[f.id] = f.name; });
            
            console.log(`Format d'√©tiquette chang√© : ${sizeNames[selectedSize] || selectedSize}`);
        }

        window.showPrintLabelOption = function(lotId) {
            showConfirmModal(
                'üñ®Ô∏è Imprimer l\'√©tiquette ?',
                'Voulez-vous imprimer l\'√©tiquette de ce lot maintenant ?',
                () => {
                    window.printLabel(lotId);
                }
            );
        }

        function updateProductSelects() {
            console.log('üîÑ Mise √† jour des s√©lecteurs de produits...');
            console.log('üì¶ Nombre de produits actifs:', productsConfig.filter(p => p.actif).length);
            
            const produitSelect = document.getElementById('produit');
            if (produitSelect) {
                const currentValue = produitSelect.value;
                
                produitSelect.innerHTML = '<option value="">S√©lectionner un produit</option>';
                
                const activeProducts = productsConfig.filter(p => p.actif);
                console.log('‚úÖ Produits actifs √† afficher:', activeProducts.length);
                
                // Trier par ordre alphab√©tique
                activeProducts.sort((a, b) => a.nom.localeCompare(b.nom, 'fr'));
                
                activeProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.nom} (DLC: +${product.dlc} jours)`;
                    option.setAttribute('data-dlc-days', product.dlc);
                    produitSelect.appendChild(option);
                });
                
                // Restaurer la valeur si elle existe toujours
                if (currentValue && activeProducts.find(p => p.id === currentValue)) {
                    produitSelect.value = currentValue;
                }
                
                console.log('‚úÖ S√©lecteur de produits mis √† jour');
            } else {
                console.warn('‚ö†Ô∏è S√©lecteur de produits non trouv√©');
            }
            
            // Mettre √† jour aussi le filtre de produits dans Consulter Lots
            const filterProduitSelect = document.getElementById('filter-produit');
            if (filterProduitSelect) {
                populateProductFilter();
                console.log('‚úÖ Filtre de produits mis √† jour');
            }
        }

        function calculateDLC() {
            const produitSelect = document.getElementById('produit');
            const dateProduction = document.getElementById('date-production');
            const dlcInput = document.getElementById('dlc');
            const dlcInfo = document.getElementById('dlc-info');
            
            if (!produitSelect || !dateProduction || !dlcInput || !dlcInfo) return;
            
            const selectedProductId = produitSelect.value;
            const productionDate = dateProduction.value;
            
            if (!selectedProductId || !productionDate) {
                dlcInput.value = '';
                dlcInfo.textContent = 'Calcul√©e automatiquement selon le produit';
                dlcInfo.style.color = '#666';
                return;
            }
            
            // Trouver le produit dans la configuration
            const product = productsConfig.find(p => p.id === selectedProductId);
            
            if (!product || !product.dlc) {
                dlcInput.value = '';
                dlcInfo.textContent = 'Dur√©e de conservation non d√©finie pour ce produit';
                dlcInfo.style.color = '#dc3545';
                return;
            }
            
            // Calculer la DLC
            const productionDateObj = new Date(productionDate);
            const dlcDateObj = new Date(productionDateObj);
            dlcDateObj.setDate(dlcDateObj.getDate() + product.dlc);
            
            // Formater la date pour l'input
            const dlcDateString = dlcDateObj.toISOString().split('T')[0];
            dlcInput.value = dlcDateString;
            
            // Mettre √† jour l'info
            dlcInfo.textContent = `DLC calcul√©e : +${product.dlc} jours (${formatDate(dlcDateString)})`;
            dlcInfo.style.color = '#28a745';
            
            // Ajouter une classe pour indiquer que c'est calcul√© automatiquement
            dlcInput.classList.add('auto-calculated');
            
            // Permettre la modification manuelle
            dlcInput.addEventListener('change', function() {
                if (this.value !== dlcDateString) {
                    dlcInfo.textContent = '‚úèÔ∏è DLC modifi√©e manuellement';
                    dlcInfo.style.color = '#ffc107';
                    dlcInfo.className = 'dlc-manual';
                    this.classList.remove('auto-calculated');
                    
                    // V√©rifier que la nouvelle DLC est coh√©rente
                    const newDlcDate = new Date(this.value);
                    const prodDate = new Date(productionDate);
                    const newDaysDiff = Math.round((newDlcDate - prodDate) / (1000 * 60 * 60 * 24));
                    
                    if (newDaysDiff > 0) {
                        dlcInfo.textContent += ` (+${newDaysDiff} jours)`;
                    }
                }
            }, { once: true });
        }

        // Affichage des lots
        function displayLots(lotsToShow = null) {
            const container = document.getElementById('lots-container');
            const lotsData = lotsToShow || filteredLots;
            
            const lotsCountElement = document.getElementById('lots-count');
            if (lotsCountElement) {
                lotsCountElement.textContent = `${lotsData.length} lot(s) trouv√©(s)`;
            }
            
            if (lotsData.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">Aucun lot trouv√© avec ces crit√®res.</div>';
                return;
            }
            
            container.innerHTML = lotsData.map(lot => {
                // Calculer le co√ªt √† partir des ingr√©dients si pas de co√ªt d√©fini
                let coutTotal = lot.cout || 0;
                let coutCalcule = false;
                
                if (!coutTotal && lot.ingredients) {
                    let ingredients = lot.ingredients;
                    if (typeof ingredients === 'string') {
                        try {
                            ingredients = JSON.parse(ingredients);
                        } catch (e) {
                            ingredients = [];
                        }
                    }
                    if (Array.isArray(ingredients) && ingredients.length > 0) {
                        coutTotal = ingredients.reduce((sum, ing) => sum + (ing.coutTotal || 0), 0);
                        coutCalcule = coutTotal > 0;
                    }
                }
                
                return `
                <div class="lot-card">
                    <div class="lot-header">
                        <div>
                            <div class="lot-number" style="cursor: pointer; transition: all 0.2s ease;" onclick="viewLotDetail(${lot.id})" title="Cliquer pour voir les d√©tails">${lot.numero}</div>
                            <div class="lot-status status-${lot.statut}">${getStatusLabel(lot.statut)}</div>
                        </div>
                        <div class="lot-actions">
                            <button class="btn btn-small" onclick="viewLotDetail(${lot.id})">üëÅÔ∏è D√©tails</button>
                            <button class="btn btn-small" onclick="exportLotPDF(${lot.id})" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">üìÑ PDF AFSCA</button>
                            <button class="btn btn-small" onclick="printLabel(${lot.id})">üñ®Ô∏è √âtiquette</button>
                            <button class="btn btn-small" onclick="printProductLabel(${lot.id})" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">üè∑Ô∏è √âtiq. Produit</button>
                            <button class="btn btn-small" onclick="editLot(${lot.id})">‚úèÔ∏è Modifier</button>
                            <button class="btn btn-small btn-danger" onclick="declareLotLoss(${lot.id})">‚ö†Ô∏è Perte</button>
                            <button class="btn btn-small btn-danger" onclick="deleteLot(${lot.id})">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                    <div class="lot-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 15px;">
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #8B4513;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üç´ Produit</div>
                            <div style="font-size: 15px; font-weight: 700; color: #000;">${lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim()}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üìÖ Date Production</div>
                            <div style="font-size: 15px; font-weight: 700; color: #000;">${formatDate(lot.date)}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #FF9800;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">‚öñÔ∏è Quantit√©</div>
                            <div style="font-size: 15px; font-weight: 700; color: #000;">${formatQuantite(lot.quantite, lot.unite)}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #9C27B0;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üë§ Op√©rateur</div>
                            <div style="font-size: 15px; font-weight: 700; color: #000;">${lot.operateur}</div>
                        </div>
                        ${lot.dlc ? `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üìÜ DLC</div>
                            <div style="font-size: 15px; font-weight: 700; color: #000;">${formatDate(lot.dlc)}${getDLCInfo(lot)}</div>
                        </div>
                        ` : ''}
                        ${coutTotal > 0 ? `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #2e7d32;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üí∞ Co√ªt Production</div>
                            <div style="font-size: 15px; font-weight: 700; color: #2e7d32;">${coutTotal.toFixed(2)} ‚Ç¨${coutCalcule ? ' <span style="font-size: 10px; color: #888;">(calcul√©)</span>' : ''}
                                ${(() => {
                                    let ings = lot.ingredients;
                                    if (typeof ings === 'string') { try { ings = JSON.parse(ings); } catch(e) { ings = []; } }
                                    if (!Array.isArray(ings)) ings = [];
                                    const totalIngKg = ings.reduce((s, i) => s + (i.quantiteUtilisee || 0), 0);
                                    return totalIngKg > 0 ? `<span style="font-size: 12px; color: #888; font-weight: normal;"> (${(coutTotal / totalIngKg).toFixed(2)} ‚Ç¨/kg)</span>` : '';
                                })()}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ${lot.observations ? `
                    <div style="margin-top: 10px; font-style: italic; color: #666;">
                        <strong>Observations:</strong> ${lot.observations}
                    </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        // Filtrage et tri
        function populateProductFilter() {
            const filter = document.getElementById('filter-produit');
            const products = [...new Set(lots.map(lot => lot.produit))];
            
            filter.innerHTML = '<option value="">Tous les produits</option>';
            products.forEach(product => {
                filter.innerHTML += `<option value="${product}">${product}</option>`;
            });
        }

        function applyLotsFilters() {
            const searchTerm = document.getElementById('search-lots').value.toLowerCase();
            const productFilter = document.getElementById('filter-produit').value;
            const statusFilter = document.getElementById('filter-statut').value;
            const dateDebut = document.getElementById('filter-date-debut').value;
            const dateFin = document.getElementById('filter-date-fin').value;
            
            filteredLots = lots.filter(lot => {
                const matchesSearch = !searchTerm || 
                    lot.numero.toLowerCase().includes(searchTerm) ||
                    lot.produit.toLowerCase().includes(searchTerm) ||
                    lot.operateur.toLowerCase().includes(searchTerm);
                
                const matchesProduct = !productFilter || lot.produit === productFilter;
                const matchesStatus = !statusFilter || lot.statut === statusFilter;
                const matchesDateDebut = !dateDebut || lot.date >= dateDebut;
                const matchesDateFin = !dateFin || lot.date <= dateFin;
                
                return matchesSearch && matchesProduct && matchesStatus && matchesDateDebut && matchesDateFin;
            });
            
            displayLots();
        }

        function clearFilters() {
            document.getElementById('search-lots').value = '';
            document.getElementById('filter-produit').value = '';
            document.getElementById('filter-statut').value = '';
            document.getElementById('filter-date-debut').value = '';
            document.getElementById('filter-date-fin').value = '';
            applyLotsFilters();
        }

        function applySorting() {
            const sortBy = document.getElementById('sort-by').value;
            
            filteredLots.sort((a, b) => {
                switch(sortBy) {
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'numero-asc':
                        return a.numero.localeCompare(b.numero);
                    case 'numero-desc':
                        return b.numero.localeCompare(a.numero);
                    case 'quantite-desc':
                        return b.quantite - a.quantite;
                    case 'quantite-asc':
                        return a.quantite - b.quantite;
                    default:
                        return 0;
                }
            });
            
            displayLots();
        }

        function getDLCInfo(lot) {
            if (!lot.dlc || !lot.date || !lot.produit) return '';
            
            const product = productsConfig.find(p => p.nom === lot.produit);
            if (!product) return '';
            
            const productionDate = new Date(lot.date);
            const dlcDate = new Date(lot.dlc);
            const daysDiff = Math.round((dlcDate - productionDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff === product.dlc) {
                return ' <span style="color: #28a745; font-size: 11px;">(calcul√©e auto)</span>';
            } else {
                return ` <span style="color: #ffc107; font-size: 11px;">(${daysDiff} jours)</span>`;
            }
        }

        function validateDLCCalculation() {
            const produitSelect = document.getElementById('produit');
            const dateProduction = document.getElementById('date-production');
            const dlcInput = document.getElementById('dlc');
            
            if (!produitSelect.value || !dateProduction.value) {
                return true; // Pas assez d'infos pour valider
            }
            
            if (!dlcInput.value) {
                showFieldError(dlcInput, 'La DLC doit √™tre calcul√©e ou saisie manuellement');
                return false;
            }
            
            const productionDate = new Date(dateProduction.value);
            const dlcDate = new Date(dlcInput.value);
            
            if (dlcDate <= productionDate) {
                showFieldError(dlcInput, 'La DLC doit √™tre post√©rieure √† la date de production');
                return false;
            }
            
            return true;
        }
        function editLot(id) {
            const lot = lots.find(l => l.id === id);
            if (!lot) return;
            
            document.getElementById('edit-lot-id').value = lot.id;
            document.getElementById('edit-numero').value = lot.numero || '';
            document.getElementById('edit-statut').value = lot.statut;
            document.getElementById('edit-quantite').value = lot.quantite;
            document.getElementById('edit-unite').value = lot.unite || 'kg';
            document.getElementById('edit-dlc').value = lot.dlc || '';
            document.getElementById('edit-cout').value = lot.cout || '';
            document.getElementById('edit-observations').value = lot.observations || '';
            
            document.getElementById('edit-modal').style.display = 'block';
        }

        async function saveEditedLot() {
            const id = parseInt(document.getElementById('edit-lot-id').value);
            const lot = lots.find(l => l.id === id);
            
            const newNumero = document.getElementById('edit-numero').value.trim();
            
            // V√©rifier que le num√©ro n'est pas vide
            if (!newNumero) {
                showAlert('‚ùå Le num√©ro de lot est obligatoire', 'danger');
                return;
            }
            
            // V√©rifier les doublons (sauf pour le lot actuel)
            const duplicate = lots.find(l => l.numero === newNumero && l.id !== id);
            if (duplicate) {
                showAlert(`‚ùå Ce num√©ro de lot existe d√©j√† pour "${duplicate.produit}"`, 'danger');
                return;
            }
            
            if (lot) {
                lot.numero = newNumero;
                lot.statut = document.getElementById('edit-statut').value;
                lot.quantite = parseFloat(document.getElementById('edit-quantite').value);
                lot.unite = document.getElementById('edit-unite').value;
                lot.dlc = document.getElementById('edit-dlc').value;
                lot.cout = document.getElementById('edit-cout').value ? parseFloat(document.getElementById('edit-cout').value) : 0;
                lot.observations = document.getElementById('edit-observations').value;
                
                // Sauvegarder dans Supabase
                const result = await saveToSupabase('lots', lot, true);
                
                // Fermer le modal
                closeModal();
                
                // Rafra√Æchir TOUTES les vues
                displayLots();
                updateStats();
                updateDashboard();
                
                // Message de succ√®s
                if (result.success) {
                    showAlert('‚úÖ Lot modifi√© et synchronis√© avec succ√®s !', 'success');
                } else {
                    showAlert('‚ö†Ô∏è Lot modifi√© localement (synchronisation en attente)', 'warning');
                }
            }
        }

        // ============================================
        // GESTION DES PERTES DE LOTS (PRODUITS FINIS)
        // ============================================
        
        function declareLotLoss(id) {
            const lot = lots.find(l => l.id === id);
            if (!lot) {
                showAlert('Lot non trouv√©', 'danger');
                return;
            }
            
            console.log('üìä D√©claration perte lot:', lot.numero);
            console.log('   - lot.cout:', lot.cout);
            console.log('   - lot.quantite:', lot.quantite);
            console.log('   - lot.quantite_initiale:', lot.quantite_initiale);
            console.log('   - lot.ingredients:', lot.ingredients);
            
            // Calculer le co√ªt total du lot (depuis lot.cout ou depuis les ingr√©dients)
            let coutTotal = lot.cout || 0;
            let ingredients = lot.ingredients || [];
            
            // Parser les ingr√©dients si c'est une string JSON
            while (typeof ingredients === 'string') {
                try { 
                    ingredients = JSON.parse(ingredients); 
                } catch (e) { 
                    ingredients = []; 
                    break;
                }
            }
            if (!Array.isArray(ingredients)) ingredients = [];
            
            // Si pas de co√ªt direct, essayer de calculer depuis les ingr√©dients
            if (!coutTotal && ingredients.length > 0) {
                
                if (Array.isArray(ingredients) && ingredients.length > 0) {
                    // D'abord essayer avec coutTotal existant
                    coutTotal = ingredients.reduce((sum, ing) => sum + (ing.coutTotal || 0), 0);
                    console.log('   - Co√ªt calcul√© depuis ingr√©dients (coutTotal):', coutTotal);
                    
                    // Si toujours 0, recalculer depuis les prix actuels des MP
                    if (coutTotal === 0) {
                        console.log('   - Recalcul depuis prix actuels des MP...');
                        console.log('   - Nombre de MP en m√©moire:', matieresPremi√®res.length);
                        
                        coutTotal = ingredients.reduce((sum, ing) => {
                            // Trouver la MP correspondante pour obtenir son co√ªt actuel
                            const mp = matieresPremi√®res.find(m => m.id === ing.matierePremiereId);
                            if (mp) {
                                const coutMP = mp.cout || mp.prix || mp.prix_unitaire || 0;
                                const coutIng = (ing.quantiteUtilisee || 0) * coutMP;
                                console.log(`      - ${ing.matierePremiereNom} (ID:${ing.matierePremiereId}): ${ing.quantiteUtilisee}kg √ó ${coutMP}‚Ç¨/kg = ${coutIng.toFixed(2)}‚Ç¨`);
                                return sum + coutIng;
                            } else {
                                console.log(`      - ${ing.matierePremiereNom} (ID:${ing.matierePremiereId}): MP NON TROUV√âE !`);
                            }
                            return sum;
                        }, 0);
                        console.log('   - Co√ªt recalcul√© depuis MP actuelles:', coutTotal);
                    }
                }
            }
            
            // Calculer le co√ªt unitaire bas√© sur le poids total des ingr√©dients
            let totalIngKgLoss = 0;
            if (Array.isArray(ingredients) && ingredients.length > 0) {
                totalIngKgLoss = ingredients.reduce((sum, ing) => sum + (ing.quantiteUtilisee || 0), 0);
            }
            const quantiteRef = totalIngKgLoss > 0 ? totalIngKgLoss : (lot.quantite_initiale || lot.quantiteInitiale || lot.quantite || 1);
            const coutUnitaire = coutTotal > 0 ? coutTotal / quantiteRef : 0;
            
            console.log('   - Co√ªt total final:', coutTotal);
            console.log('   - Quantit√© ref:', quantiteRef);
            console.log('   - Co√ªt unitaire:', coutUnitaire);
            
            document.getElementById('lot-loss-id').value = lot.id;
            document.getElementById('lot-loss-numero').textContent = lot.numero;
            document.getElementById('lot-loss-produit').textContent = lot.produit;
            document.getElementById('lot-loss-current-qty').textContent = `${(lot.quantite * 1000).toFixed(0)} g (${lot.quantite.toFixed(3)} kg)`;
            document.getElementById('lot-loss-quantity').value = '';
            document.getElementById('lot-loss-quantity').max = lot.quantite * 1000;
            document.getElementById('lot-loss-type').value = '';
            document.getElementById('lot-loss-reason').value = '';
            document.getElementById('lot-loss-date').value = new Date().toISOString().split('T')[0];
            
            // Afficher le co√ªt si disponible
            const coutInfoDiv = document.getElementById('lot-loss-cout-info');
            const coutUnitaireInput = document.getElementById('lot-loss-cout-unitaire-value');
            const valeurEstimeeDiv = document.getElementById('lot-loss-valeur-estimee');
            
            if (coutTotal > 0) {
                document.getElementById('lot-loss-cout-total').textContent = coutTotal.toFixed(2);
                document.getElementById('lot-loss-cout-unitaire').textContent = `(${coutUnitaire.toFixed(2)} ‚Ç¨/${lot.unite || 'kg'})`;
                coutUnitaireInput.value = coutUnitaire;
                coutInfoDiv.style.display = 'block';
                valeurEstimeeDiv.style.display = 'block';
                document.getElementById('lot-loss-valeur-montant').textContent = '0.00';
            } else {
                coutInfoDiv.style.display = 'none';
                coutUnitaireInput.value = 0;
                valeurEstimeeDiv.style.display = 'none';
            }
            
            document.getElementById('lot-loss-modal').style.display = 'block';
        }
        
        function updateLotLossValue() {
            const quantityG = parseFloat(document.getElementById('lot-loss-quantity').value) || 0;
            const quantity = quantityG / 1000; // Convertir en kg
            const coutUnitaire = parseFloat(document.getElementById('lot-loss-cout-unitaire-value').value) || 0;
            const valeurPerte = quantity * coutUnitaire;
            
            const valeurEstimeeDiv = document.getElementById('lot-loss-valeur-estimee');
            if (coutUnitaire > 0 && quantity > 0) {
                document.getElementById('lot-loss-valeur-montant').textContent = valeurPerte.toFixed(2);
                valeurEstimeeDiv.style.display = 'block';
            } else if (coutUnitaire === 0) {
                valeurEstimeeDiv.style.display = 'none';
            }
        }
        
        function closeLotLossModal() {
            document.getElementById('lot-loss-modal').style.display = 'none';
        }
        
        function getLotLossTypeLabel(type) {
            const labels = {
                'casse': 'üî® Casse / Dommage',
                'defaut_qualite': '‚ùå D√©faut qualit√©',
                'peremption': 'üìÖ P√©remption',
                'retour_client': '‚Ü©Ô∏è Retour client',
                'echantillon': 'üç´ √âchantillon',
                'autre': '‚ùì Autre'
            };
            return labels[type] || type;
        }
        
        async function saveLotLossDeclaration() {
            const lotId = parseInt(document.getElementById('lot-loss-id').value);
            const quantityG = parseFloat(document.getElementById('lot-loss-quantity').value);
            const quantity = quantityG / 1000; // Convertir en kg
            const lossType = document.getElementById('lot-loss-type').value;
            const reason = document.getElementById('lot-loss-reason').value.trim();
            const lossDate = document.getElementById('lot-loss-date').value;
            
            // Validations
            if (!quantityG || quantityG <= 0) {
                showAlert('Veuillez saisir une quantit√© valide', 'warning');
                return;
            }
            
            if (!lossType) {
                showAlert('Veuillez s√©lectionner un type de perte', 'warning');
                return;
            }
            
            if (!reason) {
                showAlert('Veuillez d√©crire la perte', 'warning');
                return;
            }
            
            const lot = lots.find(l => l.id === lotId);
            if (!lot) {
                showAlert('Lot non trouv√©', 'danger');
                return;
            }
            
            if (quantity > lot.quantite) {
                showAlert(`Impossible de d√©clarer ${quantityG.toFixed(0)}g de perte.\nStock actuel: ${(lot.quantite * 1000).toFixed(0)}g`, 'danger');
                return;
            }
            
            // R√©cup√©rer le co√ªt unitaire calcul√© dans le modal
            const coutUnitaire = parseFloat(document.getElementById('lot-loss-cout-unitaire-value').value) || 0;
            const valeurPerte = quantity * coutUnitaire;
            
            // Cr√©er l'enregistrement de perte
            const loss = {
                matiere_premiere: `LOT: ${lot.numero}`,
                categorie: 'produit_fini',
                lot: lot.numero,
                fournisseur: 'Production interne',
                quantity: quantity,
                type: lossType,
                reason: reason,
                date: lossDate,
                cout: coutUnitaire,
                valeur_perte: valeurPerte,
                declared_at: new Date().toISOString()
            };
            
            // Sauvegarder la perte dans Supabase
            const lossResult = await saveToSupabase('losses', loss, false);
            
            if (lossResult.success && lossResult.data) {
                loss.id = lossResult.data[0].id;
            } else {
                loss.id = Date.now();
            }
            
            // Ajouter au tableau local
            losses.push(loss);
            
            // Mettre √† jour la quantit√© du lot
            const oldQuantity = lot.quantite;
            lot.quantite = Math.max(0, lot.quantite - quantity);
            
            // Sauvegarder le lot mis √† jour
            await saveToSupabase('lots', lot, true);
            
            // Sauvegarder localement
            saveToLocalStorage();
            
            // Fermer le modal
            closeLotLossModal();
            
            // Rafra√Æchir l'affichage
            filteredLots = [...lots];
            displayLots();
            updateStats();
            updateDashboard();
            
            // Message de confirmation
            const statusText = lossResult.success && !lossResult.offline ? ' ‚úÖ [Synchronis√© ‚òÅÔ∏è]' : ' ‚ö†Ô∏è [Sauvegard√© localement]';
            showAlert(`‚ö†Ô∏è Perte d√©clar√©e sur le lot ${lot.numero}\n\n` +
                `üì¶ Produit: ${lot.produit}\n` +
                `üìâ Quantit√© perdue: ${quantityG.toFixed(0)}g\n` +
                `üìä Stock mis √† jour: ${(oldQuantity * 1000).toFixed(0)}g ‚Üí ${(lot.quantite * 1000).toFixed(0)}g\n` +
                `üí∞ Valeur de la perte: ${valeurPerte.toFixed(2)}‚Ç¨\n` +
                `üìã Type: ${getLotLossTypeLabel(lossType)}${statusText}`, 'warning');
        }

        function deleteLot(id) {
            const lot = lots.find(l => l.id === id);
            if (!lot) return;
            
            // V√©rifier si le lot a des ingr√©dients √† restocker
            let ingredients = lot.ingredients;
            if (typeof ingredients === 'string') {
                try { ingredients = JSON.parse(ingredients); } catch (e) { ingredients = []; }
            }
            if (!Array.isArray(ingredients)) ingredients = [];
            
            const hasIngredients = ingredients.length > 0;
            const confirmMsg = hasIngredients 
                ? `√ätes-vous s√ªr de vouloir supprimer le lot "${lot.numero}" ?\n\nüì¶ Les stocks de ${ingredients.length} mati√®re(s) premi√®re(s) seront restaur√©s.\n\nCette action est irr√©versible.`
                : `√ätes-vous s√ªr de vouloir supprimer le lot "${lot.numero}" ? Cette action est irr√©versible.`;
            
            showConfirmModal(
                'Supprimer ce lot ?',
                confirmMsg,
                async () => {
                    const lotIndex = lots.findIndex(l => l.id === id);
                    if (lotIndex > -1) {
                        const lotSupprime = lots[lotIndex];
                        
                        // Restaurer les stocks des mati√®res premi√®res
                        if (hasIngredients) {
                            await restoreStockFromIngredients(ingredients);
                        }
                        
                        lots.splice(lotIndex, 1);
                        filteredLots = filteredLots.filter(l => l.id !== id);
                        
                        // Supprimer de Supabase
                        await deleteFromSupabase('lots', id);
                        
                        const stockMsg = hasIngredients ? `\nüì¶ Stocks de ${ingredients.length} MP restaur√©s` : '';
                        showAlert(`Lot ${lotSupprime.numero} supprim√© avec succ√®s !${stockMsg}`, 'success');
                        displayLots();
                        updateStats();
                        updateDashboard();
                        displayMatieresPremi√®res();
                        checkStockAlerts();
                        updateIngredientsSelect();
                    }
                }
            );
        }
        
        // Restaurer les stocks quand un lot est supprim√©
        async function restoreStockFromIngredients(ingredients) {
            for (const ingredient of ingredients) {
                const mp = matieresPremi√®res.find(m => m.id === ingredient.matierePremiereId);
                if (mp) {
                    const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                    const quantiteARestituer = ingredient.quantiteUtilisee || 0;
                    const newQuantite = quantiteActuelle + quantiteARestituer;
                    
                    mp.quantite_actuelle = newQuantite;
                    mp.quantiteActuelle = newQuantite;
                    
                    console.log(`‚ôªÔ∏è Restock ${mp.nom}: ${quantiteActuelle.toFixed(3)}kg + ${quantiteARestituer.toFixed(3)}kg = ${newQuantite.toFixed(3)}kg`);
                    await saveToSupabase('matieres_premieres', mp, true);
                }
            }
        }

        function closeLotDetail() {
            document.getElementById('lot-detail-modal').style.display = 'none';
        }
        
        // Fonction pour associer une recette √† un lot existant
        async function associerRecetteAuLot(lotId) {
            const lot = lots.find(l => l.id === lotId);
            if (!lot) {
                showAlert('Lot non trouv√©', 'danger');
                return;
            }
            
            // Nettoyer le nom du produit
            const productName = lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim();
            
            // Chercher la recette correspondant au produit
            const recipe = recipesConfig.find(r => {
                const product = productsConfig.find(p => p.id === r.productId);
                return product && product.nom.toLowerCase() === productName.toLowerCase();
            });
            
            if (!recipe || !recipe.ingredients || recipe.ingredients.length === 0) {
                showAlert(`Aucune recette trouv√©e pour "${productName}". Cr√©ez d'abord une recette dans l'onglet Recettes.`, 'warning');
                return;
            }
            
            // Calculer le ratio bas√© sur la quantit√© du lot
            const recipeBaseQty = recipe.uniteBase === 'g' ? (recipe.quantiteBase || 1) / 1000 : (recipe.quantiteBase || 1);
            const ratio = lot.quantite / recipeBaseQty;
            
            // Cr√©er les ingr√©dients √† partir de la recette
            const ingredientsToAdd = [];
            let coutTotal = 0;
            
            for (const ing of recipe.ingredients) {
                const quantiteNecessaire = (ing.quantity || ing.quantite || 0) * ratio;
                
                // Chercher la MP par ID d'abord, puis par nom
                let mp = null;
                if (ing.mpId) {
                    mp = matieresPremi√®res.find(m => m.id === ing.mpId && !m.archived);
                }
                if (!mp && ing.mpNom) {
                    // Recherche tol√©rante (sans accents, insensible √† la casse)
                    const searchName = ing.mpNom.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    mp = matieresPremi√®res.find(m => {
                        if (m.archived) return false;
                        const mpName = m.nom.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                        return mpName === searchName || mpName.includes(searchName) || searchName.includes(mpName);
                    });
                }
                
                if (mp) {
                    const prixUnitaire = mp.prix_unitaire || mp.prixUnitaire || 0;
                    const coutIng = quantiteNecessaire * prixUnitaire;
                    coutTotal += coutIng;
                    
                    ingredientsToAdd.push({
                        matierePremiereId: mp.id,
                        matierePremiereNom: mp.nom,
                        matierePremiereLot: mp.lot || 'N/A',
                        matierePremiereCategorie: mp.categorie || 'autre',
                        matierePremiereFournisseur: mp.fournisseur || '',
                        quantiteUtilisee: quantiteNecessaire,
                        coutUnitaire: prixUnitaire,
                        coutTotal: coutIng
                    });
                } else {
                    // MP non trouv√©e, ajouter quand m√™me avec les infos disponibles
                    ingredientsToAdd.push({
                        matierePremiereId: ing.mpId || null,
                        matierePremiereNom: ing.mpNom || 'Inconnu',
                        matierePremiereLot: 'N/A',
                        matierePremiereCategorie: 'autre',
                        matierePremiereFournisseur: '',
                        quantiteUtilisee: quantiteNecessaire,
                        coutUnitaire: 0,
                        coutTotal: 0
                    });
                }
            }
            
            // Ajouter l'enrobage chocolat si pr√©sent
            if (recipe.enrobageChocolat && recipe.enrobageChocolat.productId) {
                const enrobageQty = (recipe.enrobageChocolat.quantite || 0) * ratio;
                const enrobagePrix = recipe.enrobageChocolat.prixUnitaire || 0;
                const enrobageCout = enrobageQty * enrobagePrix;
                coutTotal += enrobageCout;
                
                ingredientsToAdd.push({
                    matierePremiereId: null,
                    matierePremiereNom: recipe.enrobageChocolat.productName || 'Enrobage chocolat',
                    matierePremiereLot: 'Production interne',
                    matierePremiereCategorie: 'chocolat',
                    matierePremiereFournisseur: 'Interne',
                    quantiteUtilisee: enrobageQty,
                    coutUnitaire: enrobagePrix,
                    coutTotal: enrobageCout
                });
            }
            
            if (ingredientsToAdd.length === 0) {
                showAlert('Aucun ingr√©dient √† ajouter', 'warning');
                return;
            }
            
            // Mettre √† jour le lot
            lot.ingredients = ingredientsToAdd;
            lot.cout = coutTotal;
            
            // Sauvegarder dans Supabase
            const result = await saveToSupabase('lots', lot, true);
            
            // Fermer le d√©tail et le rouvrir pour voir les changements
            closeLotDetail();
            setTimeout(() => {
                viewLotDetail(lotId);
            }, 100);
            
            if (result.success) {
                showAlert(`‚úÖ Recette associ√©e ! ${ingredientsToAdd.length} ingr√©dient(s) ajout√©(s) au lot.`, 'success');
            } else {
                showAlert(`‚ö†Ô∏è Recette associ√©e localement (${ingredientsToAdd.length} ingr√©dient(s)). Synchronisation en attente.`, 'warning');
            }
        }

        function viewLotDetail(id) {
            const lot = lots.find(l => l.id === id);
            if (!lot) {
                showAlert('Lot non trouv√©', 'danger');
                return;
            }
            
            const title = document.getElementById('lot-detail-title');
            const content = document.getElementById('lot-detail-content');
            
            title.textContent = `üì¶ D√©tail du Lot ${lot.numero}`;
            
            // Debug: afficher les ingr√©dients bruts
            
            // Parser ingredients si c'est une string JSON
            let ingredients = lot.ingredients;
            if (typeof ingredients === 'string') {
                try {
                    ingredients = JSON.parse(ingredients);
                } catch (e) {
                    ingredients = [];
                }
            }
            if (!Array.isArray(ingredients)) {
                ingredients = [];
            }
            
            
            // Normaliser les ingr√©dients (compatibilit√© ancien/nouveau format)
            if (ingredients.length > 0) {
            }
            
            ingredients = ingredients.map(ing => {
                const normalized = {
                    matierePremiereId: ing.matierePremiereId || ing.mpId || ing.id,
                    matierePremiereNom: ing.matierePremiereNom || ing.mpNom || ing.nom || 'N/A',
                    matierePremiereLot: ing.matierePremiereLot || ing.mpLot || ing.lot || 'N/A',
                    matierePremiereCategorie: ing.matierePremiereCategorie || ing.categorie || 'autre',
                    matierePremiereFournisseur: ing.matierePremiereFournisseur || ing.fournisseur || '',
                    quantiteUtilisee: ing.quantiteUtilisee || ing.quantite || 0,
                    coutUnitaire: ing.coutUnitaire || ing.cout || 0,
                    coutTotal: ing.coutTotal || ((ing.quantiteUtilisee || ing.quantite || 0) * (ing.coutUnitaire || ing.cout || 0))
                };
                return normalized;
            });
            
            // Calculer le co√ªt total des ingr√©dients
            const coutTotalIngredients = ingredients.reduce((sum, ing) => sum + (ing.coutTotal || 0), 0);
            const coutLot = lot.cout || coutTotalIngredients;
            
            // Construire le contenu d√©taill√©
            let ingredientsHTML = '';
            if (ingredients && ingredients.length > 0) {
                const totalQty = ingredients.reduce((sum, ing) => sum + (ing.quantiteUtilisee || 0), 0);
                
                ingredientsHTML = `
                    <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 12px; border: 2px solid #D2691E; box-shadow: 0 4px 12px rgba(139, 69, 19, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #D2691E; flex-wrap: wrap; gap: 15px;">
                            <h3 style="color: #8B4513; font-size: 20px; margin: 0;">üßÑ Ingr√©dients Utilis√©s</h3>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Total quantit√©</div>
                                    <div style="background: #8B4513; color: white; padding: 8px 16px; border-radius: 20px; font-size: 16px; font-weight: 900;">
                                        ${totalQty.toFixed(1)} kg
                                    </div>
                                </div>
                                ${coutTotalIngredients > 0 ? `
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Co√ªt production</div>
                                    <div style="background: #2e7d32; color: white; padding: 8px 16px; border-radius: 20px; font-size: 16px; font-weight: 900;">
                                        ${coutTotalIngredients.toFixed(2)} ‚Ç¨
                                        ${(() => {
                                            const totalIngKg = ingredients.reduce((s, i) => s + (i.quantiteUtilisee || 0), 0);
                                            return totalIngKg > 0 ? `<span style="font-size: 13px; font-weight: 600; opacity: 0.9;"> (${(coutTotalIngredients / totalIngKg).toFixed(2)} ‚Ç¨/kg)</span>` : '';
                                        })()}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 15px;">
                            ${ingredients.map((ing, index) => {
                                const coutIng = ing.coutTotal || 0;
                                const coutUnitaire = ing.coutUnitaire || 0;
                                return `
                                <div style="background: white; padding: 18px; border-radius: 10px; border-left: 5px solid #D2691E; box-shadow: 0 3px 6px rgba(0,0,0,0.08); transition: transform 0.2s ease;">
                                    <div style="display: grid; grid-template-columns: auto auto 1fr auto; gap: 15px; align-items: center;">
                                        <div style="background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 16px; box-shadow: 0 2px 6px rgba(139, 69, 19, 0.3);">
                                            ${index + 1}
                                        </div>
                                        
                                        <span class="lot-status" style="font-size: 12px; padding: 5px 12px; white-space: nowrap;">${getCategorieLabel(ing.matierePremiereCategorie || 'autre')}</span>
                                        
                                        <div>
                                            <div style="font-weight: 700; font-size: 17px; color: #000; margin-bottom: 6px;">
                                                ${ing.matierePremiereNom}
                                                ${coutUnitaire > 0 ? `<span style="font-size: 12px; color: #888; font-weight: normal;">(${coutUnitaire.toFixed(2)} ‚Ç¨/kg)</span>` : ''}
                                            </div>
                                            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                                                <div style="background: #000; color: #fff; padding: 5px 12px; border-radius: 6px; font-weight: 900; font-family: 'Courier New', monospace; font-size: 13px; letter-spacing: 0.5px;">
                                                    Lot: ${ing.matierePremiereLot}
                                                </div>
                                                ${ing.matierePremiereFournisseur ? `
                                                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                                                    <span style="font-size: 16px;">üè≠</span>
                                                    <span style="font-size: 13px; color: #666; font-weight: 600;">${ing.matierePremiereFournisseur}</span>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        
                                        <div style="text-align: right; padding-left: 15px; border-left: 2px solid #e9ecef;">
                                            <div style="font-weight: 900; font-size: 24px; color: #D2691E; line-height: 1;">
                                                ${(ing.quantiteUtilisee || 0).toFixed(3)}
                                            </div>
                                            <div style="font-size: 13px; color: #666; font-weight: 600; margin-top: 2px;">
                                                kilogrammes
                                            </div>
                                            ${coutIng > 0 ? `
                                            <div style="font-size: 14px; color: #2e7d32; font-weight: 700; margin-top: 4px;">
                                                üí∞ ${coutIng.toFixed(2)} ‚Ç¨
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 8px; border: 2px solid #ffc107;">
                            <strong style="color: #856404;">üí° Tra√ßabilit√© Compl√®te</strong>
                            <div style="margin-top: 8px; color: #856404; font-size: 14px;">
                                Tous les ingr√©dients sont tra√ßables jusqu'au fournisseur d'origine. Les num√©ros de lots fournisseurs permettent une tra√ßabilit√© ascendante compl√®te.
                            </div>
                        </div>
                    </div>
                `;
            } else {
                ingredientsHTML = `
                    <div style="margin-top: 25px; padding: 30px; text-align: center; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                        <div style="font-size: 16px; color: #666; font-weight: 600; margin-bottom: 15px;">Aucun ingr√©dient enregistr√© pour ce lot</div>
                        <button class="btn" onclick="associerRecetteAuLot(${lot.id})" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">
                            üìã Associer une recette
                        </button>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #8B4513;">
                        <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üç´ Produit</div>
                        <div style="font-size: 16px; font-weight: 700; color: #000;">${lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim()}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üìÖ Date Production</div>
                        <div style="font-size: 16px; font-weight: 700; color: #000;">${formatDate(lot.date)}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
                        <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">‚öñÔ∏è Quantit√©</div>
                        <div style="font-size: 16px; font-weight: 700; color: #000;">${formatQuantite(lot.quantite, lot.unite)}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #9C27B0;">
                        <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üë§ Op√©rateur</div>
                        <div style="font-size: 16px; font-weight: 700; color: #000;">${lot.operateur}</div>
                    </div>
                    ${lot.dlc ? `
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                        <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üìÜ DLC</div>
                        <div style="font-size: 16px; font-weight: 700; color: #000;">${formatDate(lot.dlc)}</div>
                    </div>
                    ` : ''}
                    ${lot.cout ? `
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #F44336;">
                        <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üí∞ Co√ªt</div>
                        <div style="font-size: 16px; font-weight: 700; color: #000;">${lot.cout.toFixed(2)} ‚Ç¨</div>
                    </div>
                    ` : ''}
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #607D8B;">
                        <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üìä Statut</div>
                        <div><span class="lot-status status-${lot.statut}">${getStatusLabel(lot.statut)}</span></div>
                    </div>
                </div>
                
                ${lot.observations ? `
                <div style="margin-bottom: 25px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #795548;">
                    <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">üìù Observations</div>
                    <div style="font-size: 15px; color: #333; font-style: italic;">${lot.observations}</div>
                </div>
                ` : ''}
                
                ${ingredientsHTML}
                
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <button class="btn" onclick="exportLotPDF(${lot.id});" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">üìÑ Rapport AFSCA</button>
                    <button class="btn" onclick="printLabel(${lot.id}); closeLotDetail();">üñ®Ô∏è √âtiquette Lot</button>
                    <button class="btn" onclick="printProductLabel(${lot.id}); closeLotDetail();" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">üè∑Ô∏è √âtiquette Produit</button>
                    <button class="btn btn-secondary" onclick="editLot(${lot.id}); closeLotDetail();">‚úèÔ∏è Modifier</button>
                    <button class="btn btn-secondary" onclick="closeLotDetail()">‚ùå Fermer</button>
                </div>
            `;
            
            document.getElementById('lot-detail-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            
            const messageElement = document.getElementById('confirm-message');
            messageElement.style.whiteSpace = 'pre-line';
            messageElement.style.textAlign = 'left';
            messageElement.style.lineHeight = '1.6';
            messageElement.style.maxHeight = '400px';
            messageElement.style.overflowY = 'auto';
            messageElement.textContent = message;
            
            const modal = document.getElementById('confirm-modal');
            const yesBtn = document.getElementById('confirm-yes');
            const noBtn = document.getElementById('confirm-no');
            
            // Nettoyer les anciens event listeners
            yesBtn.replaceWith(yesBtn.cloneNode(true));
            noBtn.replaceWith(noBtn.cloneNode(true));
            
            // R√©cup√©rer les nouveaux √©l√©ments
            const newYesBtn = document.getElementById('confirm-yes');
            const newNoBtn = document.getElementById('confirm-no');
            
            newYesBtn.onclick = () => {
                modal.style.display = 'none';
                onConfirm();
            };
            
            newNoBtn.onclick = () => {
                modal.style.display = 'none';
            };
            
            modal.style.display = 'block';
        }

        // Mati√®res premi√®res
        let editingMPId = null; // Variable pour suivre l'√©dition en cours
        
        function clearMPForm() {
            document.getElementById('mp-nom').value = '';
            document.getElementById('mp-nom').style.display = 'none';
            document.getElementById('mp-nom-select').value = '';
            document.getElementById('mp-categorie').selectedIndex = 0;
            document.getElementById('mp-lot').value = '';
            document.getElementById('mp-fournisseur').value = '';
            document.getElementById('mp-date-reception').value = '';
            document.getElementById('mp-dlc').value = '';
            document.getElementById('mp-quantite').value = '';
            document.getElementById('mp-cout').value = '';
            document.getElementById('mp-stock-mini').value = '';
            showAlert('üóëÔ∏è Formulaire effac√©', 'info');
        }

        async function addMatierePremiere() {
            if (!validateForm('matiere-premiere-form')) {
                return;
            }
            
            const quantite = parseFloat(document.getElementById('mp-quantite').value) / 1000;
            const cout = document.getElementById('mp-cout').value ? parseFloat(document.getElementById('mp-cout').value) : 0;
            const stockMini = document.getElementById('mp-stock-mini').value ? parseFloat(document.getElementById('mp-stock-mini').value) / 1000 : 0;
            
            // V√©rifier que la quantit√© est valide
            if (!quantite || quantite <= 0) {
                showAlert('La quantit√© doit √™tre sup√©rieure √† 0', 'danger');
                return;
            }
            
            // Si on est en mode √©dition
            if (editingMPId !== null) {
                const mpIndex = matieresPremi√®res.findIndex(m => m.id === editingMPId);
                if (mpIndex > -1) {
                    const existingMP = matieresPremi√®res[mpIndex];
                    
                    // Mettre √† jour la MP existante
                    existingMP.nom = document.getElementById('mp-nom').value.trim();
                    existingMP.categorie = document.getElementById('mp-categorie').value;
                    existingMP.lot = document.getElementById('mp-lot').value.trim();
                    existingMP.fournisseur = document.getElementById('mp-fournisseur').value.trim();
                    existingMP.dateReception = document.getElementById('mp-date-reception').value;
                    existingMP.date_reception = document.getElementById('mp-date-reception').value;
                    existingMP.dlc = document.getElementById('mp-dlc').value;
                    existingMP.quantiteActuelle = quantite;
                    existingMP.quantite_actuelle = quantite;
                    existingMP.cout = cout;
                    existingMP.stockMini = stockMini;
                    existingMP.stock_mini = stockMini;
                    
                    // Sauvegarder dans Supabase
                    const result = await saveToSupabase('matieres_premieres', {
                        id: editingMPId,
                        nom: existingMP.nom,
                        categorie: existingMP.categorie,
                        lot: existingMP.lot,
                        fournisseur: existingMP.fournisseur,
                        date_reception: existingMP.dateReception,
                        dlc: existingMP.dlc,
                        quantite_actuelle: quantite,
                        cout: cout,
                        stock_mini: stockMini
                    }, true); // true = update
                    
                    const statusText = result.offline ? ' [Sauvegard√© localement]' : ' [Synchronis√© ‚òÅÔ∏è]';
                    showAlert(`‚úèÔ∏è Mati√®re premi√®re "${existingMP.nom}" modifi√©e avec succ√®s !` + statusText, 'success');
                    
                    // R√©initialiser le mode √©dition
                    editingMPId = null;
                    
                    // Retirer le style d'√©dition du formulaire
                    const form = document.getElementById('matiere-premiere-form');
                    if (form) {
                        form.style.border = '';
                        form.style.background = '';
                    }
                    
                    // R√©initialiser le formulaire
                    resetMPForm();
                    
                    // Rafra√Æchir les affichages
                    refreshAllMPLists();
                    displayMatieresPremi√®res();
                    displayInventaire();
                    checkStockAlerts();
                    updateMPFilters();
                    updateStats();
                    updateDashboard();
                    updateIngredientsSelect();
                    updateRecipeIngredientSelect();
                    
                    return;
                }
            }
            
            // Mode cr√©ation (code existant)
            const newMP = {
                nom: document.getElementById('mp-nom').value.trim(),
                categorie: document.getElementById('mp-categorie').value,
                lot: document.getElementById('mp-lot').value.trim(),
                fournisseur: document.getElementById('mp-fournisseur').value.trim(),
                date_reception: document.getElementById('mp-date-reception').value,
                dlc: document.getElementById('mp-dlc').value,
                quantite_initiale: quantite,
                quantite_actuelle: quantite,
                cout: cout,
                stock_mini: stockMini,
                archived: false,
                archived_at: null,
                archived_reason: null
            };
            
            console.log('üíæ Cr√©ation nouvelle MP:', {
                nom: newMP.nom,
                quantite_actuelle: newMP.quantite_actuelle,
                quantite_initiale: newMP.quantite_initiale,
                stock_mini: newMP.stock_mini
            });
            
            // Sauvegarder dans Supabase
            const result = await saveToSupabase('matieres_premieres', newMP, false);
            
            if (result.success && result.data) {
                newMP.id = result.data[0].id;
                newMP.created_at = result.data[0].created_at;
            } else {
                newMP.id = Date.now();
                newMP.created_at = new Date().toISOString();
            }
            
            matieresPremi√®res.push(newMP);
            
            const statusText = result.offline ? ' [Sauvegard√© localement]' : ' [Synchronis√© ‚òÅÔ∏è]';
            showAlert(`Mati√®re premi√®re "${newMP.nom}" ajout√©e avec succ√®s !` + statusText, 'success');
            
            // R√©initialiser le formulaire
            resetMPForm();
            
            // Rafra√Æchir tous les affichages
            refreshAllMPLists();
            displayMatieresPremi√®res();
            displayInventaire();
            checkStockAlerts();
            updateMPFilters();
            updateStats();
            updateDashboard();
            
            // Mettre √† jour tous les s√©lecteurs d'ingr√©dients
            updateIngredientsSelect();
            updateRecipeIngredientSelect();
        }
        
        function resetMPForm() {
            const inputs = document.querySelectorAll('#matiere-premiere-form input, #matiere-premiere-form select');
            inputs.forEach(input => {
                if (input.type === 'select-one') {
                    input.value = '';
                } else {
                    input.value = '';
                }
            });
            document.getElementById('mp-date-reception').value = new Date().toISOString().split('T')[0];
            
            // R√©initialiser le mode √©dition
            editingMPId = null;
            
            // Retirer le style d'√©dition
            const form = document.getElementById('matiere-premiere-form');
            if (form) {
                form.style.border = '';
                form.style.background = '';
            }
        }

        // ============================================
        // TRI DES MATI√àRES PREMI√àRES PAR COLONNE
        // ============================================
        
        let currentMPSort = { column: null, direction: 'asc' };
        
        function sortMPTable(column) {
            // Si m√™me colonne, inverser la direction
            if (currentMPSort.column === column) {
                currentMPSort.direction = currentMPSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentMPSort.column = column;
                currentMPSort.direction = 'asc';
            }
            
            // Trier filteredMatieresPremi√®res
            filteredMatieresPremi√®res.sort((a, b) => {
                let valA, valB;
                
                switch(column) {
                    case 'categorie':
                        valA = (a.categorie || '').toLowerCase();
                        valB = (b.categorie || '').toLowerCase();
                        break;
                    case 'nom':
                        valA = (a.nom || '').toLowerCase();
                        valB = (b.nom || '').toLowerCase();
                        break;
                    case 'lot':
                        valA = (a.lot || '').toLowerCase();
                        valB = (b.lot || '').toLowerCase();
                        break;
                    case 'fournisseur':
                        valA = (a.fournisseur || '').toLowerCase();
                        valB = (b.fournisseur || '').toLowerCase();
                        break;
                    case 'stock':
                        valA = a.quantite_actuelle || a.quantiteActuelle || 0;
                        valB = b.quantite_actuelle || b.quantiteActuelle || 0;
                        break;
                    case 'dlc':
                        valA = a.dlc ? new Date(a.dlc).getTime() : 0;
                        valB = b.dlc ? new Date(b.dlc).getTime() : 0;
                        break;
                    case 'statut':
                        valA = getStockStatus(a);
                        valB = getStockStatus(b);
                        break;
                    default:
                        valA = '';
                        valB = '';
                }
                
                // Comparaison
                let comparison = 0;
                if (typeof valA === 'number' && typeof valB === 'number') {
                    comparison = valA - valB;
                } else {
                    comparison = String(valA).localeCompare(String(valB), 'fr');
                }
                
                return currentMPSort.direction === 'asc' ? comparison : -comparison;
            });
            
            // Mettre √† jour les indicateurs visuels
            updateMPSortIndicators();
            
            // Rafra√Æchir l'affichage
            displayMatieresPremi√®res();
        }
        
        function updateMPSortIndicators() {
            // R√©initialiser tous les indicateurs
            const indicators = ['categorie', 'nom', 'lot', 'fournisseur', 'stock', 'dlc', 'statut'];
            indicators.forEach(col => {
                const indicator = document.getElementById(`sort-mp-${col}`);
                if (indicator) {
                    indicator.textContent = '‚áÖ';
                    indicator.classList.remove('active');
                }
            });
            
            // Mettre √† jour l'indicateur actif
            if (currentMPSort.column) {
                const activeIndicator = document.getElementById(`sort-mp-${currentMPSort.column}`);
                if (activeIndicator) {
                    activeIndicator.textContent = currentMPSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
                    activeIndicator.classList.add('active');
                }
            }
        }

        function displayMatieresPremi√®res() {
            const tbody = document.querySelector('#mp-table tbody');
            const countElement = document.getElementById('mp-count');
            
            if (!tbody) {
                return;
            }
            
            // Filtrer les MP non archiv√©es uniquement
            const mpToDisplay = filteredMatieresPremi√®res.filter(mp => !mp.archived);
            
            if (countElement) {
                countElement.textContent = mpToDisplay.length;
            }
            
            if (!Array.isArray(mpToDisplay) || mpToDisplay.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Aucune mati√®re premi√®re active enregistr√©e</td></tr>';
                return;
            }
            
            tbody.innerHTML = mpToDisplay.map((mp) => {
                const stockStatus = getStockStatus(mp);
                const stockLabel = getStockStatusLabel(mp);
                const dlcFormatted = mp.dlc ? formatDate(mp.dlc) : 'N/A';
                const categorieLabel = getCategorieLabel(mp.categorie);
                
                // Gestion compatibilit√© camelCase et snake_case
                const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                
                // V√©rifier si la MP est √©ligible pour archivage automatique
                const isEligibleForArchive = checkIfEligibleForArchive(mp);
                const archiveWarning = isEligibleForArchive ? '<br><span style="color: #dc3545; font-size: 11px;">‚ö†Ô∏è √âligible archivage auto</span>' : '';
                
                return `
                    <tr>
                        <td style="padding: 10px 12px;">
                            <span class="lot-status" style="font-size: 10px; padding: 3px 8px; white-space: nowrap;">${categorieLabel}</span>
                        </td>
                        <td style="padding: 10px 12px;"><strong>${mp.nom}</strong>${archiveWarning}</td>
                        <td style="padding: 10px 12px; font-family: 'Courier New', monospace; font-size: 13px;">${mp.lot}</td>
                        <td style="padding: 10px 12px;">${mp.fournisseur}</td>
                        <td style="padding: 10px 12px; text-align: center;"><strong style="font-size: 14px;">${quantiteActuelle.toFixed(3)} kg</strong></td>
                        <td style="padding: 10px 12px; text-align: center; font-size: 13px;">${dlcFormatted}</td>
                        <td style="padding: 10px 12px; text-align: center;">
                            <span class="lot-status ${stockStatus}" style="font-size: 10px; padding: 3px 8px;">${stockLabel}</span>
                        </td>
                        <td class="actions-column" style="padding: 8px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: flex-start;">
                                <button class="btn btn-small" onclick="editMatierePremiere(${mp.id})" style="font-size: 11px; padding: 5px 8px;">‚úèÔ∏è Modifier</button>
                                <button class="btn btn-small btn-secondary" onclick="adjustStock(${mp.id})" style="font-size: 11px; padding: 5px 8px;">üì¶ Stock</button>
                                <button class="btn btn-small btn-danger" onclick="declareLoss(${mp.id})" style="font-size: 11px; padding: 5px 8px;">‚ö†Ô∏è Perte</button>
                                <button class="btn btn-small" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); font-size: 11px; padding: 5px 8px;" onclick="archiveMatierePremiere(${mp.id}, 'manuel')">üì¶ Archiver</button>
                                <button class="btn btn-small btn-danger" onclick="deleteMatierePremiere(${mp.id})" style="font-size: 11px; padding: 5px 8px;">üóëÔ∏è Supprimer</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function getCategorieLabel(categorie) {
            const labels = {
                'cacao': 'üç´ Cacao',
                'sucre': 'üç¨ Sucre',
                'laitier': 'ü•õ Laitier',
                'fruits-secs': 'üå∞ Fruits Secs',
                'epices': 'üåø √âpices',
                'matieres-grasses': 'üßà Mati√®res Grasses',
                'additifs': '‚öóÔ∏è Additifs',
                'autre': 'üì¶ Autre'
            };
            return labels[categorie] || 'üì¶ Autre';
        }

        function getStockStatus(mp) {
            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            const stockMini = mp.stock_mini || mp.stockMini || 0;
            
            if (quantiteActuelle <= stockMini) return 'status-non-conforme';
            if (quantiteActuelle <= stockMini * 1.5) return 'status-production';
            return 'status-conforme';
        }

        function getStockStatusLabel(mp) {
            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            const stockMini = mp.stock_mini || mp.stockMini || 0;
            
            if (quantiteActuelle <= stockMini) return 'STOCK FAIBLE';
            if (quantiteActuelle <= stockMini * 1.5) return 'ATTENTION';
            return 'OK';
        }

        function checkStockAlerts() {
            const alertsContainer = document.getElementById('mp-alerts-container');
            if (!alertsContainer) return;
            
            // Filtrer uniquement les MP actives (non archiv√©es)
            const activeMP = getActiveMatieresPremi√®res();
            
            const lowStock = activeMP.filter(mp => {
                const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const stockMini = mp.stock_mini || mp.stockMini || 0;
                return stockMini > 0 && quantiteActuelle <= stockMini;
            });
            
            if (lowStock.length > 0) {
                alertsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Alertes Stock :</strong>
                        ${lowStock.map(mp => {
                            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                            return `${mp.nom} (${quantiteActuelle.toFixed(1)}kg restants)`;
                        }).join(', ')}
                    </div>
                `;
            } else {
                alertsContainer.innerHTML = '';
            }
        }

        function deleteMatierePremiere(id) {
            const mp = matieresPremi√®res.find(m => m.id === id);
            if (!mp) return;
            
            showConfirmModal(
                'Supprimer cette mati√®re premi√®re',
                `√ätes-vous s√ªr de vouloir supprimer "${mp.nom}" (Lot: ${mp.lot}) ? Cette action est irr√©versible.`,
                async () => {
                    const mpIndex = matieresPremi√®res.findIndex(m => m.id === id);
                    if (mpIndex > -1) {
                        const mpSupprimee = matieresPremi√®res[mpIndex];
                        matieresPremi√®res.splice(mpIndex, 1);
                        
                        // Supprimer de Supabase
                        await deleteFromSupabase('matieres_premieres', id);
                        
                        showAlert(`Mati√®re premi√®re "${mpSupprimee.nom}" supprim√©e avec succ√®s !`, 'success');
                        refreshAllMPLists();
                        displayMatieresPremi√®res();
                        checkStockAlerts();
                        updateIngredientsSelect();
                        updateMPFilters();
                    }
                }
            );
        }

        function editMatierePremiere(id) {
            const mp = matieresPremi√®res.find(m => m.id === id);
            if (!mp) return;
            
            // D√©finir l'ID en cours d'√©dition
            editingMPId = id;
            
            // Remplir le formulaire avec les donn√©es existantes
            const mpSelect = document.getElementById('mp-nom-select');
            const mpInput = document.getElementById('mp-nom');
            mpInput.value = mp.nom;
            
            // V√©rifier si la MP existe dans le select
            const selectOption = Array.from(mpSelect.options).find(o => o.value === mp.nom);
            if (selectOption) {
                mpSelect.value = mp.nom;
                mpInput.style.display = 'none';
            } else {
                mpSelect.value = '__custom__';
                mpInput.style.display = 'block';
            }
            
            document.getElementById('mp-categorie').value = mp.categorie || 'autre';
            document.getElementById('mp-lot').value = mp.lot;
            document.getElementById('mp-fournisseur').value = mp.fournisseur;
            document.getElementById('mp-date-reception').value = mp.dateReception || mp.date_reception;
            document.getElementById('mp-dlc').value = mp.dlc || '';
            document.getElementById('mp-quantite').value = Math.round((mp.quantiteActuelle || mp.quantite_actuelle || 0) * 1000);
            document.getElementById('mp-cout').value = mp.cout || '';
            document.getElementById('mp-stock-mini').value = Math.round((mp.stockMini || mp.stock_mini || 0) * 1000) || '';
            
            // Mettre en √©vidence le formulaire en mode √©dition
            const form = document.getElementById('matiere-premiere-form');
            if (form) {
                form.style.border = '3px solid #ff9800';
                form.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
            }
            
            // Faire d√©filer vers le formulaire
            document.getElementById('mp-nom-select').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            showAlert(`‚úèÔ∏è Mode √©dition : "${mp.nom}"\n\nModifiez les champs et cliquez sur "Enregistrer".\nLe formulaire est surlign√© en orange.`, 'warning');
        }
        
        function updateMPFilters() {
            // Mettre √† jour le filtre des fournisseurs
            const fournisseurFilter = document.getElementById('filter-mp-fournisseur');
            const fournisseurs = [...new Set(matieresPremi√®res.map(mp => mp.fournisseur))];
            
            fournisseurFilter.innerHTML = '<option value="">Tous les fournisseurs</option>';
            fournisseurs.forEach(fournisseur => {
                fournisseurFilter.innerHTML += `<option value="${fournisseur}">${fournisseur}</option>`;
            });
        }
        
        function applyMPFilters() {
            const categorieFilter = document.getElementById('filter-mp-categorie').value;
            const fournisseurFilter = document.getElementById('filter-mp-fournisseur').value;
            const stockFilter = document.getElementById('filter-mp-stock').value;
            
            filteredMatieresPremi√®res = matieresPremi√®res.filter(mp => {
                const matchesCategorie = !categorieFilter || mp.categorie === categorieFilter;
                const matchesFournisseur = !fournisseurFilter || mp.fournisseur === fournisseurFilter;
                
                // Compatibilit√© snake_case et camelCase
                const quantiteActuelle = mp.quantite_actuelle ?? mp.quantiteActuelle ?? 0;
                const stockMini = mp.stock_mini ?? mp.stockMini ?? 0;
                
                let matchesStock = true;
                if (stockFilter === 'alerte') {
                    matchesStock = quantiteActuelle <= stockMini;
                } else if (stockFilter === 'ok') {
                    matchesStock = quantiteActuelle > stockMini;
                }
                
                return matchesCategorie && matchesFournisseur && matchesStock;
            });
            
            displayMatieresPremi√®res();
        }
        
        function clearMPFilters() {
            document.getElementById('filter-mp-categorie').value = '';
            document.getElementById('filter-mp-fournisseur').value = '';
            document.getElementById('filter-mp-stock').value = '';
            refreshAllMPLists();
            displayMatieresPremi√®res();
        }

        function adjustStock(id) {
            const mp = matieresPremi√®res.find(m => m.id === id);
            if (!mp) return;
            
            // Compatibilit√© snake_case et camelCase
            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            const stockMini = mp.stock_mini || mp.stockMini || 0;
            
            document.getElementById('stock-mp-id').value = mp.id;
            document.getElementById('stock-mp-name').textContent = mp.nom;
            document.getElementById('stock-current-value').textContent = (quantiteActuelle * 1000).toFixed(0) + ' g';
            document.getElementById('stock-operation').value = 'remove';
            document.getElementById('stock-quantity').value = '';
            document.getElementById('stock-reason').value = '';
            
            document.getElementById('stock-modal').style.display = 'block';
        }

        async function saveStockAdjustment() {
            const mpId = parseInt(document.getElementById('stock-mp-id').value);
            const operation = document.getElementById('stock-operation').value;
            const quantityInput = document.getElementById('stock-quantity').value;
            const reason = document.getElementById('stock-reason').value;
            
            // V√©rifier que la quantit√© est saisie (peut √™tre 0 pour "set")
            if (quantityInput === '' || quantityInput === null || quantityInput === undefined) {
                showAlert('Veuillez saisir une quantit√©', 'warning');
                return;
            }
            
            const quantity = parseFloat(quantityInput) / 1000;
            
            // V√©rifier que c'est un nombre valide
            if (isNaN(quantity)) {
                showAlert('Veuillez saisir une quantit√© valide', 'warning');
                return;
            }
            
            // Pour les op√©rations add et remove, la quantit√© doit √™tre > 0
            // Pour set, on accepte 0 (pour mettre le stock √† 0)
            if ((operation === 'add' || operation === 'remove') && quantity <= 0) {
                showAlert('La quantit√© doit √™tre sup√©rieure √† 0 pour cette op√©ration', 'warning');
                return;
            }
            
            // Pour set, on accepte 0 ou plus
            if (operation === 'set' && quantity < 0) {
                showAlert('La quantit√© ne peut pas √™tre n√©gative', 'warning');
                return;
            }
            
            console.log('üì¶ Ajustement stock:', { mpId, operation, quantity, reason });
            
            const mp = matieresPremi√®res.find(m => m.id === mpId);
            if (!mp) {
                console.error('‚ùå Mati√®re premi√®re non trouv√©e:', mpId);
                showAlert('Erreur: Mati√®re premi√®re non trouv√©e', 'danger');
                return;
            }
            
            console.log('‚úÖ Mati√®re premi√®re trouv√©e:', mp.nom);
            
            // Compatibilit√© snake_case et camelCase
            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            const oldStock = quantiteActuelle;
            let newStock = quantiteActuelle;
            
            console.log('üìä Stock actuel:', oldStock);
            
            switch(operation) {
                case 'add':
                    newStock = quantiteActuelle + quantity;
                    console.log('‚ûï Ajout:', quantity, '‚Üí Nouveau stock:', newStock);
                    break;
                case 'remove':
                    if (quantity > quantiteActuelle) {
                        showAlert(`Impossible de retirer ${(quantity * 1000).toFixed(0)}g. Stock actuel: ${(quantiteActuelle * 1000).toFixed(0)}g`, 'danger');
                        return;
                    }
                    newStock = quantiteActuelle - quantity;
                    console.log('‚ûñ Retrait:', quantity, '‚Üí Nouveau stock:', newStock);
                    break;
                case 'set':
                    newStock = quantity;
                    console.log('üîÑ D√©finition:', newStock);
                    break;
            }
            
            // Mettre √† jour les deux formats
            mp.quantite_actuelle = newStock;
            mp.quantiteActuelle = newStock;
            
            console.log('üíæ Sauvegarde dans Supabase...');
            
            const operationLabels = {
                'add': 'Ajout de',
                'remove': 'Retrait de',
                'set': 'Stock d√©fini √†'
            };
            
            // Sauvegarder dans Supabase
            const result = await saveToSupabase('matieres_premieres', mp, true);
            
            if (result.success || result.offline) {
                console.log('‚úÖ Stock sauvegard√© avec succ√®s');
                
                const message = `${operationLabels[operation]} ${(quantity * 1000).toFixed(0)}g pour "${mp.nom}"${reason ? ` (${reason})` : ''}. Stock: ${(oldStock * 1000).toFixed(0)}g ‚Üí ${(newStock * 1000).toFixed(0)}g`;
                
                showAlert(message, 'success');
                
                closeStockModal();
                
                // Mettre √† jour toutes les interfaces
                refreshAllMPLists();
                displayMatieresPremi√®res();
                displayInventaire();
                updateInventaireStats();
                checkStockAlerts();
                updateIngredientsSelect();
            } else {
                console.error('‚ùå Erreur lors de la sauvegarde:', result.error);
                showAlert('Erreur lors de la sauvegarde du stock', 'danger');
            }
        }

        function closeLossModal() {
            document.getElementById('loss-modal').style.display = 'none';
        }

        window.declareLoss = function(id) {
            const mp = matieresPremi√®res.find(m => m.id === id);
            if (!mp) return;
            
            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            
            document.getElementById('loss-mp-id').value = mp.id;
            document.getElementById('loss-mp-name').textContent = mp.nom;
            document.getElementById('loss-current-value').textContent = (quantiteActuelle * 1000).toFixed(0) + ' g';
            document.getElementById('loss-quantity').value = '';
            document.getElementById('loss-type').value = '';
            document.getElementById('loss-reason').value = '';
            document.getElementById('loss-date').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('loss-modal').style.display = 'block';
        }

        async function saveLossDeclaration() {
            console.log('üöÄ === D√âBUT saveLossDeclaration ===');
            
            const mpId = parseInt(document.getElementById('loss-mp-id').value);
            const quantity = parseFloat(document.getElementById('loss-quantity').value) / 1000;
            const lossType = document.getElementById('loss-type').value;
            const reason = document.getElementById('loss-reason').value.trim();
            const lossDate = document.getElementById('loss-date').value;
            
            console.log('üìù Valeurs du formulaire:', { mpId, quantity, lossType, reason, lossDate });
            
            if (!quantity || quantity <= 0) {
                console.log('‚ùå Quantit√© invalide');
                showAlert('Veuillez saisir une quantit√© valide', 'warning');
                return;
            }
            
            if (!lossType) {
                console.log('‚ùå Type de perte manquant');
                showAlert('Veuillez s√©lectionner un type de perte', 'warning');
                return;
            }
            
            if (!reason) {
                console.log('‚ùå Raison manquante');
                showAlert('Veuillez d√©crire la perte', 'warning');
                return;
            }
            
            const mp = matieresPremi√®res.find(m => m.id === mpId);
            if (!mp) {
                console.log('‚ùå Mati√®re premi√®re introuvable');
                return;
            }
            
            console.log('‚úÖ Mati√®re premi√®re trouv√©e:', mp.nom);
            
            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            
            console.log('üìä Stock actuel:', quantiteActuelle, 'kg');
            
            if (quantity > quantiteActuelle) {
                console.log('‚ùå Quantit√© insuffisante');
                showAlert(`Impossible de d√©clarer ${(quantity * 1000).toFixed(0)}g de perte. Stock actuel: ${(quantiteActuelle * 1000).toFixed(0)}g`, 'danger');
                return;
            }
            
            console.log('‚úÖ Validation OK - Cr√©ation objet loss');
            
            // Enregistrer la perte dans l'historique
            // Noms de colonnes selon la structure Supabase (snake_case)
            const loss = {
                matiere_premiere_id: mpId,
                matiere_premiere: mp.nom,
                categorie: mp.categorie || 'autre',
                lot: mp.lot,
                fournisseur: mp.fournisseur,
                quantity: quantity,
                type: lossType,
                reason: reason,
                date: lossDate,
                cout: mp.cout || 0,
                valeur_perte: quantity * (mp.cout || 0),
                declared_at: new Date().toISOString()
            };
            
            console.log('üì¶ Objet loss cr√©√©:', loss);
            console.log('üì¶ Tentative de sauvegarde de la perte dans Supabase:', loss);
            console.log('üîç Structure de la perte:', JSON.stringify(loss, null, 2));
            console.log('üîó Client Supabase disponible:', !!supabaseClient);
            console.log('üåê Mode en ligne:', isOnline);
            
            console.log('üöÄ Appel saveToSupabase...');
            
            // Sauvegarder la perte dans Supabase
            const lossResult = await saveToSupabase('losses', loss, false);
            
            console.log('‚úÖ saveToSupabase termin√©');
            console.log('üìä R√©sultat sauvegarde perte:', lossResult);
            console.log('üìä R√©sultat d√©taill√©:', JSON.stringify(lossResult, null, 2));
            
            if (lossResult.success && lossResult.data) {
                loss.id = lossResult.data[0].id;
                loss.created_at = lossResult.data[0].created_at;
                console.log('‚úÖ Perte sauvegard√©e dans Supabase avec ID:', loss.id);
                console.log('‚úÖ Donn√©es retourn√©es:', lossResult.data[0]);
            } else if (lossResult.offline) {
                console.warn('‚ö†Ô∏è Mode hors-ligne - perte sauvegard√©e localement');
            } else if (lossResult.error) {
                console.error('‚ùå Erreur lors de la sauvegarde de la perte:', lossResult.error);
                console.error('‚ùå Message erreur:', lossResult.error.message);
                console.error('‚ùå Code erreur:', lossResult.error.code);
            }
            
            console.log('‚ûï Ajout de la perte au tableau losses');
            losses.push(loss);
            console.log('üìä Nombre total de pertes:', losses.length);
            
            // Mettre √† jour le stock
            const newStock = Math.max(0, quantiteActuelle - quantity);
            mp.quantite_actuelle = newStock;
            mp.quantiteActuelle = newStock;
            
            console.log('üì¶ Mise √† jour du stock:', quantiteActuelle, '‚Üí', newStock);
            
            // Sauvegarder la mati√®re premi√®re mise √† jour dans Supabase
            console.log('üíæ Sauvegarde de la mati√®re premi√®re mise √† jour...');
            await saveToSupabase('matieres_premieres', mp, true);
            
            const lossStatusText = lossResult.success && !lossResult.offline ? ' ‚úÖ [Perte synchronis√©e ‚òÅÔ∏è]' : (lossResult.offline ? ' ‚ö†Ô∏è [Perte sauvegard√©e localement - Sync √† la reconnexion]' : ' ‚ö†Ô∏è [Erreur Supabase - Perte sauvegard√©e localement]');
            
            const valeurPerte = loss.valeurperte || (quantity * (mp.cout || 0));
            
            showAlert(`‚ö†Ô∏è Perte d√©clar√©e : ${quantity.toFixed(1)}kg de ${mp.nom}\nType : ${getLossTypeLabel(lossType)}\nStock mis √† jour : ${quantiteActuelle.toFixed(1)}kg ‚Üí ${newStock.toFixed(1)}kg\nValeur de la perte : ${valeurPerte.toFixed(2)}‚Ç¨${lossStatusText}`, 'warning');
            
            closeLossModal();
            
            // Mettre √† jour les interfaces
            refreshAllMPLists();
            displayMatieresPremi√®res();
            displayInventaire();
            updateInventaireStats();
            checkStockAlerts();
            checkInventaireAlerts();
            
            console.log('üèÅ === FIN saveLossDeclaration ===');
        }

        function getLossTypeLabel(type) {
            const labels = {
                'casse': 'Casse / D√©t√©rioration',
                'dlc': 'DLC / DLUO d√©pass√©e',
                'contamination': 'Contamination',
                'erreur': 'Erreur de manipulation',
                'autre': 'Autre'
            };
            return labels[type] || type;
        }

        function closeStockModal() {
            document.getElementById('stock-modal').style.display = 'none';
        }

        // ============================================
        // INVENTAIRE
        // ============================================
        
        let filteredInventaire = [];
        let currentInventaireSort = { column: null, direction: 'asc' };
        
        function sortInventaireByColumn(column) {
            console.log('üîÑ Tri inventaire par:', column);
            
            // Si on clique sur la m√™me colonne, inverser la direction
            if (currentInventaireSort.column === column) {
                currentInventaireSort.direction = currentInventaireSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // Nouvelle colonne, commencer par ascendant
                currentInventaireSort.column = column;
                currentInventaireSort.direction = 'asc';
            }
            
            console.log('üìä Direction:', currentInventaireSort.direction);
            console.log('üì¶ Nombre d\'√©l√©ments √† trier:', filteredInventaire.length);
            
            // Trier les donn√©es
            filteredInventaire.sort((a, b) => {
                const qtyA = a.quantite_actuelle || a.quantiteActuelle || 0;
                const qtyB = b.quantite_actuelle || b.quantiteActuelle || 0;
                const miniA = a.stock_mini || a.stockMini || 0;
                const miniB = b.stock_mini || b.stockMini || 0;
                const coutA = a.cout || 0;
                const coutB = b.cout || 0;
                const valeurA = qtyA * coutA;
                const valeurB = qtyB * coutB;
                
                let comparison = 0;
                
                switch(column) {
                    case 'categorie':
                        const catA = categoriesMP.find(c => c.id === a.categorie);
                        const catB = categoriesMP.find(c => c.id === b.categorie);
                        comparison = (catA?.nom || 'Autre').localeCompare(catB?.nom || 'Autre');
                        break;
                    case 'nom':
                        comparison = a.nom.localeCompare(b.nom);
                        break;
                    case 'lot':
                        comparison = a.lot.localeCompare(b.lot);
                        break;
                    case 'fournisseur':
                        comparison = a.fournisseur.localeCompare(b.fournisseur);
                        break;
                    case 'stock':
                        comparison = qtyA - qtyB;
                        break;
                    case 'stock-mini':
                        comparison = miniA - miniB;
                        break;
                    case 'cout':
                        comparison = coutA - coutB;
                        break;
                    case 'valeur':
                        comparison = valeurA - valeurB;
                        break;
                    case 'dlc':
                        if (!a.dlc && !b.dlc) comparison = 0;
                        else if (!a.dlc) comparison = 1;
                        else if (!b.dlc) comparison = -1;
                        else comparison = new Date(a.dlc) - new Date(b.dlc);
                        break;
                    default:
                        comparison = 0;
                }
                
                return currentInventaireSort.direction === 'asc' ? comparison : -comparison;
            });
            
            console.log('‚úÖ Tri termin√©');
            
            // Mettre √† jour les ic√¥nes
            updateInventaireSortIcons();
            
            // R√©afficher
            displayInventaire();
        }
        
        function updateInventaireSortIcons() {
            // R√©initialiser toutes les ic√¥nes
            ['categorie', 'nom', 'lot', 'fournisseur', 'stock', 'stock-mini', 'cout', 'valeur', 'dlc'].forEach(col => {
                const icon = document.getElementById(`sort-icon-${col}`);
                if (icon) {
                    icon.textContent = '‚ÜïÔ∏è';
                }
            });
            
            // Mettre √† jour l'ic√¥ne de la colonne active
            if (currentInventaireSort.column) {
                const icon = document.getElementById(`sort-icon-${currentInventaireSort.column}`);
                if (icon) {
                    icon.textContent = currentInventaireSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                    console.log('üéØ Ic√¥ne mise √† jour:', currentInventaireSort.column, currentInventaireSort.direction);
                }
            }
        }
        
        
        function updateInventaire() {
            refreshAllMPLists();
            
            // Mettre √† jour les statistiques
            updateInventaireStats();
            
            // Mettre √† jour les filtres
            updateInventaireFilters();
            
            // Afficher l'inventaire
            displayInventaire();
            
            // V√©rifier les alertes
            checkInventaireAlerts();
            
            // Ajouter l'√©v√©nement de recherche
            const searchInput = document.getElementById('search-inventaire');
            if (searchInput) {
                searchInput.removeEventListener('input', handleInventaireSearch);
                searchInput.addEventListener('input', handleInventaireSearch);
            }
        }
        
        function handleInventaireSearch() {
            applyInventaireFilters();
        }
        
        function updateInventaireStats() {
            // Exclure les MP archiv√©es pour les stats
            const activeMP = matieresPremi√®res.filter(mp => !mp.archived);
            const totalMP = activeMP.length;
            const stockTotal = activeMP.reduce((sum, mp) => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                return sum + qty;
            }, 0);
            const valeurTotale = activeMP.reduce((sum, mp) => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const cout = mp.cout || 0;
                return sum + (qty * cout);
            }, 0);
            const alertes = activeMP.filter(mp => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const mini = mp.stock_mini || mp.stockMini || 0;
                return mini > 0 && qty <= mini;
            }).length;
            
            document.getElementById('inventaire-total-mp').textContent = totalMP;
            document.getElementById('inventaire-stock-total').textContent = stockTotal.toFixed(1);
            document.getElementById('inventaire-valeur-totale').textContent = valeurTotale.toFixed(2);
            document.getElementById('inventaire-alertes').textContent = alertes;
        }
        
        function updateInventaireFilters() {
            const categorieFilter = document.getElementById('filter-inventaire-categorie');
            if (!categorieFilter) return;
            
            categorieFilter.innerHTML = '<option value="">Toutes les cat√©gories</option>';
            categoriesMP.filter(cat => cat.actif).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.emoji} ${cat.nom}`;
                categorieFilter.appendChild(option);
            });
        }
        
        function applyInventaireFilters() {
            const searchTerm = document.getElementById('search-inventaire').value.toLowerCase();
            const categorieFilter = document.getElementById('filter-inventaire-categorie').value;
            const stockFilter = document.getElementById('filter-inventaire-stock').value;
            const sortBy = document.getElementById('sort-inventaire').value;
            
            // Filtrer - EXCLURE les MP archiv√©es
            filteredInventaire = matieresPremi√®res.filter(mp => {
                // Exclure les MP archiv√©es
                if (mp.archived) return false;
                
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const mini = mp.stock_mini || mp.stockMini || 0;
                
                const matchesSearch = !searchTerm || 
                    mp.nom.toLowerCase().includes(searchTerm) ||
                    mp.lot.toLowerCase().includes(searchTerm) ||
                    mp.fournisseur.toLowerCase().includes(searchTerm);
                
                const matchesCategorie = !categorieFilter || mp.categorie === categorieFilter;
                
                let matchesStock = true;
                if (stockFilter === 'critique') {
                    matchesStock = qty <= mini;
                } else if (stockFilter === 'faible') {
                    matchesStock = qty > mini && qty <= mini * 1.5;
                } else if (stockFilter === 'ok') {
                    matchesStock = qty > mini * 1.5;
                }
                
                return matchesSearch && matchesCategorie && matchesStock;
            });
            
            // Appliquer le tri du s√©lecteur de tri
            filteredInventaire.sort((a, b) => {
                const qtyA = a.quantite_actuelle || a.quantiteActuelle || 0;
                const qtyB = b.quantite_actuelle || b.quantiteActuelle || 0;
                const valeurA = qtyA * (a.cout || 0);
                const valeurB = qtyB * (b.cout || 0);
                
                switch(sortBy) {
                    case 'nom-asc': return a.nom.localeCompare(b.nom);
                    case 'nom-desc': return b.nom.localeCompare(a.nom);
                    case 'stock-desc': return qtyB - qtyA;
                    case 'stock-asc': return qtyA - qtyB;
                    case 'valeur-desc': return valeurB - valeurA;
                    case 'dlc-asc': 
                        if (!a.dlc && !b.dlc) return 0;
                        if (!a.dlc) return 1;
                        if (!b.dlc) return -1;
                        return new Date(a.dlc) - new Date(b.dlc);
                    default: return 0;
                }
            });
            
            // R√©initialiser le tri par clic sur colonne
            currentInventaireSort = { column: null, direction: 'asc' };
            updateInventaireSortIcons();
            
            displayInventaire();
        }
        
        function clearInventaireFilters() {
            document.getElementById('search-inventaire').value = '';
            document.getElementById('filter-inventaire-categorie').value = '';
            document.getElementById('filter-inventaire-stock').value = '';
            document.getElementById('sort-inventaire').value = 'nom-asc';
            applyInventaireFilters();
        }
        
        // ============================================
        // TRI DE L'INVENTAIRE PAR COLONNE (cliquable)
        // ============================================
        
        function sortInventaireTable(column) {
            // Si m√™me colonne, inverser la direction
            if (currentInventaireSort.column === column) {
                currentInventaireSort.direction = currentInventaireSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentInventaireSort.column = column;
                currentInventaireSort.direction = 'asc';
            }
            
            // Trier filteredInventaire
            filteredInventaire.sort((a, b) => {
                let valA, valB;
                
                switch(column) {
                    case 'categorie':
                        valA = (a.categorie || '').toLowerCase();
                        valB = (b.categorie || '').toLowerCase();
                        break;
                    case 'nom':
                        valA = (a.nom || '').toLowerCase();
                        valB = (b.nom || '').toLowerCase();
                        break;
                    case 'lot':
                        valA = (a.lot || '').toLowerCase();
                        valB = (b.lot || '').toLowerCase();
                        break;
                    case 'fournisseur':
                        valA = (a.fournisseur || '').toLowerCase();
                        valB = (b.fournisseur || '').toLowerCase();
                        break;
                    case 'stock':
                        valA = a.quantite_actuelle || a.quantiteActuelle || 0;
                        valB = b.quantite_actuelle || b.quantiteActuelle || 0;
                        break;
                    case 'stockMini':
                        valA = a.stockMini || a.stock_mini || 0;
                        valB = b.stockMini || b.stock_mini || 0;
                        break;
                    case 'cout':
                        valA = a.prixUnitaire || a.prix_unitaire || 0;
                        valB = b.prixUnitaire || b.prix_unitaire || 0;
                        break;
                    case 'valeur':
                        const stockA = a.quantite_actuelle || a.quantiteActuelle || 0;
                        const prixA = a.prixUnitaire || a.prix_unitaire || 0;
                        valA = stockA * prixA;
                        const stockB = b.quantite_actuelle || b.quantiteActuelle || 0;
                        const prixB = b.prixUnitaire || b.prix_unitaire || 0;
                        valB = stockB * prixB;
                        break;
                    case 'dlc':
                        valA = a.dlc ? new Date(a.dlc).getTime() : 0;
                        valB = b.dlc ? new Date(b.dlc).getTime() : 0;
                        break;
                    case 'statut':
                        valA = getInventaireStatus(a);
                        valB = getInventaireStatus(b);
                        break;
                    default:
                        valA = '';
                        valB = '';
                }
                
                // Comparaison
                let comparison = 0;
                if (typeof valA === 'number' && typeof valB === 'number') {
                    comparison = valA - valB;
                } else {
                    comparison = String(valA).localeCompare(String(valB), 'fr');
                }
                
                return currentInventaireSort.direction === 'asc' ? comparison : -comparison;
            });
            
            // Mettre √† jour les indicateurs visuels
            updateInventaireSortIndicators();
            
            // Rafra√Æchir l'affichage
            displayInventaire();
        }
        
        function getInventaireStatus(mp) {
            const stock = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            const stockMini = mp.stockMini || mp.stock_mini || 0;
            if (stock <= 0) return 3; // Critique
            if (stockMini > 0 && stock <= stockMini) return 2; // Bas
            return 1; // OK
        }
        
        function updateInventaireSortIndicators() {
            // R√©initialiser tous les indicateurs
            const indicators = ['categorie', 'nom', 'lot', 'fournisseur', 'stock', 'stockMini', 'cout', 'valeur', 'dlc', 'statut'];
            indicators.forEach(col => {
                const indicator = document.getElementById(`sort-inv-${col}`);
                if (indicator) {
                    indicator.textContent = '‚áÖ';
                    indicator.classList.remove('active');
                }
            });
            
            // Mettre √† jour l'indicateur actif
            if (currentInventaireSort.column) {
                const activeIndicator = document.getElementById(`sort-inv-${currentInventaireSort.column}`);
                if (activeIndicator) {
                    activeIndicator.textContent = currentInventaireSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
                    activeIndicator.classList.add('active');
                }
            }
        }
        
        function displayInventaire() {
            const tbody = document.querySelector('#inventaire-table tbody');
            if (!tbody) return;
            
            if (filteredInventaire.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">Aucune mati√®re premi√®re en stock</td></tr>';
                document.getElementById('inventaire-total-stock-footer').textContent = '0 kg';
                document.getElementById('inventaire-total-valeur-footer').textContent = '0 ‚Ç¨';
                return;
            }
            
            let totalStock = 0;
            let totalValeur = 0;
            
            tbody.innerHTML = filteredInventaire.map(mp => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const mini = mp.stock_mini || mp.stockMini || 0;
                const cout = mp.cout || 0;
                const valeur = qty * cout;
                
                totalStock += qty;
                totalValeur += valeur;
                
                const stockStatus = getStockStatus(mp);
                const stockLabel = getInventaireStockLabel(mp);
                const dlcFormatted = mp.dlc ? formatDate(mp.dlc) : 'N/A';
                const categorieLabel = getCategorieLabel(mp.categorie);
                
                // V√©rifier si la DLC est proche (moins de 30 jours)
                let dlcStyle = '';
                if (mp.dlc) {
                    const daysUntilDLC = Math.ceil((new Date(mp.dlc) - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysUntilDLC < 0) {
                        dlcStyle = 'color: #dc3545; font-weight: bold;';
                    } else if (daysUntilDLC < 30) {
                        dlcStyle = 'color: #ffc107; font-weight: bold;';
                    }
                }
                
                return `
                    <tr>
                        <td>
                            <span class="lot-status" style="font-size: 11px; padding: 4px 8px;">${categorieLabel}</span>
                        </td>
                        <td><strong>${mp.nom}</strong></td>
                        <td><code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">${mp.lot}</code></td>
                        <td>${mp.fournisseur}</td>
                        <td><strong style="font-size: 16px;">${qty.toFixed(3)} kg</strong></td>
                        <td>${mini > 0 ? mini.toFixed(3) + ' kg' : '-'}</td>
                        <td><strong>${cout.toFixed(2)} ‚Ç¨/kg</strong></td>
                        <td><strong>${valeur.toFixed(2)} ‚Ç¨</strong></td>
                        <td style="${dlcStyle}">${dlcFormatted}</td>
                        <td>
                            <span class="lot-status ${stockStatus}">${stockLabel}</span>
                        </td>
                        <td class="actions-column">
                            <button class="btn btn-small btn-secondary" onclick="adjustStockFromInventaire(${mp.id})">üì¶ Stock</button>
                            <button class="btn btn-small btn-secondary" onclick="editPriceFromInventaire(${mp.id})">üí∞ Prix</button>
                            <button class="btn btn-small btn-danger" onclick="declareLoss(${mp.id})">‚ö†Ô∏è Perte</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('inventaire-total-stock-footer').textContent = totalStock.toFixed(3) + ' kg';
            document.getElementById('inventaire-total-valeur-footer').textContent = totalValeur.toFixed(2) + ' ‚Ç¨';
        }
        
        async function reloadLossesFromSupabase() {
            if (!supabaseClient) {
                showAlert('‚ùå Client Supabase non disponible', 'danger');
                return;
            }
            
            console.log('üîÑ Rechargement manuel des pertes depuis Supabase...');
            
            try {
                const { data: lossesData, error: lossesError } = await supabaseClient
                    .from('losses')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                console.log('üìä R√©sultat rechargement:', { data: lossesData, error: lossesError });
                
                if (lossesError) {
                    console.error('‚ùå Erreur:', lossesError);
                    showAlert(`‚ùå Erreur lors du rechargement:\n${lossesError.message}\n\nV√©rifiez que:\n1. La table 'losses' existe\n2. RLS est d√©sactiv√© (ALTER TABLE losses DISABLE ROW LEVEL SECURITY)`, 'danger');
                    return;
                }
                
                losses = lossesData || [];
                console.log('‚úÖ Pertes recharg√©es:', losses.length);
                
                if (losses.length > 0) {
                    console.log('üì¶ Premi√®re perte:', losses[0]);
                    
                    // Normaliser depuis Supabase vers JavaScript
                    losses = losses.map(loss => ({
                        id: loss.id,
                        matierePremiere: loss.matierepremiere,
                        matiere_premiere: loss.matierepremiere,
                        matierepremiere: loss.matierepremiere,
                        categorie: loss.categorie,
                        lot: loss.lot,
                        fournisseur: loss.fournisseur,
                        quantity: loss.quantity,
                        type: loss.type,
                        reason: loss.reason,
                        date: loss.date,
                        cout: loss.cout,
                        valeurPerte: loss.valeurperte,
                        valeur_perte: loss.valeurperte,
                        valeurperte: loss.valeurperte,
                        declaredAt: loss.declaredat || loss.created_at,
                        declared_at: loss.declaredat || loss.created_at,
                        declaredat: loss.declaredat || loss.created_at,
                        created_at: loss.created_at
                    }));
                    
                    showAlert(`‚úÖ ${losses.length} perte(s) recharg√©e(s) depuis Supabase !`, 'success');
                } else {
                    showAlert('‚ö†Ô∏è Aucune perte trouv√©e dans Supabase.\n\nV√©rifiez que des pertes ont bien √©t√© enregistr√©es.', 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Exception:', error);
                showAlert(`‚ùå Exception: ${error.message}`, 'danger');
            }
        }

        function showLossesHistory() {
            console.log('üîç Affichage historique pertes - Nombre:', losses.length);
            console.log('üì¶ Contenu losses:', losses);
            
            if (losses.length === 0) {
                showAlert('Aucune perte d√©clar√©e pour le moment', 'success');
                return;
            }
            
            // Trier par date d√©croissante
            const sortedLosses = [...losses].sort((a, b) => {
                const dateA = new Date(a.declared_at || a.declaredat || a.date);
                const dateB = new Date(b.declared_at || b.declaredat || b.date);
                return dateB - dateA;
            });
            
            // Statistiques
            const totalLosses = losses.length;
            const totalQuantity = losses.reduce((sum, loss) => sum + (loss.quantity || 0), 0);
            const totalValue = losses.reduce((sum, loss) => sum + (loss.valeur_perte || loss.valeurperte || loss.valeurPerte || 0), 0);
            
            // Pertes par type
            const lossesByType = {};
            losses.forEach(loss => {
                const type = loss.type || 'autre';
                if (!lossesByType[type]) {
                    lossesByType[type] = { count: 0, quantity: 0, value: 0 };
                }
                lossesByType[type].count++;
                lossesByType[type].quantity += loss.quantity || 0;
                lossesByType[type].value += loss.valeur_perte || loss.valeurperte || loss.valeurPerte || 0;
            });
            
            // Pertes MP vs Lots
            const mpLosses = losses.filter(l => !l.matiere_premiere?.startsWith('LOT:'));
            const lotLosses = losses.filter(l => l.matiere_premiere?.startsWith('LOT:'));
            
            const lossesHTML = `
                <div style="max-width: 1200px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #dc3545;">‚ö†Ô∏è Historique des Pertes</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="downloadFilteredLossesPDF()" style="background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); border: none; font-size: 12px; padding: 8px 15px;">üì• T√©l√©charger (PDF)</button>
                            <button class="btn" onclick="printLossesHistory()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); border: none; font-size: 12px; padding: 8px 15px;">üñ®Ô∏è Imprimer</button>
                            <button class="btn btn-secondary" onclick="closeConfirmModal()" style="font-size: 12px; padding: 8px 15px;">‚úï Fermer</button>
                        </div>
                    </div>
                    
                    <!-- Filtres de dates -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #2196f3;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
                            <span style="font-weight: 600; color: #1565c0;">üìÖ Filtrer par p√©riode :</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 13px; color: #555;">Du</label>
                                <input type="date" id="losses-date-from" style="padding: 6px 10px; border: 1px solid #90caf9; border-radius: 6px;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 13px; color: #555;">Au</label>
                                <input type="date" id="losses-date-to" style="padding: 6px 10px; border: 1px solid #90caf9; border-radius: 6px;">
                            </div>
                            <button class="btn btn-small" onclick="filterLossesHistory()" style="background: #2196f3; border: none; padding: 6px 15px;">üîç Filtrer</button>
                            <button class="btn btn-small btn-secondary" onclick="resetLossesFilter()" style="padding: 6px 15px;">üîÑ R√©initialiser</button>
                        </div>
                    </div>
                    
                    <!-- Statistiques principales -->
                    <div id="losses-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #ef9a9a;">
                            <div style="font-size: 32px; font-weight: bold; color: #c62828;" id="losses-total-count">${totalLosses}</div>
                            <div style="font-size: 13px; color: #b71c1c; font-weight: 500;">Pertes d√©clar√©es</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #ffcc80;">
                            <div style="font-size: 32px; font-weight: bold; color: #e65100;" id="losses-total-qty">${totalQuantity.toFixed(1)}</div>
                            <div style="font-size: 13px; color: #e65100; font-weight: 500;">kg perdus</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #f48fb1;">
                            <div style="font-size: 32px; font-weight: bold; color: #c2185b;" id="losses-total-value">${totalValue.toFixed(2)} ‚Ç¨</div>
                            <div style="font-size: 13px; color: #c2185b; font-weight: 500;">Valeur totale</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #90caf9;">
                            <div style="font-size: 32px; font-weight: bold; color: #1565c0;" id="losses-mp-lot">${mpLosses.length} / ${lotLosses.length}</div>
                            <div style="font-size: 13px; color: #1565c0; font-weight: 500;">MP / Produits finis</div>
                        </div>
                    </div>
                    
                    <!-- R√©partition par type -->
                    <div id="losses-by-type" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #495057; font-size: 14px;">üìä R√©partition par type de perte</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${Object.entries(lossesByType).map(([type, data]) => `
                                <div style="background: white; padding: 10px 15px; border-radius: 8px; border-left: 4px solid ${getTypeColor(type)}; flex: 1; min-width: 150px;">
                                    <div style="font-weight: 600; color: ${getTypeColor(type)}; font-size: 13px;">${getLossTypeLabel(type)}</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                        ${data.count} perte(s) ‚Ä¢ ${data.quantity.toFixed(1)} kg ‚Ä¢ ${data.value.toFixed(2)} ‚Ç¨
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Tableau des pertes -->
                    <div id="losses-table-container" style="background: white; border-radius: 12px; border: 1px solid #dee2e6; overflow: hidden;">
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table id="losses-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; position: sticky; top: 0;">
                                    <tr>
                                        <th style="padding: 12px 10px; text-align: left; font-weight: 600;">Date</th>
                                        <th style="padding: 12px 10px; text-align: left; font-weight: 600;">Mati√®re / Lot</th>
                                        <th style="padding: 12px 10px; text-align: left; font-weight: 600;">Lot Fourn.</th>
                                        <th style="padding: 12px 10px; text-align: center; font-weight: 600;">Type</th>
                                        <th style="padding: 12px 10px; text-align: right; font-weight: 600;">Quantit√©</th>
                                        <th style="padding: 12px 10px; text-align: right; font-weight: 600;">Valeur</th>
                                        <th style="padding: 12px 10px; text-align: left; font-weight: 600;">Raison</th>
                                    </tr>
                                </thead>
                                <tbody id="losses-table-body">
                                    ${sortedLosses.map((loss, index) => {
                                        const matierePremiere = loss.matiere_premiere || loss.matierepremiere || loss.matierePremiere || 'N/A';
                                        const valeurPerte = loss.valeur_perte || loss.valeurperte || loss.valeurPerte || 0;
                                        const isLot = matierePremiere.startsWith('LOT:');
                                        const bgColor = index % 2 === 0 ? '#fff' : '#f8f9fa';
                                        
                                        return `
                                            <tr style="background: ${bgColor}; border-bottom: 1px solid #eee;" data-date="${loss.date}">
                                                <td style="padding: 10px; white-space: nowrap;">
                                                    <div style="font-weight: 600;">${formatDate(loss.date)}</div>
                                                </td>
                                                <td style="padding: 10px;">
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <span style="font-size: 16px;">${isLot ? 'üì¶' : 'ü•ú'}</span>
                                                        <div>
                                                            <div style="font-weight: 600; color: #333;">${matierePremiere.replace('LOT: ', '')}</div>
                                                            <div style="font-size: 11px; color: #888;">${loss.fournisseur || '-'}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td style="padding: 10px;">
                                                    <code style="background: #e9ecef; padding: 3px 6px; border-radius: 4px; font-size: 11px;">${loss.lot || '-'}</code>
                                                </td>
                                                <td style="padding: 10px; text-align: center;">
                                                    <span style="background: ${getTypeColor(loss.type)}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; white-space: nowrap;">
                                                        ${getLossTypeLabel(loss.type)}
                                                    </span>
                                                </td>
                                                <td style="padding: 10px; text-align: right;">
                                                    <span style="font-weight: 700; color: #dc3545; font-size: 15px;">${(loss.quantity || 0).toFixed(1)}</span>
                                                    <span style="font-size: 11px; color: #888;"> kg</span>
                                                </td>
                                                <td style="padding: 10px; text-align: right;">
                                                    <span style="font-weight: 700; color: #c62828;">${valeurPerte.toFixed(2)} ‚Ç¨</span>
                                                </td>
                                                <td style="padding: 10px; max-width: 200px;">
                                                    <div style="font-size: 12px; color: #555; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${loss.reason || '-'}">
                                                        ${loss.reason || '-'}
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                                <tfoot style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: bold; border-top: 2px solid #dc3545;">
                                    <tr>
                                        <td colspan="4" style="padding: 12px; text-align: right; color: #495057;">TOTAL</td>
                                        <td style="padding: 12px; text-align: right; color: #dc3545; font-size: 16px;" id="losses-footer-qty">${totalQuantity.toFixed(1)} kg</td>
                                        <td style="padding: 12px; text-align: right; color: #c62828; font-size: 16px;" id="losses-footer-value">${totalValue.toFixed(2)} ‚Ç¨</td>
                                        <td style="padding: 12px;"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeConfirmModal()">Fermer</button>
                        <button class="btn" onclick="downloadFilteredLossesPDF()" style="background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); border: none;">üì• T√©l√©charger (PDF)</button>
                        <button class="btn" onclick="printLossesHistory()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); border: none;">üñ®Ô∏è Imprimer</button>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('confirm-modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.maxWidth = '95%';
            modalContent.style.maxHeight = '95vh';
            modalContent.style.overflow = 'auto';
            document.getElementById('confirm-title').textContent = '';
            document.getElementById('confirm-message').innerHTML = lossesHTML;
            document.getElementById('confirm-yes').style.display = 'none';
            document.getElementById('confirm-no').style.display = 'none';
            modal.style.display = 'block';
        }
        
        function getTypeColor(type) {
            const colors = {
                'casse': '#e53935',
                'perime': '#ff9800',
                'contamination': '#9c27b0',
                'vol': '#607d8b',
                'defaut_qualite': '#f44336',
                'retour_client': '#2196f3',
                'surstock': '#ff5722',
                'autre': '#795548'
            };
            return colors[type] || '#757575';
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            modal.style.display = 'none';
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.maxWidth = '700px';
            modalContent.style.maxHeight = '';
            modalContent.style.overflow = '';
            document.getElementById('confirm-yes').style.display = 'inline-block';
            document.getElementById('confirm-no').style.display = 'inline-block';
        }
        
        // Fonction pour filtrer l'historique des pertes par date
        function filterLossesHistory() {
            const dateFrom = document.getElementById('losses-date-from').value;
            const dateTo = document.getElementById('losses-date-to').value;
            
            const rows = document.querySelectorAll('#losses-table-body tr');
            let visibleCount = 0;
            let totalQty = 0;
            let totalValue = 0;
            
            rows.forEach(row => {
                const rowDate = row.getAttribute('data-date');
                let show = true;
                
                if (dateFrom && rowDate < dateFrom) show = false;
                if (dateTo && rowDate > dateTo) show = false;
                
                row.style.display = show ? '' : 'none';
                
                if (show) {
                    visibleCount++;
                    const qtyCell = row.querySelector('td:nth-child(5) span');
                    const valueCell = row.querySelector('td:nth-child(6) span');
                    if (qtyCell) totalQty += parseFloat(qtyCell.textContent) || 0;
                    if (valueCell) totalValue += parseFloat(valueCell.textContent) || 0;
                }
            });
            
            // Mettre √† jour les statistiques
            document.getElementById('losses-total-count').textContent = visibleCount;
            document.getElementById('losses-total-qty').textContent = totalQty.toFixed(1);
            document.getElementById('losses-total-value').textContent = totalValue.toFixed(2) + ' ‚Ç¨';
            document.getElementById('losses-footer-qty').textContent = totalQty.toFixed(1) + ' kg';
            document.getElementById('losses-footer-value').textContent = totalValue.toFixed(2) + ' ‚Ç¨';
            
            // Message de confirmation
            let periodText = '';
            if (dateFrom && dateTo) {
                periodText = `du ${formatDate(dateFrom)} au ${formatDate(dateTo)}`;
            } else if (dateFrom) {
                periodText = `√† partir du ${formatDate(dateFrom)}`;
            } else if (dateTo) {
                periodText = `jusqu'au ${formatDate(dateTo)}`;
            }
            
            if (periodText) {
                showAlert(`üìÖ Filtre appliqu√© ${periodText}\n${visibleCount} perte(s) affich√©e(s)`, 'success');
            }
        }
        
        // Fonction pour r√©initialiser le filtre
        function resetLossesFilter() {
            document.getElementById('losses-date-from').value = '';
            document.getElementById('losses-date-to').value = '';
            
            const rows = document.querySelectorAll('#losses-table-body tr');
            rows.forEach(row => row.style.display = '');
            
            // Recalculer les totaux
            showLossesHistory();
        }
        
        // Fonction pour imprimer l'historique des pertes
        function printLossesHistory() {
            const dateFrom = document.getElementById('losses-date-from')?.value || '';
            const dateTo = document.getElementById('losses-date-to')?.value || '';
            
            // R√©cup√©rer les lignes visibles
            const rows = document.querySelectorAll('#losses-table-body tr');
            let tableRows = '';
            let totalQty = 0;
            let totalValue = 0;
            let count = 0;
            
            rows.forEach((row, index) => {
                if (row.style.display !== 'none') {
                    count++;
                    const cells = row.querySelectorAll('td');
                    const bgColor = count % 2 === 0 ? '#f8f9fa' : '#fff';
                    
                    // Extraire les valeurs
                    const qtySpan = cells[4]?.querySelector('span');
                    const valueSpan = cells[5]?.querySelector('span');
                    const qty = parseFloat(qtySpan?.textContent) || 0;
                    const value = parseFloat(valueSpan?.textContent) || 0;
                    totalQty += qty;
                    totalValue += value;
                    
                    tableRows += `
                        <tr style="background: ${bgColor}; border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; border: 1px solid #ddd;">${cells[0]?.textContent || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${cells[1]?.textContent?.trim() || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${cells[2]?.textContent || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${cells[3]?.textContent || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${qty.toFixed(1)} kg</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${value.toFixed(2)} ‚Ç¨</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${cells[6]?.textContent || ''}</td>
                        </tr>
                    `;
                }
            });
            
            // P√©riode affich√©e
            let periodText = 'Toutes les p√©riodes';
            if (dateFrom && dateTo) {
                periodText = `Du ${formatDate(dateFrom)} au ${formatDate(dateTo)}`;
            } else if (dateFrom) {
                periodText = `√Ä partir du ${formatDate(dateFrom)}`;
            } else if (dateTo) {
                periodText = `Jusqu'au ${formatDate(dateTo)}`;
            }
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Historique des Pertes - Emotions Chocolats</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; font-size: 12px; }
                        h1 { color: #dc3545; font-size: 20px; margin-bottom: 5px; }
                        .header { border-bottom: 2px solid #dc3545; padding-bottom: 10px; margin-bottom: 20px; }
                        .period { color: #666; font-size: 14px; margin-bottom: 20px; }
                        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
                        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; flex: 1; }
                        .stat-value { font-size: 24px; font-weight: bold; color: #dc3545; }
                        .stat-label { font-size: 11px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #dc3545; color: white; padding: 10px 8px; text-align: left; font-size: 11px; }
                        td { padding: 8px; font-size: 11px; }
                        .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #888; }
                        tfoot td { background: #f8f9fa; font-weight: bold; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>‚ö†Ô∏è Historique des Pertes</h1>
                        <div>Emotions Chocolats</div>
                    </div>
                    
                    <div class="period">üìÖ ${periodText}</div>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">Pertes d√©clar√©es</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${totalQty.toFixed(1)} kg</div>
                            <div class="stat-label">Quantit√© perdue</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${totalValue.toFixed(2)} ‚Ç¨</div>
                            <div class="stat-label">Valeur totale</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Mati√®re / Lot</th>
                                <th>Lot Fourn.</th>
                                <th style="text-align: center;">Type</th>
                                <th style="text-align: right;">Quantit√©</th>
                                <th style="text-align: right;">Valeur</th>
                                <th>Raison</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right; padding: 10px; border: 1px solid #ddd;">TOTAL</td>
                                <td style="text-align: right; padding: 10px; border: 1px solid #ddd; color: #dc3545;">${totalQty.toFixed(1)} kg</td>
                                <td style="text-align: right; padding: 10px; border: 1px solid #ddd; color: #dc3545;">${totalValue.toFixed(2)} ‚Ç¨</td>
                                <td style="border: 1px solid #ddd;"></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="footer">
                        Imprim√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')} - TRACACHOC
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function exportLosses() {
            if (losses.length === 0) {
                showAlert('Aucune perte √† exporter', 'warning');
                return;
            }
            
            const headers = ['Date Perte', 'Date D√©claration', 'Mati√®re Premi√®re', 'Cat√©gorie', 'Lot', 'Fournisseur', 'Type', 'Quantit√© (kg)', 'Co√ªt (‚Ç¨/kg)', 'Valeur Perte (‚Ç¨)', 'Description'];
            let csv = headers.join(';') + '\n';
            
            losses.forEach(loss => {
                const matierePremiere = loss.matiere_premiere || loss.matierepremiere || loss.matierePremiere || 'N/A';
                const declaredAt = loss.declared_at || loss.declaredat || loss.declaredAt || new Date().toISOString();
                const valeurPerte = loss.valeur_perte || loss.valeurperte || loss.valeurPerte || 0;
                
                const row = [
                    loss.date,
                    new Date(declaredAt).toLocaleDateString('fr-FR'),
                    matierePremiere,
                    getCategorieLabel(loss.categorie),
                    loss.lot,
                    loss.fournisseur,
                    getLossTypeLabel(loss.type),
                    (loss.quantity || 0).toFixed(1),
                    (loss.cout || 0).toFixed(2),
                    valeurPerte.toFixed(2),
                    loss.reason.replace(/;/g, ',')
                ];
                csv += row.join(';') + '\n';
            });
            
            csv = '\uFEFF' + csv;
            const blob = new Blob([csv], { type: 'text/csv' });
            const timestamp = new Date().toISOString().split('T')[0];
            
            if (downloadFile(blob, `pertes_${timestamp}.csv`)) {
                showAlert('‚úÖ Historique des pertes export√© avec succ√®s !', 'success');
            } else {
                copyToClipboard(csv);
            }
        }
        
        // T√©l√©charger les pertes filtr√©es en PDF
        function downloadFilteredLossesPDF() {
            const dateFrom = document.getElementById('losses-date-from')?.value || '';
            const dateTo = document.getElementById('losses-date-to')?.value || '';
            
            // R√©cup√©rer les lignes visibles du tableau
            const rows = document.querySelectorAll('#losses-table-body tr');
            
            if (rows.length === 0) {
                showAlert('Aucune perte √† t√©l√©charger', 'warning');
                return;
            }
            
            let tableRows = '';
            let totalQty = 0;
            let totalValue = 0;
            let count = 0;
            
            rows.forEach((row, index) => {
                if (row.style.display !== 'none') {
                    count++;
                    const cells = row.querySelectorAll('td');
                    const bgColor = count % 2 === 0 ? '#f8f9fa' : '#fff';
                    
                    const qtySpan = cells[4]?.querySelector('span');
                    const valueSpan = cells[5]?.querySelector('span');
                    const qty = parseFloat(qtySpan?.textContent) || 0;
                    const value = parseFloat(valueSpan?.textContent) || 0;
                    totalQty += qty;
                    totalValue += value;
                    
                    tableRows += `
                        <tr style="background: ${bgColor};">
                            <td style="padding: 8px; border: 1px solid #ddd;">${cells[0]?.textContent || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${cells[1]?.textContent?.trim() || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${cells[2]?.textContent || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${cells[3]?.textContent || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${qty.toFixed(1)} kg</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${value.toFixed(2)} ‚Ç¨</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${cells[6]?.textContent || ''}</td>
                        </tr>
                    `;
                }
            });
            
            // P√©riode affich√©e
            let periodText = 'Toutes les p√©riodes';
            if (dateFrom && dateTo) {
                periodText = `Du ${formatDate(dateFrom)} au ${formatDate(dateTo)}`;
            } else if (dateFrom) {
                periodText = `√Ä partir du ${formatDate(dateFrom)}`;
            } else if (dateTo) {
                periodText = `Jusqu'au ${formatDate(dateTo)}`;
            }
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Historique des Pertes - Emotions Chocolats</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; font-size: 12px; }
                        h1 { color: #dc3545; font-size: 22px; margin-bottom: 5px; }
                        .header { border-bottom: 3px solid #dc3545; padding-bottom: 15px; margin-bottom: 25px; }
                        .company { font-size: 14px; color: #666; }
                        .period { color: #333; font-size: 14px; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 5px; }
                        .stats { display: flex; gap: 20px; margin-bottom: 25px; }
                        .stat-box { background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%); padding: 15px 25px; border-radius: 10px; text-align: center; flex: 1; border: 1px solid #ffcdd2; }
                        .stat-value { font-size: 28px; font-weight: bold; color: #dc3545; }
                        .stat-label { font-size: 11px; color: #666; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #dc3545; color: white; padding: 12px 8px; text-align: left; font-size: 11px; }
                        td { padding: 8px; font-size: 11px; }
                        .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #888; border-top: 1px solid #ddd; padding-top: 15px; }
                        tfoot td { background: #f8f9fa; font-weight: bold; font-size: 12px; }
                        @media print { 
                            body { padding: 10px; }
                            @page { margin: 10mm; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>‚ö†Ô∏è Historique des Pertes</h1>
                        <div class="company">Emotions Chocolats - Rue Houmvent 4a, 4218 Couthuin</div>
                    </div>
                    
                    <div class="period">üìÖ <strong>${periodText}</strong></div>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">Pertes d√©clar√©es</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${totalQty.toFixed(1)} kg</div>
                            <div class="stat-label">Quantit√© perdue</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${totalValue.toFixed(2)} ‚Ç¨</div>
                            <div class="stat-label">Valeur totale</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Mati√®re / Lot</th>
                                <th>Lot Fourn.</th>
                                <th style="text-align: center;">Type</th>
                                <th style="text-align: right;">Quantit√©</th>
                                <th style="text-align: right;">Valeur</th>
                                <th>Raison</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right; padding: 12px; border: 1px solid #ddd;"><strong>TOTAL</strong></td>
                                <td style="text-align: right; padding: 12px; border: 1px solid #ddd; color: #dc3545;"><strong>${totalQty.toFixed(1)} kg</strong></td>
                                <td style="text-align: right; padding: 12px; border: 1px solid #ddd; color: #dc3545;"><strong>${totalValue.toFixed(2)} ‚Ç¨</strong></td>
                                <td style="border: 1px solid #ddd;"></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="footer">
                        Document g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')} - TRACACHOC v3.2.1
                    </div>
                </body>
                </html>
            `;
            
            // Ouvrir une nouvelle fen√™tre et d√©clencher l'impression en PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Attendre le chargement puis d√©clencher "Enregistrer en PDF"
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    showAlert(`‚úÖ ${count} perte(s) - Utilisez "Enregistrer en PDF" dans la bo√Æte de dialogue`, 'success');
                }, 300);
            };
        }
        
        // T√©l√©charger les pertes filtr√©es (celles affich√©es dans le tableau)
        function downloadFilteredLosses() {
            const dateFrom = document.getElementById('losses-date-from')?.value || '';
            const dateTo = document.getElementById('losses-date-to')?.value || '';
            
            // R√©cup√©rer les lignes visibles du tableau
            const rows = document.querySelectorAll('#losses-table-body tr');
            
            if (rows.length === 0) {
                showAlert('Aucune perte √† t√©l√©charger', 'warning');
                return;
            }
            
            // En-t√™tes
            const headers = ['Date', 'Mati√®re / Lot', 'Lot Fournisseur', 'Type', 'Quantit√© (kg)', 'Valeur (‚Ç¨)', 'Raison'];
            let csv = headers.join(';') + '\n';
            
            let totalQty = 0;
            let totalValue = 0;
            let count = 0;
            
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    count++;
                    const cells = row.querySelectorAll('td');
                    
                    // Extraire les valeurs
                    const date = cells[0]?.textContent?.trim() || '';
                    const matiere = cells[1]?.textContent?.trim() || '';
                    const lotFourn = cells[2]?.textContent?.trim() || '';
                    const type = cells[3]?.textContent?.trim() || '';
                    
                    const qtySpan = cells[4]?.querySelector('span');
                    const valueSpan = cells[5]?.querySelector('span');
                    const qty = parseFloat(qtySpan?.textContent) || 0;
                    const value = parseFloat(valueSpan?.textContent) || 0;
                    totalQty += qty;
                    totalValue += value;
                    
                    const raison = cells[6]?.textContent?.trim() || '';
                    
                    const rowData = [
                        date,
                        matiere.replace(/;/g, ','),
                        lotFourn,
                        type,
                        qty.toFixed(1),
                        value.toFixed(2),
                        raison.replace(/;/g, ',')
                    ];
                    csv += rowData.join(';') + '\n';
                }
            });
            
            // Ajouter la ligne total
            csv += '\n';
            csv += ['TOTAL', '', '', '', totalQty.toFixed(1), totalValue.toFixed(2), ''].join(';') + '\n';
            
            // Ajouter les infos de p√©riode
            csv += '\n';
            if (dateFrom || dateTo) {
                csv += `P√©riode;${dateFrom ? formatDate(dateFrom) : 'D√©but'};au;${dateTo ? formatDate(dateTo) : 'Fin'};;;\n`;
            }
            csv += `Nombre de pertes;${count};;;;;\n`;
            csv += `Export√© le;${new Date().toLocaleDateString('fr-FR')};;;;;\n`;
            
            csv = '\uFEFF' + csv;
            const blob = new Blob([csv], { type: 'text/csv' });
            
            // Nom du fichier avec p√©riode si d√©finie
            let filename = 'pertes';
            if (dateFrom && dateTo) {
                filename += `_${dateFrom}_au_${dateTo}`;
            } else {
                filename += `_${new Date().toISOString().split('T')[0]}`;
            }
            filename += '.csv';
            
            if (downloadFile(blob, filename)) {
                showAlert(`‚úÖ ${count} perte(s) export√©e(s) avec succ√®s !`, 'success');
            } else {
                copyToClipboard(csv);
            }
        }

        function getInventaireStockLabel(mp) {
            const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            const mini = mp.stock_mini || mp.stockMini || 0;
            
            if (qty <= mini) return 'üî¥ CRITIQUE';
            if (qty <= mini * 1.5) return 'üü† FAIBLE';
            return 'üü¢ OK';
        }
        
        function checkInventaireAlerts() {
            const alertsContainer = document.getElementById('inventaire-alerts-container');
            if (!alertsContainer) return;
            
            // Filtrer uniquement les MP actives (non archiv√©es)
            const activeMP = getActiveMatieresPremi√®res();
            
            const critiques = activeMP.filter(mp => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const mini = mp.stock_mini || mp.stockMini || 0;
                return mini > 0 && qty <= mini;
            });
            
            const dlcProches = activeMP.filter(mp => {
                if (!mp.dlc) return false;
                const daysUntilDLC = Math.ceil((new Date(mp.dlc) - new Date()) / (1000 * 60 * 60 * 24));
                return daysUntilDLC < 30 && daysUntilDLC >= 0;
            });
            
            const dlcDepassees = activeMP.filter(mp => {
                if (!mp.dlc) return false;
                return new Date(mp.dlc) < new Date();
            });
            
            let alertsHTML = '';
            
            if (dlcDepassees.length > 0) {
                alertsHTML += `
                    <div class="alert alert-danger">
                        <strong>üö® DLC D√âPASS√âES (${dlcDepassees.length}) :</strong>
                        ${dlcDepassees.map(mp => `${mp.nom} (Lot: ${mp.lot})`).join(', ')}
                    </div>
                `;
            }
            
            if (critiques.length > 0) {
                alertsHTML += `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Stocks Critiques (${critiques.length}) :</strong>
                        ${critiques.map(mp => {
                            const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                            return `${mp.nom} (${qty.toFixed(1)}kg)`;
                        }).join(', ')}
                    </div>
                `;
            }
            
            if (dlcProches.length > 0) {
                alertsHTML += `
                    <div class="alert alert-warning">
                        <strong>üìÖ DLC Proches (< 30 jours) - ${dlcProches.length} :</strong>
                        ${dlcProches.map(mp => {
                            const days = Math.ceil((new Date(mp.dlc) - new Date()) / (1000 * 60 * 60 * 24));
                            return `${mp.nom} (${days}j)`;
                        }).join(', ')}
                    </div>
                `;
            }
            
            if (alertsHTML === '') {
                alertsHTML = '<div class="alert alert-success">‚úÖ Aucune alerte - Tous les stocks sont corrects !</div>';
            }
            
            alertsContainer.innerHTML = alertsHTML;
        }
        
        function exportInventaire() {
            const csv = generateInventaireCSV(filteredInventaire);
            const blob = new Blob([csv], { type: 'text/csv' });
            const timestamp = new Date().toISOString().split('T')[0];
            
            if (downloadFile(blob, `inventaire_${timestamp}.csv`)) {
                showAlert('‚úÖ Inventaire export√© avec succ√®s !', 'success');
            } else {
                copyToClipboard(csv);
            }
        }
        
        function exportInventairePDF() {
            const data = filteredInventaire || [];
            
            if (!data || data.length === 0) {
                showAlert('Aucune donn√©e √† exporter', 'warning');
                return;
            }
            
            // Calculer les totaux
            let totalStock = 0;
            let totalValeur = 0;
            let critiques = 0;
            let faibles = 0;
            
            let tableRows = '';
            data.forEach((mp, index) => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const mini = mp.stock_mini || mp.stockMini || 0;
                const cout = mp.cout || 0;
                const valeur = qty * cout;
                const categorie = categoriesMP.find(c => c.id === mp.categorie);
                const categorieNom = categorie ? `${categorie.emoji} ${categorie.nom}` : 'üì¶ Autre';
                
                totalStock += qty;
                totalValeur += valeur;
                
                let statusColor = '#4CAF50';
                let statusText = 'üü¢ OK';
                if (mini > 0 && qty <= mini) {
                    statusColor = '#f44336';
                    statusText = 'üî¥ CRITIQUE';
                    critiques++;
                } else if (mini > 0 && qty <= mini * 1.5) {
                    statusColor = '#ff9800';
                    statusText = 'üü† FAIBLE';
                    faibles++;
                }
                
                const bgColor = index % 2 === 0 ? '#fff' : '#f8f9fa';
                
                tableRows += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 8px; border: 1px solid #ddd;">${categorieNom}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>${mp.nom}</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${mp.lot || '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${mp.fournisseur || '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${qty.toFixed(3)} kg</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${mini.toFixed(3)} kg</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${cout.toFixed(2)} ‚Ç¨</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;"><strong>${valeur.toFixed(2)} ‚Ç¨</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${mp.dlc ? formatDate(mp.dlc) : '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${statusColor}; font-weight: bold;">${statusText}</td>
                    </tr>
                `;
            });
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Inventaire - Emotions Chocolats</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; font-size: 11px; }
                        h1 { color: #8B4513; font-size: 22px; margin-bottom: 5px; }
                        .header { border-bottom: 3px solid #8B4513; padding-bottom: 15px; margin-bottom: 25px; }
                        .company { font-size: 14px; color: #666; }
                        .date { color: #333; font-size: 14px; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 5px; }
                        .stats { display: flex; gap: 15px; margin-bottom: 25px; }
                        .stat-box { padding: 15px 20px; border-radius: 10px; text-align: center; flex: 1; }
                        .stat-box.total { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px solid #90caf9; }
                        .stat-box.valeur { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #a5d6a7; }
                        .stat-box.critique { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border: 1px solid #ef9a9a; }
                        .stat-box.faible { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 1px solid #ffcc80; }
                        .stat-value { font-size: 24px; font-weight: bold; }
                        .stat-value.total { color: #1976d2; }
                        .stat-value.valeur { color: #388e3c; }
                        .stat-value.critique { color: #d32f2f; }
                        .stat-value.faible { color: #f57c00; }
                        .stat-label { font-size: 10px; color: #666; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #8B4513; color: white; padding: 10px 6px; text-align: left; font-size: 10px; }
                        td { padding: 6px; font-size: 10px; }
                        .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #888; border-top: 1px solid #ddd; padding-top: 15px; }
                        tfoot td { background: #f8f9fa; font-weight: bold; }
                        @media print { 
                            body { padding: 10px; font-size: 9px; }
                            @page { margin: 10mm; size: landscape; }
                            th, td { padding: 4px; font-size: 8px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üì¶ Inventaire des Mati√®res Premi√®res</h1>
                        <div class="company">Emotions Chocolats - Rue Houmvent 4a, 4218 Couthuin</div>
                    </div>
                    
                    <div class="date">üìÖ <strong>√âtat au ${new Date().toLocaleDateString('fr-FR')}</strong></div>
                    
                    <div class="stats">
                        <div class="stat-box total">
                            <div class="stat-value total">${data.length}</div>
                            <div class="stat-label">R√©f√©rences</div>
                        </div>
                        <div class="stat-box total">
                            <div class="stat-value total">${totalStock.toFixed(1)} kg</div>
                            <div class="stat-label">Stock total</div>
                        </div>
                        <div class="stat-box valeur">
                            <div class="stat-value valeur">${totalValeur.toFixed(2)} ‚Ç¨</div>
                            <div class="stat-label">Valeur totale</div>
                        </div>
                        <div class="stat-box critique">
                            <div class="stat-value critique">${critiques}</div>
                            <div class="stat-label">Stock critique</div>
                        </div>
                        <div class="stat-box faible">
                            <div class="stat-value faible">${faibles}</div>
                            <div class="stat-label">Stock faible</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Cat√©gorie</th>
                                <th>Mati√®re Premi√®re</th>
                                <th>Lot</th>
                                <th>Fournisseur</th>
                                <th style="text-align: right;">Stock</th>
                                <th style="text-align: right;">Mini</th>
                                <th style="text-align: right;">Co√ªt/kg</th>
                                <th style="text-align: right;">Valeur</th>
                                <th style="text-align: center;">DLC</th>
                                <th style="text-align: center;">Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right; padding: 10px; border: 1px solid #ddd;"><strong>TOTAL</strong></td>
                                <td style="text-align: right; padding: 10px; border: 1px solid #ddd;"><strong>${totalStock.toFixed(1)} kg</strong></td>
                                <td colspan="2" style="border: 1px solid #ddd;"></td>
                                <td style="text-align: right; padding: 10px; border: 1px solid #ddd; color: #388e3c;"><strong>${totalValeur.toFixed(2)} ‚Ç¨</strong></td>
                                <td colspan="2" style="border: 1px solid #ddd;"></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="footer">
                        Document g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')} - TRACACHOC v3.2.1
                    </div>
                </body>
                </html>
            `;
            
            // Ouvrir une nouvelle fen√™tre pour le PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    showAlert(`‚úÖ ${data.length} r√©f√©rence(s) - Utilisez "Enregistrer en PDF" dans la bo√Æte de dialogue`, 'success');
                }, 300);
            };
        }
        
        function generateInventaireCSV(data) {
            if (!data || data.length === 0) {
                return 'Aucune donn√©e √† exporter';
            }
            
            const headers = ['Cat√©gorie', 'Mati√®re Premi√®re', 'Lot', 'Fournisseur', 'Stock (kg)', 'Stock Mini (kg)', 'Co√ªt (‚Ç¨/kg)', 'Valeur (‚Ç¨)', 'DLC', 'Statut'];
            let csv = headers.join(';') + '\n';
            
            data.forEach(mp => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const mini = mp.stock_mini || mp.stockMini || 0;
                const cout = mp.cout || 0;
                const valeur = qty * cout;
                const categorie = categoriesMP.find(c => c.id === mp.categorie);
                const categorieNom = categorie ? categorie.nom : 'Autre';
                const stockLabel = getInventaireStockLabel(mp);
                
                const row = [
                    categorieNom,
                    mp.nom,
                    mp.lot,
                    mp.fournisseur,
                    qty.toFixed(3),
                    mini.toFixed(3),
                    cout.toFixed(2),
                    valeur.toFixed(2),
                    mp.dlc || 'N/A',
                    stockLabel
                ];
                csv += row.join(';') + '\n';
            });
            
            return '\uFEFF' + csv;
        }
        
        function printInventaire() {
            window.print();
        }

        // Contr√¥le qualit√©
        // Configuration des cat√©gories
        async function saveCategorie() {
            const categorieNom = document.getElementById('config-categorie-nom').value.trim();
            const categorieEmoji = document.getElementById('config-categorie-emoji').value.trim();
            const categorieActif = document.getElementById('config-categorie-actif').value === 'true';
            const categorieIdHidden = document.getElementById('config-categorie-id').value;
            
            if (!categorieNom || !categorieEmoji) {
                showAlert('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }
            
            // G√©n√©rer l'ID √† partir du nom si c'est une nouvelle cat√©gorie
            let categorieId;
            if (categorieIdHidden) {
                // Modification d'une cat√©gorie existante
                categorieId = categorieIdHidden;
            } else {
                // Nouvelle cat√©gorie : g√©n√©rer l'ID depuis le nom
                categorieId = categorieNom
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '') // Supprimer les accents
                    .replace(/[^a-z0-9]+/g, '-') // Remplacer les caract√®res sp√©ciaux par des tirets
                    .replace(/^-+|-+$/g, ''); // Supprimer les tirets au d√©but/fin
                
                // V√©rifier si l'ID existe d√©j√†
                let counter = 1;
                let baseId = categorieId;
                while (categoriesMP.find(c => c.id === categorieId)) {
                    categorieId = `${baseId}-${counter}`;
                    counter++;
                }
            }
            
            const existingIndex = categoriesMP.findIndex(c => c.id === categorieId);
            
            const categorie = {
                id: categorieId,
                nom: categorieNom,
                emoji: categorieEmoji,
                actif: categorieActif
            };
            
            if (existingIndex >= 0) {
                categoriesMP[existingIndex] = categorie;
                showAlert(`Cat√©gorie "${categorieNom}" mise √† jour avec succ√®s !`, 'success');
            } else {
                categoriesMP.push(categorie);
                showAlert(`Cat√©gorie "${categorieNom}" ajout√©e avec succ√®s !`, 'success');
            }
            
            // Sauvegarder dans Supabase
            await saveCategoriesConfig();
            
            displayCategoriesConfig();
            resetCategorieForm();
            
            // IMPORTANT : Mettre √† jour tous les s√©lecteurs de cat√©gories
            updateCategorieSelects();
            
            // Rafra√Æchir aussi l'onglet Mati√®res Premi√®res si on y est
            updateInventaireFilters();
        }

        function displayCategoriesConfig() {
            const tbody = document.querySelector('#categories-table tbody');
            
            if (!tbody) return;
            
            if (categoriesMP.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">Aucune cat√©gorie configur√©e</td></tr>';
                return;
            }
            
            tbody.innerHTML = categoriesMP.map(categorie => `
                <tr>
                    <td style="font-size: 24px; text-align: center;">${categorie.emoji}</td>
                    <td><strong>${categorie.nom}</strong></td>
                    <td><span class="lot-status status-${categorie.actif ? 'conforme' : 'non-conforme'}">${categorie.actif ? 'ACTIVE' : 'INACTIVE'}</span></td>
                    <td>
                        <button class="btn btn-small" onclick="editCategorie('${categorie.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-small btn-danger" onclick="deleteCategorie('${categorie.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function editCategorie(categorieId) {
            const categorie = categoriesMP.find(c => c.id === categorieId);
            if (!categorie) return;
            
            document.getElementById('config-categorie-id').value = categorie.id;
            document.getElementById('config-categorie-nom').value = categorie.nom;
            document.getElementById('config-categorie-emoji').value = categorie.emoji;
            document.getElementById('config-categorie-actif').value = categorie.actif.toString();
            
            showAlert(`√âdition de la cat√©gorie "${categorie.nom}"`, 'success');
        }

        function deleteCategorie(categorieId) {
            const categorie = categoriesMP.find(c => c.id === categorieId);
            if (!categorie) return;
            
            // V√©rifier si des mati√®res premi√®res utilisent cette cat√©gorie
            const mpUtilisant = matieresPremi√®res.filter(mp => mp.categorie === categorieId);
            
            if (mpUtilisant.length > 0) {
                showAlert(`Impossible de supprimer cette cat√©gorie : ${mpUtilisant.length} mati√®re(s) premi√®re(s) l'utilisent encore.`, 'danger');
                return;
            }
            
            showConfirmModal(
                'Supprimer cette cat√©gorie',
                `√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${categorie.nom}" ?`,
                async () => {
                    const index = categoriesMP.findIndex(c => c.id === categorieId);
                    if (index >= 0) {
                        categoriesMP.splice(index, 1);
                        
                        // Sauvegarder dans Supabase
                        await saveCategoriesConfig();
                        
                        showAlert(`Cat√©gorie "${categorie.nom}" supprim√©e avec succ√®s !`, 'success');
                        displayCategoriesConfig();
                        updateCategorieSelects();
                    }
                }
            );
        }

        function resetCategorieForm() {
            document.getElementById('config-categorie-id').value = '';
            document.getElementById('config-categorie-nom').value = '';
            document.getElementById('config-categorie-emoji').value = '';
            document.getElementById('config-categorie-actif').value = 'true';
        }

        async function loadDefaultCategories() {
            showConfirmModal(
                'Charger les cat√©gories par d√©faut',
                'Voulez-vous charger les cat√©gories par d√©faut ? Cela ajoutera de nouvelles cat√©gories √† votre configuration.',
                async () => {
                    const defaultCategories = [
                        { id: 'cacao', nom: 'Cacao / Chocolat', emoji: 'üç´', actif: true },
                        { id: 'sucre', nom: 'Sucres', emoji: 'üç¨', actif: true },
                        { id: 'laitier', nom: 'Produits Laitiers', emoji: 'ü•õ', actif: true },
                        { id: 'fruits-secs', nom: 'Fruits Secs & Ol√©agineux', emoji: 'üå∞', actif: true },
                        { id: 'epices', nom: '√âpices & Ar√¥mes', emoji: 'üåø', actif: true },
                        { id: 'matieres-grasses', nom: 'Mati√®res Grasses', emoji: 'üßà', actif: true },
                        { id: 'additifs', nom: 'Additifs & Auxiliaires', emoji: '‚öóÔ∏è', actif: true },
                        { id: 'autre', nom: 'Autre', emoji: 'üì¶', actif: true }
                    ];
                    
                    let addedCount = 0;
                    
                    defaultCategories.forEach(defaultCat => {
                        const exists = categoriesMP.find(c => c.id === defaultCat.id);
                        if (!exists) {
                            categoriesMP.push({ ...defaultCat });
                            addedCount++;
                        }
                    });
                    
                    if (addedCount > 0) {
                        // Sauvegarder dans Supabase
                        await saveCategoriesConfig();
                        
                        showAlert(`${addedCount} cat√©gorie(s) par d√©faut ajout√©e(s) !`, 'success');
                        displayCategoriesConfig();
                        updateCategorieSelects();
                    } else {
                        showAlert('Toutes les cat√©gories par d√©faut sont d√©j√† configur√©es', 'warning');
                    }
                }
            );
        }

        // Sauvegarder les cat√©gories dans Supabase
        async function saveCategoriesConfig() {
            console.log('üíæ Sauvegarde des cat√©gories dans Supabase...');
            console.log('üì¶ Nombre de cat√©gories:', categoriesMP.length);
            
            if (!isOnline || !supabaseClient) {
                console.log('Mode hors-ligne - Sauvegarde locale uniquement');
                saveToLocalStorage();
                return { success: true, offline: true };
            }
            
            try {
                console.log('üîç Recherche config existante...');
                // Chercher si une configuration de cat√©gories existe d√©j√†
                const { data: existingConfig, error: searchError } = await supabaseClient
                    .from('configuration')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('type', 'categories')
                    .single();
                
                console.log('üìä Config existante:', existingConfig);
                console.log('‚ùå Erreur recherche:', searchError);
                
                const configData = {
                    type: 'categories',
                    user_id: currentUser ? currentUser.id : null,
                    data: categoriesMP
                };
                
                console.log('üì§ Donn√©es √† sauvegarder:', configData);
                
                let result;
                if (existingConfig) {
                    console.log('üîÑ UPDATE config cat√©gories');
                    // Mise √† jour
                    result = await supabaseClient
                        .from('configuration')
                        .update(configData)
                        .eq('user_id', currentUser.id)
                        .eq('type', 'categories')
                        .select();
                } else {
                    console.log('‚ûï INSERT config cat√©gories');
                    // Insertion
                    result = await supabaseClient
                        .from('configuration')
                        .insert(configData)
                        .select();
                }
                
                if (result.error) {
                    console.error('‚ùå Erreur sauvegarde cat√©gories:', result.error);
                    throw result.error;
                }
                
                console.log('‚úÖ Cat√©gories sauvegard√©es dans Supabase');
                console.log('üìä R√©sultat:', result.data);
                saveToLocalStorage();
                return { success: true };
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde cat√©gories Supabase:', error);
                showAlert(`‚ö†Ô∏è Erreur lors de la sauvegarde des cat√©gories:\n${error.message}\n\nDonn√©es sauvegard√©es localement.`, 'warning');
                saveToLocalStorage();
                return { success: false, error };
            }
        }

        // ==========================================
        // GESTION DES MP R√âF√âRENC√âES
        // ==========================================
        
        function saveMPRef() {
            const nom = document.getElementById('config-mp-nom').value.trim();
            const categorie = document.getElementById('config-mp-categorie').value;
            const fournisseur = document.getElementById('config-mp-fournisseur').value.trim();
            const unite = document.getElementById('config-mp-unite').value;
            const prix = parseFloat(document.getElementById('config-mp-prix').value) || 0;
            const stockMini = parseFloat(document.getElementById('config-mp-stock-mini').value) || 0;
            const editIndex = parseInt(document.getElementById('config-mp-edit-index').value);
            
            if (!nom) {
                showAlert('‚ùå Le nom de la MP est obligatoire', 'danger');
                return;
            }
            
            const mpData = { nom, categorie, fournisseur, unite, prix, stockMini };
            
            if (editIndex >= 0) {
                mpRefConfig[editIndex] = mpData;
                showAlert('‚úÖ MP mise √† jour : ' + nom, 'success');
            } else {
                // V√©rifier doublon
                if (mpRefConfig.some(mp => mp.nom.toLowerCase() === nom.toLowerCase())) {
                    showAlert('‚ö†Ô∏è Cette MP existe d√©j√† dans la liste', 'warning');
                    return;
                }
                mpRefConfig.push(mpData);
                showAlert('‚úÖ MP ajout√©e : ' + nom, 'success');
            }
            
            saveMPRefConfig();
            renderMPRefTable();
            updateMPRefSelects();
            resetMPRefForm();
        }
        
        function resetMPRefForm() {
            document.getElementById('config-mp-nom').value = '';
            document.getElementById('config-mp-categorie').value = '';
            document.getElementById('config-mp-fournisseur').value = '';
            document.getElementById('config-mp-unite').value = 'kg';
            document.getElementById('config-mp-prix').value = '';
            document.getElementById('config-mp-stock-mini').value = '';
            document.getElementById('config-mp-edit-index').value = '-1';
        }
        
        function editMPRef(index) {
            const mp = mpRefConfig[index];
            if (!mp) return;
            document.getElementById('config-mp-nom').value = mp.nom || '';
            document.getElementById('config-mp-categorie').value = mp.categorie || '';
            document.getElementById('config-mp-fournisseur').value = mp.fournisseur || '';
            document.getElementById('config-mp-unite').value = mp.unite || 'kg';
            document.getElementById('config-mp-prix').value = mp.prix || '';
            document.getElementById('config-mp-stock-mini').value = mp.stockMini || '';
            document.getElementById('config-mp-edit-index').value = index;
            document.getElementById('config-mp-nom').scrollIntoView({ behavior: 'smooth' });
        }
        
        function deleteMPRef(index) {
            if (!confirm('Supprimer "' + mpRefConfig[index].nom + '" de la liste ?')) return;
            mpRefConfig.splice(index, 1);
            saveMPRefConfig();
            renderMPRefTable();
            updateMPRefSelects();
            showAlert('‚úÖ MP supprim√©e de la liste', 'success');
        }
        
        // ============================================
        // CONFIGURATION DES √âTIQUETTES
        // ============================================
        
        const builtInLabelFormats = [
            { id: 'a4', name: 'A4 (210 √ó 297 mm)', width: 210, height: 297, group: 'Formats Standard' },
            { id: 'a5', name: 'A5 (148 √ó 210 mm)', width: 148, height: 210, group: 'Formats Standard' },
            { id: 'a6', name: 'A6 (105 √ó 148 mm)', width: 105, height: 148, group: 'Formats Standard' },
            { id: 'label-small', name: '√âtiquette Petite (70 √ó 100 mm)', width: 70, height: 100, group: '√âtiquettes Autocollantes' },
            { id: 'label-medium', name: '√âtiquette Moyenne (100 √ó 150 mm)', width: 100, height: 150, group: '√âtiquettes Autocollantes' },
            { id: 'label-large', name: '√âtiquette Grande (150 √ó 200 mm)', width: 150, height: 200, group: '√âtiquettes Autocollantes' }
        ];
        
        function getAllLabelFormats() {
            const customs = (labelConfig.customFormats || []).map(f => ({
                ...f,
                id: 'custom-' + f.width + 'x' + f.height + '-' + f.name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase(),
                group: 'Formats Personnalis√©s'
            }));
            return [...builtInLabelFormats, ...customs];
        }
        
        function renderCustomLabelTable() {
            const tbody = document.querySelector('#custom-label-table tbody');
            if (!tbody) return;
            const formats = labelConfig.customFormats || [];
            document.getElementById('custom-label-count').textContent = formats.length;
            
            if (formats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">Aucun format personnalis√©. Ajoutez-en ci-dessus.</td></tr>';
                return;
            }
            
            tbody.innerHTML = formats.map((f, i) => `
                <tr>
                    <td><strong>${f.name}</strong></td>
                    <td>${f.width} mm</td>
                    <td>${f.height} mm</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCustomLabelSize(${i})" style="font-size: 12px; padding: 5px 10px;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function updateLabelSizeSelects() {
            const formats = getAllLabelFormats();
            const defaultSelect = document.getElementById('config-label-default');
            const labelSelect = document.getElementById('label-size-select');
            
            // Update config default select
            if (defaultSelect) {
                defaultSelect.innerHTML = '';
                const groups = {};
                formats.forEach(f => {
                    if (!groups[f.group]) groups[f.group] = [];
                    groups[f.group].push(f);
                });
                Object.keys(groups).forEach(g => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = g;
                    groups[g].forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f.id;
                        opt.textContent = f.name;
                        if (f.id === labelConfig.defaultSize) opt.selected = true;
                        optgroup.appendChild(opt);
                    });
                    defaultSelect.appendChild(optgroup);
                });
            }
            
            // Update the label size select in the √âtiquettes tab
            if (labelSelect) {
                const currentVal = labelSelect.value;
                labelSelect.innerHTML = '';
                const groups = {};
                formats.forEach(f => {
                    if (!groups[f.group]) groups[f.group] = [];
                    groups[f.group].push(f);
                });
                Object.keys(groups).forEach(g => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = g;
                    optgroup.style.fontWeight = '700';
                    groups[g].forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f.id;
                        opt.textContent = f.name;
                        if (f.id === (currentVal || labelConfig.defaultSize)) opt.selected = true;
                        optgroup.appendChild(opt);
                    });
                    labelSelect.appendChild(optgroup);
                });
                // Inject dynamic CSS for custom formats
                injectCustomLabelCSS();
            }
        }
        
        function injectCustomLabelCSS() {
            let style = document.getElementById('custom-label-styles');
            if (!style) {
                style = document.createElement('style');
                style.id = 'custom-label-styles';
                document.head.appendChild(style);
            }
            const customs = labelConfig.customFormats || [];
            style.textContent = customs.map(f => {
                const id = 'custom-' + f.width + 'x' + f.height + '-' + f.name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                return `.label-size-${id} { width: ${f.width}mm; max-width: ${f.width}mm; min-height: ${f.height}mm; padding: ${f.width < 70 ? '6' : '12'}px; }`;
            }).join('\n');
        }
        
        function addCustomLabelSize() {
            const name = document.getElementById('config-label-name').value.trim();
            const width = parseInt(document.getElementById('config-label-width').value);
            const height = parseInt(document.getElementById('config-label-height').value);
            
            if (!name) { showAlert('‚ùå Le nom est obligatoire', 'danger'); return; }
            if (!width || width < 20 || width > 300) { showAlert('‚ùå Largeur invalide (20-300mm)', 'danger'); return; }
            if (!height || height < 10 || height > 300) { showAlert('‚ùå Hauteur invalide (10-300mm)', 'danger'); return; }
            
            if (!labelConfig.customFormats) labelConfig.customFormats = [];
            
            // V√©rifier doublon
            const exists = labelConfig.customFormats.find(f => f.name.toLowerCase() === name.toLowerCase());
            if (exists) { showAlert('‚ùå Un format avec ce nom existe d√©j√†', 'danger'); return; }
            
            labelConfig.customFormats.push({ name, width, height });
            saveLabelConfig();
            renderCustomLabelTable();
            updateLabelSizeSelects();
            
            document.getElementById('config-label-name').value = '';
            document.getElementById('config-label-width').value = '';
            document.getElementById('config-label-height').value = '';
            
            showAlert(`‚úÖ Format "${name}" (${width}√ó${height}mm) ajout√©`, 'success');
        }
        
        function deleteCustomLabelSize(index) {
            if (!confirm('Supprimer ce format ?')) return;
            labelConfig.customFormats.splice(index, 1);
            saveLabelConfig();
            renderCustomLabelTable();
            updateLabelSizeSelects();
            showAlert('‚úÖ Format supprim√©', 'success');
        }
        
        function saveDefaultLabelSize() {
            const select = document.getElementById('config-label-default');
            if (!select) return;
            labelConfig.defaultSize = select.value;
            saveLabelConfig();
            updateLabelSizeSelects();
            showAlert('‚úÖ Format par d√©faut enregistr√©', 'success');
        }
        
        async function saveLabelConfig() {
            try {
                const { error } = await supabaseClient
                    .from('configuration')
                    .upsert({
                        user_id: currentUser.id,
                        type: 'label_config',
                        data: labelConfig,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id,type' });
                if (error) console.error('Erreur sauvegarde label config:', error);
            } catch (e) {
                console.error('Erreur:', e);
            }
        }
        
        function importMPFromStock() {
            if (!matieresPremi√®res || matieresPremi√®res.length === 0) {
                showAlert('‚ùå Aucune mati√®re premi√®re en stock', 'danger');
                return;
            }
            
            const existingNames = new Set(mpRefConfig.map(mp => mp.nom.toLowerCase().trim()));
            let added = 0;
            const mpParNom = {};
            
            matieresPremi√®res.filter(mp => !mp.archived).forEach(mp => {
                const key = (mp.nom || '').toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                if (!key) return;
                if (!mpParNom[key] || (mp.cout && mp.cout > 0 && (!mpParNom[key].cout || mpParNom[key].cout === 0))) {
                    mpParNom[key] = mp;
                }
            });
            
            Object.values(mpParNom).forEach(mp => {
                const nomKey = mp.nom.toLowerCase().trim();
                if (!existingNames.has(nomKey)) {
                    mpRefConfig.push({
                        nom: mp.nom,
                        categorie: mp.categorie || '',
                        fournisseur: mp.fournisseur || '',
                        unite: 'kg',
                        prix: mp.cout || 0,
                        stockMini: mp.stockMini || mp.stock_mini || 0
                    });
                    existingNames.add(nomKey);
                    added++;
                }
            });
            
            if (added > 0) {
                mpRefConfig.sort((a, b) => a.nom.localeCompare(b.nom));
                saveMPRefConfig();
                renderMPRefTable();
                updateMPRefSelects();
                showAlert(`‚úÖ ${added} mati√®re(s) premi√®re(s) import√©e(s) depuis le stock`, 'success');
            } else {
                showAlert('‚ÑπÔ∏è Toutes les MP du stock sont d√©j√† dans la liste', 'info');
            }
        }
        
        function renderMPRefTable() {
            const tbody = document.querySelector('#mp-ref-table tbody');
            document.getElementById('mp-ref-count').textContent = mpRefConfig.length;
            
            if (mpRefConfig.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">Aucune MP r√©f√©renc√©e. Ajoutez-en via le formulaire ci-dessus.</td></tr>';
                return;
            }
            
            const catLabels = {
                'cacao': 'üç´ Cacao', 'sucre': 'üç¨ Sucres', 'laitier': 'ü•õ Laitiers',
                'fruits-secs': 'üå∞ Fruits Secs', 'epices': 'üåø √âpices', 
                'matieres-grasses': 'üßà Mat. Grasses', 'additifs': '‚öóÔ∏è Additifs', 'autre': 'üì¶ Autre'
            };
            
            tbody.innerHTML = mpRefConfig.map((mp, i) => `
                <tr>
                    <td><strong>${mp.nom}</strong></td>
                    <td>${catLabels[mp.categorie] || mp.categorie || '-'}</td>
                    <td>${mp.fournisseur || '-'}</td>
                    <td>${mp.unite || 'kg'}</td>
                    <td>${mp.prix ? mp.prix.toFixed(2) + '‚Ç¨' : '-'}</td>
                    <td>${mp.stockMini || '-'}</td>
                    <td>
                        <button class="btn btn-small" onclick="editMPRef(${i})" style="background: #2196f3; color: white; margin: 2px;">‚úèÔ∏è</button>
                        <button class="btn btn-small" onclick="deleteMPRef(${i})" style="background: #f44336; color: white; margin: 2px;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function saveMPRefConfig() {
            if (!isOnline || !supabaseClient) {
                saveToLocalStorage();
                return;
            }
            try {
                const { data: existing } = await supabaseClient
                    .from('configuration')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('type', 'mp_references')
                    .single();
                
                const configData = {
                    type: 'mp_references',
                    user_id: currentUser ? currentUser.id : null,
                    data: mpRefConfig
                };
                
                if (existing) {
                    await supabaseClient.from('configuration').update({ data: mpRefConfig }).eq('id', existing.id);
                } else {
                    await supabaseClient.from('configuration').insert(configData);
                }
                console.log('‚úÖ MP r√©f√©renc√©es sauvegard√©es');
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde MP ref:', error);
            }
        }
        
        function updateMPRefSelects() {
            // Mettre √† jour les selects dans le formulaire MP et r√©ception
            const selects = ['mp-nom-select', 'reception-mp-nom-select'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                // Sauvegarder la valeur actuelle
                const currentVal = select.value;
                
                // Reconstruire les options
                let options = '<option value="">-- S√©lectionner une MP --</option>';
                
                // Grouper par cat√©gorie
                const catLabels = {
                    'cacao': 'üç´ Cacao / Chocolat', 'sucre': 'üç¨ Sucres', 'laitier': 'ü•õ Produits Laitiers',
                    'fruits-secs': 'üå∞ Fruits Secs', 'epices': 'üåø √âpices & Ar√¥mes', 
                    'matieres-grasses': 'üßà Mati√®res Grasses', 'additifs': '‚öóÔ∏è Additifs', 'autre': 'üì¶ Autre', '': 'üì¶ Autre'
                };
                
                const grouped = {};
                mpRefConfig.forEach(mp => {
                    const cat = mp.categorie || '';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push(mp);
                });
                
                Object.keys(grouped).sort().forEach(cat => {
                    const label = catLabels[cat] || cat || 'Autre';
                    options += `<optgroup label="${label}">`;
                    grouped[cat].sort((a, b) => a.nom.localeCompare(b.nom)).forEach(mp => {
                        options += `<option value="${mp.nom}" data-categorie="${mp.categorie || ''}" data-fournisseur="${mp.fournisseur || ''}" data-unite="${mp.unite || 'kg'}" data-prix="${mp.prix || 0}" data-stock-mini="${mp.stockMini || 0}">${mp.nom}</option>`;
                    });
                    options += '</optgroup>';
                });
                
                options += '<option value="__custom__">‚úèÔ∏è Saisie libre...</option>';
                select.innerHTML = options;
                
                // Restaurer la valeur
                if (currentVal) select.value = currentVal;
            });
        }
        
        function onMPRefSelect(select) {
            const val = select.value;
            const nomInput = document.getElementById('mp-nom');
            
            if (val === '__custom__') {
                nomInput.style.display = 'block';
                nomInput.value = '';
                nomInput.focus();
                return;
            }
            
            nomInput.style.display = 'none';
            
            if (val && val !== '') {
                nomInput.value = val;
                
                // Auto-remplir les champs depuis la MP r√©f√©renc√©e
                const option = select.selectedOptions[0];
                if (option) {
                    const cat = option.dataset.categorie;
                    const fourn = option.dataset.fournisseur;
                    const unite = option.dataset.unite;
                    const prix = option.dataset.prix;
                    const stockMini = option.dataset.stockMini;
                    
                    if (cat) document.getElementById('mp-categorie').value = cat;
                    if (fourn) document.getElementById('mp-fournisseur').value = fourn;
                    if (unite) document.getElementById('mp-unite').value = unite;
                    if (prix && prix !== '0') document.getElementById('mp-prix').value = prix;
                    if (stockMini && stockMini !== '0') document.getElementById('mp-stock-mini').value = stockMini;
                }
            }
        }
        
        function onReceptionMPRefSelect(select) {
            const val = select.value;
            const nomInput = document.getElementById('reception-mp-nom');
            
            if (val === '__custom__') {
                nomInput.style.display = 'block';
                nomInput.value = '';
                nomInput.focus();
                return;
            }
            
            nomInput.style.display = 'none';
            
            if (val && val !== '') {
                nomInput.value = val;
                
                // Auto-remplir le fournisseur si disponible
                const option = select.selectedOptions[0];
                if (option && option.dataset.fournisseur) {
                    const fournInput = document.getElementById('reception-fournisseur');
                    if (fournInput && !fournInput.value) {
                        fournInput.value = option.dataset.fournisseur;
                    }
                }
            }
        }

        function updateCategorieSelects() {
            console.log('üîÑ Mise √† jour des s√©lecteurs de cat√©gories...');
            console.log('üì¶ Cat√©gories totales:', categoriesMP.length);
            console.log('üì¶ Cat√©gories actives:', categoriesMP.filter(c => c.actif).length);
            console.log('üìã Liste compl√®te des cat√©gories:', categoriesMP.map(c => `${c.emoji} ${c.nom} (${c.actif ? 'actif' : 'inactif'})`));
            
            // Mettre √† jour tous les s√©lecteurs de cat√©gories
            const selects = [
                document.getElementById('mp-categorie'),
                document.getElementById('filter-mp-categorie'),
                document.getElementById('filter-inventaire-categorie')
            ];
            
            const activeCategories = categoriesMP.filter(cat => cat.actif);
            console.log('üéØ Cat√©gories actives √† afficher:', activeCategories.length);
            activeCategories.forEach((cat, index) => {
                console.log(`  ${index + 1}. ${cat.emoji} ${cat.nom} (ID: ${cat.id})`);
            });
            
            selects.forEach(select => {
                if (!select) {
                    console.warn('‚ö†Ô∏è S√©lecteur non trouv√©');
                    return;
                }
                
                const currentValue = select.value;
                const isFilter = select.id.includes('filter');
                
                // Vider compl√®tement le s√©lecteur
                while (select.firstChild) {
                    select.removeChild(select.firstChild);
                }
                
                // Ajouter l'option par d√©faut
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = isFilter ? 'Toutes les cat√©gories' : 'S√©lectionner une cat√©gorie';
                select.appendChild(defaultOption);
                
                // Ajouter toutes les cat√©gories actives
                activeCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = `${cat.emoji} ${cat.nom}`;
                    select.appendChild(option);
                });
                
                // Restaurer la valeur si elle existe toujours
                if (currentValue && activeCategories.find(c => c.id === currentValue)) {
                    select.value = currentValue;
                }
                
                console.log(`‚úÖ S√©lecteur ${select.id} mis √† jour - ${select.options.length - 1} cat√©gories ajout√©es`);
            });
            
            console.log('‚úÖ Tous les s√©lecteurs de cat√©gories sont √† jour');
        }

        function getCategorieLabel(categorieId) {
            const categorie = categoriesMP.find(c => c.id === categorieId);
            if (categorie) {
                return `${categorie.emoji} ${categorie.nom}`;
            }
            return 'üì¶ Autre';
        }
        
        // Fonction pour mettre √† jour le s√©lecteur de produits dans les recettes
        function updateRecipeProductSelects() {
            const select = document.getElementById('config-recette-produit');
            if (!select) return;
            
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">S√©lectionner un produit</option>';
            
            const activeProducts = productsConfig.filter(p => p.actif);
            
            // Trier par ordre alphab√©tique
            activeProducts.sort((a, b) => a.nom.localeCompare(b.nom, 'fr'));
            
            activeProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.nom;
                select.appendChild(option);
            });
            
            // Restaurer la valeur si elle existe toujours
            if (currentValue && activeProducts.find(p => p.id === currentValue)) {
                select.value = currentValue;
            }
        }
        
        // Fonction pour mettre √† jour le s√©lecteur d'ingr√©dients de recettes (par nom de MP)
        function updateRecipeIngredientSelect() {
            const select = document.getElementById('recette-ingredient-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choisir une mati√®re premi√®re</option>';
            
            // Grouper par cat√©gorie, mais avec des noms uniques
            const categories = {};
            const mpParNom = {}; // Pour regrouper les MP par nom
            
            categoriesMP
                .filter(cat => cat.actif)
                .forEach(cat => {
                    categories[cat.id] = [];
                });
            
            // D'abord ajouter les MP r√©f√©renc√©es (elles apparaissent m√™me sans stock)
            if (mpRefConfig && mpRefConfig.length > 0) {
                mpRefConfig.forEach(mp => {
                    const nomNormalized = (mp.nom || '').toLowerCase().trim()
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    if (!mpParNom[nomNormalized]) {
                        mpParNom[nomNormalized] = {
                            nom: mp.nom,
                            categorie: mp.categorie || 'autre',
                            cout: mp.prix || 0
                        };
                    }
                });
            }
            
            // Ensuite ajouter les MP en stock (√©crase si m√™me nom = donn√©es plus √† jour)
            matieresPremi√®res.filter(mp => !mp.archived).forEach(mp => {
                const nomNormalized = (mp.nom || '').toLowerCase().trim()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                
                if (!mpParNom[nomNormalized]) {
                    mpParNom[nomNormalized] = mp;
                }
            });
            
            // R√©partir dans les cat√©gories
            Object.values(mpParNom).forEach(mp => {
                const categorie = mp.categorie || 'autre';
                if (!categories[categorie]) {
                    categories[categorie] = [];
                }
                categories[categorie].push(mp);
            });
            
            // Ajouter les options group√©es par cat√©gorie
            categoriesMP
                .filter(cat => cat.actif)
                .forEach(cat => {
                    if (categories[cat.id] && categories[cat.id].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `${cat.emoji} ${cat.nom}`;
                        
                        // Trier par nom
                        categories[cat.id].sort((a, b) => a.nom.localeCompare(b.nom));
                        
                        categories[cat.id].forEach(mp => {
                            const option = document.createElement('option');
                            option.value = mp.nom;
                            option.dataset.category = mp.categorie;
                            const coutInfo = mp.cout ? ` (${mp.cout.toFixed(2)} ‚Ç¨/kg)` : '';
                            option.textContent = `${mp.nom}${coutInfo}`;
                            optgroup.appendChild(option);
                        });
                        
                        select.appendChild(optgroup);
                    }
                });
        }
        
        // ============================================
        // GESTION DES RECETTES
        // ============================================
        
        window.createRecipeFromProduct = function(productId) {
            // Basculer vers l'onglet Recettes
            showTab('recettes');
            
            // Attendre que l'onglet soit charg√©
            setTimeout(() => {
                // S√©lectionner le produit
                const productSelect = document.getElementById('config-recette-produit');
                if (productSelect) {
                    productSelect.value = productId;
                    
                    // Faire d√©filer vers le formulaire de recette
                    setTimeout(() => {
                        const recetteForm = document.getElementById('recette-form');
                        if (recetteForm) {
                            recetteForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                    
                    const product = productsConfig.find(p => p.id === productId);
                    if (product) {
                        showAlert(`‚ú® Cr√©ation de recette pour "${product.nom}"\n\nS√©lectionnez les mati√®res premi√®res et leurs quantit√©s ci-dessous.`, 'success');
                    }
                }
            }, 200);
        }
        
        window.editRecipeFromProduct = function(productId) {
            const recipe = recipesConfig.find(r => r.productId === productId);
            if (!recipe) {
                createRecipeFromProduct(productId);
                return;
            }
            
            // Basculer vers l'onglet Recettes (pas Configuration)
            showTab('recettes');
            
            // Remplir le formulaire avec la recette existante
            setTimeout(() => {
                console.log('üìã Chargement recette:', recipe);
                console.log('üìã quantiteBase:', recipe.quantiteBase);
                console.log('üìã uniteBase:', recipe.uniteBase);
                console.log('üìã enrobage:', recipe.enrobage);
                
                document.getElementById('config-recette-produit').value = recipe.productId;
                document.getElementById('config-recette-quantite-base').value = recipe.quantiteBase;
                document.getElementById('config-recette-unite-base').value = recipe.uniteBase || 'kg';
                
                // Charger les ingr√©dients de la recette
                // S'assurer que les ingr√©dients ont tous une unit√© et recalculer les co√ªts
                currentRecipeIngredients = recipe.ingredients.map(ing => {
                    // Chercher la MP pour r√©cup√©rer le co√ªt actuel
                    const mp = matieresPremi√®res.find(m => m.id === ing.mpId || m.nom === ing.mpNom);
                    const coutUnitaire = mp ? (mp.cout || mp.prix || 0) : (ing.coutUnitaire || 0);
                    const quantity = ing.quantity || 0;
                    const unite = ing.unite || 'kg';
                    
                    // Calculer le co√ªt total
                    let coutTotal = 0;
                    if (unite === 'kg') {
                        coutTotal = quantity * coutUnitaire;
                    } else {
                        coutTotal = quantity * coutUnitaire;
                    }
                    
                    return {
                        ...ing,
                        unite: unite,
                        coutUnitaire: coutUnitaire,
                        coutTotal: coutTotal
                    };
                });
                
                // Mettre √† jour le select des chocolats d'enrobage
                updateEnrobageChocolatSelect();
                
                // Charger l'enrobage si pr√©sent
                if (recipe.enrobage) {
                    // Chercher par mpId d'abord, sinon par nom
                    const enrobageSelect = document.getElementById('recette-enrobage-chocolat');
                    if (recipe.enrobage.mpId) {
                        enrobageSelect.value = recipe.enrobage.mpId;
                    } else {
                        // Fallback : chercher par nom
                        const options = Array.from(enrobageSelect.options);
                        const match = options.find(opt => opt.dataset.mpNom === recipe.enrobage.chocolat);
                        if (match) {
                            enrobageSelect.value = match.value;
                        }
                    }
                    
                    // Afficher les champs d'enrobage
                    toggleEnrobageFields();
                    
                    document.getElementById('recette-enrobage-grammage').value = recipe.enrobage.grammage || '';
                    document.getElementById('recette-enrobage-pieces').value = recipe.enrobage.nombrePieces || recipe.quantiteBase || '';
                    // Note: updateEnrobageDisplay sera appel√© dans le setTimeout
                } else {
                    document.getElementById('recette-enrobage-chocolat').value = '';
                    document.getElementById('recette-enrobage-grammage').value = '';
                    document.getElementById('recette-enrobage-pieces').value = '';
                    document.getElementById('recette-enrobage-total').textContent = '-';
                }
                
                // Appeler les fonctions de mise √† jour apr√®s un d√©lai pour s'assurer que tout est charg√©
                setTimeout(() => {
                    console.log('üîÑ Mise √† jour apr√®s d√©lai...');
                    console.log('üîÑ Grammage:', document.getElementById('recette-enrobage-grammage')?.value);
                    console.log('üîÑ Chocolat ID:', document.getElementById('recette-enrobage-chocolat')?.value);
                    console.log('üîÑ Quantit√© base:', document.getElementById('config-recette-quantite-base')?.value);
                    
                    updateEnrobageDisplay();
                    updateRecipeIngredientsDisplay();
                }, 150);
                
                // Faire d√©filer vers le formulaire
                const recetteForm = document.getElementById('recette-form');
                if (recetteForm) {
                    recetteForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                const product = productsConfig.find(p => p.id === recipe.productId);
                let enrobageInfo = recipe.enrobage ? `\nüç´ Enrobage: ${recipe.enrobage.chocolat} (${recipe.enrobage.grammage}g/pi√®ce)` : '';
                if (product) {
                    showAlert(`‚úèÔ∏è Modification de la recette pour "${product.nom}"\n\nüì¶ Quantit√© base: ${recipe.quantiteBase} ${recipe.uniteBase === 'nombre' ? 'unit√©(s)' : 'kg'}\nüßÑ ${recipe.ingredients.length} ingr√©dient(s)${enrobageInfo}`, 'success');
                }
            }, 100);
        }
        
        function viewRecipeDetail(productId) {
            const recipe = recipesConfig.find(r => r.productId === productId);
            if (!recipe) {
                showAlert('Recette non trouv√©e', 'danger');
                return;
            }
            
            const product = productsConfig.find(p => p.id === productId);
            const productName = product ? product.nom : 'Produit inconnu';
            
            const totalQuantityKg = recipe.ingredients.filter(ing => ing.unite === 'kg').reduce((sum, ing) => sum + ing.quantity, 0);
            const totalQuantityNombre = recipe.ingredients.filter(ing => ing.unite === 'nombre').reduce((sum, ing) => sum + ing.quantity, 0);
            
            let totalText = '';
            if (totalQuantityKg > 0 && totalQuantityNombre > 0) {
                totalText = `${totalQuantityKg.toFixed(3)} kg + ${totalQuantityNombre} unit√©(s)`;
            } else if (totalQuantityKg > 0) {
                totalText = `${totalQuantityKg.toFixed(3)} kg`;
            } else if (totalQuantityNombre > 0) {
                totalText = `${totalQuantityNombre} unit√©(s)`;
            }
            
            const uniteBaseLabel = recipe.uniteBase === 'kg' ? 'kg' : recipe.uniteBase === 'g' ? 'g' : recipe.uniteBase === 'nombre' ? 'unit√©(s)' : 'kg';
            const quantiteBaseDisplay = recipe.uniteBase === 'nombre' ? Math.round(recipe.quantiteBase) : recipe.uniteBase === 'g' ? recipe.quantiteBase.toFixed(0) : recipe.quantiteBase.toFixed(1);
            
            const detailHTML = `
                <div style="max-width: 800px;">
                    <h2>üß™ Recette : ${productName}</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #9C27B0;">
                        <strong>üì¶ Quantit√© de base :</strong> ${quantiteBaseDisplay} ${uniteBaseLabel}<br>
                        <strong>üßÑ Nombre d'ingr√©dients :</strong> ${recipe.ingredients.length}<br>
                        <strong>‚öñÔ∏è Total mati√®res premi√®res :</strong> ${totalText}
                        ${recipe.enrobage ? `<br><strong>üç´ Enrobage :</strong> ${recipe.enrobage.chocolat} (${recipe.enrobage.grammage}g/pi√®ce)` : ''}
                    </div>
                    
                    ${recipe.enrobage ? `
                    <div style="background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%); padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #8B4513;">
                        <h4 style="color: #5c3a21; margin-bottom: 10px;">üç´ Chocolat d'Enrobage</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <strong>Type :</strong> ${recipe.enrobage.chocolat}
                            </div>
                            <div>
                                <strong>Grammage :</strong> ${recipe.enrobage.grammage}g par pi√®ce
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <h3 style="margin-top: 25px; color: #9C27B0;">Composition :</h3>
                    
                    <div style="display: grid; gap: 10px; margin-top: 15px;">
                        ${recipe.ingredients.map((ing, index) => {
                            const uniteLabel = ing.unite === 'kg' ? 'kg' : ing.unite === 'nombre' ? 'unit√©(s)' : ing.unite;
                            const quantityDisplay = ing.unite === 'kg' ? ing.quantity.toFixed(3) : Math.round(ing.quantity);
                            const totalForPercentage = totalQuantityKg > 0 ? totalQuantityKg : 1;
                            const percentage = ing.unite === 'kg' ? ((ing.quantity / totalForPercentage) * 100).toFixed(1) : '';
                            
                            return `
                                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #9C27B0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                                                ${ing.mpNom}
                                            </div>
                                            <div style="font-size: 13px; color: #666;">
                                                ${ing.categorieEmoji} ${ing.categorieNom} ‚Ä¢ Pour ${quantiteBaseDisplay} ${uniteBaseLabel} de produit fini
                                            </div>
                                        </div>
                                        <div style="text-align: right; padding-left: 20px;">
                                            <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">
                                                ${quantityDisplay} ${uniteLabel}
                                            </div>
                                            ${percentage ? `<div style="font-size: 12px; color: #666;">
                                                ${percentage}% du total
                                            </div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn" onclick="editRecipeFromProduct('${escJS(productId)}'); closeConfirmModal();">‚úèÔ∏è Modifier la Recette</button>
                        <button class="btn btn-secondary" onclick="closeConfirmModal()">Fermer</button>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = '';
            document.getElementById('confirm-message').innerHTML = detailHTML;
            document.getElementById('confirm-yes').style.display = 'none';
            document.getElementById('confirm-no').style.display = 'none';
            modal.style.display = 'block';
        }
        
        function addRecipeIngredient() {
            const mpNameOrId = document.getElementById('recette-ingredient-select').value;
            let quantity = parseFloat(document.getElementById('recette-ingredient-quantite').value);
            let unite = document.getElementById('recette-ingredient-unite').value;
            
            if (!mpNameOrId || !quantity || quantity <= 0) {
                showAlert('Veuillez s√©lectionner une mati√®re premi√®re et saisir une quantit√© valide', 'warning');
                return;
            }
            
            // Chercher la MP par nom (pas par ID)
            const mp = matieresPremi√®res.find(m => m.nom === mpNameOrId);
            if (!mp) {
                showAlert('Mati√®re premi√®re non trouv√©e', 'danger');
                return;
            }
            
            // Convertir les grammes en kg pour le stockage interne
            let quantityKg = quantity;
            let displayQuantity = quantity;
            let displayUnite = unite;
            
            if (unite === 'g') {
                quantityKg = quantity / 1000; // Convertir g en kg
                displayQuantity = quantity;
                displayUnite = 'g';
                unite = 'kg'; // Stocker en kg internement
            }
            
            // V√©rifier si cette MP n'est pas d√©j√† dans la recette (par nom)
            const existingIndex = currentRecipeIngredients.findIndex(ing => ing.mpNom === mp.nom);
            
            if (existingIndex >= 0) {
                showAlert(`‚ö†Ô∏è "${mp.nom}" est d√©j√† dans la recette.\n\nModifiez la quantit√© existante ou supprimez-la d'abord.`, 'warning');
                return;
            }
            
            const categorie = categoriesMP.find(c => c.id === mp.categorie);
            
            // R√©cup√©rer le co√ªt de la MP (‚Ç¨/kg ou ‚Ç¨/unit√©)
            const coutMP = mp.cout || mp.prix || 0;
            
            // Calculer le co√ªt pour cette quantit√©
            let coutIngredient = 0;
            if (unite === 'kg') {
                coutIngredient = quantityKg * coutMP; // co√ªt = quantit√© en kg * prix/kg
            } else {
                // Pour les unit√©s, on suppose que le co√ªt est d√©j√† par unit√©
                coutIngredient = quantity * coutMP;
            }
            
            currentRecipeIngredients.push({
                mpNom: mp.nom,  // Utiliser le NOM comme identifiant principal
                categorieId: mp.categorie,
                categorieNom: categorie ? categorie.nom : 'Autre',
                categorieEmoji: categorie ? categorie.emoji : 'üì¶',
                quantity: unite === 'kg' ? quantityKg : quantity, // Stocker en kg si c'√©tait en g
                unite: unite,
                coutUnitaire: coutMP,
                coutTotal: coutIngredient
            });
            
            updateRecipeIngredientsDisplay();
            
            // R√©initialiser les champs
            document.getElementById('recette-ingredient-select').value = '';
            document.getElementById('recette-ingredient-quantite').value = '';
            document.getElementById('recette-ingredient-unite').value = 'g'; // Par d√©faut grammes
            
            const uniteLabel = displayUnite === 'kg' ? 'kg' : displayUnite === 'g' ? 'g' : displayUnite === 'nombre' ? 'unit√©(s)' : displayUnite;
            showAlert(`‚úÖ ${displayQuantity} ${uniteLabel} de ${mp.nom} ajout√© √† la recette (${coutIngredient.toFixed(2)} ‚Ç¨)`, 'success');
        }
        
        function updateRecipeIngredientsDisplay() {
            const container = document.getElementById('recette-ingredients-list');
            const emptyMessage = document.getElementById('recette-ingredients-empty');
            const totalDiv = document.getElementById('recette-total');
            const totalWeight = document.getElementById('total-recette-weight');
            const totalCout = document.getElementById('total-recette-cout');
            const coutUnitaireDiv = document.getElementById('recette-cout-unitaire');
            const coutParUnite = document.getElementById('cout-par-unite');
            const uniteBaseLabel = document.getElementById('unite-base-label');
            
            if (!container || !emptyMessage || !totalDiv || !totalWeight) return;
            
            // Supprimer tous les anciens ingr√©dients affich√©s
            const oldIngredients = container.querySelectorAll('.ingredient-simple-row');
            oldIngredients.forEach(item => item.remove());
            
            if (currentRecipeIngredients.length === 0) {
                emptyMessage.style.display = 'block';
                totalDiv.style.display = 'none';
                return;
            }
            
            emptyMessage.style.display = 'none';
            totalDiv.style.display = 'block';
            
            // Calculer le total des ingr√©dients (uniquement les kg)
            const totalKgIngredients = currentRecipeIngredients
                .filter(ing => ing.unite === 'kg')
                .reduce((sum, ing) => sum + ing.quantity, 0);
            const totalNombre = currentRecipeIngredients
                .filter(ing => ing.unite === 'nombre')
                .reduce((sum, ing) => sum + ing.quantity, 0);
            
            // Calculer le co√ªt total des ingr√©dients
            const coutIngredients = currentRecipeIngredients.reduce((sum, ing) => sum + (ing.coutTotal || 0), 0);
            
            // Calculer le poids et co√ªt de l'enrobage si pr√©sent
            let coutEnrobage = 0;
            let poidsEnrobageKg = 0;
            const enrobageSelect = document.getElementById('recette-enrobage-chocolat');
            const enrobageMpId = enrobageSelect ? enrobageSelect.value : '';
            const enrobageGrammage = parseFloat(document.getElementById('recette-enrobage-grammage')?.value) || 0;
            const quantiteBase = parseFloat(document.getElementById('config-recette-quantite-base')?.value) || 1;
            const uniteBase = document.getElementById('config-recette-unite-base')?.value || 'kg';
            
            if (enrobageMpId && enrobageGrammage > 0) {
                const mpEnrobage = matieresPremi√®res.find(mp => mp.id == enrobageMpId);
                const enrobagePieces = parseFloat(document.getElementById('recette-enrobage-pieces')?.value) || 0;
                
                if (mpEnrobage && enrobagePieces > 0) {
                    const enrobageCoutKg = mpEnrobage.cout || 0;
                    
                    // Calcul du poids de l'enrobage avec le nombre de pi√®ces sp√©cifi√©
                    poidsEnrobageKg = (enrobageGrammage * enrobagePieces) / 1000;
                    coutEnrobage = poidsEnrobageKg * enrobageCoutKg;
                }
            }
            
            // Total kg = ingr√©dients + enrobage
            const totalKg = totalKgIngredients + poidsEnrobageKg;
            
            // Co√ªt total = ingr√©dients + enrobage
            const totalCoutValue = coutIngredients + coutEnrobage;
            
            let totalText = '';
            if (totalKg > 0 && totalNombre > 0) {
                totalText = `${totalKg.toFixed(3)} kg + ${totalNombre} unit√©(s)`;
            } else if (totalKg > 0) {
                totalText = `${totalKg.toFixed(3)} kg`;
            } else if (totalNombre > 0) {
                totalText = `${totalNombre} unit√©(s)`;
            } else {
                totalText = '0';
            }
            
            // Ajouter le d√©tail si enrobage pr√©sent
            if (poidsEnrobageKg > 0) {
                const poidsEnrobageG = poidsEnrobageKg * 1000;
                const poidsIngredientsG = totalKgIngredients * 1000;
                totalText += ` <span style="font-size: 12px; color: #666;">(ing: ${poidsIngredientsG.toFixed(0)}g + enr: ${poidsEnrobageG.toFixed(0)}g)</span>`;
            }
            
            totalWeight.innerHTML = totalText;
            
            // Afficher le co√ªt total avec d√©tail si enrobage
            if (totalCout) {
                if (coutEnrobage > 0) {
                    totalCout.innerHTML = `${totalCoutValue.toFixed(2)} <span style="font-size: 12px; color: #666;">(ing: ${coutIngredients.toFixed(2)}‚Ç¨ + enr: ${coutEnrobage.toFixed(2)}‚Ç¨)</span>`;
                } else {
                    totalCout.textContent = totalCoutValue.toFixed(2);
                }
            }
            
            // Calculer et afficher le co√ªt unitaire si quantit√© base est d√©finie
            if (coutUnitaireDiv && coutParUnite && uniteBaseLabel && totalKg > 0) {
                const coutParKgValue = totalCoutValue / totalKg;
                coutParUnite.textContent = coutParKgValue.toFixed(2);
                uniteBaseLabel.textContent = 'kg';
                coutUnitaireDiv.style.display = 'block';
            } else if (coutUnitaireDiv) {
                coutUnitaireDiv.style.display = 'none';
            }
            
            const ingredientsHTML = currentRecipeIngredients.map((ingredient, index) => {
                let quantityDisplay, uniteLabel;
                
                if (ingredient.unite === 'kg') {
                    // Si la quantit√© est petite (< 0.1 kg = 100g), afficher en grammes
                    if (ingredient.quantity < 0.1) {
                        quantityDisplay = Math.round(ingredient.quantity * 1000);
                        uniteLabel = 'g';
                    } else {
                        quantityDisplay = ingredient.quantity.toFixed(3);
                        uniteLabel = 'kg';
                    }
                } else if (ingredient.unite === 'nombre') {
                    quantityDisplay = Math.round(ingredient.quantity);
                    uniteLabel = 'unit√©(s)';
                } else {
                    quantityDisplay = ingredient.quantity;
                    uniteLabel = ingredient.unite;
                }
                
                const coutDisplay = (ingredient.coutTotal || 0).toFixed(2);
                const coutUnitaireDisplay = (ingredient.coutUnitaire || 0).toFixed(2);
                
                return `
                <div class="ingredient-simple-row" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #9C27B0;">
                    <div style="flex: 1;">
                        <div style="font-size: 15px; font-weight: 700; color: #000; margin-bottom: 4px;">
                            ${ingredient.mpNom}
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            ${ingredient.categorieEmoji} ${ingredient.categorieNom} ‚Ä¢ <span style="color: #888;">${coutUnitaireDisplay} ‚Ç¨/${ingredient.unite === 'kg' ? 'kg' : 'u'}</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="text-align: right;">
                            <div style="font-weight: 700; font-size: 18px; color: #9C27B0;">${quantityDisplay} ${uniteLabel}</div>
                            <div style="font-size: 13px; color: #2e7d32; font-weight: 600;">üí∞ ${coutDisplay} ‚Ç¨</div>
                        </div>
                        <button onclick="removeRecipeIngredient(${index})" class="btn btn-small btn-danger" style="padding: 6px 10px;">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            }).join('');
            
            emptyMessage.insertAdjacentHTML('afterend', ingredientsHTML);
        }
        
        function removeRecipeIngredient(index) {
            if (index >= 0 && index < currentRecipeIngredients.length) {
                const removed = currentRecipeIngredients[index];
                currentRecipeIngredients.splice(index, 1);
                
                // Supprimer les anciens √©l√©ments d'ingr√©dients
                document.querySelectorAll('.ingredient-simple-row').forEach(item => item.remove());
                
                updateRecipeIngredientsDisplay();
                showAlert(`${removed.categorieNom} retir√© de la recette`, 'success');
            }
        }
        
        function checkRecipeExists() {
            const productId = document.getElementById('config-recette-produit').value;
            const warning = document.getElementById('recipe-exists-warning');
            
            if (!productId || !warning) return;
            
            const existingRecipe = recipesConfig.find(r => r.productId === productId);
            
            if (existingRecipe) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }
        
        // Fonction pour synchroniser les recettes avec les MP (ajouter les ID manquants)
        async function syncRecipesWithMP() {
            if (recipesConfig.length === 0) {
                showAlert('Aucune recette √† synchroniser', 'warning');
                return;
            }
            
            let modifiedCount = 0;
            let issuesFound = [];
            
            // Fonction pour chercher une MP par nom (avec tol√©rance)
            const findMPByName = (mpName) => {
                if (!mpName) return null;
                
                const mpNameNormalized = mpName.toLowerCase().trim().replace(/\s+/g, ' ');
                const removeAccents = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                const mpNameNoAccents = removeAccents(mpNameNormalized);
                
                // Chercher correspondance exacte
                let mp = matieresPremi√®res.find(m => {
                    const nomNorm = (m.nom || '').toLowerCase().trim().replace(/\s+/g, ' ');
                    return nomNorm === mpNameNormalized;
                });
                
                // Si pas trouv√©, chercher sans accents
                if (!mp) {
                    mp = matieresPremi√®res.find(m => {
                        const nomNorm = removeAccents((m.nom || '').toLowerCase().trim().replace(/\s+/g, ' '));
                        return nomNorm === mpNameNoAccents;
                    });
                }
                
                // Si pas trouv√©, chercher correspondance partielle
                if (!mp) {
                    mp = matieresPremi√®res.find(m => {
                        const nomNorm = (m.nom || '').toLowerCase().trim().replace(/\s+/g, ' ');
                        const nomNoAccents = removeAccents(nomNorm);
                        return nomNorm.includes(mpNameNormalized) || mpNameNormalized.includes(nomNorm) ||
                               nomNoAccents.includes(mpNameNoAccents) || mpNameNoAccents.includes(nomNoAccents);
                    });
                }
                
                return mp;
            };
            
            // Parcourir toutes les recettes
            for (const recipe of recipesConfig) {
                let recipeModified = false;
                
                // Synchroniser les ingr√©dients
                if (recipe.ingredients && recipe.ingredients.length > 0) {
                    for (const ing of recipe.ingredients) {
                        // Si pas d'ID, chercher la MP par nom
                        if (!ing.mpId && ing.mpNom) {
                            const mp = findMPByName(ing.mpNom);
                            if (mp) {
                                ing.mpId = mp.id;
                                recipeModified = true;
                                console.log(`‚úÖ ${recipe.productName}: "${ing.mpNom}" ‚Üí ID ${mp.id} (${mp.nom})`);
                            } else {
                                issuesFound.push(`${recipe.productName}: "${ing.mpNom}" non trouv√©`);
                                console.warn(`‚ùå ${recipe.productName}: "${ing.mpNom}" non trouv√© dans les MP`);
                            }
                        }
                    }
                }
                
                // Synchroniser l'enrobage
                if (recipe.enrobage && recipe.enrobage.chocolat && !recipe.enrobage.mpId) {
                    const mp = findMPByName(recipe.enrobage.chocolat);
                    if (mp) {
                        recipe.enrobage.mpId = mp.id;
                        recipeModified = true;
                        console.log(`‚úÖ ${recipe.productName} (enrobage): "${recipe.enrobage.chocolat}" ‚Üí ID ${mp.id}`);
                    } else {
                        issuesFound.push(`${recipe.productName} (enrobage): "${recipe.enrobage.chocolat}" non trouv√©`);
                    }
                }
                
                if (recipeModified) {
                    modifiedCount++;
                }
            }
            
            // Sauvegarder si des modifications ont √©t√© faites
            if (modifiedCount > 0) {
                await saveRecipesConfig();
                displayRecipesConfig();
            }
            
            // Afficher le r√©sultat
            let message = `üîÑ Synchronisation termin√©e !\n\n`;
            message += `‚úÖ ${modifiedCount} recette(s) mise(s) √† jour\n`;
            
            if (issuesFound.length > 0) {
                message += `\n‚ö†Ô∏è ${issuesFound.length} ingr√©dient(s) non trouv√©(s) :\n`;
                message += issuesFound.slice(0, 10).map(i => `‚Ä¢ ${i}`).join('\n');
                if (issuesFound.length > 10) {
                    message += `\n... et ${issuesFound.length - 10} autre(s)`;
                }
                message += `\n\nüí° Pour ces ingr√©dients, v√©rifiez que les MP existent dans votre stock.`;
                showAlert(message, 'warning');
            } else if (modifiedCount > 0) {
                showAlert(message + '\nToutes les recettes sont maintenant synchronis√©es ! üéâ', 'success');
            } else {
                showAlert('‚úÖ Toutes les recettes sont d√©j√† synchronis√©es !', 'success');
            }
        }
        
        async function saveRecipe() {
            const productId = document.getElementById('config-recette-produit').value;
            const quantiteBase = parseFloat(document.getElementById('config-recette-quantite-base').value);
            const uniteBase = document.getElementById('config-recette-unite-base').value;
            
            // R√©cup√©rer les infos d'enrobage
            const enrobageSelect = document.getElementById('recette-enrobage-chocolat');
            const enrobageMpId = enrobageSelect.value;
            const enrobageGrammage = parseFloat(document.getElementById('recette-enrobage-grammage').value) || 0;
            const enrobagePieces = parseFloat(document.getElementById('recette-enrobage-pieces').value) || 0;
            
            // R√©cup√©rer le nom et le co√ªt du chocolat depuis la MP
            let enrobageChocolatNom = '';
            let enrobageCoutKg = 0;
            let enrobageLot = '';
            if (enrobageMpId) {
                const selectedOption = enrobageSelect.options[enrobageSelect.selectedIndex];
                enrobageChocolatNom = selectedOption.dataset.mpNom || selectedOption.textContent.replace('üç´ ', '').split(' - Lot:')[0];
                enrobageLot = selectedOption.dataset.mpLot || '';
                
                // R√©cup√©rer le co√ªt unitaire de la MP
                const mpEnrobage = matieresPremi√®res.find(mp => mp.id == enrobageMpId);
                if (mpEnrobage) {
                    enrobageCoutKg = mpEnrobage.cout || 0; // Co√ªt en ‚Ç¨/kg
                }
            }
            
            if (!productId || !quantiteBase || quantiteBase <= 0) {
                showAlert('Veuillez s√©lectionner un produit et saisir une quantit√© de base valide', 'warning');
                return;
            }
            
            if (currentRecipeIngredients.length === 0) {
                showAlert('Veuillez ajouter au moins un ingr√©dient √† la recette', 'warning');
                return;
            }
            
            const product = productsConfig.find(p => p.id === productId);
            if (!product) {
                showAlert('Produit non trouv√©', 'danger');
                return;
            }
            
            // Calculer le co√ªt total des ingr√©dients
            const coutIngredients = currentRecipeIngredients.reduce((sum, ing) => sum + (ing.coutTotal || 0), 0);
            
            // Calculer le co√ªt de l'enrobage si pr√©sent
            let coutEnrobage = 0;
            let quantiteEnrobageKg = 0;
            if (enrobageMpId && enrobageGrammage > 0 && enrobagePieces > 0) {
                // Utiliser le nombre de pi√®ces sp√©cifi√© pour calculer l'enrobage
                quantiteEnrobageKg = (enrobageGrammage * enrobagePieces) / 1000;
                coutEnrobage = quantiteEnrobageKg * enrobageCoutKg;
            }
            
            // Co√ªt total = ingr√©dients + enrobage
            const coutTotal = coutIngredients + coutEnrobage;
            const totalIngredientsKg = currentRecipeIngredients
                .filter(ing => ing.unite === 'kg')
                .reduce((sum, ing) => sum + ing.quantity, 0);
            const totalPoidsKg = totalIngredientsKg + quantiteEnrobageKg;
            const coutUnitaire = totalPoidsKg > 0 ? coutTotal / totalPoidsKg : 0;
            
            // V√©rifier si une recette existe d√©j√†
            const existingIndex = recipesConfig.findIndex(r => r.productId === productId);
            
            const recipe = {
                productId: productId,
                productName: product.nom,
                quantiteBase: quantiteBase,
                uniteBase: uniteBase,
                ingredients: [...currentRecipeIngredients],
                enrobage: enrobageMpId ? {
                    mpId: parseInt(enrobageMpId),
                    chocolat: enrobageChocolatNom,
                    lot: enrobageLot,
                    grammage: enrobageGrammage,
                    nombrePieces: enrobagePieces,  // NOUVEAU CHAMP
                    coutKg: enrobageCoutKg,
                    quantiteKg: quantiteEnrobageKg,
                    coutTotal: coutEnrobage
                } : null,
                coutIngredients: coutIngredients,
                coutEnrobage: coutEnrobage,
                coutTotal: coutTotal,
                coutUnitaire: coutUnitaire,
                updatedAt: new Date().toISOString()
            };
            
            const uniteLabel = uniteBase === 'kg' ? 'kg' : uniteBase === 'g' ? 'g' : 'unit√©(s)';
            let enrobageInfo = '';
            if (enrobageMpId && enrobageGrammage > 0) {
                enrobageInfo = `\nüç´ Enrobage: ${enrobageChocolatNom} (${enrobageGrammage}g/pi√®ce = ${(quantiteEnrobageKg * 1000).toFixed(0)}g total ‚Üí ${coutEnrobage.toFixed(2)} ‚Ç¨)`;
            }
            
            // Construire le d√©tail des co√ªts
            let coutDetail = `\nüí∞ Co√ªt ingr√©dients: ${coutIngredients.toFixed(2)} ‚Ç¨`;
            if (coutEnrobage > 0) {
                coutDetail += `\nüç´ Co√ªt enrobage: ${coutEnrobage.toFixed(2)} ‚Ç¨`;
            }
            const coutParKg = coutUnitaire;
            coutDetail += `\nüìä TOTAL: ${coutTotal.toFixed(2)} ‚Ç¨ (${coutParKg.toFixed(2)} ‚Ç¨/kg)`;
            
            if (existingIndex >= 0) {
                recipesConfig[existingIndex] = recipe;
                showAlert(`‚úÖ Recette pour "${product.nom}" mise √† jour avec succ√®s !\n\nüì¶ Base: ${quantiteBase} ${uniteLabel}\nüßÑ ${currentRecipeIngredients.length} ingr√©dient(s)${enrobageInfo}${coutDetail}`, 'success');
            } else {
                recipesConfig.push(recipe);
                showAlert(`‚úÖ Recette pour "${product.nom}" cr√©√©e avec succ√®s !\n\nüì¶ Base: ${quantiteBase} ${uniteLabel}\nüßÑ ${currentRecipeIngredients.length} ingr√©dient(s)${enrobageInfo}${coutDetail}`, 'success');
            }
            
            // Sauvegarder dans Supabase
            await saveRecipesConfig();
            
            resetRecipeForm();
            displayProductsConfig();
            displayRecipesConfig();
        }
        
        function resetRecipeForm() {
            document.getElementById('config-recette-produit').value = '';
            document.getElementById('config-recette-quantite-base').value = '';
            document.getElementById('config-recette-unite-base').value = 'kg';
            document.getElementById('recette-ingredient-select').value = '';
            document.getElementById('recette-ingredient-quantite').value = '';
            document.getElementById('recette-ingredient-unite').value = 'g'; // Par d√©faut grammes
            
            // Reset enrobage
            document.getElementById('recette-enrobage-chocolat').value = '';
            document.getElementById('recette-enrobage-grammage').value = '';
            document.getElementById('recette-enrobage-total').textContent = '-';
            
            currentRecipeIngredients = [];
            updateRecipeIngredientsDisplay();
            
            const warning = document.getElementById('recipe-exists-warning');
            if (warning) {
                warning.style.display = 'none';
            }
        }
        
        // Fonction pour calculer et afficher le total d'enrobage
        function toggleEnrobageFields() {
            const chocolatSelect = document.getElementById('recette-enrobage-chocolat');
            const hasEnrobage = chocolatSelect.value !== '';
            
            // Afficher/masquer les champs d'enrobage
            document.getElementById('enrobage-grammage-group').style.display = hasEnrobage ? 'block' : 'none';
            document.getElementById('enrobage-pieces-group').style.display = hasEnrobage ? 'block' : 'none';
            document.getElementById('enrobage-total-group').style.display = hasEnrobage ? 'block' : 'none';
            
            // Si on active l'enrobage, pr√©-remplir le nombre de pi√®ces si l'unit√© est "nombre"
            if (hasEnrobage) {
                const uniteBase = document.getElementById('config-recette-unite-base').value;
                const quantiteBase = parseFloat(document.getElementById('config-recette-quantite-base').value) || 0;
                const piecesInput = document.getElementById('recette-enrobage-pieces');
                
                if (uniteBase === 'nombre' && quantiteBase > 0 && !piecesInput.value) {
                    // Pr√©-remplir avec la quantit√© de base
                    piecesInput.value = quantiteBase;
                }
            }
        }
        
        function updateEnrobageDisplay() {
            const chocolatSelect = document.getElementById('recette-enrobage-chocolat');
            const selectedOption = chocolatSelect.options[chocolatSelect.selectedIndex];
            const chocolatMpId = chocolatSelect.value;
            const grammage = parseFloat(document.getElementById('recette-enrobage-grammage').value) || 0;
            const nombrePieces = parseFloat(document.getElementById('recette-enrobage-pieces').value) || 0;
            const quantiteBase = parseFloat(document.getElementById('config-recette-quantite-base').value) || 0;
            const uniteBase = document.getElementById('config-recette-unite-base').value;
            
            const totalDiv = document.getElementById('recette-enrobage-total');
            
            if (!chocolatMpId) {
                totalDiv.textContent = '-';
                return;
            }
            
            // R√©cup√©rer le co√ªt du chocolat
            let coutKg = 0;
            const mpEnrobage = matieresPremi√®res.find(mp => mp.id == chocolatMpId);
            if (mpEnrobage) {
                coutKg = mpEnrobage.cout || 0;
            }
            
            if (grammage > 0 && nombrePieces > 0) {
                // Calcul avec le nombre de pi√®ces sp√©cifi√©
                const totalEnrobage = grammage * nombrePieces;
                const quantiteKg = totalEnrobage / 1000;
                const coutTotal = quantiteKg * coutKg;
                
                let baseInfo = '';
                if (uniteBase === 'nombre') {
                    baseInfo = `${nombrePieces} pi√®ces`;
                } else {
                    baseInfo = `${quantiteBase} kg ‚Üí ${nombrePieces} pi√®ces`;
                }
                
                totalDiv.innerHTML = `<strong>${totalEnrobage.toFixed(0)}g</strong> (${quantiteKg.toFixed(3)} kg) pour ${baseInfo}<br><span style="color: #2e7d32; font-weight: bold;">üí∞ ${coutTotal.toFixed(2)} ‚Ç¨</span> <span style="font-size: 11px; color: #888;">(${coutKg.toFixed(2)} ‚Ç¨/kg)</span>`;
            } else if (grammage > 0) {
                totalDiv.innerHTML = `<strong>${grammage}g</strong> par pi√®ce <span style="font-size: 11px; color: #888;">(${coutKg.toFixed(2)} ‚Ç¨/kg)</span>`;
            } else {
                totalDiv.textContent = 'Indiquez le grammage';
            }
        }
        
        // Fonction pour remplir le select des chocolats d'enrobage depuis les MP
        function updateEnrobageChocolatSelect() {
            const select = document.getElementById('recette-enrobage-chocolat');
            if (!select) return;
            
            // Garder la valeur actuelle pour la restaurer si possible
            const currentValue = select.value;
            
            // Vider et remettre l'option par d√©faut
            select.innerHTML = '<option value="">Pas d\'enrobage</option>';
            
            // Filtrer les MP qui sont des chocolats (plusieurs m√©thodes de d√©tection)
            const chocolatsMP = matieresPremi√®res.filter(mp => {
                if (!mp || mp.actif === false || mp.archived) return false;
                
                // V√©rifier qu'il y a du stock
                const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                if (quantiteActuelle <= 0) return false;
                
                // M√©thode 1: cat√©gorie cacao
                const isCacao = mp.categorie === 'cacao';
                
                // M√©thode 2: nom contient "chocolat"
                const nomLower = (mp.nom || '').toLowerCase();
                const isChocolatNom = nomLower.includes('chocolat');
                
                // M√©thode 3: nom contient "couverture" (chocolat de couverture)
                const isCouverture = nomLower.includes('couverture');
                
                // M√©thode 4: nom contient "cacao" ou "cocoa"
                const isCacaoNom = nomLower.includes('cacao') || nomLower.includes('cocoa');
                
                // M√©thode 5: cat√©gorie contient "choco" ou "cacao"
                const categorieLower = (mp.categorie || '').toLowerCase();
                const isChocolatCategorie = categorieLower.includes('choco') || categorieLower.includes('cacao');
                
                return isCacao || isChocolatNom || isCouverture || isCacaoNom || isChocolatCategorie;
            });
            
            // Trier par nom puis par date de r√©ception (FIFO)
            chocolatsMP.sort((a, b) => {
                const nomCompare = (a.nom || '').localeCompare(b.nom || '');
                if (nomCompare !== 0) return nomCompare;
                // Si m√™me nom, trier par date de r√©ception (plus ancien en premier)
                const dateA = new Date(a.date_reception || a.dateReception || '2000-01-01');
                const dateB = new Date(b.date_reception || b.dateReception || '2000-01-01');
                return dateA - dateB;
            });
            
            // Ajouter les options avec lot et stock
            chocolatsMP.forEach(mp => {
                const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const stockKg = quantiteActuelle.toFixed(2);
                const lot = mp.lot || 'N/A';
                
                const option = document.createElement('option');
                option.value = mp.id; // On stocke l'ID pour pouvoir retrouver la MP
                option.textContent = `üç´ ${mp.nom} - Lot: ${lot} (${stockKg} kg)`;
                option.dataset.mpNom = mp.nom;
                option.dataset.mpId = mp.id;
                option.dataset.mpLot = lot;
                select.appendChild(option);
            });
            
            // Si aucun chocolat trouv√©, afficher un message
            if (chocolatsMP.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "‚ö†Ô∏è Aucun chocolat en stock";
                option.disabled = true;
                select.appendChild(option);
            }
            
            // Restaurer la valeur si elle existe toujours
            if (currentValue) {
                // Chercher par ID ou par nom
                const options = Array.from(select.options);
                const matchById = options.find(opt => opt.value === currentValue);
                const matchByName = options.find(opt => opt.dataset.mpNom === currentValue);
                if (matchById) {
                    select.value = currentValue;
                } else if (matchByName) {
                    select.value = matchByName.value;
                }
            }
        }
        
        // Ajouter un listener pour le champ grammage
        document.addEventListener('DOMContentLoaded', function() {
            const grammageInput = document.getElementById('recette-enrobage-grammage');
            if (grammageInput) {
                grammageInput.addEventListener('input', updateEnrobageDisplay);
            }
            // Note: updateEnrobageChocolatSelect() est appel√© apr√®s le chargement Supabase
        });
        
        function displayRecipesConfig() {
            const tbody = document.querySelector('#recipes-table tbody');
            if (!tbody) return;
            
            if (recipesConfig.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">Aucune recette configur√©e</td></tr>';
                return;
            }
            
            // Trier les recettes par ordre alphab√©tique du nom de produit
            const sortedRecipes = [...recipesConfig].sort((a, b) => {
                const nameA = (a.productName || '').toLowerCase();
                const nameB = (b.productName || '').toLowerCase();
                return nameA.localeCompare(nameB, 'fr');
            });
            
            tbody.innerHTML = sortedRecipes.map(recipe => {
                const totalQuantityKgIngredients = recipe.ingredients.filter(ing => ing.unite === 'kg').reduce((sum, ing) => sum + ing.quantity, 0);
                const totalQuantityNombre = recipe.ingredients.filter(ing => ing.unite === 'nombre').reduce((sum, ing) => sum + ing.quantity, 0);
                
                // Calculer le co√ªt des ingr√©dients
                const coutIngredients = recipe.ingredients.reduce((sum, ing) => sum + (ing.coutTotal || 0), 0);
                
                // Calculer le co√ªt et poids de l'enrobage si pr√©sent
                let coutEnrobage = 0;
                let poidsEnrobageKg = 0;
                if (recipe.enrobage && recipe.enrobage.grammage > 0 && recipe.quantiteBase > 0) {
                    // Nombre de pi√®ces : stock√© dans la recette, ou d√©duit de quantiteBase
                    let nombrePieces = recipe.enrobage.nombrePieces || recipe.quantiteBase;
                    if (recipe.uniteBase === 'nombre') {
                        nombrePieces = recipe.quantiteBase;
                    }
                    poidsEnrobageKg = (recipe.enrobage.grammage * nombrePieces) / 1000;
                    
                    // Chercher le co√ªt du chocolat d'enrobage
                    const chocolatName = recipe.enrobage.chocolat?.toLowerCase() || '';
                    const mpEnrobage = matieresPremi√®res.find(mp => {
                        if (recipe.enrobage.mpId && mp.id == recipe.enrobage.mpId) return true;
                        const mpNom = (mp.nom || '').toLowerCase();
                        return mpNom.includes(chocolatName) || chocolatName.includes(mpNom);
                    });
                    
                    if (mpEnrobage) {
                        const enrobageCoutKg = mpEnrobage.cout || 0;
                        coutEnrobage = poidsEnrobageKg * enrobageCoutKg;
                    }
                }
                
                // Co√ªt total = ingr√©dients + enrobage
                const coutTotalCalcule = coutIngredients + coutEnrobage;
                const coutTotal = coutTotalCalcule > 0 ? coutTotalCalcule : (recipe.coutTotal || 0);
                
                // Poids total = ingr√©dients + enrobage
                const totalQuantityKg = totalQuantityKgIngredients + poidsEnrobageKg;
                const coutUnitaire = totalQuantityKg > 0 ? coutTotal / totalQuantityKg : 0;
                
                let totalText = '';
                if (totalQuantityKg > 0 && totalQuantityNombre > 0) {
                    totalText = `${totalQuantityKg.toFixed(3)} kg + ${totalQuantityNombre} unit√©(s)`;
                } else if (totalQuantityKg > 0) {
                    totalText = `${totalQuantityKg.toFixed(3)} kg`;
                } else if (totalQuantityNombre > 0) {
                    totalText = `${totalQuantityNombre} unit√©(s)`;
                }
                
                // Ajouter le d√©tail si enrobage pr√©sent
                if (poidsEnrobageKg > 0) {
                    const poidsIngG = Math.round(totalQuantityKgIngredients * 1000);
                    const poidsEnrG = Math.round(poidsEnrobageKg * 1000);
                    totalText += ` <span style="font-size: 11px; color: #666;">(${poidsIngG}g + ${poidsEnrG}g enr.)</span>`;
                }
                
                const uniteBaseLabel = recipe.uniteBase === 'kg' ? 'kg' : recipe.uniteBase === 'g' ? 'g' : recipe.uniteBase === 'nombre' ? 'u' : 'kg';
                const quantiteBaseDisplay = recipe.uniteBase === 'nombre' ? Math.round(recipe.quantiteBase) : recipe.uniteBase === 'g' ? recipe.quantiteBase.toFixed(0) : recipe.quantiteBase.toFixed(2);
                
                return `
                    <tr>
                        <td>
                            <strong>${recipe.productName}</strong>
                            <div style="margin-top: 5px; padding: 5px 10px; background: #e8f5e9; border-radius: 6px; display: inline-block;">
                                <span style="color: #2e7d32; font-weight: bold;">üí∞ ${coutTotal.toFixed(2)} ‚Ç¨</span>
                                <span style="color: #666; font-size: 11px; margin-left: 5px;">(${coutUnitaire.toFixed(2)} ‚Ç¨/kg)</span>
                                ${coutEnrobage > 0 ? `<br><span style="font-size: 10px; color: #888;">ing: ${coutIngredients.toFixed(2)}‚Ç¨ + enr: ${coutEnrobage.toFixed(2)}‚Ç¨</span>` : ''}
                            </div>
                        </td>
                        <td>${quantiteBaseDisplay} ${uniteBaseLabel}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                ${recipe.ingredients.map(ing => {
                                    const uniteLabel = ing.unite === 'kg' ? 'kg' : ing.unite === 'nombre' ? 'u' : ing.unite;
                                    const quantityDisplay = ing.unite === 'kg' ? ing.quantity.toFixed(3) : Math.round(ing.quantity);
                                    const coutIng = (ing.coutTotal || 0).toFixed(2);
                                    
                                    return `
                                        <div class="ingredient-badge" style="display: flex; flex-direction: column; padding: 6px 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; text-align: left;">
                                            <div style="font-weight: bold; color: #000; margin-bottom: 4px;">
                                                ${quantityDisplay}${uniteLabel} de ${ing.mpNom}
                                                <span style="color: #2e7d32; font-size: 11px; margin-left: 5px;">(${coutIng} ‚Ç¨)</span>
                                            </div>
                                            <div style="font-size: 10px; color: #999; font-weight: normal; font-style: italic;">
                                                ${ing.categorieEmoji} ${ing.categorieNom}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${recipe.enrobage ? `
                                <div style="margin-top: 8px; padding: 8px 12px; background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%); border-radius: 8px; border: 1px solid #d4a853;">
                                    <span style="font-weight: bold; color: #5c3a21;">üç´ Enrobage: ${recipe.enrobage.chocolat}</span>
                                    <span style="color: #8B4513; margin-left: 8px;">${recipe.enrobage.grammage}g/pi√®ce</span>
                                    ${coutEnrobage > 0 ? `<span style="color: #2e7d32; margin-left: 8px; font-size: 12px;">(${coutEnrobage.toFixed(2)} ‚Ç¨)</span>` : ''}
                                </div>
                            ` : ''}
                            <div style="margin-top: 8px; font-weight: bold; color: #9C27B0;">
                                Total: ${totalText}
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-small" onclick="viewRecipeDetail('${escJS(recipe.productId)}')">üëÅÔ∏è Voir</button>
                            <button class="btn btn-small" onclick="editRecipeFromProduct('${escJS(recipe.productId)}')">‚úèÔ∏è Modifier</button>
                            <button class="btn btn-small btn-danger" onclick="deleteRecipe('${escJS(recipe.productId)}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function deleteRecipe(productId) {
            const recipe = recipesConfig.find(r => r.productId === productId);
            if (!recipe) return;
            
            showConfirmModal(
                'Supprimer cette recette',
                `√ätes-vous s√ªr de vouloir supprimer la recette pour "${recipe.productName}" ?`,
                async () => {
                    const index = recipesConfig.findIndex(r => r.productId === productId);
                    if (index >= 0) {
                        recipesConfig.splice(index, 1);
                        
                        // Sauvegarder dans Supabase
                        await saveRecipesConfig();
                        
                        showAlert(`Recette "${recipe.productName}" supprim√©e avec succ√®s !`, 'success');
                        displayProductsConfig();
                        displayRecipesConfig();
                    }
                }
            );
        }
        
        async function saveRecipesConfig() {
            if (!isOnline || !supabaseClient) {
                console.log('Mode hors-ligne - Sauvegarde locale uniquement');
                saveToLocalStorage();
                return { success: true, offline: true };
            }
            
            try {
                const { data: existingConfig, error: searchError } = await supabaseClient
                    .from('configuration')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('type', 'recipes')
                    .single();
                
                const configData = {
                    type: 'recipes',
                    user_id: currentUser ? currentUser.id : null,
                    data: recipesConfig
                };
                
                let result;
                if (existingConfig) {
                    result = await supabaseClient
                        .from('configuration')
                        .update(configData)
                        .eq('user_id', currentUser.id)
                        .eq('type', 'recipes')
                        .select();
                } else {
                    result = await supabaseClient
                        .from('configuration')
                        .insert(configData)
                        .select();
                }
                
                if (result.error) {
                    throw result.error;
                }
                
                console.log('‚úÖ Recettes sauvegard√©es dans Supabase');
                saveToLocalStorage();
                return { success: true };
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde recettes Supabase:', error);
                saveToLocalStorage();
                return { success: false, error };
            }
        }

        // Configuration des produits
        // Param√®tres g√©n√©raux
        async function saveGeneralSettings() {
            const entreprise = document.getElementById('config-entreprise').value.trim();
            const stockAlerte = parseFloat(document.getElementById('config-stock-alerte').value) || 20;
            
            if (!entreprise) {
                showAlert('Veuillez remplir le nom de l\'entreprise', 'warning');
                return;
            }
            
            generalSettings.entreprise = entreprise;
            generalSettings.stockAlerte = stockAlerte;
            
            // Sauvegarder dans Supabase
            await saveGeneralSettingsConfig();
            
            showAlert(`‚úÖ Param√®tres enregistr√©s !
            
üè¢ Entreprise : ${entreprise}
‚ö†Ô∏è Seuil d'alerte : ${stockAlerte} kg
üì¶ Format lots : ANN√âE-XXX (Ex: 2025-203, 2025-204...)`, 'success');
            
            // R√©g√©n√©rer le num√©ro de lot
            generateLotNumber();
        }
        
        // ============================================
        // IMPORT/EXPORT PRODUITS
        // ============================================
        
        function showImportProductsModal() {
            const modalHTML = `
                <div style="max-width: 700px;">
                    <h2 style="margin-bottom: 20px;">üì• Importer des Produits</h2>
                    
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #2196F3;">
                        <strong style="font-size: 16px; color: #1976d2;">üìã Format requis (CSV ou Excel) :</strong>
                        <div style="margin-top: 12px; color: #1565c0; line-height: 1.8; font-size: 14px;">
                            <strong>Colonnes n√©cessaires :</strong><br>
                            ‚Ä¢ <code>code</code> - Code unique du produit (ex: tablette-noir-70)<br>
                            ‚Ä¢ <code>nom</code> - Nom du produit (ex: Tablette Noir 70%)<br>
                            ‚Ä¢ <code>dlc</code> - Dur√©e de conservation en jours (ex: 730)<br>
                            ‚Ä¢ <code>categorie</code> - tablette, truffe, bonbon, praline, confiserie, autre<br>
                            ‚Ä¢ <code>prix</code> - Prix de vente ‚Ç¨/kg (optionnel)<br>
                            ‚Ä¢ <code>description</code> - Description (optionnel)<br>
                            ‚Ä¢ <code>actif</code> - true/false (optionnel, par d√©faut true)
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <strong>üí° Exemple de CSV :</strong>
                        <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 8px; font-size: 12px; overflow-x: auto;">code;nom;dlc;categorie;prix;description;actif
tablette-noir-70;Tablette Noir 70%;730;tablette;42.00;Chocolat noir 70% cacao;true
tablette-lait-40;Tablette Lait 40%;548;tablette;38.00;Chocolat au lait;true
truffes-nature;Truffes Nature;28;truffe;85.00;Truffes au chocolat;true</pre>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn" onclick="document.getElementById('products-import').click(); closeConfirmModal();">
                            üìÇ S√©lectionner Fichier
                        </button>
                        <button class="btn btn-secondary" onclick="downloadProductsTemplate()">
                            üìÑ T√©l√©charger Mod√®le CSV
                        </button>
                        <button class="btn btn-secondary" onclick="closeConfirmModal()">‚ùå Annuler</button>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = '';
            document.getElementById('confirm-message').innerHTML = modalHTML;
            document.getElementById('confirm-yes').style.display = 'none';
            document.getElementById('confirm-no').style.display = 'none';
            modal.style.display = 'block';
        }
        
        function downloadProductsTemplate() {
            const template = `code;nom;dlc;categorie;prix;description;actif
tablette-noir-70;Tablette Noir 70%;730;tablette;42.00;Chocolat noir 70% cacao;true
tablette-lait-40;Tablette Lait 40%;548;tablette;38.00;Chocolat au lait;true
truffes-nature;Truffes Nature;28;truffe;85.00;Truffes au chocolat;true`;
            
            const blob = new Blob(['\uFEFF' + template], { type: 'text/csv;charset=utf-8;' });
            downloadFile(blob, 'modele_produits.csv');
            showAlert('‚úÖ Mod√®le CSV t√©l√©charg√© !', 'success');
        }
        
        async function handleProductsImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        showAlert('‚ùå Fichier vide ou invalide', 'danger');
                        return;
                    }
                    
                    // D√©tecter le s√©parateur (; ou ,)
                    const separator = lines[0].includes(';') ? ';' : ',';
                    const headers = lines[0].split(separator).map(h => h.trim().toLowerCase());
                    
                    // V√©rifier les colonnes requises
                    const requiredColumns = ['code', 'nom', 'dlc', 'categorie'];
                    const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                    
                    if (missingColumns.length > 0) {
                        showAlert(`‚ùå Colonnes manquantes: ${missingColumns.join(', ')}`, 'danger');
                        return;
                    }
                    
                    let importedCount = 0;
                    let updatedCount = 0;
                    let errorCount = 0;
                    const errors = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = line.split(separator).map(v => v.trim());
                        const row = {};
                        
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        try {
                            const productId = row.code;
                            const existingIndex = productsConfig.findIndex(p => p.id === productId);
                            
                            const product = {
                                id: productId,
                                nom: row.nom,
                                dlc: parseInt(row.dlc),
                                categorie: row.categorie,
                                prix: row.prix ? parseFloat(row.prix) : 0,
                                description: row.description || '',
                                actif: row.actif ? row.actif.toLowerCase() === 'true' : true
                            };
                            
                            if (existingIndex >= 0) {
                                productsConfig[existingIndex] = product;
                                updatedCount++;
                            } else {
                                productsConfig.push(product);
                                importedCount++;
                            }
                        } catch (err) {
                            errorCount++;
                            errors.push(`Ligne ${i + 1}: ${err.message}`);
                        }
                    }
                    
                    // Sauvegarder dans Supabase
                    await saveProductsConfig();
                    
                    displayProductsConfig();
                    updateProductSelects();
                    updateRecipeProductSelects(); // Mise √† jour apr√®s import
                    
                    let message = `‚úÖ Import termin√© !\n\n`;
                    message += `üì• ${importedCount} nouveau(x) produit(s)\n`;
                    message += `üîÑ ${updatedCount} produit(s) mis √† jour\n`;
                    if (errorCount > 0) {
                        message += `‚ö†Ô∏è ${errorCount} erreur(s)\n\n${errors.slice(0, 5).join('\n')}`;
                    }
                    
                    showAlert(message, errorCount > 0 ? 'warning' : 'success');
                    
                } catch (error) {
                    showAlert('‚ùå Erreur lors de la lecture du fichier: ' + error.message, 'danger');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }
        
        function exportProductsCSV() {
            if (productsConfig.length === 0) {
                showAlert('Aucun produit √† exporter', 'warning');
                return;
            }
            
            const headers = ['code', 'nom', 'dlc', 'categorie', 'prix', 'description', 'actif'];
            let csv = headers.join(';') + '\n';
            
            productsConfig.forEach(product => {
                const row = [
                    product.id,
                    product.nom,
                    product.dlc,
                    product.categorie,
                    product.prix ? product.prix.toFixed(2) : '0',
                    product.description || '',
                    product.actif
                ];
                csv += row.join(';') + '\n';
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const timestamp = new Date().toISOString().split('T')[0];
            downloadFile(blob, `produits_${timestamp}.csv`);
            
            showAlert(`‚úÖ ${productsConfig.length} produit(s) export√©(s) !`, 'success');
        }
        
        // ============================================
        // IMPORT/EXPORT MATI√àRES PREMI√àRES
        // ============================================
        
        function showImportMPModal() {
            const modalHTML = `
                <div style="max-width: 700px;">
                    <h2 style="margin-bottom: 20px;">üì• Importer des Mati√®res Premi√®res</h2>
                    
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #2196F3;">
                        <strong style="font-size: 16px; color: #1976d2;">üìã Format requis (CSV ou Excel) :</strong>
                        <div style="margin-top: 12px; color: #1565c0; line-height: 1.8; font-size: 14px;">
                            <strong>Colonnes n√©cessaires :</strong><br>
                            ‚Ä¢ <code>nom</code> - Nom de la mati√®re premi√®re<br>
                            ‚Ä¢ <code>categorie</code> - cacao, sucre, laitier, fruits-secs, epices, matieres-grasses, additifs, autre<br>
                            ‚Ä¢ <code>lot</code> - Num√©ro de lot fournisseur<br>
                            ‚Ä¢ <code>fournisseur</code> - Nom du fournisseur<br>
                            ‚Ä¢ <code>quantite</code> - Quantit√© en kg<br>
                            ‚Ä¢ <code>date_reception</code> - Date format YYYY-MM-DD (optionnel)<br>
                            ‚Ä¢ <code>dlc</code> - Date limite format YYYY-MM-DD (optionnel)<br>
                            ‚Ä¢ <code>cout</code> - Co√ªt ‚Ç¨/kg (optionnel)<br>
                            ‚Ä¢ <code>stock_mini</code> - Stock minimum en kg (optionnel)
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <strong>üí° Exemple de CSV :</strong>
                        <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 8px; font-size: 12px; overflow-x: auto;">nom;categorie;lot;fournisseur;quantite;date_reception;dlc;cout;stock_mini
Cacao Venezuela;cacao;VEN-2025-01;Cacao Plus;25.5;2025-01-15;2027-01-15;12.50;10.0
Sucre Bio;sucre;SUC-2025-02;Bio Import;50.0;2025-01-16;;8.20;20.0
Beurre de Cacao;matieres-grasses;BDC-2025-01;Lipides SA;15.0;2025-01-14;2026-01-14;18.50;5.0</pre>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn" onclick="document.getElementById('mp-import').click(); closeConfirmModal();">
                            üìÇ S√©lectionner Fichier
                        </button>
                        <button class="btn btn-secondary" onclick="downloadMPTemplate()">
                            üìÑ T√©l√©charger Mod√®le CSV
                        </button>
                        <button class="btn btn-secondary" onclick="closeConfirmModal()">‚ùå Annuler</button>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = '';
            document.getElementById('confirm-message').innerHTML = modalHTML;
            document.getElementById('confirm-yes').style.display = 'none';
            document.getElementById('confirm-no').style.display = 'none';
            modal.style.display = 'block';
        }
        
        function downloadMPTemplate() {
            const template = `nom;categorie;lot;fournisseur;quantite;date_reception;dlc;cout;stock_mini
Cacao Venezuela;cacao;VEN-2025-01;Cacao Plus;25.5;2025-01-15;2027-01-15;12.50;10.0
Sucre Bio;sucre;SUC-2025-02;Bio Import;50.0;2025-01-16;;8.20;20.0
Beurre de Cacao;matieres-grasses;BDC-2025-01;Lipides SA;15.0;2025-01-14;2026-01-14;18.50;5.0`;
            
            const blob = new Blob(['\uFEFF' + template], { type: 'text/csv;charset=utf-8;' });
            downloadFile(blob, 'modele_matieres_premieres.csv');
            showAlert('‚úÖ Mod√®le CSV t√©l√©charg√© !', 'success');
        }
        
        async function handleMPImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        showAlert('‚ùå Fichier vide ou invalide', 'danger');
                        return;
                    }
                    
                    // D√©tecter le s√©parateur
                    const separator = lines[0].includes(';') ? ';' : ',';
                    const headers = lines[0].split(separator).map(h => h.trim().toLowerCase());
                    
                    // V√©rifier les colonnes requises
                    const requiredColumns = ['nom', 'categorie', 'lot', 'fournisseur', 'quantite'];
                    const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                    
                    if (missingColumns.length > 0) {
                        showAlert(`‚ùå Colonnes manquantes: ${missingColumns.join(', ')}`, 'danger');
                        return;
                    }
                    
                    let importedCount = 0;
                    let errorCount = 0;
                    const errors = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = line.split(separator).map(v => v.trim());
                        const row = {};
                        
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        try {
                            const quantite = parseFloat(row.quantite);
                            if (!quantite || quantite <= 0) {
                                throw new Error('Quantit√© invalide');
                            }
                            
                            const newMP = {
                                nom: row.nom,
                                categorie: row.categorie,
                                lot: row.lot,
                                fournisseur: row.fournisseur,
                                quantite_initiale: quantite,
                                quantite_actuelle: quantite,
                                date_reception: row.date_reception || new Date().toISOString().split('T')[0],
                                dlc: row.dlc || null,
                                cout: row.cout ? parseFloat(row.cout) : 0,
                                stock_mini: row.stock_mini ? parseFloat(row.stock_mini) : 0,
                                archived: false,
                                archived_at: null,
                                archived_reason: null
                            };
                            
                            // Sauvegarder dans Supabase
                            const result = await saveToSupabase('matieres_premieres', newMP, false);
                            
                            if (result.success && result.data) {
                                newMP.id = result.data[0].id;
                                newMP.created_at = result.data[0].created_at;
                            } else {
                                newMP.id = Date.now() + i;
                                newMP.created_at = new Date().toISOString();
                            }
                            
                            matieresPremi√®res.push(newMP);
                            importedCount++;
                            
                        } catch (err) {
                            errorCount++;
                            errors.push(`Ligne ${i + 1}: ${err.message}`);
                        }
                    }
                    
                    refreshAllMPLists();
                    displayMatieresPremi√®res();
                    checkStockAlerts();
                    updateMPFilters();
                    updateIngredientsSelect();
                    
                    let message = `‚úÖ Import termin√© !\n\n`;
                    message += `üì• ${importedCount} mati√®re(s) premi√®re(s) import√©e(s)\n`;
                    if (errorCount > 0) {
                        message += `‚ö†Ô∏è ${errorCount} erreur(s)\n\n${errors.slice(0, 5).join('\n')}`;
                    }
                    
                    showAlert(message, errorCount > 0 ? 'warning' : 'success');
                    
                } catch (error) {
                    showAlert('‚ùå Erreur lors de la lecture du fichier: ' + error.message, 'danger');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }
        
        // Distance de Levenshtein pour d√©tecter les noms proches
        function levenshtein(a, b) {
            const m = a.length, n = b.length;
            const d = Array.from({length: m + 1}, (_, i) => [i]);
            for (let j = 1; j <= n; j++) d[0][j] = j;
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    d[i][j] = Math.min(
                        d[i-1][j] + 1,
                        d[i][j-1] + 1,
                        d[i-1][j-1] + (a[i-1] !== b[j-1] ? 1 : 0)
                    );
                }
            }
            return d[m][n];
        }
        
        function detectDuplicateMP() {
            const activeMPs = matieresPremi√®res.filter(mp => !mp.archived);
            const duplicates = [];
            
            // Normaliser les noms
            const normalize = (s) => (s || '').toLowerCase().trim()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            // Comparer chaque paire
            for (let i = 0; i < activeMPs.length; i++) {
                for (let j = i + 1; j < activeMPs.length; j++) {
                    const normA = normalize(activeMPs[i].nom);
                    const normB = normalize(activeMPs[j].nom);
                    
                    // Exact match apr√®s normalisation
                    if (normA === normB) {
                        duplicates.push({
                            mp1: activeMPs[i],
                            mp2: activeMPs[j],
                            type: 'exact',
                            distance: 0
                        });
                        continue;
                    }
                    
                    // Levenshtein ‚â§ 2 pour les noms courts, ‚â§ 3 pour les longs
                    const maxDist = Math.max(normA.length, normB.length) > 10 ? 3 : 2;
                    const dist = levenshtein(normA, normB);
                    if (dist <= maxDist && dist > 0) {
                        duplicates.push({
                            mp1: activeMPs[i],
                            mp2: activeMPs[j],
                            type: 'proche',
                            distance: dist
                        });
                    }
                }
            }
            
            if (duplicates.length === 0) {
                showAlert('‚úÖ Aucun doublon d√©tect√© dans les mati√®res premi√®res !', 'success');
                return;
            }
            
            // Afficher les r√©sultats dans un modal
            let html = `
                <div style="max-width: 900px;">
                    <h2 style="color: #9C27B0; margin-bottom: 15px;">üîç Doublons d√©tect√©s (${duplicates.length})</h2>
                    <p style="color: #666; margin-bottom: 20px;">Les mati√®res premi√®res suivantes ont des noms similaires. Vous pouvez renommer l'une d'elles pour fusionner les stocks.</p>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
            `;
            
            duplicates.forEach((dup, idx) => {
                const stock1 = ((dup.mp1.quantite_actuelle || dup.mp1.quantiteActuelle || 0) * 1000).toFixed(0);
                const stock2 = ((dup.mp2.quantite_actuelle || dup.mp2.quantiteActuelle || 0) * 1000).toFixed(0);
                const isExact = dup.type === 'exact';
                
                html += `
                    <div style="background: white; border-radius: 10px; border: 2px solid ${isExact ? '#f44336' : '#ff9800'}; padding: 15px; border-left: 5px solid ${isExact ? '#f44336' : '#ff9800'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 12px; font-weight: 600; color: ${isExact ? '#f44336' : '#ff9800'}; background: ${isExact ? '#ffebee' : '#fff3e0'}; padding: 2px 10px; border-radius: 12px;">
                                ${isExact ? 'üî¥ Doublon exact (accent)' : 'üü† Nom proche (distance: ' + dup.distance + ')'}
                            </span>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                                <div style="font-weight: 700; color: #333;">${dup.mp1.nom}</div>
                                <div style="font-size: 12px; color: #666;">Lot: ${dup.mp1.lot || '-'} ¬∑ Stock: ${stock1}g ¬∑ ${dup.mp1.fournisseur || '-'}</div>
                            </div>
                            <span style="font-size: 20px; color: #999;">‚ü∑</span>
                            <div style="flex: 1; min-width: 200px; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                                <div style="font-weight: 700; color: #333;">${dup.mp2.nom}</div>
                                <div style="font-size: 12px; color: #666;">Lot: ${dup.mp2.lot || '-'} ¬∑ Stock: ${stock2}g ¬∑ ${dup.mp2.fournisseur || '-'}</div>
                            </div>
                            <button class="btn btn-small" onclick="renameMPDuplicate(${dup.mp2.id}, '${escJS(dup.mp1.nom)}')" 
                                    style="background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); font-size: 11px; padding: 6px 12px; white-space: nowrap;">
                                ‚úèÔ∏è Renommer ‚Üí "${dup.mp1.nom}"
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeConfirmModal()">Fermer</button>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('confirm-modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.maxWidth = '95%';
            modalContent.style.maxHeight = '95vh';
            modalContent.style.overflow = 'auto';
            document.getElementById('confirm-title').textContent = '';
            document.getElementById('confirm-message').innerHTML = html;
            document.getElementById('confirm-yes').style.display = 'none';
            document.getElementById('confirm-no').style.display = 'none';
            modal.style.display = 'block';
        }
        
        async function renameMPDuplicate(mpId, newName) {
            const mp = matieresPremi√®res.find(m => m.id === mpId);
            if (!mp) return;
            
            const oldName = mp.nom;
            mp.nom = newName;
            await saveToSupabase('matieres_premieres', mp, true);
            
            showAlert(`‚úÖ "${oldName}" renomm√© en "${newName}"`, 'success');
            
            // Refresh displays
            displayMatieresPremi√®res();
            updateIngredientsSelect();
            updateRecipeIngredientSelect();
            
            // Re-run detection
            detectDuplicateMP();
        }
        
        function exportMPCSV() {
            const activeMPs = matieresPremi√®res.filter(mp => !mp.archived);
            
            if (activeMPs.length === 0) {
                showAlert('Aucune mati√®re premi√®re √† exporter', 'warning');
                return;
            }
            
            const headers = ['nom', 'categorie', 'lot', 'fournisseur', 'quantite', 'date_reception', 'dlc', 'cout', 'stock_mini'];
            let csv = headers.join(';') + '\n';
            
            activeMPs.forEach(mp => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const row = [
                    mp.nom,
                    mp.categorie,
                    mp.lot,
                    mp.fournisseur,
                    qty.toFixed(3),
                    mp.date_reception || mp.dateReception || '',
                    mp.dlc || '',
                    (mp.cout || 0).toFixed(2),
                    (mp.stock_mini || mp.stockMini || 0).toFixed(3)
                ];
                csv += row.join(';') + '\n';
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const timestamp = new Date().toISOString().split('T')[0];
            downloadFile(blob, `matieres_premieres_${timestamp}.csv`);
            
            showAlert(`‚úÖ ${activeMPs.length} mati√®re(s) premi√®re(s) export√©e(s) !`, 'success');
        }
        
        function loadGeneralSettings() {
            document.getElementById('config-entreprise').value = generalSettings.entreprise || 'Emotions Chocolats - Couthuin, Belgium';
            document.getElementById('config-stock-alerte').value = generalSettings.stockAlerte || 20;
        }

        // Sauvegarder les param√®tres g√©n√©raux dans Supabase
        async function saveGeneralSettingsConfig() {
            if (!isOnline || !supabaseClient) {
                console.log('Mode hors-ligne - Sauvegarde locale uniquement');
                saveToLocalStorage();
                return { success: true, offline: true };
            }
            
            try {
                // Chercher si une configuration de param√®tres existe d√©j√†
                const { data: existingConfig, error: searchError } = await supabaseClient
                    .from('configuration')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('type', 'settings')
                    .single();
                
                const configData = {
                    type: 'settings',
                    user_id: currentUser ? currentUser.id : null,
                    data: generalSettings
                };
                
                let result;
                if (existingConfig) {
                    // Mise √† jour
                    result = await supabaseClient
                        .from('configuration')
                        .update(configData)
                        .eq('user_id', currentUser.id)
                        .eq('type', 'settings')
                        .select();
                } else {
                    // Insertion
                    result = await supabaseClient
                        .from('configuration')
                        .insert(configData)
                        .select();
                }
                
                if (result.error) {
                    throw result.error;
                }
                
                console.log('‚úÖ Param√®tres g√©n√©raux sauvegard√©s dans Supabase');
                saveToLocalStorage();
                return { success: true };
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde param√®tres Supabase:', error);
                saveToLocalStorage();
                return { success: false, error };
            }
        }

        // Configuration des produits
        async function saveProduct() {
            const productId = document.getElementById('config-produit-id').value.trim();
            const productName = document.getElementById('config-produit-nom').value.trim();
            const productDlc = parseInt(document.getElementById('config-produit-dlc').value);
            const productCategory = document.getElementById('config-produit-categorie').value;
            const productPrice = document.getElementById('config-produit-prix').value ? parseFloat(document.getElementById('config-produit-prix').value) : 0;
            const productActive = document.getElementById('config-produit-actif').value === 'true';
            const productDescription = document.getElementById('config-produit-description').value.trim();
            const productPoids = document.getElementById('config-produit-poids').value.trim();
            const productIngredients = document.getElementById('config-produit-ingredients').value.trim();
            const productAllergenes = document.getElementById('config-produit-allergenes').value.trim();
            
            if (!productId || !productName || !productDlc) {
                showAlert('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }
            
            const existingIndex = productsConfig.findIndex(p => p.id === productId);
            
            const product = {
                id: productId,
                nom: productName,
                dlc: productDlc,
                categorie: productCategory,
                prix: productPrice,
                actif: productActive,
                description: productDescription,
                poids: productPoids,
                ingredients: productIngredients,
                allergenes: productAllergenes
            };
            
            if (existingIndex >= 0) {
                productsConfig[existingIndex] = product;
                showAlert(`Produit "${productName}" mis √† jour avec succ√®s !`, 'success');
            } else {
                productsConfig.push(product);
                showAlert(`Produit "${productName}" ajout√© avec succ√®s !`, 'success');
            }
            
            // Sauvegarder dans Supabase
            await saveProductsConfig();
            
            displayProductsConfig();
            resetProductForm();
            
            // IMPORTANT : Mettre √† jour tous les s√©lecteurs de produits
            updateProductSelects();
            updateRecipeProductSelects(); // Mise √† jour du s√©lecteur de recettes
            
            console.log('‚úÖ Produit sauvegard√© et tous les s√©lecteurs mis √† jour');
        }

        function displayProductsConfig() {
            const tbody = document.querySelector('#products-table tbody');
            const countElement = document.getElementById('products-count');
            const sortSelect = document.getElementById('products-sort');
            
            if (!tbody) return;
            
            if (countElement) {
                countElement.textContent = productsConfig.length;
            }
            
            if (productsConfig.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Aucun produit configur√©</td></tr>';
                return;
            }
            
            // Appliquer le tri
            const sortValue = sortSelect ? sortSelect.value : 'nom-asc';
            let sortedProducts = [...productsConfig];
            
            switch(sortValue) {
                case 'nom-asc':
                    sortedProducts.sort((a, b) => a.nom.localeCompare(b.nom, 'fr'));
                    break;
                case 'nom-desc':
                    sortedProducts.sort((a, b) => b.nom.localeCompare(a.nom, 'fr'));
                    break;
                case 'categorie-asc':
                    sortedProducts.sort((a, b) => (a.categorie || '').localeCompare(b.categorie || '', 'fr'));
                    break;
                case 'categorie-desc':
                    sortedProducts.sort((a, b) => (b.categorie || '').localeCompare(a.categorie || '', 'fr'));
                    break;
                case 'dlc-asc':
                    sortedProducts.sort((a, b) => (a.dlc || 0) - (b.dlc || 0));
                    break;
                case 'dlc-desc':
                    sortedProducts.sort((a, b) => (b.dlc || 0) - (a.dlc || 0));
                    break;
                case 'prix-asc':
                    sortedProducts.sort((a, b) => (a.prix || 0) - (b.prix || 0));
                    break;
                case 'prix-desc':
                    sortedProducts.sort((a, b) => (b.prix || 0) - (a.prix || 0));
                    break;
                case 'actif':
                    sortedProducts.sort((a, b) => (b.actif ? 1 : 0) - (a.actif ? 1 : 0));
                    break;
                case 'inactif':
                    sortedProducts.sort((a, b) => (a.actif ? 1 : 0) - (b.actif ? 1 : 0));
                    break;
            }
            
            tbody.innerHTML = sortedProducts.map(product => {
                // V√©rifier si une recette existe pour ce produit
                const recipe = recipesConfig.find(r => r.productId === product.id);
                
                let recetteHTML = '';
                if (recipe) {
                    const ingredientsCount = recipe.ingredients.length;
                    const ingredientsList = recipe.ingredients
                        .map(ing => `${ing.categorieEmoji} ${ing.categorieNom}`)
                        .join(', ');
                    
                    recetteHTML = `
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span class="lot-status status-conforme" style="font-size: 11px; padding: 3px 8px;">
                                    ‚úÖ ${ingredientsCount} ingr√©dient${ingredientsCount > 1 ? 's' : ''}
                                </span>
                            </div>
                            <div style="font-size: 11px; color: #666;">
                                Base: ${recipe.quantiteBase}kg
                            </div>
                            <div style="font-size: 10px; color: #999; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${ingredientsList}">
                                ${ingredientsList}
                            </div>
                        </div>
                    `;
                } else {
                    recetteHTML = `
                        <span class="lot-status status-non-conforme" style="font-size: 11px; padding: 3px 8px;">
                            ‚ùå Aucune recette
                        </span>
                    `;
                }
                
                return `
                    <tr>
                        <td><code style="background: #f8f9fa; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${product.id}</code></td>
                        <td><strong>${product.nom}</strong></td>
                        <td><span class="lot-status status-${product.categorie}" style="font-size: 11px;">${product.categorie.toUpperCase()}</span></td>
                        <td>${product.dlc} jours</td>
                        <td><strong>${product.prix ? product.prix.toFixed(2) + ' ‚Ç¨' : 'N/A'}</strong></td>
                        <td>${recetteHTML}</td>
                        <td>
                            <span class="lot-status status-${product.actif ? 'conforme' : 'non-conforme'}" 
                                  onclick="toggleProductActif('${escJS(product.id)}')" 
                                  style="cursor: pointer;" 
                                  title="Cliquer pour changer le statut">
                                ${product.actif ? 'ACTIF' : 'INACTIF'}
                            </span>
                        </td>
                        <td class="actions-column">
                            ${recipe ? `
                                <button class="btn btn-small" onclick="editRecipeFromProduct('${escJS(product.id)}')" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); font-size: 11px; padding: 5px 10px;">
                                    üß™ Modifier Recette
                                </button>
                                <button class="btn btn-small btn-secondary" onclick="viewRecipeDetail('${escJS(product.id)}')" style="font-size: 11px; padding: 5px 10px;">
                                    üëÅÔ∏è Voir Recette
                                </button>
                            ` : `
                                <button class="btn btn-small" onclick="createRecipeFromProduct('${escJS(product.id)}')" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); font-size: 11px; padding: 5px 10px;">
                                    ‚ûï Cr√©er Recette
                                </button>
                            `}
                            <button class="btn btn-small" onclick="editProduct('${escJS(product.id)}')" style="font-size: 11px; padding: 5px 10px;">‚úèÔ∏è Produit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteProduct('${escJS(product.id)}')" style="font-size: 11px; padding: 5px 10px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function toggleProductActif(productId) {
            const product = productsConfig.find(p => p.id === productId);
            if (!product) return;
            
            product.actif = !product.actif;
            await saveProductsConfig();
            displayProductsConfig();
            updateProductSelects();
            updateRecipeProductSelects();
        }
        
        function editProduct(productId) {
            const product = productsConfig.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('config-produit-id').value = product.id;
            document.getElementById('config-produit-nom').value = product.nom;
            document.getElementById('config-produit-dlc').value = product.dlc;
            document.getElementById('config-produit-categorie').value = product.categorie;
            document.getElementById('config-produit-prix').value = product.prix || '';
            document.getElementById('config-produit-actif').value = product.actif.toString();
            document.getElementById('config-produit-description').value = product.description || '';
            document.getElementById('config-produit-poids').value = product.poids || '';
            document.getElementById('config-produit-ingredients').value = product.ingredients || '';
            document.getElementById('config-produit-allergenes').value = product.allergenes || '';
            
            document.getElementById('config-produit-id').readOnly = true;
            
            showAlert(`√âdition du produit "${product.nom}"`, 'success');
        }

        function deleteProduct(productId) {
            const product = productsConfig.find(p => p.id === productId);
            if (!product) return;
            
            showConfirmModal(
                'Supprimer ce produit',
                `√ätes-vous s√ªr de vouloir supprimer le produit "${product.nom}" ?`,
                async () => {
                    const index = productsConfig.findIndex(p => p.id === productId);
                    if (index >= 0) {
                        productsConfig.splice(index, 1);
                        
                        // Sauvegarder dans Supabase
                        await saveProductsConfig();
                        
                        showAlert(`Produit "${product.nom}" supprim√© avec succ√®s !`, 'success');
                        displayProductsConfig();
                        updateProductSelects();
                    }
                }
            );
        }

        function resetProductForm() {
            document.getElementById('config-produit-id').value = '';
            document.getElementById('config-produit-nom').value = '';
            document.getElementById('config-produit-dlc').value = '';
            document.getElementById('config-produit-categorie').value = 'tablette';
            document.getElementById('config-produit-prix').value = '';
            document.getElementById('config-produit-actif').value = 'true';
            document.getElementById('config-produit-description').value = '';
            document.getElementById('config-produit-poids').value = '';
            document.getElementById('config-produit-ingredients').value = '';
            document.getElementById('config-produit-allergenes').value = '';
            
            document.getElementById('config-produit-id').readOnly = false;
        }

        async function loadDefaultProducts() {
            showConfirmModal(
                'Charger les produits par d√©faut',
                'Voulez-vous charger les produits par d√©faut ? Cela ajoutera de nouveaux produits √† votre configuration.',
                async () => {
                    let addedCount = 0;
                    
                    defaultProductsConfig.forEach(defaultProduct => {
                        const exists = productsConfig.find(p => p.id === defaultProduct.id);
                        if (!exists) {
                            productsConfig.push({ ...defaultProduct });
                            addedCount++;
                        }
                    });
                    
                    if (addedCount > 0) {
                        // Sauvegarder dans Supabase
                        await saveProductsConfig();
                        
                        showAlert(`${addedCount} produit(s) par d√©faut ajout√©(s) !`, 'success');
                        displayProductsConfig();
                        updateProductSelects();
                    } else {
                        showAlert('Tous les produits par d√©faut sont d√©j√† configur√©s', 'warning');
                    }
                }
            );
        }

        // Sauvegarder les produits dans Supabase
        async function saveProductsConfig() {
            console.log('üíæ Sauvegarde des produits dans Supabase...');
            console.log('üì¶ Nombre de produits:', productsConfig.length);
            
            if (!isOnline || !supabaseClient) {
                console.log('Mode hors-ligne - Sauvegarde locale uniquement');
                saveToLocalStorage();
                return { success: true, offline: true };
            }
            
            try {
                console.log('üîç Recherche config existante...');
                // Chercher si une configuration de produits existe d√©j√†
                const { data: existingConfig, error: searchError } = await supabaseClient
                    .from('configuration')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('type', 'products')
                    .single();
                
                console.log('üìä Config existante:', existingConfig);
                console.log('‚ùå Erreur recherche:', searchError);
                
                const configData = {
                    type: 'products',
                    user_id: currentUser ? currentUser.id : null,
                    data: productsConfig
                };
                
                console.log('üì§ Donn√©es √† sauvegarder:', configData);
                
                let result;
                if (existingConfig) {
                    console.log('üîÑ UPDATE config produits');
                    // Mise √† jour
                    result = await supabaseClient
                        .from('configuration')
                        .update(configData)
                        .eq('user_id', currentUser.id)
                        .eq('type', 'products')
                        .select();
                } else {
                    console.log('‚ûï INSERT config produits');
                    // Insertion
                    result = await supabaseClient
                        .from('configuration')
                        .insert(configData)
                        .select();
                }
                
                if (result.error) {
                    console.error('‚ùå Erreur sauvegarde produits:', result.error);
                    throw result.error;
                }
                
                console.log('‚úÖ Produits sauvegard√©s dans Supabase');
                console.log('üìä R√©sultat:', result.data);
                saveToLocalStorage();
                return { success: true };
                
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde produits Supabase:', error);
                showAlert(`‚ö†Ô∏è Erreur lors de la sauvegarde des produits:\n${error.message}\n\nDonn√©es sauvegard√©es localement.`, 'warning');
                saveToLocalStorage();
                return { success: false, error };
            }
        }

        // Sauvegarde et chargement
        function saveCompleteBackup() {
            try {
                const completeData = {
                    metadata: {
                        version: '2.0',
                        exportDate: new Date().toISOString(),
                        appName: 'Chocolaterie Tra√ßabilit√© - Syst√®me Complet',
                        counts: {
                            lots: lots.length,
                            matieresPremi√®res: matieresPremi√®res.length,
                            controlesQualite: controlesQualite.length,
                            receptions: receptions.length,
                            losses: losses.length,
                            produits: productsConfig.length,
                            categories: categoriesMP.length
                        }
                    },
                    data: {
                        // Module Lots de Production
                        lots: lots,
                        
                        // Module Mati√®res Premi√®res
                        matieresPremi√®res: matieresPremi√®res,
                        matieresPremieres: matieresPremi√®res, // Compatibilit√©
                        
                        // Module Contr√¥le Qualit√©
                        controlesQualite: controlesQualite,
                        
                        // Module R√©ception Marchandises
                        receptions: receptions,
                        
                        // Module Pertes
                        losses: losses
                    },
                    configuration: {
                        // Configuration des Produits
                        productsConfig: productsConfig,
                        
                        // Configuration des Recettes
                        recipesConfig: recipesConfig,
                        
                        // Configuration des Cat√©gories
                        categoriesMP: categoriesMP,
                        
                        // Param√®tres G√©n√©raux
                        generalSettings: generalSettings
                    }
                };
                
                const dataStr = JSON.stringify(completeData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `chocolaterie_sauvegarde_complete_${timestamp}.json`;
                
                if (downloadFile(dataBlob, filename)) {
                    const summaryMessage = `‚úÖ Sauvegarde compl√®te cr√©√©e avec succ√®s !
                    
üì¶ Donn√©es sauvegard√©es :
‚Ä¢ ${lots.length} lot(s) de production
‚Ä¢ ${matieresPremi√®res.length} mati√®re(s) premi√®re(s)
‚Ä¢ ${receptions.length} r√©ception(s) de marchandises
‚Ä¢ ${controlesQualite.length} contr√¥le(s) qualit√©
‚Ä¢ ${losses.length} perte(s) d√©clar√©e(s)
‚Ä¢ ${productsConfig.length} produit(s) configur√©(s)
‚Ä¢ ${categoriesMP.length} cat√©gorie(s) configur√©e(s)

üíæ Fichier : ${filename}`;
                    
                    showAlert(summaryMessage, 'success');
                } else {
                    copyToClipboard(dataStr);
                }
                
            } catch (error) {
                showAlert('‚ùå Erreur lors de la sauvegarde: ' + error.message, 'danger');
                console.error('Erreur de sauvegarde:', error);
            }
        }

        function loadBackupFile() {
            document.getElementById('file-import').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Afficher un r√©sum√© avant la restauration
                    const summary = `
üìä Contenu de la sauvegarde :
${data.metadata ? `Version : ${data.metadata.version || 'N/A'}` : ''}
${data.metadata && data.metadata.exportDate ? `Date : ${new Date(data.metadata.exportDate).toLocaleDateString('fr-FR')}` : ''}

‚ö†Ô∏è ATTENTION : Cela remplacera TOUTES vos donn√©es actuelles !

Voulez-vous continuer ?`;
                    
                    showConfirmModal(
                        'üîÑ Restaurer cette sauvegarde ?',
                        summary,
                        async () => {
                            try {
                                // Restaurer les donn√©es
                                if (data.data) {
                                    lots = data.data.lots || [];
                                    matieresPremi√®res = data.data.matieresPremi√®res || data.data.matieresPremieres || [];
                                    controlesQualite = data.data.controlesQualite || [];
                                    receptions = data.data.receptions || [];
                                    losses = data.data.losses || [];
                                }
                                
                                // Restaurer la configuration
                                if (data.configuration) {
                                    if (data.configuration.productsConfig) {
                                        productsConfig = data.configuration.productsConfig;
                                    }
                                    if (data.configuration.categoriesMP) {
                                        categoriesMP = data.configuration.categoriesMP;
                                    }
                                    if (data.configuration.generalSettings) {
                                        generalSettings = data.configuration.generalSettings;
                                    }
                                }
                                
                                console.log('‚úÖ Donn√©es restaur√©es localement');
                                console.log('üì¶ Lots:', lots.length);
                                console.log('üì¶ MP:', matieresPremi√®res.length);
                                console.log('üì¶ Pertes:', losses.length);
                                
                                // Sauvegarder dans localStorage
                                saveToLocalStorage();
                                
                                // Synchroniser avec Supabase si connect√©
                                if (isOnline && supabaseClient) {
                                    showAlert('üîÑ Synchronisation avec Supabase en cours...', 'success');
                                    
                                    // Note: On ne synchronise pas automatiquement vers Supabase pour √©viter d'√©craser les donn√©es
                                    // L'utilisateur peut utiliser le bouton "Synchroniser" s'il le souhaite
                                }
                                
                                // R√©initialiser les listes filtr√©es
                                filteredLots = [...lots];
                                filteredReceptions = [...receptions];
                                
                                // Mettre √† jour toutes les interfaces
                                updateStats();
                                updateDashboard();
                                updateProductSelects();
                                updateCategorieSelects();
                                displayMatieresPremi√®res();
                                displayReceptions();
                                checkStockAlerts();
                                updateReceptionFilters();
                                displayProductsConfig();
                                displayCategoriesConfig();
                                updateIngredientsSelect();
                                
                                const successMessage = `‚úÖ Sauvegarde restaur√©e avec succ√®s !

üì¶ Donn√©es restaur√©es :
‚Ä¢ ${lots.length} lot(s) de production
‚Ä¢ ${matieresPremi√®res.length} mati√®re(s) premi√®re(s)
‚Ä¢ ${receptions.length} r√©ception(s)
‚Ä¢ ${controlesQualite.length} contr√¥le(s) qualit√©
‚Ä¢ ${losses.length} perte(s) d√©clar√©e(s)
‚Ä¢ ${productsConfig.length} produit(s) configur√©(s)
‚Ä¢ ${categoriesMP.length} cat√©gorie(s) configur√©e(s)

üîÑ Toutes les interfaces ont √©t√© mises √† jour !

üí° Conseil : Utilisez le bouton "üîÑ Synchroniser" pour envoyer ces donn√©es vers Supabase si n√©cessaire.`;
                                
                                showAlert(successMessage, 'success');
                                
                            } catch (restoreError) {
                                showAlert('‚ùå Erreur lors de la restauration : ' + restoreError.message, 'danger');
                                console.error('Erreur de restauration:', restoreError);
                            }
                        }
                    );
                    
                } catch (error) {
                    showAlert('‚ùå Erreur lors de la lecture du fichier : ' + error.message + '\n\nAssurez-vous que le fichier est une sauvegarde valide.', 'danger');
                    console.error('Erreur de lecture:', error);
                }
            };
            
            reader.onerror = function() {
                showAlert('‚ùå Impossible de lire le fichier', 'danger');
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearAllData() {
            const totalItems = lots.length + matieresPremi√®res.length + receptions.length + controlesQualite.length;
            
            const confirmMessage = `‚ö†Ô∏è ATTENTION : Vous √™tes sur le point d'effacer TOUTES les donn√©es !

üìä Donn√©es qui seront supprim√©es :
‚Ä¢ ${lots.length} lot(s) de production
‚Ä¢ ${matieresPremi√®res.length} mati√®re(s) premi√®re(s)
‚Ä¢ ${receptions.length} r√©ception(s)
‚Ä¢ ${controlesQualite.length} contr√¥le(s) qualit√©
‚Ä¢ ${losses.length} perte(s) d√©clar√©e(s)

‚öôÔ∏è La configuration des produits sera conserv√©e.

üö® Cette action est IRR√âVERSIBLE !

üí° Conseil : Faites une sauvegarde compl√®te avant de continuer.`;
            
            showConfirmModal(
                'üóëÔ∏è Effacer TOUTES les donn√©es ?',
                confirmMessage,
                () => {
                    // Sauvegarder les compteurs avant effacement
                    const deletedCounts = {
                        lots: lots.length,
                        mp: matieresPremi√®res.length,
                        receptions: receptions.length,
                        cq: controlesQualite.length,
                        losses: losses.length
                    };
                    
                    // Effacer toutes les donn√©es
                    lots = [];
                    matieresPremi√®res = [];
                    controlesQualite = [];
                    receptions = [];
                    losses = [];
                    filteredLots = [];
                    filteredReceptions = [];
                    currentIngredients = [];
                    
                    // Mettre √† jour toutes les interfaces
                    updateStats();
                    updateDashboard();
                    displayLots();
                    displayMatieresPremi√®res();
                    displayReceptions();
                    updateIngredientsSelect();
                    
                    const successMessage = `üóëÔ∏è Toutes les donn√©es ont √©t√© effac√©es !

üìä √âl√©ments supprim√©s :
‚Ä¢ ${deletedCounts.lots} lot(s)
‚Ä¢ ${deletedCounts.mp} mati√®re(s) premi√®re(s)
‚Ä¢ ${deletedCounts.receptions} r√©ception(s)
‚Ä¢ ${deletedCounts.cq} contr√¥le(s) qualit√©
‚Ä¢ ${deletedCounts.losses} perte(s)

‚úÖ L'application est maintenant vide et pr√™te pour de nouvelles donn√©es.`;
                    
                    showAlert(successMessage, 'warning');
                    generateLotNumber();
                }
            );
        }

        function exportData(format) {
            if (format === 'json') {
                saveCompleteBackup();
                return;
            }
            
            if (format === 'csv') {
                const csv = generateCSV(lots);
                const blob = new Blob([csv], { type: 'text/csv' });
                const timestamp = new Date().toISOString().split('T')[0];
                
                if (downloadFile(blob, `chocolaterie_lots_${timestamp}.csv`)) {
                    showAlert('Export CSV r√©alis√© avec succ√®s !', 'success');
                } else {
                    copyToClipboard(csv);
                }
            }
        }

        function generateCSV(data) {
            if (!data || data.length === 0) {
                return 'Aucune donn√©e √† exporter';
            }
            
            const headers = ['Num√©ro Lot', 'Produit', 'Date', 'Quantit√©', 'Unit√©', 'Op√©rateur', 'Statut'];
            let csv = headers.join(';') + '\n';
            
            data.forEach(lot => {
                const row = [
                    lot.numero,
                    lot.produit,
                    lot.date,
                    lot.quantite,
                    lot.unite || 'kg',
                    lot.operateur,
                    getStatusLabel(lot.statut)
                ];
                csv += row.join(';') + '\n';
            });
            
            return '\uFEFF' + csv;
        }

        function generateSimpleReport() {
            const reportData = {
                title: 'Rapport Simple de Production',
                date: new Date().toISOString(),
                summary: {
                    totalLots: lots.length,
                    totalProduction: lots.reduce((sum, lot) => sum + getLotQuantiteKg(lot), 0),
                    lotsTermines: lots.filter(l => l.statut === 'fini').length
                },
                lots: lots
            };
            
            const reportStr = JSON.stringify(reportData, null, 2);
            const reportBlob = new Blob([reportStr], { type: 'application/json' });
            const timestamp = new Date().toISOString().split('T')[0];
            
            if (downloadFile(reportBlob, `rapport_simple_${timestamp}.json`)) {
                showAlert('Rapport g√©n√©r√© avec succ√®s !', 'success');
            } else {
                copyToClipboard(reportStr);
            }
        }

        // R√©ception de marchandises
        function initializeReceptionForm() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const timeStr = today.toTimeString().split(' ')[0].substring(0, 5);
            
            document.getElementById('reception-date').value = dateStr;
            document.getElementById('reception-heure').value = timeStr;
            
            // Initialiser la date de r√©ception des MP au jour actuel
            const dateReceptionInput = document.getElementById('reception-mp-date-reception');
            if (dateReceptionInput) {
                dateReceptionInput.value = dateStr;
            }
            
            // Initialiser le select des cat√©gories
            const categorieSelect = document.getElementById('reception-mp-categorie');
            if (categorieSelect) {
                categorieSelect.innerHTML = '<option value="">S√©lectionner une cat√©gorie</option>';
                categoriesMP.filter(cat => cat.actif).forEach(cat => {
                    categorieSelect.innerHTML += `<option value="${cat.id}">${cat.emoji} ${cat.nom}</option>`;
                });
            }
            
            clearPhotos();
            filteredReceptions = [...receptions];
        }

        async function saveReception() {
            if (!validateForm('reception-form')) {
                return;
            }
            
            // V√©rifier qu'il y a des produits √† r√©ceptionner
            if (currentReceptionItems.length === 0) {
                showAlert('Veuillez ajouter au moins un produit √† r√©ceptionner', 'warning');
                return;
            }
            
            const fournisseur = document.getElementById('reception-fournisseur').value.trim();
            
            const newReception = {
                date: document.getElementById('reception-date').value,
                heure: document.getElementById('reception-heure').value,
                bon_livraison: document.getElementById('reception-bon-livraison').value.trim(),
                fournisseur: fournisseur,
                temperature: document.getElementById('reception-temperature').value ? parseFloat(document.getElementById('reception-temperature').value) : null,
                commentaires: document.getElementById('reception-commentaires').value.trim(),
                photos: [...currentPhotos],
                statut: 'recu',
                items: currentReceptionItems.map(item => ({
                    mpNom: item.mpNom,
                    quantite: item.quantite,
                    lot: item.lot,
                    dlc: item.dlc,
                    prix: item.prix
                }))
            };
            
            // Sauvegarder la r√©ception dans Supabase
            const result = await saveToSupabase('receptions', newReception, false);
            
            if (result.success && result.data) {
                newReception.id = result.data[0].id;
                newReception.created_at = result.data[0].created_at;
            } else {
                newReception.id = Date.now();
                newReception.created_at = new Date().toISOString();
            }
            
            // Cr√©er les mati√®res premi√®res avec le stock
            for (const item of currentReceptionItems) {
                const newMP = {
                    nom: item.mpNom,
                    lot: item.lot,
                    fournisseur: item.fournisseur,
                    categorie: item.categorie,
                    quantite_initiale: item.quantite,
                    quantite_actuelle: item.quantite,
                    cout: item.prix || 0,
                    dlc: item.dlc || null,
                    date_reception: item.dateReception,
                    stock_mini: item.stockMini || 0
                };
                
                // Sauvegarder la MP
                const mpResult = await saveToSupabase('matieres_premieres', newMP, false);
                
                if (mpResult.success && mpResult.data) {
                    newMP.id = mpResult.data[0].id;
                    newMP.created_at = mpResult.data[0].created_at;
                } else {
                    newMP.id = Date.now() + Math.random();
                    newMP.created_at = new Date().toISOString();
                }
                
                matieresPremi√®res.push(newMP);
            }
            
            receptions.unshift(newReception);
            
            const statusText = result.offline ? ' [Sauvegard√© localement]' : ' [Synchronis√© ‚òÅÔ∏è]';
            showAlert(`R√©ception ${newReception.bon_livraison} enregistr√©e avec ${currentReceptionItems.length} produit(s) ! ${currentPhotos.length} photo(s) attach√©e(s).` + statusText, 'success');
            
            resetReceptionForm();
            filteredReceptions = [...receptions];
            displayReceptions();
            updateReceptionFilters();
            updateStats();
            updateDashboard();
            displayMatieresPremi√®res();
            refreshAllMPLists();
        }

        function resetReceptionForm() {
            const inputs = document.querySelectorAll('#reception-form input, #reception-form textarea');
            inputs.forEach(input => {
                if (input.type === 'date') {
                    input.value = new Date().toISOString().split('T')[0];
                } else if (input.type === 'time') {
                    input.value = new Date().toTimeString().split(' ')[0].substring(0, 5);
                } else {
                    input.value = '';
                }
            });
            
            // R√©initialiser les items de r√©ception
            currentReceptionItems = [];
            updateReceptionItemsDisplay();
            
            clearPhotos();
            stopCamera();
        }
        
        // Gestion des items de r√©ception
        let currentReceptionItems = [];
        
        function initReceptionMPSelect() {
            const select = document.getElementById('reception-mp-select');
            if (!select) return;
            
            // R√©cup√©rer toutes les MP uniques par nom
            const mpNames = [...new Set(matieresPremi√®res.map(mp => mp.nom))].sort((a, b) => a.localeCompare(b, 'fr'));
            
            select.innerHTML = '<option value="">-- S√©lectionner une MP --</option>';
            mpNames.forEach(nom => {
                const mp = matieresPremi√®res.find(m => m.nom === nom);
                if (mp) {
                    const categorie = categoriesMP.find(c => c.id === mp.categorie);
                    const emoji = categorie ? categorie.emoji : 'üì¶';
                    select.innerHTML += `<option value="${nom}" data-categorie="${mp.categorie}">${emoji} ${nom}</option>`;
                }
            });
        }
        
        function addReceptionItem() {
            const nomInput = document.getElementById('reception-mp-nom');
            const categorieSelect = document.getElementById('reception-mp-categorie');
            const lotInput = document.getElementById('reception-mp-lot');
            const fournisseurInput = document.getElementById('reception-mp-fournisseur');
            const dateReceptionInput = document.getElementById('reception-mp-date-reception');
            const dlcInput = document.getElementById('reception-mp-dlc');
            const quantiteInput = document.getElementById('reception-mp-quantite');
            const prixInput = document.getElementById('reception-mp-prix');
            const stockMiniInput = document.getElementById('reception-mp-stock-mini');
            
            const mpNom = nomInput.value.trim();
            const categorie = categorieSelect.value;
            const lot = lotInput.value.trim();
            const fournisseur = fournisseurInput.value.trim();
            const dateReception = dateReceptionInput.value;
            const dlc = dlcInput.value;
            const quantite = parseFloat(quantiteInput.value);
            const prix = parseFloat(prixInput.value) || 0;
            const stockMini = parseFloat(stockMiniInput.value) || 0;
            
            // Validations
            if (!mpNom) {
                showAlert('Veuillez entrer le nom de la mati√®re premi√®re', 'warning');
                return;
            }
            
            if (!categorie) {
                showAlert('Veuillez s√©lectionner une cat√©gorie', 'warning');
                return;
            }
            
            if (!lot) {
                showAlert('Veuillez entrer le num√©ro de lot fournisseur', 'warning');
                return;
            }
            
            if (!fournisseur) {
                showAlert('Veuillez entrer le nom du fournisseur', 'warning');
                return;
            }
            
            if (!dateReception) {
                showAlert('Veuillez s√©lectionner la date de r√©ception', 'warning');
                return;
            }
            
            if (!quantite || quantite <= 0) {
                showAlert('Veuillez entrer une quantit√© valide', 'warning');
                return;
            }
            
            currentReceptionItems.push({
                mpNom: mpNom,
                categorie: categorie,
                lot: lot,
                fournisseur: fournisseur,
                dateReception: dateReception,
                dlc: dlc,
                quantite: quantite / 1000,
                prix: prix,
                stockMini: stockMini / 1000
            });
            
            // R√©initialiser les champs
            nomInput.value = '';
            categorieSelect.value = '';
            lotInput.value = '';
            fournisseurInput.value = '';
            dateReceptionInput.value = '';
            dlcInput.value = '';
            quantiteInput.value = '';
            prixInput.value = '';
            stockMiniInput.value = '';
            
            updateReceptionItemsDisplay();
            showAlert(`‚úÖ ${mpNom} ajout√© √† la r√©ception`, 'success');
        }
        
        function removeReceptionItem(index) {
            if (index >= 0 && index < currentReceptionItems.length) {
                const removed = currentReceptionItems[index];
                currentReceptionItems.splice(index, 1);
                updateReceptionItemsDisplay();
                showAlert(`${removed.mpNom} retir√© de la r√©ception`, 'success');
            }
        }
        
        function editReceptionItem(index) {
            if (index < 0 || index >= currentReceptionItems.length) return;
            const item = currentReceptionItems[index];
            
            const nomSelect = document.getElementById('reception-mp-nom-select');
            const nomInput = document.getElementById('reception-mp-nom');
            if (nomSelect) {
                const option = Array.from(nomSelect.options).find(o => o.value === item.mpNom);
                if (option) {
                    nomSelect.value = item.mpNom;
                    nomInput.style.display = 'none';
                    nomInput.value = item.mpNom;
                } else {
                    nomSelect.value = '__custom__';
                    nomInput.style.display = 'block';
                    nomInput.value = item.mpNom;
                }
            }
            
            const catSelect = document.getElementById('reception-mp-categorie');
            if (catSelect) catSelect.value = item.categorie;
            
            document.getElementById('reception-mp-lot').value = item.lot || '';
            document.getElementById('reception-mp-fournisseur').value = item.fournisseur || '';
            document.getElementById('reception-mp-date-reception').value = item.dateReception || '';
            document.getElementById('reception-mp-dlc').value = item.dlc || '';
            document.getElementById('reception-mp-quantite').value = item.quantite ? (item.quantite * 1000).toFixed(0) : '';
            
            const prixInput = document.getElementById('reception-mp-prix');
            if (prixInput) prixInput.value = item.prix || '';
            
            const stockMiniInput = document.getElementById('reception-mp-stock-mini');
            if (stockMiniInput) stockMiniInput.value = item.stockMini ? (item.stockMini * 1000).toFixed(0) : '';
            
            currentReceptionItems.splice(index, 1);
            updateReceptionItemsDisplay();
            
            const form = document.getElementById('reception-mp-nom-select') || document.getElementById('reception-mp-nom');
            if (form) form.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            showAlert(`‚úèÔ∏è Modification de "${item.mpNom}" ‚Äî corrigez les champs puis cliquez sur "Ajouter"`, 'info');
        }
        
        function updateReceptionItemsDisplay() {
            const listDiv = document.getElementById('reception-items-list');
            const emptyMsg = document.getElementById('reception-items-empty');
            const totalDiv = document.getElementById('reception-items-total');
            const totalCount = document.getElementById('reception-total-count');
            const totalQty = document.getElementById('reception-total-qty');
            const totalCost = document.getElementById('reception-total-cost');
            
            if (!listDiv) return;
            
            if (currentReceptionItems.length === 0) {
                if (emptyMsg) emptyMsg.style.display = 'block';
                if (totalDiv) totalDiv.style.display = 'none';
                // Supprimer les anciens items
                listDiv.querySelectorAll('.reception-item').forEach(item => item.remove());
                return;
            }
            
            if (emptyMsg) emptyMsg.style.display = 'none';
            if (totalDiv) totalDiv.style.display = 'block';
            
            // Calculer les totaux
            const totalQuantite = currentReceptionItems.reduce((sum, item) => sum + item.quantite, 0);
            const totalCoutCalcul = currentReceptionItems.reduce((sum, item) => sum + (item.quantite * item.prix), 0);
            
            if (totalCount) totalCount.textContent = currentReceptionItems.length;
            if (totalQty) totalQty.textContent = totalQuantite.toFixed(3);
            if (totalCost) totalCost.textContent = totalCoutCalcul.toFixed(2);
            
            // Supprimer les anciens items
            listDiv.querySelectorAll('.reception-item').forEach(item => item.remove());
            
            // Afficher les items
            const itemsHTML = currentReceptionItems.map((item, index) => {
                const categorie = categoriesMP.find(c => c.id === item.categorie);
                const emoji = categorie ? categorie.emoji : 'üì¶';
                const categorieLabel = categorie ? categorie.nom : 'Autre';
                
                return `
                    <div class="reception-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #4caf50; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 16px; color: #000; margin-bottom: 6px;">
                                    ${emoji} ${item.mpNom}
                                </div>
                                <span class="lot-status" style="font-size: 11px; padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px;">${categorieLabel}</span>
                            </div>
                            <button class="btn btn-small" onclick="editReceptionItem(${index})" style="padding: 6px 12px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);" title="Modifier">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="removeReceptionItem(${index})" style="padding: 6px 12px;">üóëÔ∏è</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üè≠ FOURNISSEUR</div>
                                <div style="font-weight: 600; color: #000;">${item.fournisseur}</div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üì¶ LOT</div>
                                <div style="font-weight: 600; font-family: monospace; color: #000;">${item.lot}</div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üìÖ DATE R√âCEPTION</div>
                                <div style="font-weight: 600; color: #000;">${formatDate(item.dateReception)}</div>
                            </div>
                            
                            ${item.dlc ? `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">‚è∞ DLC</div>
                                <div style="font-weight: 600; color: #000;">${formatDate(item.dlc)}</div>
                            </div>
                            ` : ''}
                            
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #2e7d32; margin-bottom: 4px;">‚öñÔ∏è QUANTIT√â</div>
                                <div style="font-weight: 700; color: #1b5e20; font-size: 16px;">${(item.quantite * 1000).toFixed(0)} g</div>
                            </div>
                            
                            ${item.prix ? `
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #2e7d32; margin-bottom: 4px;">üí∞ CO√õT</div>
                                <div style="font-weight: 700; color: #1b5e20; font-size: 16px;">${item.prix.toFixed(2)} ‚Ç¨/kg</div>
                                <div style="font-size: 11px; color: #666; margin-top: 2px;">Total: ${(item.quantite * item.prix).toFixed(2)} ‚Ç¨</div>
                            </div>
                            ` : ''}
                            
                            ${item.stockMini > 0 ? `
                            <div style="background: #fff3e0; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #e65100; margin-bottom: 4px;">‚ö†Ô∏è STOCK MINI</div>
                                <div style="font-weight: 600; color: #bf360c;">${(item.stockMini * 1000).toFixed(0)} g</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            listDiv.insertAdjacentHTML('beforeend', itemsHTML);
        }

        function displayReceptions() {
            const tbody = document.querySelector('#receptions-table tbody');
            
            console.log('üìã displayReceptions appel√©');
            console.log('   - receptions.length:', receptions.length);
            console.log('   - filteredReceptions.length:', filteredReceptions.length);
            
            if (!tbody) {
                console.log('   - ‚ùå tbody non trouv√© !');
                return;
            }
            
            if (filteredReceptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Aucune r√©ception enregistr√©e</td></tr>';
                return;
            }
            
            console.log('   - Premi√®re r√©ception:', filteredReceptions[0]);
            
            tbody.innerHTML = filteredReceptions.map(reception => {
                const tempDisplay = reception.temperature !== null ? `${reception.temperature}¬∞C` : 'N/A';
                
                const statusClass = reception.statut === 'recu' ? 'status-conforme' : 'status-production';
                const bonLivraison = reception.bon_livraison || reception.bonLivraison;
                
                return `
                    <tr>
                        <td>
                            <div>${formatDate(reception.date)}</div>
                            <div style="font-size: 12px; color: #666;">${reception.heure}</div>
                        </td>
                        <td><strong>${bonLivraison}</strong></td>
                        <td>${reception.fournisseur}</td>
                        <td>${tempDisplay}</td>
                        <td>
                            <button class="btn btn-small" onclick="viewReceptionDetail(${reception.id})">üì∏ Voir photos</button>
                        </td>
                        <td><span class="lot-status ${statusClass}">RE√áU</span></td>
                        <td class="actions-column">
                            <button class="btn btn-small" onclick="viewReceptionDetail(${reception.id})">üëÅÔ∏è D√©tail</button>
                            <button class="btn btn-small btn-secondary" onclick="editReception(${reception.id})">‚úèÔ∏è Modifier</button>
                            <button class="btn btn-small btn-danger" onclick="deleteReception(${reception.id})">üóëÔ∏è Supprimer</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateReceptionFilters() {
            const fournisseurFilter = document.getElementById('filter-reception-fournisseur');
            const fournisseurs = [...new Set(receptions.map(r => r.fournisseur))];
            
            fournisseurFilter.innerHTML = '<option value="">Tous les fournisseurs</option>';
            fournisseurs.forEach(fournisseur => {
                fournisseurFilter.innerHTML += `<option value="${fournisseur}">${fournisseur}</option>`;
            });
        }

        function applyReceptionFilters() {
            const searchTerm = document.getElementById('search-receptions').value.toLowerCase();
            const fournisseurFilter = document.getElementById('filter-reception-fournisseur').value;
            const dateDebut = document.getElementById('filter-reception-date-debut').value;
            const dateFin = document.getElementById('filter-reception-date-fin').value;
            
            filteredReceptions = receptions.filter(reception => {
                const matchesSearch = !searchTerm || 
                    reception.bonLivraison.toLowerCase().includes(searchTerm) ||
                    reception.fournisseur.toLowerCase().includes(searchTerm);
                
                const matchesFournisseur = !fournisseurFilter || reception.fournisseur === fournisseurFilter;
                const matchesDateDebut = !dateDebut || reception.date >= dateDebut;
                const matchesDateFin = !dateFin || reception.date <= dateFin;
                
                return matchesSearch && matchesFournisseur && matchesDateDebut && matchesDateFin;
            });
            
            displayReceptions();
        }

        function clearReceptionFilters() {
            document.getElementById('search-receptions').value = '';
            document.getElementById('filter-reception-fournisseur').value = '';
            document.getElementById('filter-reception-date-debut').value = '';
            document.getElementById('filter-reception-date-fin').value = '';
            applyReceptionFilters();
        }

        function deleteReception(id) {
            const reception = receptions.find(r => r.id === id);
            if (!reception) return;
            
            const bonLivraison = reception.bon_livraison || reception.bonLivraison;
            
            // Trouver les MP cr√©√©es lors de cette r√©ception
            const mpDeLaReception = matieresPremi√®res.filter(mp => {
                // V√©rifier par date de r√©ception et fournisseur
                const dateReceptionMP = mp.date_reception || mp.dateReception;
                const fournisseurMP = mp.fournisseur;
                
                // Comparaison: m√™me date ET m√™me fournisseur
                return dateReceptionMP === reception.date && fournisseurMP === reception.fournisseur;
            });
            
            // V√©rifier si certaines MP ont √©t√© utilis√©es (stock diminu√©)
            const mpUtilisees = mpDeLaReception.filter(mp => {
                const quantiteInitiale = mp.quantite_initiale || mp.quantiteInitiale || 0;
                const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                return quantiteActuelle < quantiteInitiale;
            });
            
            let warningMessage = `√ätes-vous s√ªr de vouloir supprimer la r√©ception "${bonLivraison}" du ${formatDate(reception.date)} ?\n\n`;
            
            if (mpDeLaReception.length > 0) {
                warningMessage += `‚ö†Ô∏è Cette action va √©galement supprimer ${mpDeLaReception.length} mati√®re(s) premi√®re(s) cr√©√©e(s) lors de cette r√©ception :\n\n`;
                mpDeLaReception.forEach(mp => {
                    const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                    warningMessage += `‚Ä¢ ${mp.nom} - Lot ${mp.lot} (${quantiteActuelle.toFixed(3)} kg)\n`;
                });
                
                if (mpUtilisees.length > 0) {
                    warningMessage += `\nüî¥ ATTENTION : ${mpUtilisees.length} de ces mati√®res ont d√©j√† √©t√© utilis√©es en production !\n`;
                    warningMessage += `Cela peut affecter la tra√ßabilit√© de vos lots produits.\n`;
                }
            }
            
            warningMessage += `\n‚ö†Ô∏è Cette action est irr√©versible !`;
            
            showConfirmModal(
                'Supprimer cette r√©ception',
                warningMessage,
                async () => {
                    // Supprimer les MP de la r√©ception
                    for (const mp of mpDeLaReception) {
                        // Supprimer du tableau local
                        const mpIndex = matieresPremi√®res.findIndex(m => m.id === mp.id);
                        if (mpIndex > -1) {
                            matieresPremi√®res.splice(mpIndex, 1);
                        }
                        
                        // Supprimer de Supabase
                        await deleteFromSupabase('matieres_premieres', mp.id);
                        
                        console.log(`üóëÔ∏è MP supprim√©e: ${mp.nom} - Lot ${mp.lot}`);
                    }
                    
                    // Supprimer la r√©ception
                    const receptionIndex = receptions.findIndex(r => r.id === id);
                    if (receptionIndex > -1) {
                        receptions.splice(receptionIndex, 1);
                        filteredReceptions = filteredReceptions.filter(r => r.id !== id);
                        
                        // Supprimer de Supabase
                        await deleteFromSupabase('receptions', id);
                        
                        showAlert(`‚úÖ R√©ception ${bonLivraison} supprim√©e avec succ√®s !\n${mpDeLaReception.length} mati√®re(s) premi√®re(s) supprim√©e(s).`, 'success');
                        
                        // Rafra√Æchir tous les affichages
                        displayReceptions();
                        updateReceptionFilters();
                        displayMatieresPremi√®res();
                        displayInventaire();
                        checkStockAlerts();
                        updateStats();
                        updateDashboard();
                        refreshAllMPLists();
                    }
                }
            );
        }

        async function viewReceptionDetail(id) {
            const reception = receptions.find(r => r.id === id);
            if (!reception) return;
            
            const detailContent = document.getElementById('reception-detail-content');
            const bonLivraison = reception.bon_livraison || reception.bonLivraison;
            
            // Afficher d'abord les infos de base avec un indicateur de chargement pour les photos
            detailContent.innerHTML = `
                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="detail-item">
                        <span class="detail-label">Date de r√©ception:</span>
                        <span>${formatDate(reception.date)} √† ${reception.heure}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Bon de livraison:</span>
                        <span><strong>${bonLivraison}</strong></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fournisseur:</span>
                        <span>${reception.fournisseur}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Temp√©rature camion:</span>
                        <span>${reception.temperature !== null ? reception.temperature + '¬∞C' : 'Non renseign√©e'}</span>
                    </div>
                </div>
                
                ${reception.commentaires ? `
                <div style="margin-bottom: 20px;">
                    <h4>Commentaires :</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #D2691E;">
                        ${reception.commentaires}
                    </div>
                </div>
                ` : ''}
                
                <div id="reception-photos-container">
                    <div style="text-align: center; padding: 20px;">
                        <div class="spinner"></div>
                        <div style="margin-top: 10px; color: #666;">Chargement des photos...</div>
                    </div>
                </div>
            `;
            
            document.getElementById('reception-detail-modal').style.display = 'block';
            
            // Charger les photos √† la demande
            try {
                const { data: receptionWithPhotos, error } = await supabaseClient
                    .from('receptions')
                    .select('photos')
                    .eq('id', id)
                    .single();
                
                const photosContainer = document.getElementById('reception-photos-container');
                
                if (error || !receptionWithPhotos) {
                    photosContainer.innerHTML = '<div style="text-align: center; color: #999;">Impossible de charger les photos</div>';
                    return;
                }
                
                // Parser les photos si c'est une string JSON
                let photos = receptionWithPhotos.photos;
                if (typeof photos === 'string') {
                    try {
                        photos = JSON.parse(photos);
                    } catch (e) {
                        photos = [];
                    }
                }
                
                // Mettre √† jour l'objet reception avec les photos
                reception.photos = photos;
                
                if (photos && photos.length > 0) {
                    photosContainer.innerHTML = `
                        <h4>Photos (${photos.length}) :</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                            ${photos.map((photo, index) => `
                                <img src="${photo.data || photo}" alt="Photo ${index + 1}" 
                                     style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease;"
                                     onmouseover="this.style.transform='scale(1.05)'" 
                                     onmouseout="this.style.transform='scale(1)'"
                                     onclick="openLightbox(${reception.id}, ${index})">
                            `).join('')}
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn" onclick="openLightbox(${reception.id}, 0)">üîç Voir toutes les photos en grand</button>
                        </div>
                    `;
                } else {
                    photosContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Aucune photo pour cette r√©ception</div>';
                }
            } catch (e) {
                console.error('Erreur chargement photos:', e);
                document.getElementById('reception-photos-container').innerHTML = '<div style="text-align: center; color: #999;">Erreur lors du chargement des photos</div>';
            }
        }

        // ============================================
        // LIGHTBOX - SYST√àME D'AGRANDISSEMENT PHOTOS
        // ============================================
        
        let currentLightboxPhotos = [];
        let currentLightboxIndex = 0;
        let currentLightboxReceptionId = null;
        
        function openLightbox(receptionId, startIndex = 0) {
            const reception = receptions.find(r => r.id === receptionId);
            console.log('üì∏ openLightbox appel√© pour r√©ception:', receptionId);
            
            if (!reception || !reception.photos) {
                showAlert('Aucune photo disponible', 'warning');
                return;
            }
            
            // Parser les photos si c'est une string JSON
            let photos = reception.photos;
            if (typeof photos === 'string') {
                try {
                    photos = JSON.parse(photos);
                    console.log('   - Photos pars√©es depuis JSON string');
                } catch (e) {
                    console.error('   - Erreur parsing photos:', e);
                    showAlert('Erreur lors du chargement des photos', 'danger');
                    return;
                }
            }
            
            if (!Array.isArray(photos) || photos.length === 0) {
                showAlert('Aucune photo disponible', 'warning');
                return;
            }
            
            console.log('   - Nombre de photos:', photos.length);
            
            currentLightboxPhotos = photos;
            currentLightboxIndex = startIndex;
            currentLightboxReceptionId = receptionId;
            
            updateLightboxImage();
            document.getElementById('photo-lightbox').classList.add('active');
            document.body.style.overflow = 'hidden'; // Emp√™cher le scroll
            
            // Fermer les autres modals
            document.getElementById('photo-viewer-modal').style.display = 'none';
        }
        
        function updateLightboxImage() {
            const photo = currentLightboxPhotos[currentLightboxIndex];
            const img = document.getElementById('lightbox-image');
            const caption = document.getElementById('lightbox-caption');
            const counter = document.getElementById('lightbox-counter');
            
            img.src = photo.data;
            img.classList.remove('zoomed');
            
            // Afficher les infos
            let captionText = `<strong>Photo ${currentLightboxIndex + 1}</strong>`;
            if (photo.timestamp) {
                captionText += ` ‚Ä¢ ${new Date(photo.timestamp).toLocaleString('fr-FR')}`;
            }
            if (photo.source) {
                const sourceLabel = photo.source === 'camera-enhanced' ? '‚ú® Am√©lior√©e' : 
                                   photo.source === 'camera-quick' ? '‚ö° Rapide' : 
                                   photo.source === 'gallery' ? 'üìÅ Galerie' : '';
                if (sourceLabel) captionText += ` ‚Ä¢ ${sourceLabel}`;
            }
            caption.innerHTML = captionText;
            counter.textContent = `${currentLightboxIndex + 1} / ${currentLightboxPhotos.length}`;
            
            // Cacher les fl√®ches si une seule photo
            document.querySelector('.photo-lightbox-prev').style.display = currentLightboxPhotos.length > 1 ? 'block' : 'none';
            document.querySelector('.photo-lightbox-next').style.display = currentLightboxPhotos.length > 1 ? 'block' : 'none';
            
            // R√©initialiser la rotation et la nettet√©
            currentRotation = 0;
            img.style.transform = '';
            img.classList.remove('sharpened');
            const btnSharpen = document.getElementById('btn-sharpen');
            if (btnSharpen) btnSharpen.classList.remove('active');
        }
        
        // Variables pour la rotation
        let currentRotation = 0;
        
        function rotateLightboxImage(degrees) {
            const img = document.getElementById('lightbox-image');
            currentRotation += degrees;
            
            // Normaliser entre 0 et 360
            currentRotation = ((currentRotation % 360) + 360) % 360;
            
            // Appliquer la rotation avec le zoom si actif
            const isZoomed = img.classList.contains('zoomed');
            const scale = isZoomed ? 2 : 1;
            img.style.transform = `rotate(${currentRotation}deg) scale(${scale})`;
        }
        
        function toggleSharpen() {
            const img = document.getElementById('lightbox-image');
            const btn = document.getElementById('btn-sharpen');
            
            img.classList.toggle('sharpened');
            btn.classList.toggle('active');
            
            if (img.classList.contains('sharpened')) {
                showAlert('‚ú® Nettet√© am√©lior√©e', 'success');
            }
        }
        
        function downloadLightboxImage() {
            const photo = currentLightboxPhotos[currentLightboxIndex];
            if (!photo) return;
            
            const photoData = photo.data || photo;
            
            // Cr√©er un canvas pour appliquer la rotation si n√©cessaire
            if (currentRotation !== 0) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Ajuster la taille du canvas selon la rotation
                    if (currentRotation === 90 || currentRotation === 270) {
                        canvas.width = img.height;
                        canvas.height = img.width;
                    } else {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    }
                    
                    // Appliquer la rotation
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(currentRotation * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    
                    // T√©l√©charger
                    const link = document.createElement('a');
                    link.download = `photo_reception_${currentLightboxIndex + 1}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    
                    showAlert('üíæ Photo t√©l√©charg√©e avec rotation appliqu√©e', 'success');
                };
                img.src = photoData;
            } else {
                // T√©l√©charger directement sans rotation
                const link = document.createElement('a');
                link.download = `photo_reception_${currentLightboxIndex + 1}.jpg`;
                link.href = photoData;
                link.click();
                
                showAlert('üíæ Photo t√©l√©charg√©e', 'success');
            }
        }
        
        function navigateLightbox(direction) {
            currentLightboxIndex += direction;
            
            // Boucler
            if (currentLightboxIndex >= currentLightboxPhotos.length) {
                currentLightboxIndex = 0;
            } else if (currentLightboxIndex < 0) {
                currentLightboxIndex = currentLightboxPhotos.length - 1;
            }
            
            updateLightboxImage();
        }
        
        // === PHOTO VIEWER : Zoom + Pan (d√©placement) ===
        let viewerState = { scale: 1, panX: 0, panY: 0, isPanning: false, startX: 0, startY: 0 };
        
        function toggleZoom() {
            const img = document.getElementById('lightbox-image');
            const isZoomed = img.classList.contains('zoomed');
            
            if (isZoomed) {
                img.classList.remove('zoomed');
                viewerState.scale = 1;
                viewerState.panX = 0;
                viewerState.panY = 0;
                img.style.transform = `rotate(${currentRotation}deg)`;
                img.style.cursor = 'zoom-in';
            } else {
                img.classList.add('zoomed');
                viewerState.scale = 3;
                viewerState.panX = 0;
                viewerState.panY = 0;
                updateImageTransform();
                img.style.cursor = 'grab';
            }
        }
        
        function updateImageTransform() {
            const img = document.getElementById('lightbox-image');
            img.style.transform = `rotate(${currentRotation}deg) scale(${viewerState.scale}) translate(${viewerState.panX}px, ${viewerState.panY}px)`;
        }
        
        function zoomImage(delta) {
            const img = document.getElementById('lightbox-image');
            viewerState.scale = Math.max(1, Math.min(8, viewerState.scale + delta));
            
            if (viewerState.scale === 1) {
                img.classList.remove('zoomed');
                viewerState.panX = 0;
                viewerState.panY = 0;
                img.style.cursor = 'zoom-in';
            } else {
                img.classList.add('zoomed');
                img.style.cursor = 'grab';
            }
            updateImageTransform();
        }
        
        // Mouse wheel zoom
        document.addEventListener('wheel', function(e) {
            const lightbox = document.getElementById('photo-lightbox');
            if (!lightbox.classList.contains('active')) return;
            const img = document.getElementById('lightbox-image');
            if (!img) return;
            const rect = img.getBoundingClientRect();
            if (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom) {
                e.preventDefault();
                zoomImage(e.deltaY < 0 ? 0.5 : -0.5);
            }
        }, { passive: false });
        
        // Pan with mouse drag
        document.addEventListener('mousedown', function(e) {
            const img = document.getElementById('lightbox-image');
            if (!img || !img.classList.contains('zoomed') || e.target !== img) return;
            viewerState.isPanning = true;
            viewerState.startX = e.clientX - viewerState.panX;
            viewerState.startY = e.clientY - viewerState.panY;
            img.style.cursor = 'grabbing';
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!viewerState.isPanning) return;
            viewerState.panX = e.clientX - viewerState.startX;
            viewerState.panY = e.clientY - viewerState.startY;
            updateImageTransform();
        });
        
        document.addEventListener('mouseup', function() {
            if (viewerState.isPanning) {
                viewerState.isPanning = false;
                const img = document.getElementById('lightbox-image');
                if (img && img.classList.contains('zoomed')) img.style.cursor = 'grab';
            }
        });
        
        // Touch pan + pinch zoom (mobile)
        let touchStartDist = 0;
        document.addEventListener('touchstart', function(e) {
            const img = document.getElementById('lightbox-image');
            if (!img || e.target !== img) return;
            if (e.touches.length === 1 && img.classList.contains('zoomed')) {
                viewerState.isPanning = true;
                viewerState.startX = e.touches[0].clientX - viewerState.panX;
                viewerState.startY = e.touches[0].clientY - viewerState.panY;
                e.preventDefault();
            } else if (e.touches.length === 2) {
                touchStartDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchmove', function(e) {
            const img = document.getElementById('lightbox-image');
            if (!img || e.target !== img) return;
            if (e.touches.length === 1 && viewerState.isPanning) {
                viewerState.panX = e.touches[0].clientX - viewerState.startX;
                viewerState.panY = e.touches[0].clientY - viewerState.startY;
                updateImageTransform();
                e.preventDefault();
            } else if (e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                zoomImage((dist - touchStartDist) * 0.01);
                touchStartDist = dist;
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchend', function() { viewerState.isPanning = false; });
        
        function closeLightbox() {
            document.getElementById('photo-lightbox').classList.remove('active');
            document.body.style.overflow = '';
            const img = document.getElementById('lightbox-image');
            img.classList.remove('zoomed');
            img.classList.remove('sharpened');
            img.style.transform = '';
            img.style.cursor = 'zoom-in';
            currentRotation = 0;
            viewerState = { scale: 1, panX: 0, panY: 0, isPanning: false, startX: 0, startY: 0 };
        }
        
        function closeLightboxOnBackground(event) {
            // Fermer seulement si on clique sur le fond noir
            if (event.target.id === 'photo-lightbox') {
                closeLightbox();
            }
        }
        
        // Navigation au clavier
        document.addEventListener('keydown', function(e) {
            const lightbox = document.getElementById('photo-lightbox');
            if (!lightbox.classList.contains('active')) return;
            
            switch(e.key) {
                case 'Escape':
                    closeLightbox();
                    break;
                case 'ArrowLeft':
                    navigateLightbox(-1);
                    break;
                case 'ArrowRight':
                    navigateLightbox(1);
                    break;
                case ' ':
                    e.preventDefault();
                    toggleZoom();
                    break;
            }
        });

        function viewReceptionPhotos(id, startIndex = 0) {
            // Utiliser la lightbox directement
            openLightbox(id, startIndex);
        }

        function editReception(id) {
            const reception = receptions.find(r => r.id === id);
            if (!reception) return;
            
            // Remplir le formulaire avec les donn√©es existantes
            document.getElementById('reception-date').value = reception.date;
            document.getElementById('reception-heure').value = reception.heure;
            document.getElementById('reception-bon-livraison').value = reception.bonLivraison;
            document.getElementById('reception-fournisseur').value = reception.fournisseur;
            document.getElementById('reception-temperature').value = reception.temperature || '';
            document.getElementById('reception-commentaires').value = reception.commentaires || '';
            
            // Charger les photos
            currentPhotos = reception.photos ? [...reception.photos] : [];
            updatePhotosPreview();
            
            // Supprimer l'entr√©e existante temporairement
            const receptionIndex = receptions.findIndex(r => r.id === id);
            if (receptionIndex > -1) {
                receptions.splice(receptionIndex, 1);
                displayReceptions();
            }
            
            // Faire d√©filer vers le formulaire
            document.getElementById('reception-date').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('reception-date').focus();
            
            showAlert(`Modification de la r√©ception "${reception.bonLivraison}" - Modifiez les champs et cliquez sur "Enregistrer"`, 'success');
        }

        function closeReceptionDetail() {
            document.getElementById('reception-detail-modal').style.display = 'none';
        }

        function closePhotoViewer() {
            document.getElementById('photo-viewer-modal').style.display = 'none';
        }

        // Impression de l'historique des r√©ceptions en PDF
        function printReceptionsHistory() {
            const receptionsToShow = filteredReceptions.length > 0 ? filteredReceptions : receptions;
            
            if (receptionsToShow.length === 0) {
                showAlert('Aucune r√©ception √† imprimer', 'warning');
                return;
            }
            
            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '_blank');
            
            const totalReceptions = receptionsToShow.length;
            const dateDebut = receptionsToShow.length > 0 ? receptionsToShow[receptionsToShow.length - 1].date : '';
            const dateFin = receptionsToShow.length > 0 ? receptionsToShow[0].date : '';
            
            // Construire le HTML pour l'impression
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Historique des R√©ceptions - ${new Date().toLocaleDateString('fr-FR')}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: Arial, sans-serif; 
                            padding: 20mm;
                            color: #000;
                            font-size: 11pt;
                        }
                        
                        .header {
                            border-bottom: 3px solid #8B4513;
                            padding-bottom: 15px;
                            margin-bottom: 25px;
                        }
                        
                        .header h1 {
                            color: #8B4513;
                            font-size: 24pt;
                            margin-bottom: 8px;
                        }
                        
                        .header-info {
                            display: flex;
                            justify-content: space-between;
                            margin-top: 12px;
                            font-size: 10pt;
                            color: #666;
                        }
                        
                        .summary-box {
                            background: #f8f9fa;
                            border: 2px solid #dee2e6;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 25px;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        }
                        
                        .summary-item {
                            text-align: center;
                        }
                        
                        .summary-number {
                            font-size: 20pt;
                            font-weight: bold;
                            color: #8B4513;
                        }
                        
                        .summary-label {
                            font-size: 9pt;
                            color: #666;
                            margin-top: 4px;
                        }
                        
                        .reception-card {
                            border: 2px solid #dee2e6;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 15px;
                            page-break-inside: avoid;
                        }
                        
                        .reception-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                            padding-bottom: 10px;
                            border-bottom: 1px solid #dee2e6;
                        }
                        
                        .reception-number {
                            font-size: 14pt;
                            font-weight: bold;
                            color: #8B4513;
                        }
                        
                        .reception-date {
                            font-size: 10pt;
                            color: #666;
                        }
                        
                        .reception-details {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                            margin-top: 10px;
                        }
                        
                        .detail-row {
                            display: flex;
                            gap: 8px;
                            font-size: 10pt;
                        }
                        
                        .detail-label {
                            font-weight: bold;
                            color: #333;
                            min-width: 120px;
                        }
                        
                        .detail-value {
                            color: #000;
                        }
                        
                        .reception-comments {
                            margin-top: 12px;
                            padding: 10px;
                            background: #f8f9fa;
                            border-left: 4px solid #8B4513;
                            font-size: 9pt;
                            font-style: italic;
                        }
                        
                        .photos-indicator {
                            display: inline-block;
                            background: #d4edda;
                            color: #155724;
                            padding: 4px 10px;
                            border-radius: 4px;
                            font-size: 9pt;
                            font-weight: bold;
                            margin-top: 8px;
                        }
                        
                        .footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 2px solid #dee2e6;
                            text-align: center;
                            font-size: 9pt;
                            color: #666;
                        }
                        
                        @media print {
                            body { padding: 10mm; }
                            .no-print { display: none; }
                            @page { 
                                margin: 15mm;
                                size: A4 portrait;
                            }
                        }
                        
                        .print-button {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #8B4513;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 14pt;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                            z-index: 1000;
                        }
                        
                        .print-button:hover {
                            background: #6d3410;
                        }
                    </style>
                </head>
                <body>
                    <button class="print-button no-print" onclick="window.print()">üñ®Ô∏è Imprimer / Sauvegarder PDF</button>
                    
                    <div class="header">
                        <h1>üì¶ Historique des R√©ceptions de Marchandises</h1>
                        <div style="font-size: 12pt; color: #666; margin-top: 8px;">
                            ${generalSettings.entreprise || 'Emotions Chocolats - Couthuin, Belgium'}
                        </div>
                        <div class="header-info">
                            <div>
                                <strong>Document g√©n√©r√© le :</strong> ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}
                            </div>
                            <div>
                                <strong>P√©riode :</strong> ${dateDebut ? formatDate(dateDebut) : 'N/A'} au ${dateFin ? formatDate(dateFin) : 'N/A'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-box">
                        <div class="summary-item">
                            <div class="summary-number">${totalReceptions}</div>
                            <div class="summary-label">R√©ceptions Total</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number">${new Set(receptionsToShow.map(r => r.fournisseur)).size}</div>
                            <div class="summary-label">Fournisseurs Diff√©rents</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number">${receptionsToShow.reduce((sum, r) => sum + (r.photos ? r.photos.length : 0), 0)}</div>
                            <div class="summary-label">Photos Document√©es</div>
                        </div>
                    </div>
                    
                    ${receptionsToShow.map((reception, index) => {
                        const bonLivraison = reception.bon_livraison || reception.bonLivraison;
                        const photosCount = reception.photos ? reception.photos.length : 0;
                        
                        return `
                            <div class="reception-card">
                                <div class="reception-header">
                                    <div>
                                        <div class="reception-number">üì¶ ${bonLivraison}</div>
                                        <div class="reception-date">${formatDate(reception.date)} √† ${reception.heure}</div>
                                    </div>
                                    <div style="text-align: right; font-size: 10pt; color: #666;">
                                        R√©ception n¬∞${index + 1} / ${totalReceptions}
                                    </div>
                                </div>
                                
                                <div class="reception-details">
                                    <div class="detail-row">
                                        <span class="detail-label">üè≠ Fournisseur :</span>
                                        <span class="detail-value">${reception.fournisseur}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">üå°Ô∏è Temp√©rature :</span>
                                        <span class="detail-value">${reception.temperature !== null ? reception.temperature + '¬∞C' : 'Non renseign√©e'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">üìÖ Date r√©ception :</span>
                                        <span class="detail-value">${formatDate(reception.date)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">‚è∞ Heure :</span>
                                        <span class="detail-value">${reception.heure}</span>
                                    </div>
                                </div>
                                
                                ${photosCount > 0 ? `
                                <div class="photos-indicator">
                                    üì∏ ${photosCount} photo(s) disponible(s) dans le syst√®me
                                </div>
                                ` : ''}
                                
                                ${reception.commentaires ? `
                                <div class="reception-comments">
                                    <strong>üí¨ Commentaires :</strong><br>
                                    ${reception.commentaires}
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                    
                    <div class="footer">
                        <p>Document g√©n√©r√© automatiquement par le Syst√®me de Tra√ßabilit√© Chocolaterie</p>
                        <p style="margin-top: 8px;">
                            <strong>Instructions :</strong> Utilisez Ctrl+P (Windows) ou Cmd+P (Mac) pour imprimer ou sauvegarder en PDF
                        </p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Attendre que le contenu soit charg√© avant d'afficher la fen√™tre
            printWindow.onload = function() {
                showAlert(`‚úÖ Fen√™tre d'impression ouverte avec ${totalReceptions} r√©ception(s)\n\nUtilisez Ctrl+P pour imprimer ou sauvegarder en PDF`, 'success');
            };
        }

        // Gestion des photos
        // ============================================
        // PHOTO INTELLIGENTE - SYST√àME COMPLET
        // ============================================
        
        let lightAnalysisInterval = null;
        let lastFrameData = null;
        let stabilityCounter = 0;
        let tempOriginalPhoto = null;
        let tempEnhancedPhoto = null;
        
        function startCamera() {
            const video = document.getElementById('camera-video');
            const cameraSection = document.getElementById('camera-section');
            const enhancementPreview = document.getElementById('enhancement-preview');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('La cam√©ra n\'est pas support√©e sur ce navigateur', 'warning');
                return;
            }
            
            // R√©initialiser l'√©tat
            enhancementPreview.classList.remove('active');
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            })
            .then(stream => {
                cameraStream = stream;
                video.srcObject = stream;
                video.play();
                cameraSection.style.display = 'block';
                
                // D√©marrer l'analyse de luminosit√© et stabilit√©
                startLightAnalysis();
            })
            .catch(error => {
                console.error('Erreur d\'acc√®s √† la cam√©ra:', error);
                showAlert('Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions.', 'danger');
            });
        }

        function stopCamera() {
            const cameraSection = document.getElementById('camera-section');
            const video = document.getElementById('camera-video');
            const enhancementPreview = document.getElementById('enhancement-preview');
            
            // Arr√™ter l'analyse
            stopLightAnalysis();
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.srcObject = null;
            cameraSection.style.display = 'none';
            enhancementPreview.classList.remove('active');
        }
        
        function startLightAnalysis() {
            const video = document.getElementById('camera-video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            lightAnalysisInterval = setInterval(() => {
                if (!video.videoWidth) return;
                
                // Analyser un √©chantillon de l'image (plus rapide)
                canvas.width = 100;
                canvas.height = 75;
                ctx.drawImage(video, 0, 0, 100, 75);
                
                const imageData = ctx.getImageData(0, 0, 100, 75);
                const data = imageData.data;
                
                // Calculer la luminosit√© moyenne
                let totalBrightness = 0;
                for (let i = 0; i < data.length; i += 4) {
                    totalBrightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
                }
                const avgBrightness = totalBrightness / (data.length / 4);
                
                // Mettre √† jour l'indicateur de luminosit√©
                updateLightIndicator(avgBrightness);
                
                // Analyser la stabilit√© (comparaison avec frame pr√©c√©dente)
                if (lastFrameData) {
                    let diff = 0;
                    for (let i = 0; i < data.length; i += 16) {
                        diff += Math.abs(data[i] - lastFrameData[i]);
                    }
                    const avgDiff = diff / (data.length / 16);
                    
                    if (avgDiff < 5) {
                        stabilityCounter++;
                    } else {
                        stabilityCounter = Math.max(0, stabilityCounter - 2);
                    }
                    
                    updateStabilityIndicator(stabilityCounter);
                }
                
                lastFrameData = new Uint8ClampedArray(data);
                
            }, 200);
        }
        
        function stopLightAnalysis() {
            if (lightAnalysisInterval) {
                clearInterval(lightAnalysisInterval);
                lightAnalysisInterval = null;
            }
            lastFrameData = null;
            stabilityCounter = 0;
        }
        
        function updateLightIndicator(brightness) {
            const indicator = document.getElementById('light-indicator');
            const status = document.getElementById('light-status');
            
            if (brightness < 60) {
                indicator.className = 'camera-indicator bad';
                status.textContent = '‚ö†Ô∏è Trop sombre';
            } else if (brightness > 200) {
                indicator.className = 'camera-indicator bad';
                status.textContent = '‚ö†Ô∏è Trop clair';
            } else if (brightness < 90 || brightness > 170) {
                indicator.className = 'camera-indicator warning';
                status.textContent = 'üí° Lumi√®re moyenne';
            } else {
                indicator.className = 'camera-indicator good';
                status.textContent = '‚úÖ Lumi√®re OK';
            }
        }
        
        function updateStabilityIndicator(counter) {
            const indicator = document.getElementById('stability-indicator');
            const status = document.getElementById('stability-status');
            
            if (counter < 3) {
                indicator.className = 'camera-indicator warning';
                status.textContent = 'üì± Stabilisez...';
            } else if (counter < 6) {
                indicator.className = 'camera-indicator warning';
                status.textContent = 'üì± Presque stable';
            } else {
                indicator.className = 'camera-indicator good';
                status.textContent = '‚úÖ Stable';
            }
        }
        
        function toggleCameraGrid() {
            const grid = document.getElementById('camera-grid');
            const toggle = document.getElementById('toggle-grid');
            grid.style.display = toggle.checked ? 'block' : 'none';
        }
        
        // Capture intelligente avec countdown
        async function smartCapture() {
            const btn = document.getElementById('btn-smart-capture');
            const countdownEl = document.getElementById('capture-countdown');
            
            btn.disabled = true;
            
            // Countdown 3-2-1
            for (let i = 3; i >= 1; i--) {
                countdownEl.textContent = i;
                countdownEl.style.display = 'block';
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            countdownEl.textContent = 'üì∏';
            await new Promise(resolve => setTimeout(resolve, 300));
            countdownEl.style.display = 'none';
            
            // Capturer et am√©liorer
            captureAndEnhance();
            
            btn.disabled = false;
        }
        
        // Capture rapide (sans countdown)
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('photo-canvas');
            const context = canvas.getContext('2d');
            
            if (!video.videoWidth || !video.videoHeight) {
                showAlert('La cam√©ra n\'est pas pr√™te. Veuillez patienter.', 'warning');
                return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            context.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photo = {
                        id: Date.now(),
                        data: e.target.result,
                        timestamp: new Date().toISOString(),
                        source: 'camera-quick'
                    };
                    
                    currentPhotos.push(photo);
                    updatePhotosPreview();
                    
                    showAlert('üì∏ Photo captur√©e (rapide) !', 'success');
                    stopCamera();
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.85);
        }
        
        // Capturer et am√©liorer
        function captureAndEnhance() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('photo-canvas');
            const enhancementCanvas = document.getElementById('enhancement-canvas');
            const context = canvas.getContext('2d');
            
            if (!video.videoWidth || !video.videoHeight) {
                showAlert('La cam√©ra n\'est pas pr√™te.', 'warning');
                return;
            }
            
            // Capturer l'original
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            // Sauvegarder l'original
            tempOriginalPhoto = canvas.toDataURL('image/jpeg', 0.95);
            
            // Am√©liorer l'image
            enhancementCanvas.width = video.videoWidth;
            enhancementCanvas.height = video.videoHeight;
            const enhCtx = enhancementCanvas.getContext('2d');
            enhCtx.drawImage(video, 0, 0);
            
            // Appliquer les am√©liorations
            const enhancements = enhanceImage(enhancementCanvas);
            
            // Sauvegarder l'am√©lior√©e
            tempEnhancedPhoto = enhancementCanvas.toDataURL('image/jpeg', 0.88);
            
            // Afficher la pr√©visualisation
            showEnhancementPreview(enhancements);
        }
        
        // Am√©lioration de l'image
        function enhanceImage(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Analyser l'image pour d√©terminer les ajustements n√©cessaires
            let totalBrightness = 0;
            let minBrightness = 255;
            let maxBrightness = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                totalBrightness += brightness;
                minBrightness = Math.min(minBrightness, brightness);
                maxBrightness = Math.max(maxBrightness, brightness);
            }
            
            const avgBrightness = totalBrightness / (data.length / 4);
            const contrast = maxBrightness - minBrightness;
            
            // Calculer les ajustements automatiques
            let brightnessAdjust = 0;
            let contrastAdjust = 1;
            
            // Ajuster la luminosit√© si n√©cessaire
            if (avgBrightness < 100) {
                brightnessAdjust = Math.min(40, (100 - avgBrightness) * 0.5);
            } else if (avgBrightness > 170) {
                brightnessAdjust = Math.max(-30, (170 - avgBrightness) * 0.4);
            }
            
            // Ajuster le contraste si n√©cessaire
            if (contrast < 150) {
                contrastAdjust = 1 + (150 - contrast) / 500;
            }
            contrastAdjust = Math.min(1.3, Math.max(1, contrastAdjust));
            
            // Appliquer les ajustements
            for (let i = 0; i < data.length; i += 4) {
                // Luminosit√©
                data[i] = Math.min(255, Math.max(0, data[i] + brightnessAdjust));
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + brightnessAdjust));
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + brightnessAdjust));
                
                // Contraste
                data[i] = Math.min(255, Math.max(0, ((data[i] - 128) * contrastAdjust) + 128));
                data[i + 1] = Math.min(255, Math.max(0, ((data[i + 1] - 128) * contrastAdjust) + 128));
                data[i + 2] = Math.min(255, Math.max(0, ((data[i + 2] - 128) * contrastAdjust) + 128));
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            const sharpnessBoost = contrast < 120 ? 15 : 8;
            
            return {
                brightness: Math.round(brightnessAdjust),
                contrast: Math.round((contrastAdjust - 1) * 100),
                sharpness: sharpnessBoost
            };
        }
        
        function showEnhancementPreview(enhancements) {
            const preview = document.getElementById('enhancement-preview');
            const originalImg = document.getElementById('preview-original');
            const enhancedImg = document.getElementById('preview-enhanced');
            
            originalImg.src = tempOriginalPhoto;
            enhancedImg.src = tempEnhancedPhoto;
            
            // Afficher les stats
            document.getElementById('stat-brightness').textContent = 
                (enhancements.brightness >= 0 ? '+' : '') + enhancements.brightness + '%';
            document.getElementById('stat-contrast').textContent = 
                '+' + enhancements.contrast + '%';
            document.getElementById('stat-sharpness').textContent = 
                '+' + enhancements.sharpness + '%';
            
            // Calculer la taille approximative
            const sizeKB = Math.round(tempEnhancedPhoto.length * 0.75 / 1024);
            document.getElementById('stat-size').textContent = sizeKB + ' KB';
            
            // Afficher la preview
            preview.classList.add('active');
            
            // Masquer la section cam√©ra
            document.querySelector('.smart-camera-container').style.display = 'none';
            document.querySelector('.camera-indicators').style.display = 'none';
            document.querySelector('.smart-capture-buttons').style.display = 'none';
        }
        
        function acceptEnhancedPhoto() {
            const photo = {
                id: Date.now(),
                data: tempEnhancedPhoto,
                timestamp: new Date().toISOString(),
                source: 'camera-enhanced'
            };
            
            currentPhotos.push(photo);
            updatePhotosPreview();
            
            showAlert('‚ú® Photo am√©lior√©e ajout√©e !', 'success');
            cleanupAndClose();
        }
        
        function useOriginalPhoto() {
            const photo = {
                id: Date.now(),
                data: tempOriginalPhoto,
                timestamp: new Date().toISOString(),
                source: 'camera-original'
            };
            
            currentPhotos.push(photo);
            updatePhotosPreview();
            
            showAlert('üì∑ Photo originale ajout√©e !', 'success');
            cleanupAndClose();
        }
        
        function retakePhoto() {
            tempOriginalPhoto = null;
            tempEnhancedPhoto = null;
            
            document.getElementById('enhancement-preview').classList.remove('active');
            document.querySelector('.smart-camera-container').style.display = 'inline-block';
            document.querySelector('.camera-indicators').style.display = 'flex';
            document.querySelector('.smart-capture-buttons').style.display = 'flex';
        }
        
        function cleanupAndClose() {
            tempOriginalPhoto = null;
            tempEnhancedPhoto = null;
            stopCamera();
        }

        function selectFromGallery() {
            document.getElementById('gallery-input').click();
        }

        function handleGallerySelect(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) return;
            
            let processedFiles = 0;
            const totalFiles = files.length;
            
            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    processedFiles++;
                    if (processedFiles === totalFiles) {
                        showAlert(`${totalFiles} fichier(s) trait√©(s)`, 'success');
                    }
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Am√©liorer aussi les images de la galerie
                    enhanceGalleryImage(e.target.result, file.name).then(enhancedData => {
                        const photo = {
                            id: Date.now() + Math.random(),
                            data: enhancedData,
                            timestamp: new Date().toISOString(),
                            source: 'gallery-enhanced',
                            filename: file.name
                        };
                        
                        currentPhotos.push(photo);
                        processedFiles++;
                        
                        if (processedFiles === totalFiles) {
                            updatePhotosPreview();
                            showAlert(`‚ú® ${totalFiles} photo(s) ajout√©e(s) et am√©lior√©e(s) !`, 'success');
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
            
            // R√©initialiser l'input
            event.target.value = '';
        }
        
        // Am√©liorer les images de la galerie
        function enhanceGalleryImage(dataUrl, filename) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Redimensionner si trop grande (max 1920px)
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 1920;
                    
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = Math.round(height * maxSize / width);
                            width = maxSize;
                        } else {
                            width = Math.round(width * maxSize / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Appliquer les am√©liorations
                    enhanceImage(canvas);
                    
                    // Retourner l'image am√©lior√©e
                    resolve(canvas.toDataURL('image/jpeg', 0.88));
                };
                img.onerror = function() {
                    // En cas d'erreur, retourner l'original
                    resolve(dataUrl);
                };
                img.src = dataUrl;
            });
        }

        function updatePhotosPreview() {
            const preview = document.getElementById('photos-preview');
            const count = document.getElementById('photos-count');
            
            count.textContent = `${currentPhotos.length} photo(s) s√©lectionn√©e(s)`;
            
            if (currentPhotos.length === 0) {
                preview.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">Aucune photo</div>';
                return;
            }
            
            preview.innerHTML = currentPhotos.map((photo, index) => `
                <div style="position: relative; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                    <img src="${photo.data}" alt="Photo ${index + 1}" 
                         style="width: 100%; height: 80px; object-fit: cover;">
                    <button onclick="removePhoto(${index})" 
                            style="position: absolute; top: 5px; right: 5px; background: rgba(220,53,69,0.8); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">
                        √ó
                    </button>
                    <div style="padding: 5px; font-size: 10px; text-align: center; color: #666;">
                        ${photo.source === 'camera' ? 'üì∑' : 'üñºÔ∏è'}
                    </div>
                </div>
            `).join('');
        }

        function removePhoto(index) {
            if (index >= 0 && index < currentPhotos.length) {
                currentPhotos.splice(index, 1);
                updatePhotosPreview();
                showAlert('Photo supprim√©e', 'success');
            }
        }

        function clearPhotos() {
            currentPhotos = [];
            updatePhotosPreview();
            stopCamera();
        }

        // Utilitaires de t√©l√©chargement
        function downloadFile(blob, filename) {
            try {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 100);
                
                return true;
                
            } catch (error) {
                return false;
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('Contenu copi√© dans le presse-papiers !', 'warning');
                }).catch(() => {
                    showClipboardFallback(text);
                });
            } else {
                showClipboardFallback(text);
            }
        }

        function showClipboardFallback(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('Contenu copi√© !', 'success');
                } else {
                    showAlert('Impossible de copier automatiquement.', 'warning');
                }
            } catch (err) {
                showAlert('Copie non support√©e.', 'warning');
            }
            
            document.body.removeChild(textarea);
        }

        // Statistiques et dashboard
        function updateStats() {
            const totalLots = lots.length;
            const lotsProduction = lots.filter(l => l.statut === 'production').length;
            const lotsFinis = lots.filter(l => l.statut === 'fini').length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const lotsThisMonth = lots.filter(l => {
                const date = new Date(l.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            const productionMois = lotsThisMonth
                .reduce((sum, l) => sum + getLotQuantiteKg(l), 0);
            
            document.getElementById('stat-lots-total').textContent = totalLots;
            document.getElementById('stat-lots-production').textContent = lotsProduction;
            document.getElementById('stat-lots-finis').textContent = lotsFinis;
            document.getElementById('stat-production-mois').textContent = productionMois.toFixed(1);
        }

        function updateDashboard() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const weekStart = new Date(new Date().setDate(new Date().getDate() - new Date().getDay()));
            const thisWeek = lots.filter(l => new Date(l.date) >= weekStart);
            const lotsThisMonth = lots.filter(l => {
                const date = new Date(l.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            document.getElementById('dashboard-lots-semaine').textContent = thisWeek.length;
            
            const kgThisWeek = thisWeek
                .reduce((sum, l) => sum + getLotQuantiteKg(l), 0);
            document.getElementById('dashboard-kg-semaine').textContent = kgThisWeek.toFixed(1);
            
            const productCounts = {};
            const productKg = {};
            lotsThisMonth.forEach(l => {
                const nom = l.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim();
                productCounts[nom] = (productCounts[nom] || 0) + 1;
                productKg[nom] = (productKg[nom] || 0) + getLotQuantiteKg(l);
            });
            const mostPopular = Object.keys(productCounts).length > 0 
                ? Object.keys(productCounts).reduce((a, b) => productCounts[a] > productCounts[b] ? a : b)
                : '-';
            const mostPopularInfo = mostPopular !== '-' 
                ? `${mostPopular} (${productCounts[mostPopular]} lots, ${productKg[mostPopular].toFixed(1)} kg)`
                : '-';
            document.getElementById('dashboard-produits-populaires').textContent = mostPopularInfo;
            
            const recentLots = lots.slice(0, 5);
            const recentContainer = document.getElementById('recent-lots-container');
            if (recentLots.length > 0) {
                recentContainer.innerHTML = recentLots.map(lot => `
                    <div class="lot-card" style="margin-bottom: 10px;">
                        <div class="lot-header">
                            <div class="lot-number">${lot.numero}</div>
                            <div class="lot-status status-${lot.statut}">${getStatusLabel(lot.statut)}</div>
                        </div>
                        <div>${lot.produit} - ${formatQuantite(lot.quantite, lot.unite)} - ${formatDate(lot.date)}</div>
                    </div>
                `).join('');
            } else {
                recentContainer.innerHTML = '<div class="alert alert-warning">Aucun lot cr√©√©</div>';
            }
            
            updateAlerts();
        }

        function updateAlerts() {
            const alertsContainer = document.getElementById('alerts-container');
            if (!alertsContainer) return;
            
            const alerts = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Filtrer les MP non archiv√©es
            const activeMP = matieresPremi√®res.filter(mp => !mp.archived);
            
            // Alertes de stock faible
            activeMP.forEach(mp => {
                const stock = mp.quantite_actuelle ?? mp.quantiteActuelle ?? 0;
                const stockMini = mp.stock_mini ?? mp.stockMini ?? 0;
                
                if (stock <= 0) {
                    alerts.push({
                        type: 'danger',
                        icon: 'üö®',
                        message: `Stock √©puis√© : <strong>${mp.nom}</strong> (${mp.lot || 'N/A'})`,
                        itemType: 'mp',
                        itemId: mp.id
                    });
                } else if (stockMini > 0 && stock <= stockMini) {
                    alerts.push({
                        type: 'warning',
                        icon: 'üì¶',
                        message: `Stock faible : <strong>${mp.nom}</strong> - ${stock.toFixed(2)} ${mp.unite || 'kg'} (mini: ${stockMini})`,
                        itemType: 'mp',
                        itemId: mp.id
                    });
                }
            });
            
            // Alertes DLC proches (dans les 7 jours)
            activeMP.forEach(mp => {
                if (mp.dlc) {
                    const dlcDate = new Date(mp.dlc);
                    dlcDate.setHours(0, 0, 0, 0);
                    const daysUntilDLC = Math.ceil((dlcDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilDLC < 0) {
                        alerts.push({
                            type: 'danger',
                            icon: '‚õî',
                            message: `DLC d√©pass√©e : <strong>${mp.nom}</strong> (${mp.lot || 'N/A'}) - ${formatDate(mp.dlc)}`,
                            itemType: 'mp',
                            itemId: mp.id
                        });
                    } else if (daysUntilDLC <= 7) {
                        alerts.push({
                            type: 'warning',
                            icon: '‚è∞',
                            message: `DLC proche : <strong>${mp.nom}</strong> (${mp.lot || 'N/A'}) - ${formatDate(mp.dlc)} (${daysUntilDLC} jour${daysUntilDLC > 1 ? 's' : ''})`,
                            itemType: 'mp',
                            itemId: mp.id
                        });
                    }
                }
            });
            
            // Alertes DLC lots (dans les 14 jours)
            lots.forEach(lot => {
                if (lot.dlc && lot.statut !== 'vendu') {
                    const dlcDate = new Date(lot.dlc);
                    dlcDate.setHours(0, 0, 0, 0);
                    const daysUntilDLC = Math.ceil((dlcDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilDLC < 0) {
                        alerts.push({
                            type: 'danger',
                            icon: '‚õî',
                            message: `Lot p√©rim√© : <strong>${lot.numero}</strong> (${lot.produit}) - DLC: ${formatDate(lot.dlc)}`,
                            itemType: 'lot',
                            itemId: lot.id
                        });
                    } else if (daysUntilDLC <= 14) {
                        alerts.push({
                            type: 'warning',
                            icon: 'üç´',
                            message: `Lot DLC proche : <strong>${lot.numero}</strong> (${lot.produit}) - ${formatDate(lot.dlc)} (${daysUntilDLC} jour${daysUntilDLC > 1 ? 's' : ''})`,
                            itemType: 'lot',
                            itemId: lot.id
                        });
                    }
                }
            });
            
            // Trier par type (danger en premier)
            alerts.sort((a, b) => {
                if (a.type === 'danger' && b.type !== 'danger') return -1;
                if (a.type !== 'danger' && b.type === 'danger') return 1;
                return 0;
            });
            
            // Afficher les alertes
            if (alerts.length > 0) {
                alertsContainer.innerHTML = `
                    <div style="margin-bottom: 10px; color: #666; font-size: 13px;">
                        ${alerts.length} alerte${alerts.length > 1 ? 's' : ''} en cours
                    </div>
                    ${alerts.map(alert => 
                        `<div class="alert alert-${alert.type}" style="margin-bottom: 8px; padding: 12px; border-radius: 8px; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;" 
                            onclick="goToAlertItem('${alert.itemType}', ${alert.itemId})"
                            onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';"
                            onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                            ${alert.icon} ${alert.message}
                            <span style="float: right; opacity: 0.5;">‚Üí</span>
                        </div>`
                    ).join('')}
                `;
            } else {
                alertsContainer.innerHTML = '<div class="alert alert-success" style="padding: 15px; border-radius: 8px;">‚úÖ Aucune alerte en cours - Tout est en ordre !</div>';
            }
        }
        
        // Fonction pour naviguer vers l'√©l√©ment de l'alerte
        function goToAlertItem(itemType, itemId) {
            if (itemType === 'mp') {
                // Aller √† l'onglet Mati√®res Premi√®res et ouvrir l'√©dition
                goToTab('matieres-premieres');
                setTimeout(() => {
                    const mp = matieresPremi√®res.find(m => m.id === itemId);
                    if (mp) {
                        editMatierePremiere(itemId);
                    }
                }, 300);
            } else if (itemType === 'lot') {
                // Aller √† l'onglet Lots et ouvrir le d√©tail
                goToTab('consulter-lots');
                setTimeout(() => {
                    const lot = lots.find(l => l.id === itemId);
                    if (lot) {
                        viewLotDetail(itemId);
                    }
                }, 300);
            }
        }
        
        // Fonction pour naviguer vers un onglet sans event
        function goToTab(tabName) {
            // Masquer tous les contenus
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Afficher le contenu demand√©
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // Activer l'onglet correspondant
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(tabName)) {
                    tab.classList.add('active');
                }
            });
            
            // Ex√©cuter les actions sp√©cifiques √† l'onglet
            switch(tabName) {
                case 'consulter-lots':
                    populateProductFilter();
                    applyLotsFilters();
                    break;
                case 'matieres-premieres':
                    refreshAllMPLists();
                    displayMatieresPremi√®res();
                    checkStockAlerts();
                    updateMPFilters();
                    break;
            }
        }

        function updateRapportStats() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const thisMonthLots = lots.filter(l => {
                const date = new Date(l.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            document.getElementById('rapport-lots-mois').textContent = thisMonthLots.length;
            
            const kgThisMonth = thisMonthLots
                .reduce((sum, l) => sum + getLotQuantiteKg(l), 0);
            document.getElementById('rapport-production-mois').textContent = kgThisMonth.toFixed(1);
            
            const totalCost = thisMonthLots.reduce((sum, l) => sum + (l.cout || 0), 0);
            const avgCost = thisMonthLots.length > 0 ? totalCost / thisMonthLots.length : 0;
            document.getElementById('rapport-cout-moyen').textContent = avgCost.toFixed(2);
            
            const avgNote = controlesQualite.length > 0 ? 
                controlesQualite.reduce((sum, cq) => sum + (cq.note || 0), 0) / controlesQualite.length : 0;
            document.getElementById('rapport-note-qualite').textContent = avgNote.toFixed(1);
        }
        
        // ============================================
        // SYST√àME D'ARCHIVAGE DES MATI√àRES PREMI√àRES
        // ============================================
        
        function checkIfEligibleForArchive(mp) {
            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            
            // Stock √† 0 depuis 30 jours
            if (quantiteActuelle === 0 && mp.stock_zero_since) {
                const daysSinceZero = Math.floor((new Date() - new Date(mp.stock_zero_since)) / (1000 * 60 * 60 * 24));
                if (daysSinceZero >= 30) return true;
            }
            
            // DLC d√©pass√©e
            if (mp.dlc && new Date(mp.dlc) < new Date()) {
                return true;
            }
            
            return false;
        }
        
        async function archiveMatierePremiere(id, reason) {
            const mp = matieresPremi√®res.find(m => m.id === id);
            if (!mp) return;
            
            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
            
            let reasonText = '';
            if (reason === 'manuel') {
                reasonText = 'üì¶ Archiv√© manuellement';
            } else if (reason === 'stock-zero') {
                reasonText = 'üìâ Stock √©puis√© (0 kg depuis 30 jours)';
            } else if (reason === 'perime') {
                reasonText = 'üìÖ DLC d√©pass√©e';
            }
            
            showConfirmModal(
                'üì¶ Archiver cette mati√®re premi√®re ?',
                `Voulez-vous archiver "${mp.nom}" (Lot: ${mp.lot}) ?\n\nRaison : ${reasonText}\n\n‚úÖ La MP sera retir√©e de la liste active\n‚úÖ Elle restera visible dans l'historique des lots\n‚úÖ Vous pourrez la r√©activer si besoin`,
                async () => {
                    console.log('üîÑ Archivage de la MP:', mp.nom);
                    console.log('üìä Avant archivage:', { archived: mp.archived, archived_at: mp.archived_at, archived_reason: mp.archived_reason });
                    
                    mp.archived = true;
                    mp.archived_at = new Date().toISOString();
                    mp.archived_reason = reason;
                    
                    console.log('üìä Apr√®s modification:', { archived: mp.archived, archived_at: mp.archived_at, archived_reason: mp.archived_reason });
                    console.log('üíæ Tentative de sauvegarde dans Supabase...');
                    
                    // Sauvegarder dans Supabase avec v√©rification
                    const result = await saveToSupabase('matieres_premieres', mp, true);
                    
                    console.log('üìä R√©sultat sauvegarde:', result);
                    
                    if (result.success && !result.offline) {
                        console.log('‚úÖ MP archiv√©e et sauvegard√©e dans Supabase');
                        showAlert(`üì¶ "${mp.nom}" archiv√©e avec succ√®s !\n\n${reasonText}\n\n‚úÖ [Synchronis√© Supabase ‚òÅÔ∏è]`, 'success');
                    } else if (result.offline) {
                        console.log('‚ö†Ô∏è MP archiv√©e localement - Mode hors ligne');
                        showAlert(`üì¶ "${mp.nom}" archiv√©e localement !\n\n${reasonText}\n\n‚ö†Ô∏è [Sync √† la reconnexion]`, 'warning');
                    } else {
                        console.error('‚ùå Erreur sauvegarde Supabase:', result.error);
                        showAlert(`üì¶ "${mp.nom}" archiv√©e localement !\n\n${reasonText}\n\n‚ö†Ô∏è [Erreur Supabase - donn√©es locales uniquement]`, 'warning');
                    }
                    
                    // Mettre √† jour les interfaces
                    refreshAllMPLists();
                    displayMatieresPremi√®res();
                    displayInventaire();
                    checkStockAlerts();
                    checkInventaireAlerts();
                    updateIngredientsSelect();
                    updateRecipeIngredientSelect();
                    updateMPFilters();
                    updateStats();
                    updateDashboard();
                }
            );
        }
        
        async function unarchiveMatierePremiere(id) {
            const mp = matieresPremi√®res.find(m => m.id === id);
            if (!mp) return;
            
            showConfirmModal(
                'üîÑ R√©activer cette mati√®re premi√®re ?',
                `Voulez-vous r√©activer "${mp.nom}" (Lot: ${mp.lot}) ?\n\n‚úÖ La MP redeviendra disponible pour cr√©er des lots\n‚úÖ Elle r√©appara√Ætra dans la liste active`,
                async () => {
                    console.log('üîÑ R√©activation de la MP:', mp.nom);
                    console.log('üìä Avant r√©activation:', { archived: mp.archived, archived_at: mp.archived_at, archived_reason: mp.archived_reason });
                    
                    mp.archived = false;
                    mp.archived_at = null;
                    mp.archived_reason = null;
                    
                    console.log('üìä Apr√®s modification:', { archived: mp.archived, archived_at: mp.archived_at, archived_reason: mp.archived_reason });
                    console.log('üíæ Tentative de sauvegarde dans Supabase...');
                    
                    // Sauvegarder dans Supabase avec v√©rification
                    const result = await saveToSupabase('matieres_premieres', mp, true);
                    
                    console.log('üìä R√©sultat sauvegarde:', result);
                    
                    if (result.success && !result.offline) {
                        console.log('‚úÖ MP r√©activ√©e et sauvegard√©e dans Supabase');
                        showAlert(`üîÑ "${mp.nom}" r√©activ√©e avec succ√®s !\n\n‚úÖ [Synchronis√© Supabase ‚òÅÔ∏è]`, 'success');
                    } else if (result.offline) {
                        console.log('‚ö†Ô∏è MP r√©activ√©e localement - Mode hors ligne');
                        showAlert(`üîÑ "${mp.nom}" r√©activ√©e localement !\n\n‚ö†Ô∏è [Sync √† la reconnexion]`, 'warning');
                    } else {
                        console.error('‚ùå Erreur sauvegarde Supabase:', result.error);
                        showAlert(`üîÑ "${mp.nom}" r√©activ√©e localement !\n\n‚ö†Ô∏è [Erreur Supabase - donn√©es locales uniquement]`, 'warning');
                    }
                    
                    // Mettre √† jour les interfaces
                    displayArchives();
                    updateArchivesStats();
                    refreshAllMPLists();
                    displayMatieresPremi√®res();
                    displayInventaire();
                    checkStockAlerts();
                    checkInventaireAlerts();
                    updateIngredientsSelect();
                    updateRecipeIngredientSelect();
                    updateStats();
                    updateDashboard();
                }
            );
        }
        
        function checkAutoArchive() {
            console.log('üîç V√©rification des MP √©ligibles pour archivage automatique...');
            
            const eligibleMPs = matieresPremi√®res.filter(mp => {
                if (mp.archived) return false;
                return checkIfEligibleForArchive(mp);
            });
            
            console.log(`üìä ${eligibleMPs.length} MP √©ligible(s) trouv√©e(s)`);
            
            if (eligibleMPs.length === 0) {
                showAlert('‚úÖ Aucune mati√®re premi√®re √©ligible pour archivage automatique', 'success');
                return;
            }
            
            const alertsHTML = `
                <div style="max-width: 800px;">
                    <h2>üîç Mati√®res Premi√®res √âligibles pour Archivage</h2>
                    <p style="margin: 15px 0; color: #666;">
                        ${eligibleMPs.length} mati√®re(s) premi√®re(s) peuvent √™tre archiv√©es automatiquement :
                    </p>
                    
                    <div style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
                        ${eligibleMPs.map(mp => {
                            const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                            const isDLCExpired = mp.dlc && new Date(mp.dlc) < new Date();
                            const isStockZero = quantiteActuelle === 0;
                            
                            let reason = '';
                            if (isDLCExpired) reason = 'üìÖ DLC d√©pass√©e';
                            else if (isStockZero) reason = 'üìâ Stock √† 0';
                            
                            return `
                                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-left: 4px solid #FF9800; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <strong style="font-size: 16px;">${mp.nom}</strong>
                                            <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                                Lot: ${mp.lot} ‚Ä¢ Fournisseur: ${mp.fournisseur}
                                            </div>
                                            <div style="margin-top: 8px;">
                                                <span style="background: #FF9800; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                                    ${reason}
                                                </span>
                                            </div>
                                        </div>
                                        <button class="btn btn-small" onclick="archiveMatierePremiere(${mp.id}, '${isDLCExpired ? 'perime' : 'stock-zero'}'); closeConfirmModal();">
                                            üì¶ Archiver
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="archiveAllEligible()">üì¶ Archiver Toutes</button>
                        <button class="btn btn-secondary" onclick="closeConfirmModal()">‚ùå Fermer</button>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = '';
            document.getElementById('confirm-message').innerHTML = alertsHTML;
            document.getElementById('confirm-yes').style.display = 'none';
            document.getElementById('confirm-no').style.display = 'none';
            modal.style.display = 'block';
        }
        
        async function archiveAllEligible() {
            const eligibleMPs = matieresPremi√®res.filter(mp => {
                if (mp.archived) return false;
                return checkIfEligibleForArchive(mp);
            });
            
            if (eligibleMPs.length === 0) return;
            
            console.log(`üîÑ Archivage automatique de ${eligibleMPs.length} MP(s)...`);
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const mp of eligibleMPs) {
                const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const isDLCExpired = mp.dlc && new Date(mp.dlc) < new Date();
                const isStockZero = quantiteActuelle === 0;
                
                const reason = isDLCExpired ? 'perime' : (isStockZero ? 'stock-zero' : 'manuel');
                
                console.log(`üì¶ Archivage: ${mp.nom} (raison: ${reason})`);
                
                mp.archived = true;
                mp.archived_at = new Date().toISOString();
                mp.archived_reason = reason;
                
                const result = await saveToSupabase('matieres_premieres', mp, true);
                
                if (result.success) {
                    successCount++;
                    console.log(`‚úÖ ${mp.nom} archiv√©e avec succ√®s`);
                } else {
                    errorCount++;
                    console.error(`‚ùå Erreur archivage ${mp.nom}:`, result.error);
                }
            }
            
            const statusText = errorCount > 0 
                ? `\n\n‚ö†Ô∏è ${errorCount} erreur(s) de synchronisation Supabase` 
                : '\n\n‚úÖ [Toutes synchronis√©es Supabase ‚òÅÔ∏è]';
            
            showAlert(`üì¶ ${successCount} mati√®re(s) premi√®re(s) archiv√©e(s) automatiquement !${statusText}`, 'success');
            
            closeConfirmModal();
            filteredMatieresPremi√®res = matieresPremi√®res.filter(m => !m.archived);
            displayMatieresPremi√®res();
            checkStockAlerts();
            updateIngredientsSelect();
        }
        
        function displayArchives() {
            const tbody = document.querySelector('#archives-table tbody');
            if (!tbody) return;
            
            const archivedMPs = matieresPremi√®res.filter(mp => mp.archived);
            
            // Appliquer les filtres
            const searchTerm = document.getElementById('search-archives')?.value.toLowerCase() || '';
            const categorieFilter = document.getElementById('filter-archives-categorie')?.value || '';
            const raisonFilter = document.getElementById('filter-archives-raison')?.value || '';
            const sortBy = document.getElementById('sort-archives')?.value || 'date-desc';
            
            let filtered = archivedMPs.filter(mp => {
                const matchesSearch = !searchTerm || 
                    mp.nom.toLowerCase().includes(searchTerm) ||
                    mp.lot.toLowerCase().includes(searchTerm) ||
                    mp.fournisseur.toLowerCase().includes(searchTerm);
                
                const matchesCategorie = !categorieFilter || mp.categorie === categorieFilter;
                const matchesRaison = !raisonFilter || mp.archived_reason === raisonFilter;
                
                return matchesSearch && matchesCategorie && matchesRaison;
            });
            
            // Trier
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'date-desc':
                        return new Date(b.archived_at) - new Date(a.archived_at);
                    case 'date-asc':
                        return new Date(a.archived_at) - new Date(b.archived_at);
                    case 'nom-asc':
                        return a.nom.localeCompare(b.nom);
                    case 'nom-desc':
                        return b.nom.localeCompare(a.nom);
                    default:
                        return 0;
                }
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">Aucune mati√®re premi√®re archiv√©e</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(mp => {
                const quantiteActuelle = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const categorieLabel = getCategorieLabel(mp.categorie);
                const dlcFormatted = mp.dlc ? formatDate(mp.dlc) : 'N/A';
                
                let reasonBadge = '';
                if (mp.archived_reason === 'manuel') {
                    reasonBadge = '<span class="lot-status" style="background: #FF9800; color: white;">üì¶ Manuel</span>';
                } else if (mp.archived_reason === 'stock-zero') {
                    reasonBadge = '<span class="lot-status" style="background: #9E9E9E; color: white;">üìâ Stock 0</span>';
                } else if (mp.archived_reason === 'perime') {
                    reasonBadge = '<span class="lot-status" style="background: #F44336; color: white;">üìÖ P√©rim√©</span>';
                }
                
                return `
                    <tr style="opacity: 0.8;">
                        <td>
                            <span class="lot-status" style="font-size: 11px; padding: 4px 8px;">${categorieLabel}</span>
                        </td>
                        <td><strong>${mp.nom}</strong></td>
                        <td>${mp.lot}</td>
                        <td>${mp.fournisseur}</td>
                        <td>${quantiteActuelle.toFixed(3)} kg</td>
                        <td>${dlcFormatted}</td>
                        <td>${mp.archived_at ? formatDate(mp.archived_at.split('T')[0]) : 'N/A'}</td>
                        <td>${reasonBadge}</td>
                        <td class="actions-column">
                            <button class="btn btn-small btn-success" onclick="unarchiveMatierePremiere(${mp.id})">üîÑ R√©activer</button>
                            <button class="btn btn-small btn-danger" onclick="deleteArchivedMP(${mp.id})">üóëÔ∏è Supprimer</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateArchivesStats() {
            const archivedMPs = matieresPremi√®res.filter(mp => mp.archived);
            const epuisees = archivedMPs.filter(mp => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                return qty === 0;
            });
            const perimees = archivedMPs.filter(mp => mp.dlc && new Date(mp.dlc) < new Date());
            const valeurPerdue = archivedMPs.reduce((sum, mp) => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                return sum + (qty * (mp.cout || 0));
            }, 0);
            
            document.getElementById('archives-total').textContent = archivedMPs.length;
            document.getElementById('archives-epuisees').textContent = epuisees.length;
            document.getElementById('archives-perimees').textContent = perimees.length;
            document.getElementById('archives-valeur-perdue').textContent = valeurPerdue.toFixed(2) + ' ‚Ç¨';
        }
        
        function applyArchivesFilters() {
            displayArchives();
        }
        
        function updateArchiveFilters() {
            const categorieFilter = document.getElementById('filter-archives-categorie');
            if (!categorieFilter) return;
            
            categorieFilter.innerHTML = '<option value="">Toutes les cat√©gories</option>';
            categoriesMP.filter(cat => cat.actif).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.emoji} ${cat.nom}`;
                categorieFilter.appendChild(option);
            });
        }
        
        async function deleteArchivedMP(id) {
            const mp = matieresPremi√®res.find(m => m.id === id);
            if (!mp) return;
            
            showConfirmModal(
                'Supprimer d√©finitivement cette MP archiv√©e ?',
                `‚ö†Ô∏è ATTENTION : Vous √™tes sur le point de supprimer d√©finitivement "${mp.nom}" (Lot: ${mp.lot}).\n\nüö® Cette action est IRR√âVERSIBLE !\n\n‚ö†Ô∏è La MP sera supprim√©e de tous les historiques.`,
                async () => {
                    const mpIndex = matieresPremi√®res.findIndex(m => m.id === id);
                    if (mpIndex > -1) {
                        matieresPremi√®res.splice(mpIndex, 1);
                        await deleteFromSupabase('matieres_premieres', id);
                        showAlert(`"${mp.nom}" supprim√©e d√©finitivement`, 'success');
                        displayArchives();
                        updateArchivesStats();
                    }
                }
            );
        }
        
        function exportArchives() {
            const archivedMPs = matieresPremi√®res.filter(mp => mp.archived);
            
            if (archivedMPs.length === 0) {
                showAlert('Aucune archive √† exporter', 'warning');
                return;
            }
            
            const headers = ['Cat√©gorie', 'Mati√®re Premi√®re', 'Lot', 'Fournisseur', 'Stock Final (kg)', 'DLC', 'Date Archivage', 'Raison'];
            let csv = headers.join(';') + '\n';
            
            archivedMPs.forEach(mp => {
                const qty = mp.quantite_actuelle || mp.quantiteActuelle || 0;
                const categorie = categoriesMP.find(c => c.id === mp.categorie);
                const categorieNom = categorie ? categorie.nom : 'Autre';
                
                let reason = '';
                if (mp.archived_reason === 'manuel') reason = 'Manuel';
                else if (mp.archived_reason === 'stock-zero') reason = 'Stock √©puis√©';
                else if (mp.archived_reason === 'perime') reason = 'P√©rim√©';
                
                const row = [
                    categorieNom,
                    mp.nom,
                    mp.lot,
                    mp.fournisseur,
                    qty.toFixed(3),
                    mp.dlc || 'N/A',
                    mp.archived_at ? formatDate(mp.archived_at.split('T')[0]) : 'N/A',
                    reason
                ];
                csv += row.join(';') + '\n';
            });
            
            csv = '\uFEFF' + csv;
            const blob = new Blob([csv], { type: 'text/csv' });
            const timestamp = new Date().toISOString().split('T')[0];
            
            if (downloadFile(blob, `archives_mp_${timestamp}.csv`)) {
                showAlert(`‚úÖ ${archivedMPs.length} archive(s) export√©e(s) !`, 'success');
            } else {
                copyToClipboard(csv);
            }
        }
        
        async function syncArchivesWithSupabase() {
            if (!isOnline || !supabaseClient) {
                showAlert('‚ùå Impossible de synchroniser - Pas de connexion Supabase', 'danger');
                return;
            }
            
            const archivedMPs = matieresPremi√®res.filter(mp => mp.archived);
            
            if (archivedMPs.length === 0) {
                showAlert('‚ÑπÔ∏è Aucune archive √† synchroniser', 'success');
                return;
            }
            
            console.log(`üîÑ Re-synchronisation de ${archivedMPs.length} archives avec Supabase...`);
            
            let successCount = 0;
            let errorCount = 0;
            let errors = [];
            
            for (const mp of archivedMPs) {
                console.log(`üíæ Sync: ${mp.nom} (archived: ${mp.archived}, at: ${mp.archived_at}, reason: ${mp.archived_reason})`);
                
                const result = await saveToSupabase('matieres_premieres', mp, true);
                
                if (result.success && !result.offline) {
                    successCount++;
                    console.log(`‚úÖ ${mp.nom} synchronis√©e`);
                } else {
                    errorCount++;
                    const errorMsg = result.error ? result.error.message : 'Erreur inconnue';
                    errors.push(`${mp.nom}: ${errorMsg}`);
                    console.error(`‚ùå Erreur sync ${mp.nom}:`, result.error);
                }
            }
            
            let message = `‚úÖ Synchronisation termin√©e !\n\n`;
            message += `üìä ${successCount} archive(s) synchronis√©e(s)\n`;
            
            if (errorCount > 0) {
                message += `‚ö†Ô∏è ${errorCount} erreur(s)\n\n`;
                message += `D√©tails erreurs:\n${errors.join('\n')}`;
                showAlert(message, 'warning');
            } else {
                message += `\n‚úÖ Toutes les archives sont maintenant dans Supabase !`;
                showAlert(message, 'success');
            }
        }

        // Utilitaires
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                min-width: 400px;
                max-width: 600px;
                text-align: left;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                opacity: 0;
                transition: all 0.3s ease;
                white-space: pre-line;
                line-height: 1.6;
            `;
            
            const icon = type === 'success' ? '‚úÖ' : type === 'danger' ? 'üö®' : '‚ö†Ô∏è';
            
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <span style="font-size: 24px; flex-shrink: 0;">${icon}</span>
                    <div style="flex: 1;">${message}</div>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = '1';
                alertDiv.style.transform = 'translateX(-50%) translateY(0)';
            }, 10);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.style.opacity = '0';
                    alertDiv.style.transform = 'translateX(-50%) translateY(-20px)';
                    
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 300);
                }
            }, 6000); // Augment√© √† 6 secondes pour les messages longs
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        function getStatusLabel(status) {
            const labels = {
                'production': 'En Production',
                'fini': 'Termin√©',
                'vendu': 'Vendu'
            };
            return labels[status] || status;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Fonction throttle pour limiter les appels
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // Fonction de g√©n√©ration d'ID unique
        function generateUniqueId() {
            return Date.now() + Math.random().toString(36).substr(2, 9);
        }

        // Fonction pour copier dans le presse-papiers
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('üìã Copi√© dans le presse-papiers !', 'success');
                }).catch(err => {
                    console.error('Erreur copie:', err);
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showAlert('üìã Copi√© dans le presse-papiers !', 'success');
            } catch (err) {
                showAlert('‚ùå Erreur lors de la copie', 'danger');
            }
            document.body.removeChild(textArea);
        }

        // Fonction de t√©l√©chargement de fichier
        function downloadFile(blob, filename) {
            try {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                return true;
            } catch (err) {
                console.error('Erreur t√©l√©chargement:', err);
                return false;
            }
        }

        // ============================================
        // √âCOUTEURS ADDITIONNELS
        // ============================================
        
        // Ajouter les √©couteurs d'√©v√©nements pour la recherche avec debounce
        document.addEventListener('DOMContentLoaded', function() {
            const searchInputs = ['search-lots', 'search-inventaire', 'search-mp', 'search-receptions', 'search-archives'];
            searchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', debounce(function() {
                        applyFilters(inputId);
                    }, 300));
                }
            });
        });

        // Fonction d'application des filtres g√©n√©rique
        function applyFilters(sourceInputId) {
            switch(sourceInputId) {
                case 'search-lots':
                    applyLotsFilters();
                    break;
                case 'search-inventaire':
                    applyInventaireFilters();
                    break;
                case 'search-mp':
                    applyMPFilters();
                    break;
                case 'search-receptions':
                    applyReceptionFilters();
                    break;
                case 'search-archives':
                    applyArchivesFilters();
                    break;
            }
        }

        // ============================================
        // FONCTIONNALIT√âS AFSCA - TRA√áABILIT√â
        // ============================================
        
        /**
         * 1. Export PDF d'un lot avec tra√ßabilit√© compl√®te
         */
        function exportLotPDF(lotId) {
            const lot = lots.find(l => l.id === lotId);
            if (!lot) {
                showAlert('Lot non trouv√©', 'danger');
                return;
            }
            
            // Parser ingredients
            let ingredients = lot.ingredients;
            if (typeof ingredients === 'string') {
                try {
                    ingredients = JSON.parse(ingredients);
                } catch (e) {
                    ingredients = [];
                }
            }
            if (!Array.isArray(ingredients)) {
                ingredients = [];
            }
            
            // Normaliser les ingr√©dients
            ingredients = ingredients.map(ing => ({
                matierePremiereId: ing.matierePremiereId || ing.mpId || ing.id,
                matierePremiereNom: ing.matierePremiereNom || ing.mpNom || ing.nom || 'N/A',
                matierePremiereLot: ing.matierePremiereLot || ing.mpLot || ing.lot || 'N/A',
                matierePremiereCategorie: ing.matierePremiereCategorie || ing.categorie || 'autre',
                matierePremiereFournisseur: ing.matierePremiereFournisseur || ing.fournisseur || 'N/A',
                quantiteUtilisee: ing.quantiteUtilisee || ing.quantite || 0,
                coutUnitaire: ing.coutUnitaire || ing.cout || 0,
                coutTotal: ing.coutTotal || ((ing.quantiteUtilisee || ing.quantite || 0) * (ing.coutUnitaire || ing.cout || 0))
            }));
            
            // Cr√©er le contenu HTML du PDF
            const totalQty = ingredients.reduce((sum, ing) => sum + (ing.quantiteUtilisee || 0), 0);
            const coutTotal = ingredients.reduce((sum, ing) => sum + (ing.coutTotal || 0), 0);
            
            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rapport de Tra√ßabilit√© - Lot ${lot.numero}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
        .header { text-align: center; border-bottom: 3px solid #8B4513; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #8B4513; margin: 0 0 10px 0; }
        .header .company { font-size: 18px; color: #666; }
        .header .date { font-size: 14px; color: #999; margin-top: 10px; }
        .section { margin-bottom: 30px; }
        .section h2 { color: #8B4513; border-bottom: 2px solid #D2691E; padding-bottom: 8px; margin-bottom: 15px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .info-box { padding: 15px; background: #f8f9fa; border-left: 4px solid #8B4513; border-radius: 5px; }
        .info-label { font-size: 11px; color: #666; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
        .info-value { font-size: 16px; font-weight: bold; color: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #8B4513; color: white; padding: 12px; text-align: left; font-weight: bold; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        tr:hover { background: #f8f9fa; }
        .highlight { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; border-radius: 5px; margin-top: 20px; }
        .footer { margin-top: 50px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; font-size: 12px; color: #999; }
        .total-row { background: #e8f5e9; font-weight: bold; }
        @media print {
            body { margin: 20px; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üç´ RAPPORT DE TRA√áABILIT√â AFSCA</h1>
        <div class="company">Emotions Chocolats - Couthuin, Belgique</div>
        <div class="date">G√©n√©r√© le ${new Date().toLocaleDateString('fr-BE', { year: 'numeric', month: 'long', day: 'numeric' })} √† ${new Date().toLocaleTimeString('fr-BE')}</div>
    </div>
    
    <div class="section">
        <h2>üì¶ Informations du Lot</h2>
        <div class="info-grid">
            <div class="info-box">
                <div class="info-label">Num√©ro de Lot</div>
                <div class="info-value">${lot.numero}</div>
            </div>
            <div class="info-box">
                <div class="info-label">Produit</div>
                <div class="info-value">${lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim()}</div>
            </div>
            <div class="info-box">
                <div class="info-label">Date de Production</div>
                <div class="info-value">${formatDate(lot.date)}</div>
            </div>
            <div class="info-box">
                <div class="info-label">Op√©rateur</div>
                <div class="info-value">${lot.operateur}</div>
            </div>
            <div class="info-box">
                <div class="info-label">Quantit√© Produite</div>
                <div class="info-value">${formatQuantite(lot.quantite, lot.unite)}</div>
            </div>
            <div class="info-box">
                <div class="info-label">Date Limite de Consommation</div>
                <div class="info-value">${lot.dlc ? formatDate(lot.dlc) : 'N/A'}</div>
            </div>
        </div>
        ${lot.observations ? `
        <div class="info-box" style="margin-top: 15px;">
            <div class="info-label">Observations</div>
            <div class="info-value" style="font-style: italic; font-weight: normal;">${lot.observations}</div>
        </div>
        ` : ''}
    </div>
    
    <div class="section">
        <h2>üßÑ Mati√®res Premi√®res Utilis√©es - Tra√ßabilit√© Compl√®te</h2>
        ${ingredients.length > 0 ? `
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Mati√®re Premi√®re</th>
                    <th>Lot Fournisseur</th>
                    <th>Fournisseur</th>
                    <th>Quantit√© (kg)</th>
                    <th>Co√ªt (‚Ç¨)</th>
                </tr>
            </thead>
            <tbody>
                ${ingredients.map((ing, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${ing.matierePremiereNom}</strong><br><small style="color: #666;">${getCategorieLabel(ing.matierePremiereCategorie)}</small></td>
                    <td><strong>${ing.matierePremiereLot}</strong></td>
                    <td>${ing.matierePremiereFournisseur}</td>
                    <td>${(ing.quantiteUtilisee || 0).toFixed(3)}</td>
                    <td>${(ing.coutTotal || 0).toFixed(2)}</td>
                </tr>
                `).join('')}
                <tr class="total-row">
                    <td colspan="4" style="text-align: right; padding-right: 20px;"><strong>TOTAL</strong></td>
                    <td><strong>${totalQty.toFixed(3)} kg</strong></td>
                    <td><strong>${coutTotal.toFixed(2)} ‚Ç¨</strong></td>
                </tr>
            </tbody>
        </table>
        
        <div class="highlight">
            <strong>‚úÖ Conformit√© AFSCA</strong><br>
            Tous les ingr√©dients de ce lot sont tra√ßables jusqu'au fournisseur d'origine avec les num√©ros de lots fournisseurs.
            Cette documentation permet une tra√ßabilit√© ascendante compl√®te en cas de contr√¥le ou de rappel produit.
        </div>
        ` : `
        <div class="highlight">
            ‚ö†Ô∏è Aucun ingr√©dient enregistr√© pour ce lot.
        </div>
        `}
    </div>
    
    <div class="footer">
        ${getWatermarkText()}<br>
        Document confidentiel - Usage interne uniquement
    </div>
</body>
</html>
            `;
            
            // Cr√©er un blob et t√©l√©charger
            const blob = new Blob(['\uFEFF' + htmlContent], { type: 'text/html; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Tracabilite_Lot_${lot.numero}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert(`üìÑ Rapport de tra√ßabilit√© g√©n√©r√© !\n\nOuvrez le fichier HTML et imprimez-le en PDF depuis votre navigateur.\n(Ctrl+P ou Cmd+P puis "Enregistrer au format PDF")`, 'success');
        }
        
        /**
         * 2. Fonction pour l'historique complet (bouton existant)
         */
        function printLotsHistory() {
            if (filteredLots.length === 0) {
                showAlert('Aucun lot √† exporter', 'warning');
                return;
            }
            
            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Historique des Lots de Production</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
        .header { text-align: center; border-bottom: 3px solid #8B4513; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #8B4513; margin: 0 0 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        th { background: #8B4513; color: white; padding: 10px; text-align: left; font-weight: bold; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        tr:hover { background: #f8f9fa; }
        .footer { margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; font-size: 12px; color: #999; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Historique des Lots de Production</h1>
        <div>Emotions Chocolats - G√©n√©r√© le ${new Date().toLocaleDateString('fr-BE')}</div>
    </div>
    <table>
        <thead>
            <tr>
                <th>N¬∞ Lot</th>
                <th>Produit</th>
                <th>Date Production</th>
                <th>Quantit√©</th>
                <th>Op√©rateur</th>
                <th>DLC</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody>
            ${filteredLots.map(lot => `
            <tr>
                <td><strong>${lot.numero}</strong></td>
                <td>${lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim()}</td>
                <td>${formatDate(lot.date)}</td>
                <td>${formatQuantite(lot.quantite, lot.unite)}</td>
                <td>${lot.operateur}</td>
                <td>${lot.dlc ? formatDate(lot.dlc) : 'N/A'}</td>
                <td>${getStatusLabel(lot.statut)}</td>
            </tr>
            `).join('')}
        </tbody>
    </table>
    <div class="footer">${getWatermarkText()}</div>
</body>
</html>
            `;
            
            const blob = new Blob(['\uFEFF' + htmlContent], { type: 'text/html; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Historique_Lots_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert(`üìÑ Historique g√©n√©r√© ! Ouvrez le fichier et imprimez-le en PDF (Ctrl+P)`, 'success');
        }
        
        /**
         * 3. Recherche avanc√©e avec lots fournisseurs et fournisseurs
         */
        function applyLotsFilters() {
            const searchTerm = document.getElementById('search-lots').value.toLowerCase();
            const productFilter = document.getElementById('filter-produit').value;
            const statusFilter = document.getElementById('filter-statut').value;
            const dateDebut = document.getElementById('filter-date-debut').value;
            const dateFin = document.getElementById('filter-date-fin').value;
            
            filteredLots = lots.filter(lot => {
                // Recherche de base
                let matchesSearch = !searchTerm;
                
                if (searchTerm) {
                    // Recherche dans les champs de base
                    matchesSearch = lot.numero.toLowerCase().includes(searchTerm) ||
                                   lot.produit.toLowerCase().includes(searchTerm) ||
                                   lot.operateur.toLowerCase().includes(searchTerm);
                    
                    // NOUVEAU : Recherche dans les ingr√©dients (lots fournisseurs et fournisseurs)
                    if (!matchesSearch && lot.ingredients) {
                        let ingredients = lot.ingredients;
                        if (typeof ingredients === 'string') {
                            try {
                                ingredients = JSON.parse(ingredients);
                            } catch (e) {
                                ingredients = [];
                            }
                        }
                        if (Array.isArray(ingredients)) {
                            matchesSearch = ingredients.some(ing => {
                                const lotFournisseur = (ing.matierePremiereLot || ing.mpLot || ing.lot || '').toLowerCase();
                                const fournisseur = (ing.matierePremiereFournisseur || ing.fournisseur || '').toLowerCase();
                                const nomMP = (ing.matierePremiereNom || ing.mpNom || ing.nom || '').toLowerCase();
                                return lotFournisseur.includes(searchTerm) || 
                                       fournisseur.includes(searchTerm) ||
                                       nomMP.includes(searchTerm);
                            });
                        }
                    }
                }
                
                const matchesProduct = !productFilter || lot.produit === productFilter;
                const matchesStatus = !statusFilter || lot.statut === statusFilter;
                const matchesDateDebut = !dateDebut || lot.date >= dateDebut;
                const matchesDateFin = !dateFin || lot.date <= dateFin;
                
                return matchesSearch && matchesProduct && matchesStatus && matchesDateDebut && matchesDateFin;
            });
            
            displayLots();
        }
        
        /**
         * 4. Module de tra√ßabilit√© inverse (Recall Management)
         */
        function openTraceabilityModule() {
            const modal = document.createElement('div');
            modal.id = 'traceability-modal';
            modal.style.cssText = 'display: block; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);';
            
            modal.innerHTML = `
                <div style="background: white; margin: 5% auto; padding: 30px; border-radius: 12px; max-width: 900px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 3px solid #8B4513; padding-bottom: 15px;">
                        <h2 style="color: #8B4513; margin: 0;">üîç Tra√ßabilit√© Inverse - Recherche de Rappel</h2>
                        <button onclick="closeTraceabilityModule()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px;">‚úï</button>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 25px;">
                        <strong>‚ö†Ô∏è Module de Gestion de Rappel AFSCA</strong><br>
                        <span style="font-size: 14px;">Recherchez tous les lots de production qui contiennent une mati√®re premi√®re sp√©cifique, un lot fournisseur ou un fournisseur donn√©.</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #666;">Type de recherche :</label>
                        <select id="trace-search-type" onchange="updateTraceSearchFields()" style="width: 100%; padding: 12px; border: 2px solid #8B4513; border-radius: 8px; font-size: 14px;">
                            <option value="lot-fournisseur">Par Lot Fournisseur</option>
                            <option value="fournisseur">Par Fournisseur</option>
                            <option value="matiere-premiere">Par Mati√®re Premi√®re</option>
                        </select>
                    </div>
                    
                    <div id="trace-search-field" style="margin-bottom: 25px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #666;">Rechercher :</label>
                        <input type="text" id="trace-search-input" placeholder="Entrez le num√©ro de lot fournisseur..." style="width: 100%; padding: 12px; border: 2px solid #8B4513; border-radius: 8px; font-size: 14px;">
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 25px;">
                        <button onclick="performTraceabilitySearch()" style="background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%); color: white; border: none; padding: 15px 40px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);">
                            üîç Lancer la Recherche
                        </button>
                    </div>
                    
                    <div id="trace-results" style="margin-top: 25px;">
                        <!-- R√©sultats ici -->
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        window.closeTraceabilityModule = function() {
            const modal = document.getElementById('traceability-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        window.updateTraceSearchFields = function() {
            const searchType = document.getElementById('trace-search-type').value;
            const input = document.getElementById('trace-search-input');
            
            switch(searchType) {
                case 'lot-fournisseur':
                    input.placeholder = 'Entrez le num√©ro de lot fournisseur...';
                    break;
                case 'fournisseur':
                    input.placeholder = 'Entrez le nom du fournisseur...';
                    break;
                case 'matiere-premiere':
                    input.placeholder = 'Entrez le nom de la mati√®re premi√®re...';
                    break;
            }
        }
        
        window.performTraceabilitySearch = function() {
            const searchType = document.getElementById('trace-search-type').value;
            const searchValue = document.getElementById('trace-search-input').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('trace-results');
            
            if (!searchValue) {
                resultsDiv.innerHTML = `
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336; color: #c62828;">
                        ‚ö†Ô∏è Veuillez entrer une valeur de recherche.
                    </div>
                `;
                return;
            }
            
            // Rechercher dans tous les lots
            const affectedLots = [];
            
            lots.forEach(lot => {
                let ingredients = lot.ingredients;
                if (typeof ingredients === 'string') {
                    try {
                        ingredients = JSON.parse(ingredients);
                    } catch (e) {
                        ingredients = [];
                    }
                }
                
                if (!Array.isArray(ingredients)) return;
                
                const matchingIngredients = ingredients.filter(ing => {
                    switch(searchType) {
                        case 'lot-fournisseur':
                            const lotF = (ing.matierePremiereLot || ing.mpLot || ing.lot || '').toLowerCase();
                            return lotF.includes(searchValue);
                        case 'fournisseur':
                            const fournisseur = (ing.matierePremiereFournisseur || ing.fournisseur || '').toLowerCase();
                            return fournisseur.includes(searchValue);
                        case 'matiere-premiere':
                            const nomMP = (ing.matierePremiereNom || ing.mpNom || ing.nom || '').toLowerCase();
                            return nomMP.includes(searchValue);
                        default:
                            return false;
                    }
                });
                
                if (matchingIngredients.length > 0) {
                    affectedLots.push({
                        lot: lot,
                        matchingIngredients: matchingIngredients
                    });
                }
            });
            
            // Afficher les r√©sultats
            if (affectedLots.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                        <strong style="color: #2e7d32; font-size: 18px;">Aucun lot concern√©</strong><br>
                        <span style="color: #666; font-size: 14px;">Aucun lot de production ne contient cette mati√®re premi√®re, lot fournisseur ou fournisseur.</span>
                    </div>
                `;
            } else {
                let html = `
                    <div style="background: #ffebee; padding: 20px; border-radius: 8px; border-left: 4px solid #f44336; margin-bottom: 20px;">
                        <div style="font-size: 48px; text-align: center; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <strong style="color: #c62828; font-size: 20px; display: block; text-align: center; margin-bottom: 10px;">
                            ${affectedLots.length} lot(s) concern√©(s) !
                        </strong>
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="exportTraceabilityReport()" style="background: #f44336; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                üìÑ Exporter le Rapport de Rappel
                            </button>
                        </div>
                    </div>
                    
                    <div style="max-height: 500px; overflow-y: auto;">
                `;
                
                affectedLots.forEach(({ lot, matchingIngredients }) => {
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #f44336; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <strong style="font-size: 18px; color: #c62828;">Lot ${lot.numero}</strong><br>
                                    <span style="color: #666;">${lot.produit} - ${formatDate(lot.date)}</span><br>
                                    <span style="color: #666;">Op√©rateur: ${lot.operateur}</span>
                                </div>
                                <button onclick="exportLotPDF(${lot.id})" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    üìÑ Export PDF
                                </button>
                            </div>
                            <div style="background: #fff3e0; padding: 12px; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <strong style="color: #e65100;">Mati√®res premi√®res concern√©es :</strong>
                                ${matchingIngredients.map(ing => `
                                    <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
                                        ‚Ä¢ <strong>${ing.matierePremiereNom || ing.mpNom || ing.nom}</strong><br>
                                        <span style="font-size: 13px; color: #666;">
                                            Lot: <strong>${ing.matierePremiereLot || ing.mpLot || ing.lot || 'N/A'}</strong> | 
                                            Fournisseur: <strong>${ing.matierePremiereFournisseur || ing.fournisseur || 'N/A'}</strong> | 
                                            Quantit√©: ${((ing.quantiteUtilisee || ing.quantite || 0) * 1000).toFixed(0)}g
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
                // Stocker les r√©sultats pour l'export
                window.currentTraceabilityResults = {
                    searchType: searchType,
                    searchValue: searchValue,
                    affectedLots: affectedLots
                };
            }
        }
        
        /**
         * 5. Export du rapport de rappel
         */
        window.exportTraceabilityReport = function() {
            if (!window.currentTraceabilityResults) return;
            
            const { searchType, searchValue, affectedLots } = window.currentTraceabilityResults;
            
            const searchTypeLabels = {
                'lot-fournisseur': 'Lot Fournisseur',
                'fournisseur': 'Fournisseur',
                'matiere-premiere': 'Mati√®re Premi√®re'
            };
            
            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rapport de Rappel AFSCA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
        .header { text-align: center; border-bottom: 3px solid #f44336; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #f44336; margin: 0 0 10px 0; }
        .alert-box { background: #ffebee; padding: 20px; border: 3px solid #f44336; border-radius: 8px; margin-bottom: 30px; }
        .lot-section { background: #f8f9fa; padding: 20px; border-left: 4px solid #f44336; margin-bottom: 20px; border-radius: 8px; }
        .lot-title { color: #c62828; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .ingredient-list { background: white; padding: 15px; border-radius: 6px; margin-top: 10px; }
        .footer { margin-top: 50px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; font-size: 12px; color: #999; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f44336; color: white; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö†Ô∏è RAPPORT DE RAPPEL PRODUIT - AFSCA</h1>
        <div>Emotions Chocolats - Couthuin, Belgique</div>
        <div>G√©n√©r√© le ${new Date().toLocaleDateString('fr-BE', { year: 'numeric', month: 'long', day: 'numeric' })} √† ${new Date().toLocaleTimeString('fr-BE')}</div>
    </div>
    
    <div class="alert-box">
        <strong style="font-size: 20px;">üîç Crit√®re de Recherche</strong><br>
        <strong>Type :</strong> ${searchTypeLabels[searchType]}<br>
        <strong>Valeur :</strong> "${searchValue}"<br><br>
        <strong style="font-size: 20px; color: #c62828;">${affectedLots.length} LOT(S) CONCERN√â(S)</strong>
    </div>
    
    <h2 style="color: #c62828; border-bottom: 2px solid #f44336; padding-bottom: 10px;">üìã Liste des Lots Affect√©s</h2>
    
    ${affectedLots.map(({ lot, matchingIngredients }) => `
        <div class="lot-section">
            <div class="lot-title">Lot ${lot.numero}</div>
            <div><strong>Produit :</strong> ${lot.produit.replace(/\s*\(DLC:.*?\)\s*$/i, '').trim()}</div>
            <div><strong>Date de Production :</strong> ${formatDate(lot.date)}</div>
            <div><strong>Op√©rateur :</strong> ${lot.operateur}</div>
            <div><strong>Quantit√© Produite :</strong> ${formatQuantite(lot.quantite, lot.unite)}</div>
            <div><strong>DLC :</strong> ${lot.dlc ? formatDate(lot.dlc) : 'N/A'}</div>
            
            <div class="ingredient-list">
                <strong>‚ö†Ô∏è Mati√®res Premi√®res Concern√©es :</strong>
                <table>
                    <thead>
                        <tr>
                            <th>Mati√®re Premi√®re</th>
                            <th>Lot Fournisseur</th>
                            <th>Fournisseur</th>
                            <th>Quantit√© Utilis√©e</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${matchingIngredients.map(ing => `
                        <tr>
                            <td><strong>${ing.matierePremiereNom || ing.mpNom || ing.nom}</strong></td>
                            <td><strong>${ing.matierePremiereLot || ing.mpLot || ing.lot || 'N/A'}</strong></td>
                            <td>${ing.matierePremiereFournisseur || ing.fournisseur || 'N/A'}</td>
                            <td>${((ing.quantiteUtilisee || ing.quantite || 0) * 1000).toFixed(0)}g</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `).join('')}
    
    <div style="background: #fff3cd; padding: 20px; border-left: 4px solid #ffc107; border-radius: 8px; margin-top: 30px;">
        <strong>üìã Actions Recommand√©es :</strong>
        <ul>
            <li>Bloquer imm√©diatement tous les lots concern√©s</li>
            <li>Informer les clients ayant re√ßu ces lots</li>
            <li>Contacter l'AFSCA pour d√©claration officielle</li>
            <li>Conserver ce rapport pour la tra√ßabilit√©</li>
        </ul>
    </div>
    
    <div class="footer">
        ${getWatermarkText()}<br>
        <strong>Document Confidentiel - URGENCE AFSCA</strong>
    </div>
</body>
</html>
            `;
            
            const blob = new Blob(['\uFEFF' + htmlContent], { type: 'text/html; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Rapport_Rappel_AFSCA_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert(`üìÑ Rapport de rappel g√©n√©r√© !\n\nOuvrez le fichier et imprimez-le en PDF.\nConservez ce document pour vos archives AFSCA.`, 'success');
        }

        // ============================================
        // COPYRIGHT & PROTECTION
        // ============================================
        
        // Affichage copyright console
        console.log('%cüç´ TRACACHOC v3.2.1', 'font-size: 20px; font-weight: bold; color: #5c3a21;');
        console.log('%c¬© 2024-2026 Emmanuel Laurent / Emotions Chocolats', 'font-size: 12px; color: #8a7b6c;');
        console.log('%c‚ö†Ô∏è Ce logiciel est prot√©g√© par le droit d\'auteur. Toute copie non autoris√©e est interdite.', 'font-size: 11px; color: #c43d3d;');
        
        // Protection basique contre copie du code (peut √™tre contourn√©e mais dissuasive)
        document.addEventListener('contextmenu', function(e) {
            // Permet le clic droit sur les inputs pour copier/coller
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return true;
            }
        });
        
        // Watermark discret dans les exports
        const APP_COPYRIGHT = {
            name: 'TRACACHOC',
            version: '3.2.1',
            author: 'Emmanuel Laurent',
            company: 'Emotions Chocolats',
            location: 'Couthuin, Belgique',
            year: '2024-2026',
            license: 'Proprietary - All rights reserved',
            website: '',
            contact: 'man497@hotmail.be'
        };
        
        // Fonction pour ajouter watermark aux exports PDF/Excel
        function getWatermarkText() {
            return `G√©n√©r√© par ${APP_COPYRIGHT.name} v${APP_COPYRIGHT.version} - ¬© ${APP_COPYRIGHT.year} ${APP_COPYRIGHT.author}`;
        }
    </script>
    
    <!-- 
    ================================================================================
    TRACACHOC - Syst√®me de Tra√ßabilit√© pour Chocolateries
    Copyright ¬© 2024-2026 Emmanuel Laurent / Emotions Chocolats
    Couthuin, Belgique - Tous droits r√©serv√©s
    Licence propri√©taire - Usage commercial interdit sans autorisation
    ================================================================================
    -->
</body>
</html>
